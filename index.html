<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mu Online 99B Marketplace</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
    }
    html {
      height: 100%;
    }
    .category-btn {
      transition: all 0.3s ease;
    }
    .category-btn:hover {
      transform: translateY(-2px);
    }
    .product-card {
      transition: all 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.7);
    }
    .btn-primary {
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: scale(1.05);
    }
    .star {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .star:hover {
      transform: scale(1.2);
    }
    .top-shop-card {
      transition: all 0.3s ease;
    }
    .top-shop-card:hover {
      transform: translateX(5px);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>

  <script>
    const DB_KEY = 'mu_marketplace_db_v1';

    // Inicializar DB en memoria desde LocalStorage o vac√≠o
    let savedData = localStorage.getItem(DB_KEY);
    window.mockDb = {
      data: savedData ? JSON.parse(savedData) : [],
      handler: null,
      notify() {
        // Guardar en LocalStorage cada vez que hay cambios
        localStorage.setItem(DB_KEY, JSON.stringify(this.data));
        if (this.handler) this.handler.onDataChanged(this.data);
      }
    };

    // Simular Data SDK
    window.dataSdk = {
      init: async (handler) => {
        window.mockDb.handler = handler;
        // Notificar datos iniciales
        setTimeout(() => window.mockDb.notify(), 50); 
        return { isOk: true };
      },
      create: async (item) => {
        item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        window.mockDb.data.push(item);
        window.mockDb.notify();
        return { isOk: true };
      },
      update: async (item) => {
        const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
        if (index !== -1) {
          window.mockDb.data[index] = item;
          window.mockDb.notify();
          return { isOk: true };
        }
        return { isOk: false };
      },
      delete: async (item) => {
        window.mockDb.data = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
        window.mockDb.notify();
        return { isOk: true };
      }
    };

    // Simular Element SDK (Configuraci√≥n visual)
    window.elementSdk = {
      config: {},
      init: (options) => {
        window.elementSdk.config = options.defaultConfig;
        if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
      },
      setConfig: (newConfig) => {
        window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
        // En un entorno real esto disparar√≠a onConfigChange, aqu√≠ lo hacemos simple
      }
    };
  </script>
 </head>
 <body>
  <div id="app" class="min-h-full"></div>
  
  <script>
    const defaultConfig = {
      site_title: "Mu Online 99B Marketplace",
      welcome_message: "Bienvenido a nuestra tienda de items premium",
      contact_info: "Contacto: Discord/WhatsApp",
      background_color: "#0f172a",
      card_background: "#1e293b",
      text_color: "#f1f5f9",
      primary_button: "#3b82f6",
      secondary_button: "#10b981",
      font_family: "Inter",
      font_size: 16
    };

    let currentUser = null;
    let currentView = 'catalog';
    let selectedCategory = 'all';
    let allProducts = [];
    let allUsers = [];
    let allOrders = [];
    let allReviews = [];
    let cart = [];
    let showModal = null;
    let selectedOrder = null;

    const CATEGORIES = [
      { id: 'all', name: 'Todos', icon: 'üéÆ' },
      { id: 'promotions', name: 'Promociones', icon: 'üî•' },
      { id: 'items', name: 'Items', icon: '‚öîÔ∏è' },
      { id: 'jewels', name: 'Joyas', icon: 'üíé' },
      { id: 'wings', name: 'Alas', icon: 'ü¶Ö' },
      { id: 'sets', name: 'Sets', icon: 'üõ°Ô∏è' }
    ];

    const ADMIN_CREDENTIALS = {
      username: 'Kaleb',
      password: 'Kaleb.2021'
    };

    let onlineUsers = new Set();
    let userActivityTimeout = null;

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        allProducts = data.filter(item => item.type === 'product') || [];
        allUsers = data.filter(item => item.type === 'user') || [];
        allOrders = data.filter(item => item.type === 'order') || [];
        allReviews = data.filter(item => item.type === 'review') || [];
        const activityRecords = data.filter(item => item.type === 'activity') || [];
        
        // Actualizar usuarios en l√≠nea (√∫ltimos 5 minutos)
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        onlineUsers = new Set(
          activityRecords
            .filter(a => new Date(a.last_activity).getTime() > fiveMinutesAgo)
            .map(a => a.username)
        );
        
        checkPendingReviews();
        render();
      }
    };

    // Initialize
    async function init() {
      const initResult = await window.dataSdk.init(dataHandler);
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
            document.body.style.color = config.text_color || defaultConfig.text_color;
            const baseSize = config.font_size || defaultConfig.font_size;
            document.body.style.fontSize = `${baseSize}px`;
            render();
          }
        });
      }

      render();
    }

    // Verificar pedidos pendientes de calificar
    function checkPendingReviews() {
      if (!currentUser || currentUser.role !== 'buyer') return;
      
      const pendingOrder = allOrders.find(o => 
        o.buyer_username === currentUser.username && 
        o.order_status === 'completed' && 
        o.needs_review === true
      );

      if (pendingOrder) {
        selectedOrder = pendingOrder;
        showModal = 'review';
        render();
      }
    }

    // Export/Import Functions
    async function exportData() {
      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
      }

      const exportData = {
        products: allProducts,
        users: allUsers,
        orders: allOrders,
        reviews: allReviews,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      
      try {
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `marketplace_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
        showToast('‚úÖ Descargando archivo JSON...');
      } catch (error) {
        showToast('‚ùå Error al descargar.');
      }

      if (btn) {
        btn.disabled = false;
        btn.innerHTML = 'üì• Exportar Todos los Datos';
      }
    }

    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          if (!importedData.products || !importedData.users) {
            showToast('‚ùå Archivo JSON inv√°lido');
            return;
          }
          showModal = 'importConfirm';
          selectedOrder = importedData;
          render();
        } catch (error) {
          showToast('‚ùå Error al leer el archivo JSON');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    async function confirmImport() {
      const importedData = selectedOrder;
      if (!importedData) return;

      let successCount = 0;

      // Import logic (Simplified for mock DB: just push if not exists)
      // Note: In a real backend this would be bulk insert
      const collections = ['users', 'products', 'orders', 'reviews'];
      
      for (const col of collections) {
          if(importedData[col]) {
              for(const item of importedData[col]) {
                  // Check existence based on a unique field if possible, simplistic approach here
                  const newItem = {...item};
                  delete newItem.__backendId; // Generate new IDs for the mock DB
                  await window.dataSdk.create(newItem);
                  successCount++;
              }
          }
      }

      showToast(`‚úÖ Importaci√≥n completada`);
      showModal = null;
      selectedOrder = null;
      render();
    }

    // Auth Functions
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        currentUser = { username, role: 'admin', __backendId: 'admin' };
        showModal = null;
        currentView = 'admin';
        showToast('Bienvenido Admin');
        await updateUserActivity();
        render();
        return;
      }

      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        if (user.role === 'reseller' && !user.approved) {
          showToast('Tu cuenta a√∫n no ha sido aprobada');
          return;
        }
        
        currentUser = { 
          username: user.username,
          role: user.role,
          shop_name: user.shop_name,
          discord_tag: user.discord_tag,
          __backendId: user.__backendId
        };
        
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag)) {
          selectedOrder = user;
          showModal = 'setupShop';
          showToast('Por favor configura tu tienda para continuar');
          render();
          return;
        }
        
        showModal = null;
        if (user.role === 'reseller' || user.role === 'admin') {
          currentView = 'admin';
        }
        showToast(`Bienvenido ${username}`);
        
        await updateUserActivity();
        checkPendingReviews();
        render();
      } else {
        showToast('Usuario o contrase√±a incorrectos');
      }
    }

    async function handleRegisterBuyer(e) {
      e.preventDefault();
      const username = document.getElementById('buyerUsername').value.trim();
      const password = document.getElementById('buyerPassword').value;
      const discord = document.getElementById('buyerDiscord').value.trim();

      if (allUsers.find(u => u.username === username)) {
        showToast('El usuario ya existe');
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username,
        password,
        discord_tag: discord,
        profile_picture: '',
        role: 'buyer',
        approved: true,
        status: 'active',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);
      if (result.isOk) {
        showToast('Registro exitoso! Ahora puedes iniciar sesi√≥n');
        showModal = 'login';
        render();
      } else {
        showToast('Error al registrar usuario');
      }
    }

    async function handleRegisterReseller(e) {
      e.preventDefault();
      const username = document.getElementById('resellerUsername').value.trim();
      const password = document.getElementById('resellerPassword').value;
      const discord = document.getElementById('resellerDiscord').value.trim();
      const shopName = document.getElementById('resellerShop').value.trim();

      if (allUsers.find(u => u.username === username)) {
        showToast('El usuario ya existe');
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username,
        password,
        discord_tag: discord,
        shop_name: shopName,
        profile_picture: '',
        role: 'reseller',
        approved: false,
        status: 'pending',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);
      if (result.isOk) {
        showToast('Solicitud enviada! Espera aprobaci√≥n del admin');
        showModal = null;
        render();
      } else {
        showToast('Error al enviar solicitud');
      }
    }

    async function updateUserActivity() {
      if (!currentUser) return;
      
      // En el mock DB solo actualizamos si existe
      const activityRecords = window.mockDb.data.filter(item => item.type === 'activity');
      const existingActivity = activityRecords.find(a => a.username === currentUser.username);
      
      if (existingActivity) {
        existingActivity.last_activity = new Date().toISOString();
        await window.dataSdk.update(existingActivity);
      } else {
        const activityData = {
          id: 'activity_' + currentUser.username,
          type: 'activity',
          username: currentUser.username,
          last_activity: new Date().toISOString()
        };
        await window.dataSdk.create(activityData);
      }
      
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      userActivityTimeout = setTimeout(updateUserActivity, 2 * 60 * 1000);
    }

    function logout() {
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      currentUser = null;
      currentView = 'catalog';
      cart = [];
      showToast('Sesi√≥n cerrada');
      render();
    }

    // Product Functions
    async function handleAddProduct(e) {
      e.preventDefault();
      if (allProducts.length >= 999) {
        showToast('L√≠mite de productos alcanzado');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      let imageUrl = document.getElementById('productImage').value.trim();
      
      if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        imageUrl = imageUrl + '.jpg';
      }

      const discount = parseInt(document.getElementById('productDiscount').value) || 0;
      const onSale = document.getElementById('productOnSale').checked;
      const originalPrice = parseFloat(document.getElementById('productPrice').value);
      const finalPrice = discount > 0 ? originalPrice * (1 - discount / 100) : originalPrice;

      const productData = {
        id: Date.now().toString(),
        type: 'product',
        name: document.getElementById('productName').value.trim(),
        category: document.getElementById('productCategory').value,
        price: originalPrice,
        final_price: finalPrice,
        discount: discount,
        on_sale: onSale,
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value.trim(),
        image_url: imageUrl,
        seller_username: currentUser.username,
        seller_shop_name: currentUser.shop_name || currentUser.username,
        seller_discord: currentUser.discord_tag || 'Admin',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(productData);
      if (result.isOk) {
        showToast('Producto agregado exitosamente');
        e.target.reset();
      } else {
        showToast('Error al agregar producto');
      }

      btn.disabled = false;
      btn.innerHTML = 'Agregar Producto';
    }

    async function deleteProduct(backendId) {
      const product = allProducts.find(p => p.__backendId === backendId);
      if (!product) return;

      const result = await window.dataSdk.delete(product);
      if (result.isOk) {
        showToast('Producto eliminado');
      } else {
        showToast('Error al eliminar producto');
      }
    }

    async function approveReseller(backendId, approve) {
      const user = allUsers.find(u => u.__backendId === backendId);
      if (!user) return;

      user.approved = approve;
      user.status = approve ? 'approved' : 'rejected';

      const result = await window.dataSdk.update(user);
      if (result.isOk) {
        showToast(approve ? 'Vendedor aprobado' : 'Vendedor rechazado');
      } else {
        showToast('Error al procesar solicitud');
      }
    }

    async function changeUserRole(backendId, newRole) {
      const user = allUsers.find(u => u.__backendId === backendId);
      if (!user) return;

      const oldRole = user.role;
      user.role = newRole;
      
      if (newRole === 'reseller') {
        user.approved = true;
        user.status = 'approved';
      } else if (newRole === 'admin') {
        user.approved = true;
        user.status = 'approved';
        if (oldRole === 'reseller') {
          user.shop_name = '';
          user.discord_tag = user.discord_tag || '';
        }
      } else if (newRole === 'buyer') {
        user.approved = true;
        user.status = 'active';
        user.shop_name = '';
      }

      const result = await window.dataSdk.update(user);
      if (result.isOk) {
        showToast(`Rol cambiado a ${newRole}`);
      } else {
        showToast('Error al cambiar rol');
      }
    }

    async function handleSetupShop(e) {
      e.preventDefault();
      const user = selectedOrder;
      if (!user) return;

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      const shopName = document.getElementById('setupShopName').value.trim();
      const discordTag = document.getElementById('setupDiscord').value.trim();

      // Validar Discord (simple)
      const discordExists = allUsers.find(u => u.discord_tag === discordTag && u.__backendId !== user.__backendId);
      if (discordExists) {
        showToast('Este Discord ya est√° registrado por otro usuario');
        btn.disabled = false;
        btn.innerHTML = 'Crear Tienda';
        return;
      }

      user.role = 'reseller';
      user.shop_name = shopName;
      user.discord_tag = discordTag;
      user.approved = true;
      user.status = 'approved';

      const result = await window.dataSdk.update(user);
      if (result.isOk) {
        showToast('Tienda configurada exitosamente');
        showModal = null;
        selectedOrder = null;
        
        if (currentUser && user.__backendId === currentUser.__backendId) {
          currentUser = user;
          currentView = 'admin';
        }
        
        render();
      } else {
        showToast('Error al configurar tienda');
        btn.disabled = false;
        btn.innerHTML = 'Crear Tienda';
      }
    }

    // User Profile & Search Functions
    function filterUsers(searchTerm) {
      const rows = document.querySelectorAll('.user-row');
      const term = searchTerm.toLowerCase().trim();
      
      rows.forEach(row => {
        const username = row.getAttribute('data-username');
        if (username.includes(term)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    function viewUserProfile(backendId) {
      const user = allUsers.find(u => u.__backendId === backendId);
      if (!user) return;
      
      selectedOrder = user;
      showModal = 'userProfile';
      render();
    }

    // Cart Functions
    function addToCart(backendId) {
      if (!currentUser) {
        showToast('Inicia sesi√≥n para agregar al carrito');
        showModal = 'login';
        render();
        return;
      }

      const product = allProducts.find(p => p.__backendId === backendId);
      if (!product || product.stock <= 0) {
        showToast('Producto sin stock');
        return;
      }

      const existing = cart.find(item => item.__backendId === backendId);
      if (existing) {
        if (existing.quantity < product.stock) {
          existing.quantity++;
          showToast('Cantidad actualizada');
        } else {
          showToast('No hay m√°s stock disponible');
        }
      } else {
        cart.push({ ...product, quantity: 1 });
        showToast('Agregado al carrito');
      }
      render();
    }

    function updateCartQuantity(index, change) {
      const item = cart[index];
      const product = allProducts.find(p => p.__backendId === item.__backendId);
      const newQuantity = item.quantity + change;

      if (newQuantity < 1) {
        removeFromCart(index);
        return;
      }

      if (newQuantity <= product.stock) {
        cart[index].quantity = newQuantity;
        render();
      } else {
        showToast('No hay m√°s stock disponible');
      }
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      showToast('Producto eliminado del carrito');
      render();
    }

    function clearCart() {
      cart = [];
      render();
    }

    // Order Functions
    async function createOrder() {
      if (cart.length === 0) return;
      if (allOrders.length >= 999) {
        showToast('L√≠mite de pedidos alcanzado');
        return;
      }

      const ordersBySeller = {};
      cart.forEach(item => {
        if (!ordersBySeller[item.seller_username]) {
          ordersBySeller[item.seller_username] = {
            seller: item.seller_username,
            discord: item.seller_discord,
            items: [],
            total: 0
          };
        }
        const itemPrice = item.discount > 0 ? item.final_price : item.price;
        ordersBySeller[item.seller_username].items.push(item);
        ordersBySeller[item.seller_username].total += itemPrice * item.quantity;
      });

      for (const sellerUsername in ordersBySeller) {
        const orderInfo = ordersBySeller[sellerUsername];
        const itemsDesc = orderInfo.items.map(item => {
          const itemPrice = item.discount > 0 ? item.final_price : item.price;
          return `${item.name} x${item.quantity} ($${(itemPrice * item.quantity).toFixed(2)} USDT)`;
        }).join(' | ');

        const itemsData = JSON.stringify(orderInfo.items.map(item => ({
          backendId: item.__backendId,
          name: item.name,
          quantity: item.quantity
        })));

        const orderData = {
          id: Date.now().toString() + '_' + sellerUsername,
          type: 'order',
          buyer_username: currentUser.username,
          buyer_discord: currentUser.discord_tag,
          seller_username: sellerUsername,
          seller_discord: orderInfo.discord,
          items: itemsDesc,
          items_data: itemsData,
          total: orderInfo.total,
          order_status: 'pending',
          seller_confirmed: false,
          buyer_confirmed: false,
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.create(orderData);
        if (!result.isOk) {
          showToast('Error al crear pedido');
          return;
        }
      }

      showToast('Pedido(s) creado(s) exitosamente! Contacta al vendedor por Discord');
      cart = [];
      currentView = 'orders';
      render();
    }

    async function confirmOrder(backendId, isSeller) {
      const order = allOrders.find(o => o.__backendId === backendId);
      if (!order) return;

      if (isSeller) {
        order.seller_confirmed = true;
      } else {
        order.buyer_confirmed = true;
      }

      if (order.seller_confirmed && order.buyer_confirmed) {
        order.order_status = 'completed';
        order.needs_review = true;
        
        // Actualizar Stock
        try {
          const itemsData = JSON.parse(order.items_data);
          for (const item of itemsData) {
            const product = allProducts.find(p => p.__backendId === item.backendId);
            if (product) {
              product.stock = Math.max(0, product.stock - item.quantity);
              await window.dataSdk.update(product);
            }
          }
        } catch (e) {
          console.error('Error procesando items:', e);
        }
      }

      const result = await window.dataSdk.update(order);
      
      if (result.isOk) {
        if (order.order_status === 'completed') {
          showToast('¬°Pedido completado! Stock actualizado');
          if (!isSeller) {
            selectedOrder = order;
            showModal = 'review';
            render();
          }
        } else {
          showToast('Confirmaci√≥n registrada. Esperando confirmaci√≥n de ' + (isSeller ? 'comprador' : 'vendedor'));
        }
        render();
      } else {
        showToast('Error al confirmar pedido');
      }
    }

    async function handleSubmitReview(e) {
      e.preventDefault();
      if (!selectedOrder) return;

      const rating = parseInt(document.querySelector('input[name="rating"]:checked')?.value || '0');
      const reviewText = document.getElementById('reviewText').value.trim();

      if (rating === 0) {
        showToast('Por favor selecciona una calificaci√≥n');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      const reviewData = {
        id: Date.now().toString(),
        type: 'review',
        buyer_username: currentUser.username,
        reviewed_seller: selectedOrder.seller_username,
        rating: rating,
        review_text: reviewText,
        created_at: new Date().toISOString()
      };

      const reviewResult = await window.dataSdk.create(reviewData);
      
      if (reviewResult.isOk) {
        selectedOrder.needs_review = false;
        await window.dataSdk.update(selectedOrder);
        
        showToast('¬°Gracias por tu rese√±a!');
        showModal = null;
        selectedOrder = null;
        render();
      } else {
        showToast('Error al guardar rese√±a');
      }

      btn.disabled = false;
      btn.innerHTML = 'Enviar Rese√±a';
    }

    // Review Functions
    function getSellerRating(sellerUsername) {
      const sellerReviews = allReviews.filter(r => r.reviewed_seller === sellerUsername);
      if (sellerReviews.length === 0) return { average: 0, count: 0 };
      
      const sum = sellerReviews.reduce((acc, r) => acc + r.rating, 0);
      return {
        average: (sum / sellerReviews.length).toFixed(1),
        count: sellerReviews.length
      };
    }

    function getTopShops() {
      const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
      const shopsWithRatings = resellers.map(seller => {
        const rating = getSellerRating(seller.username);
        return {
          ...seller,
          rating: parseFloat(rating.average),
          reviewCount: rating.count
        };
      }).filter(shop => shop.reviewCount > 0);

      return shopsWithRatings.sort((a, b) => {
        if (b.rating !== a.rating) return b.rating - a.rating;
        return b.reviewCount - a.reviewCount;
      }).slice(0, 3);
    }

    function renderStars(rating) {
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      let stars = '';
      for (let i = 0; i < fullStars; i++) stars += '‚≠ê';
      if (hasHalfStar) stars += '‚ú®';
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) stars += '‚òÜ';
      return stars;
    }

    // Utility Functions
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white';
      toast.style.backgroundColor = getConfig().primary_button;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getConfig() {
      return window.elementSdk ? window.elementSdk.config : defaultConfig;
    }

    function getCurrentUserData() {
      if (!currentUser) return null;
      if (currentUser.role === 'admin' && currentUser.__backendId === 'admin') {
        return currentUser;
      }
      return allUsers.find(u => u.username === currentUser.username);
    }

    function getCategoryIcon(categoryId) {
      const cat = CATEGORIES.find(c => c.id === categoryId);
      return cat ? cat.icon : 'üì¶';
    }

    function getCategoryName(categoryId) {
      const cat = CATEGORIES.find(c => c.id === categoryId);
      return cat ? cat.name : 'Otro';
    }

    // Render Functions
    function render() {
      const app = document.getElementById('app');
      const config = getConfig();

      document.body.style.backgroundColor = config.background_color;
      document.body.style.color = config.text_color;
      document.body.style.fontFamily = `${config.font_family}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;

      if (currentView === 'catalog') {
        app.innerHTML = renderCatalog();
      } else if (currentView === 'cart') {
        app.innerHTML = renderCart();
      } else if (currentView === 'orders') {
        app.innerHTML = renderOrders();
      } else if (currentView === 'admin') {
        app.innerHTML = renderAdmin();
      }

      if (showModal) {
        const modalContainer = document.getElementById('modalContainer');
        if (modalContainer) {
          modalContainer.innerHTML = renderModal();
        }
      }
    }

    function renderCatalog() {
      const config = getConfig();
      const filteredProducts = selectedCategory === 'all' 
        ? allProducts 
        : selectedCategory === 'promotions'
        ? allProducts.filter(p => p.on_sale === true)
        : allProducts.filter(p => p.category === selectedCategory);

      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const topShops = getTopShops();

      return `
        <div class="min-h-full" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <header class="shadow-lg" style="background-color: ${config.card_background};">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="text-center lg:text-left">
                  <h1 class="text-3xl lg:text-4xl font-bold">${config.site_title}</h1>
                  <p class="text-sm lg:text-base mt-2 opacity-80">${config.welcome_message}</p>
                  <p class="text-xs mt-1 opacity-60">${config.contact_info}</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                  ${currentUser ? `
                    <button onclick="currentView='cart'; render();" class="relative px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                      üõí Carrito
                      ${cartCount > 0 ? `<span class="cart-badge">${cartCount}</span>` : ''}
                    </button>
                    <button onclick="currentView='orders'; render();" class="px-4 py-2 rounded-lg font-semibold transition bg-purple-600 text-white">
                      üì¶ Mis Pedidos
                    </button>
                    ${currentUser.role !== 'buyer' ? `
                      <button onclick="currentView='admin'; render();" class="px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.secondary_button}; color: white;">
                        ${currentUser.role === 'admin' ? '‚öôÔ∏è Admin' : 'üè™ Mi Tienda'}
                      </button>
                    ` : ''}
                    <button onclick="logout();" class="px-4 py-2 rounded-lg font-semibold transition bg-red-600 text-white">
                      üö™ Salir
                    </button>
                  ` : `
                    <button onclick="showModal='register'; render();" class="px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.secondary_button}; color: white;">
                      üìù Registrarse
                    </button>
                    <button onclick="showModal='registerReseller'; render();" class="px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                      üè™ Abrir Tienda
                    </button>
                    <button onclick="showModal='login'; render();" class="px-4 py-2 rounded-lg font-semibold transition bg-purple-600 text-white">
                      üîê Login
                    </button>
                  `}
                </div>
              </div>
            </div>
          </header>

          ${topShops.length > 0 ? `
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div class="rounded-xl p-6 shadow-lg" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4 text-center">üèÜ Top 3 Tiendas M√°s Confiables</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                  ${topShops.map((shop, index) => `
                    <div class="top-shop-card rounded-lg p-4 text-center shadow-md" style="background-color: rgba(0,0,0,0.3); border: 2px solid ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : 'rgba(255,255,255,0.1)'};">
                      <div class="text-3xl mb-2">
                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ'}
                      </div>
                      <p class="font-bold text-lg mb-1">üè™ ${shop.shop_name}</p>
                      <p class="text-sm opacity-70 mb-2">üë§ ${shop.username}</p>
                      <div class="text-xl mb-1">${renderStars(shop.rating)}</div>
                      <p class="font-bold text-lg" style="color: ${config.secondary_button};">${shop.rating} ‚≠ê</p>
                      <p class="text-xs opacity-70">(${shop.reviewCount} rese√±as)</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}

          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-wrap gap-3 justify-center">
              ${CATEGORIES.map(cat => `
                <button 
                  onclick="selectedCategory='${cat.id}'; render();" 
                  class="category-btn px-6 py-3 rounded-lg font-semibold shadow-md ${selectedCategory === cat.id ? 'ring-4 ring-blue-400' : ''}"
                  style="background-color: ${selectedCategory === cat.id ? config.primary_button : config.card_background}; color: ${config.text_color};">
                  ${cat.icon} ${cat.name}
                </button>
              `).join('')}
            </div>
          </div>

          <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-12">
            ${filteredProducts.length === 0 ? `
              <div class="text-center py-20">
                <p class="text-2xl opacity-60">üì¶ No hay productos disponibles</p>
                <p class="mt-4 opacity-40">Pronto habr√° items incre√≠bles aqu√≠</p>
              </div>
            ` : `
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${filteredProducts.map(product => {
                  const rating = getSellerRating(product.seller_username);
                  return `
                  <div class="product-card rounded-xl shadow-lg overflow-hidden ${product.on_sale ? 'ring-4 ring-red-500' : ''} relative" style="background-color: ${config.card_background};">
                    ${product.on_sale ? `
                      <div class="absolute top-2 right-2 z-10">
                        <span class="px-3 py-1 rounded-full text-sm font-bold bg-red-600 text-white shadow-lg animate-pulse">
                          üî• PROMO
                        </span>
                      </div>
                    ` : ''}
                    
                    <div class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600">
                      <p class="text-xs font-semibold text-white flex items-center justify-between">
                        <span>üè™ ${product.seller_shop_name || product.seller_username}</span>
                        ${rating.count > 0 ? `<span>‚≠ê ${rating.average} (${rating.count})</span>` : ''}
                      </p>
                      <p class="text-xs text-white opacity-90">üë§ ${product.seller_username} | üí¨ ${product.seller_discord}</p>
                    </div>

                    <div class="flex items-center justify-center h-40 text-6xl" style="background-color: rgba(0,0,0,0.2);">
                      ${product.image_url ? `
                        <img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='${getCategoryIcon(product.category)}';">
                      ` : getCategoryIcon(product.category)}
                    </div>

                    <div class="p-4">
                      <h3 class="text-xl font-bold mb-2">${product.name}</h3>
                      <p class="text-sm opacity-70 mb-3 line-clamp-2">${product.description}</p>
                      
                      <div class="flex items-center gap-2 mb-3">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background-color: ${config.primary_button}; color: white;">
                          ${getCategoryIcon(product.category)} ${getCategoryName(product.category)}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${product.stock > 0 ? 'bg-green-600' : 'bg-red-600'} text-white">
                          üì¶ Stock: ${product.stock}
                        </span>
                      </div>

                      <div class="flex items-center justify-between mt-4">
                        <div>
                          ${product.discount > 0 ? `
                            <p class="text-sm line-through opacity-50">$${product.price.toFixed(2)} USDT</p>
                            <p class="text-2xl font-bold" style="color: ${config.secondary_button};">
                              üí∞ $${product.final_price.toFixed(2)} USDT
                            </p>
                            <span class="inline-block mt-1 px-2 py-1 rounded-full text-xs font-bold bg-red-600 text-white">
                              -${product.discount}% OFF
                            </span>
                          ` : `
                            <p class="text-2xl font-bold" style="color: ${config.secondary_button};">
                              üí∞ $${product.price.toFixed(2)} USDT
                            </p>
                          `}
                        </div>
                        <button 
                          onclick="addToCart('${product.__backendId}')" 
                          ${product.stock <= 0 ? 'disabled' : ''}
                          class="px-4 py-2 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                          style="background-color: ${config.secondary_button}; color: white;">
                          ${product.stock > 0 ? 'üõí Agregar' : '‚ùå Sin Stock'}
                        </button>
                      </div>
                    </div>
                  </div>
                `}).join('')}
              </div>
            `}
          </main>
          <div id="modalContainer"></div>
        </div>
      `;
    }

    function renderCart() {
      const config = getConfig();
      const total = cart.reduce((sum, item) => {
        const itemPrice = item.discount > 0 ? item.final_price : item.price;
        return sum + (itemPrice * item.quantity);
      }, 0);

      return `
        <div class="min-h-full" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <header class="shadow-lg" style="background-color: ${config.card_background};">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üõí Mi Carrito</h1>
                <button onclick="currentView='catalog'; render();" class="px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                  ‚Üê Volver al Cat√°logo
                </button>
              </div>
            </div>
          </header>

          <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            ${cart.length === 0 ? `
              <div class="text-center py-20">
                <p class="text-4xl mb-4">üõí</p>
                <p class="text-2xl opacity-60 mb-6">Tu carrito est√° vac√≠o</p>
                <button onclick="currentView='catalog'; render();" class="px-6 py-3 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                  Ver Productos
                </button>
              </div>
            ` : `
              <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-4">
                  ${cart.map((item, index) => `
                    <div class="rounded-xl p-4 shadow-lg" style="background-color: ${config.card_background};">
                      <div class="flex gap-4">
                        <div class="flex-shrink-0 w-24 h-24 rounded-lg flex items-center justify-center text-4xl" style="background-color: rgba(0,0,0,0.2);">
                          ${item.image_url ? `
                            <img src="${item.image_url}" alt="${item.name}" class="w-full h-full object-cover rounded-lg" onerror="this.style.display='none'; this.parentElement.innerHTML='${getCategoryIcon(item.category)}';">
                          ` : getCategoryIcon(item.category)}
                        </div>
                        
                        <div class="flex-1">
                          <h3 class="text-xl font-bold mb-1">${item.name}</h3>
                          <p class="text-sm opacity-70 mb-2">Vendedor: ${item.seller_username}</p>
                          ${item.discount > 0 ? `
                            <p class="text-xs line-through opacity-50">$${item.price.toFixed(2)} USDT</p>
                            <p class="text-lg font-bold" style="color: ${config.secondary_button};">
                              üí∞ $${item.final_price.toFixed(2)} USDT 
                              <span class="text-xs bg-red-600 text-white px-2 py-1 rounded-full">-${item.discount}%</span>
                            </p>
                          ` : `
                            <p class="text-lg font-bold" style="color: ${config.secondary_button};">üí∞ $${item.price.toFixed(2)} USDT</p>
                          `}
                        </div>

                        <div class="flex flex-col justify-between items-end">
                          <button onclick="removeFromCart(${index});" class="text-red-500 hover:text-red-700 font-bold">
                            ‚ùå
                          </button>
                          
                          <div class="flex items-center gap-2">
                            <button onclick="updateCartQuantity(${index}, -1);" class="w-8 h-8 rounded-lg font-bold transition" style="background-color: ${config.primary_button}; color: white;">
                              -
                            </button>
                            <span class="w-12 text-center font-bold text-lg">${item.quantity}</span>
                            <button onclick="updateCartQuantity(${index}, 1);" class="w-8 h-8 rounded-lg font-bold transition" style="background-color: ${config.primary_button}; color: white;">
                              +
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>

                <div class="lg:col-span-1">
                  <div class="rounded-xl p-6 shadow-lg sticky top-4" style="background-color: ${config.card_background};">
                    <h2 class="text-2xl font-bold mb-6">üìã Resumen del Pedido</h2>
                    <div class="space-y-3 mb-6">
                      <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span class="font-semibold">$${total.toFixed(2)} USDT</span>
                      </div>
                      <div class="flex justify-between text-sm opacity-70">
                        <span>Items:</span>
                        <span>${cart.reduce((sum, item) => sum + item.quantity, 0)}</span>
                      </div>
                      <div class="border-t pt-3 mt-3" style="border-color: rgba(255,255,255,0.1);">
                        <div class="flex justify-between text-xl font-bold">
                          <span>Total:</span>
                          <span style="color: ${config.secondary_button};">üí∞ $${total.toFixed(2)} USDT</span>
                        </div>
                      </div>
                    </div>

                    <button onclick="createOrder();" class="w-full py-4 rounded-lg font-bold text-lg transition mb-3" style="background-color: ${config.secondary_button}; color: white;">
                      ‚úÖ Confirmar Pedido
                    </button>
                    
                    <button onclick="clearCart();" class="w-full py-2 rounded-lg font-semibold transition bg-red-600 text-white">
                      üóëÔ∏è Vaciar Carrito
                    </button>

                    <div class="mt-6 p-4 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1);">
                      <p class="text-sm opacity-80">
                        üí¨ Despu√©s de confirmar, contacta al vendedor por Discord para coordinar la entrega
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            `}
          </main>
        </div>
      `;
    }

    function renderOrders() {
      const config = getConfig();
      const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username);

      return `
        <div class="min-h-full" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <header class="shadow-lg" style="background-color: ${config.card_background};">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üì¶ Mis Pedidos</h1>
                <button onclick="currentView='catalog'; render();" class="px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                  ‚Üê Volver al Cat√°logo
                </button>
              </div>
            </div>
          </header>

          <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            ${myOrders.length === 0 ? `
              <div class="text-center py-20">
                <p class="text-4xl mb-4">üì¶</p>
                <p class="text-2xl opacity-60 mb-6">No tienes pedidos a√∫n</p>
                <button onclick="currentView='catalog'; render();" class="px-6 py-3 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                  Ver Productos
                </button>
              </div>
            ` : `
              <div class="space-y-4">
                ${myOrders.map(order => {
                  const isPending = order.order_status === 'pending';
                  const isCompleted = order.order_status === 'completed';
                  return `
                    <div class="rounded-xl p-6 shadow-lg" style="background-color: ${config.card_background};">
                      <div class="flex flex-col lg:flex-row justify-between gap-4">
                        <div class="flex-1">
                          <div class="flex items-center gap-3 mb-3">
                            <h3 class="text-xl font-bold">Pedido #${order.id.substring(0, 8)}</h3>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${isCompleted ? 'bg-green-600' : 'bg-yellow-600'} text-white">
                              ${isCompleted ? '‚úÖ Completado' : '‚è≥ Pendiente'}
                            </span>
                          </div>
                          
                          <div class="space-y-2 mb-4">
                            <p class="text-sm"><span class="font-semibold">Vendedor:</span> ${order.seller_username}</p>
                            <p class="text-sm"><span class="font-semibold">Discord:</span> ${order.seller_discord}</p>
                            <p class="text-sm"><span class="font-semibold">Fecha:</span> ${new Date(order.created_at).toLocaleDateString()}</p>
                          </div>

                          <div class="p-4 rounded-lg mb-4" style="background-color: rgba(0,0,0,0.2);">
                            <p class="font-semibold mb-2">üì¶ Productos:</p>
                            <p class="text-sm opacity-90">${order.items}</p>
                          </div>

                          <p class="text-2xl font-bold" style="color: ${config.secondary_button};">
                            üí∞ Total: $${order.total.toFixed(2)} USDT
                          </p>

                          ${isPending ? `
                            <div class="mt-4 p-3 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1);">
                              <p class="text-sm font-semibold mb-1">Estado de Confirmaci√≥n:</p>
                              <p class="text-xs">Vendedor: ${order.seller_confirmed ? '‚úÖ Confirmado' : '‚è≥ Pendiente'}</p>
                              <p class="text-xs">Comprador (t√∫): ${order.buyer_confirmed ? '‚úÖ Confirmado' : '‚è≥ Pendiente'}</p>
                            </div>
                          ` : ''}
                        </div>

                        <div class="flex flex-col justify-between gap-3">
                          ${isPending ? `
                            <button 
                              onclick="confirmOrder('${order.__backendId}', false);" 
                              ${order.buyer_confirmed ? 'disabled' : ''}
                              class="px-6 py-3 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" 
                              style="background-color: ${config.secondary_button}; color: white;">
                              ${order.buyer_confirmed ? '‚úÖ Ya Confirmaste' : '‚úÖ Confirmar Recibido'}
                            </button>
                            <div class="p-3 rounded-lg text-center text-sm" style="background-color: rgba(59, 130, 246, 0.1);">
                              üí¨ Contacta al vendedor por Discord
                            </div>
                          ` : `
                            <div class="p-3 rounded-lg text-center" style="background-color: rgba(16, 185, 129, 0.2);">
                              <p class="font-semibold text-green-400">‚úÖ Pedido Completado</p>
                              <p class="text-xs mt-1 opacity-70">Gracias por tu compra</p>
                            </div>
                          `}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </main>
        </div>
      `;
    }

    function renderAdmin() {
      const config = getConfig();
      const userData = getCurrentUserData();
      if (!userData) return '<div>Error: Usuario no encontrado</div>';

      const userProducts = userData.role === 'admin' 
        ? allProducts 
        : allProducts.filter(p => p.seller_username === userData.username);
      
      const pendingResellers = allUsers.filter(u => u.role === 'reseller' && !u.approved);
      
      const myOrders = userData.role === 'admin'
        ? allOrders
        : allOrders.filter(o => o.seller_username === userData.username);

      const myReviews = userData.role === 'admin'
        ? []
        : allReviews.filter(r => r.reviewed_seller === userData.username);

      const rating = userData.role === 'admin' ? null : getSellerRating(userData.username);
      
      const completedOrders = allOrders.filter(o => o.order_status === 'completed');
      
      const activeUsers = allUsers;
      
      const stats = {
        total: userProducts.length,
        items: userProducts.filter(p => p.category === 'items').length,
        wings: userProducts.filter(p => p.category === 'wings').length,
        sets: userProducts.filter(p => p.category === 'sets').length,
        resellers: allUsers.filter(u => u.role === 'reseller' && u.approved).length,
        pendingOrders: myOrders.filter(o => o.order_status === 'pending').length,
        completedOrders: currentUser.role === 'admin' ? completedOrders.length : myOrders.filter(o => o.order_status === 'completed').length,
        totalUsers: allUsers.length,
        onlineUsers: onlineUsers.size,
        buyers: allUsers.filter(u => u.role === 'buyer').length,
        admins: allUsers.filter(u => u.role === 'admin').length,
      };

      return `
        <div class="min-h-full" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <header class="shadow-lg" style="background-color: ${config.card_background};">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                  ${userData.profile_picture ? `
                    <img src="${userData.profile_picture}" alt="${userData.username}" class="w-20 h-20 rounded-full object-cover border-4 border-blue-500 shadow-lg" onerror="this.style.display='none';">
                  ` : `
                    <div class="w-20 h-20 rounded-full flex items-center justify-center text-4xl border-4 border-blue-500 shadow-lg" style="background-color: rgba(59, 130, 246, 0.2);">
                      üë§
                    </div>
                  `}
                  <div>
                    <h1 class="text-3xl font-bold">
                      ${userData.role === 'admin' ? '‚öôÔ∏è Panel de Administraci√≥n' : 'üè™ Mi Tienda'}
                    </h1>
                    <p class="opacity-70 mt-1">Bienvenido, ${userData.username}</p>
                    ${rating && rating.count > 0 ? `
                      <p class="mt-2 text-lg">
                        ${renderStars(parseFloat(rating.average))} 
                        <span class="font-semibold">${rating.average}</span> 
                        <span class="text-sm opacity-70">(${rating.count} rese√±as)</span>
                      </p>
                    ` : ''}
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="currentView='catalog'; render();" class="px-4 py-2 rounded-lg font-semibold transition" style="background-color: ${config.primary_button}; color: white;">
                    üè† Inicio
                  </button>
                  <button onclick="logout();" class="px-4 py-2 rounded-lg font-semibold transition bg-red-600 text-white">
                    üö™ Salir
                  </button>
                </div>
              </div>
            </div>
          </header>

          <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            ${userData.role === 'admin' ? `
              <div class="rounded-xl p-6 shadow-lg mb-6" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4 text-center">üíæ Gesti√≥n de Datos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <button onclick="exportData();" class="px-6 py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-2" style="background-color: ${config.secondary_button}; color: white;">
                    üì• Exportar Todos los Datos
                  </button>
                  <button onclick="document.getElementById('importFileInput').click();" class="px-6 py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-2" style="background-color: ${config.primary_button}; color: white;">
                    üì§ Importar Datos
                  </button>
                  <input type="file" id="importFileInput" accept=".json" onchange="importData(event);" style="display: none;">
                </div>
                <div class="p-4 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1);">
                  <p class="text-sm opacity-90 mb-2">
                    <strong>üì• Exportar:</strong> Descarga un archivo JSON con toda la informaci√≥n (usuarios, productos, pedidos).
                  </p>
                  <p class="text-sm opacity-90">
                    <strong>üì§ Importar:</strong> Carga un archivo JSON previamente exportado.
                  </p>
                </div>
              </div>

              <div class="rounded-xl p-6 shadow-lg mb-6" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4 text-center">üë• Estad√≠sticas de Usuarios</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="rounded-lg p-4 text-center" style="background-color: rgba(59, 130, 246, 0.2);">
                    <p class="text-3xl font-bold text-blue-400">${stats.totalUsers}</p>
                    <p class="mt-1 text-sm opacity-70">Usuarios Registrados</p>
                  </div>
                  <div class="rounded-lg p-4 text-center" style="background-color: rgba(16, 185, 129, 0.2);">
                    <p class="text-3xl font-bold text-green-400">${stats.onlineUsers}</p>
                    <p class="mt-1 text-sm opacity-70">Usuarios En L√≠nea</p>
                  </div>
                  <div class="rounded-lg p-4 text-center" style="background-color: rgba(245, 158, 11, 0.2);">
                    <p class="text-3xl font-bold text-orange-400">${stats.buyers}</p>
                    <p class="mt-1 text-sm opacity-70">Compradores</p>
                  </div>
                  <div class="rounded-lg p-4 text-center" style="background-color: rgba(168, 85, 247, 0.2);">
                    <p class="text-3xl font-bold text-purple-400">${stats.admins}</p>
                    <p class="mt-1 text-sm opacity-70">Administradores</p>
                  </div>
                </div>
              </div>
            ` : ''}

            <div class="grid grid-cols-2 md:grid-cols-${userData.role === 'admin' ? '5' : '4'} gap-4 mb-8">
              <div class="rounded-xl p-6 text-center shadow-lg" style="background-color: ${config.card_background};">
                <p class="text-4xl font-bold" style="color: ${config.primary_button};">${stats.total}</p>
                <p class="mt-2 opacity-70">Total Productos</p>
              </div>
              ${currentUser.role === 'admin' ? `
                <div class="rounded-xl p-6 text-center shadow-lg" style="background-color: ${config.card_background};">
                  <p class="text-4xl font-bold" style="color: ${config.secondary_button};">${stats.resellers}</p>
                  <p class="mt-2 opacity-70">Vendedores Activos</p>
                </div>
              ` : ''}
              <div class="rounded-xl p-6 text-center shadow-lg" style="background-color: ${config.card_background};">
                <p class="text-4xl font-bold text-yellow-500">${stats.pendingOrders}</p>
                <p class="mt-2 opacity-70">Pedidos Pendientes</p>
              </div>
              <div class="rounded-xl p-6 text-center shadow-lg" style="background-color: ${config.card_background};">
                <p class="text-4xl font-bold text-green-500">${stats.completedOrders}</p>
                <p class="mt-2 opacity-70">Pedidos Completados</p>
              </div>
              <div class="rounded-xl p-6 text-center shadow-lg" style="background-color: ${config.card_background};">
                <p class="text-4xl font-bold" style="color: ${config.secondary_button};">‚öîÔ∏è ${stats.items}</p>
                <p class="mt-2 opacity-70">Items</p>
              </div>
              <div class="rounded-xl p-6 text-center shadow-lg" style="background-color: ${config.card_background};">
                <p class="text-4xl font-bold" style="color: ${config.secondary_button};">ü¶Ö ${stats.wings}</p>
                <p class="mt-2 opacity-70">Alas</p>
              </div>
            </div>

            ${myOrders.length > 0 ? `
              <div class="rounded-xl p-6 shadow-lg mb-8" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4">üì¶ ${userData.role === 'admin' ? 'Todos los Pedidos' : 'Pedidos de Clientes'}</h2>
                <div class="space-y-4">
                  ${myOrders.map(order => {
                    const isPending = order.order_status === 'pending';
                    const isCompleted = order.order_status === 'completed';
                    return `
                      <div class="p-4 rounded-lg ${isPending ? 'border-2 border-yellow-500' : ''}" style="background-color: rgba(0,0,0,0.2);">
                        <div class="flex flex-col lg:flex-row justify-between items-start gap-4 mb-3">
                          <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                              <p class="font-bold text-lg">üì¶ Pedido #${order.id.substring(0, 8)}</p>
                              <span class="px-3 py-1 rounded-full text-xs font-semibold ${isCompleted ? 'bg-green-600' : 'bg-yellow-600'} text-white">
                                ${isCompleted ? '‚úÖ Completado' : '‚è≥ Pendiente'}
                              </span>
                            </div>
                            <p class="text-sm opacity-70">Cliente: ${order.buyer_username}</p>
                            <p class="text-sm opacity-70">Discord: ${order.buyer_discord}</p>
                            <p class="text-sm opacity-70">Fecha: ${new Date(order.created_at).toLocaleDateString()}</p>
                          </div>
                          ${isPending && userData.role === 'reseller' ? `
                            <button 
                              onclick="confirmOrder('${order.__backendId}', true);" 
                              ${order.seller_confirmed ? 'disabled' : ''}
                              class="px-6 py-3 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" 
                              style="background-color: ${config.secondary_button}; color: white;">
                              ${order.seller_confirmed ? '‚úÖ Ya Confirmaste' : '‚úÖ Confirmar Entrega'}
                            </button>
                          ` : ''}
                        </div>
                        <div class="p-3 rounded-lg mb-3" style="background-color: rgba(255,255,255,0.05);">
                          <p class="text-sm font-semibold mb-1">Productos:</p>
                          <p class="text-sm opacity-90">${order.items}</p>
                        </div>
                        <p class="text-xl font-bold mb-2" style="color: ${config.secondary_button};">
                          üí∞ Total: $${order.total.toFixed(2)} USDT
                        </p>
                        ${isPending ? `
                          <div class="p-3 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1);">
                            <p class="text-sm font-semibold mb-1">Estado de Confirmaci√≥n:</p>
                            <p class="text-xs">Vendedor: ${order.seller_confirmed ? '‚úÖ Confirmado' : '‚è≥ Pendiente'}</p>
                            <p class="text-xs">Comprador: ${order.buyer_confirmed ? '‚úÖ Confirmado' : '‚è≥ Pendiente'}</p>
                            ${currentUser.role === 'reseller' && !order.seller_confirmed ? `
                              <p class="text-xs mt-2 opacity-70">üí¨ Contacta al cliente: <span class="font-bold">${order.buyer_discord}</span></p>
                            ` : ''}
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            ${userData.role === 'reseller' && myReviews.length > 0 ? `
              <div class="rounded-xl p-6 shadow-lg mb-8" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4">‚≠ê Rese√±as de Clientes</h2>
                <div class="space-y-3">
                  ${myReviews.map(review => `
                    <div class="p-4 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                      <div class="flex justify-between items-start mb-2">
                        <div>
                          <p class="font-semibold">üë§ ${review.buyer_username}</p>
                          <p class="text-sm opacity-70">${new Date(review.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="text-xl">
                          ${renderStars(review.rating)}
                        </div>
                      </div>
                      ${review.review_text ? `
                        <p class="text-sm opacity-90 italic">"${review.review_text}"</p>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${userData.role === 'admin' && pendingResellers.length > 0 ? `
              <div class="rounded-xl p-6 shadow-lg mb-8" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4">‚è≥ Solicitudes Pendientes</h2>
                <div class="space-y-3">
                  ${pendingResellers.map(user => `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                      <div>
                        <p class="font-bold">üë§ ${user.username}</p>
                        <p class="text-sm opacity-70">üè™ ${user.shop_name}</p>
                        <p class="text-sm opacity-70">üí¨ ${user.discord_tag}</p>
                      </div>
                      <div class="flex gap-2">
                        <button onclick="approveReseller('${user.__backendId}', true);" class="px-4 py-2 rounded-lg font-semibold transition text-white" style="background-color: ${config.secondary_button};">
                          ‚úÖ Aprobar
                        </button>
                        <button onclick="approveReseller('${user.__backendId}', false);" class="px-4 py-2 rounded-lg font-semibold transition bg-red-600 text-white">
                          ‚ùå Rechazar
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${userData.role === 'admin' ? `
              <div class="rounded-xl p-6 shadow-lg mb-8" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4">üë• Gesti√≥n de Usuarios Activos</h2>
                
                <div class="mb-6">
                  <input 
                    type="text" 
                    id="userSearchInput"
                    placeholder="üîç Buscar usuario..."
                    oninput="filterUsers(this.value)"
                    class="w-full px-4 py-3 rounded-lg font-semibold"
                    style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); color: ${config.text_color};">
                </div>

                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="border-b" style="border-color: rgba(255,255,255,0.1);">
                        <th class="text-left py-3 px-4">Usuario</th>
                        <th class="text-left py-3 px-4">Discord</th>
                        <th class="text-left py-3 px-4">Rol Actual</th>
                        <th class="text-left py-3 px-4">Estado</th>
                        <th class="text-left py-3 px-4">Tienda</th>
                        <th class="text-left py-3 px-4">Productos</th>
                        <th class="text-left py-3 px-4">En L√≠nea</th>
                        <th class="text-left py-3 px-4">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableBody">
                      ${activeUsers.map(user => {
                        const userProductCount = allProducts.filter(p => p.seller_username === user.username).length;
                        const isOnline = onlineUsers.has(user.username);
                        return `
                          <tr class="user-row border-b hover:bg-opacity-50" data-username="${user.username.toLowerCase()}" style="border-color: rgba(255,255,255,0.05);">
                            <td class="py-3 px-4">
                              <button 
                                onclick="viewUserProfile('${user.__backendId}');"
                                class="font-semibold hover:underline"
                                style="color: ${config.primary_button};">
                                üë§ ${user.username}
                              </button>
                            </td>
                            <td class="py-3 px-4 text-xs opacity-70">üí¨ ${user.discord_tag || '-'}</td>
                            <td class="py-3 px-4">
                              <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                user.role === 'admin' ? 'bg-purple-600' : 
                                user.role === 'reseller' ? 'bg-blue-600' : 
                                'bg-green-600'
                              } text-white">
                                ${user.role === 'admin' ? 'üëë Admin' : user.role === 'reseller' ? 'üè™ Vendedor' : 'üõí Comprador'}
                              </span>
                            </td>
                            <td class="py-3 px-4">
                              <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                user.approved ? 'bg-green-600' : 'bg-yellow-600'
                              } text-white">
                                ${user.approved ? '‚úÖ' : '‚è≥'}
                              </span>
                            </td>
                            <td class="py-3 px-4 text-xs">${user.shop_name || '-'}</td>
                            <td class="py-3 px-4 text-center">${userProductCount}</td>
                            <td class="py-3 px-4 text-center">
                              <span class="text-xl">${isOnline ? 'üü¢' : '‚ö´'}</span>
                            </td>
                            <td class="py-3 px-4">
                              <div class="flex gap-2">
                                <select 
                                  onchange="if(this.value) changeUserRole('${user.__backendId}', this.value);" 
                                  class="px-2 py-1 rounded text-xs font-semibold"
                                  style="background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: ${config.text_color};">
                                  <option value="">Rol...</option>
                                  <option value="buyer" ${user.role === 'buyer' ? 'disabled' : ''}>üõí Comprador</option>
                                  <option value="reseller" ${user.role === 'reseller' ? 'disabled' : ''}>üè™ Vendedor</option>
                                  <option value="admin" ${user.role === 'admin' ? 'disabled' : ''}>üëë Admin</option>
                                </select>
                              </div>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}

            <div class="rounded-xl p-6 shadow-lg mb-8" style="background-color: ${config.card_background};">
              <h2 class="text-2xl font-bold mb-6">‚ûï Agregar Producto</h2>
              
              <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3);">
                <p class="text-center font-bold mb-2">üí∞ Recordatorio de Comisi√≥n</p>
                <p class="text-sm text-center opacity-90">La plataforma cobra un <span class="font-bold text-xl" style="color: ${config.secondary_button};">10%</span> de todas tus ventas completadas</p>
              </div>

              <form onsubmit="handleAddProduct(event);" class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" for="productName">Nombre del Producto</label>
                  <input type="text" id="productName" required class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2" for="productCategory">Categor√≠a</label>
                  <select id="productCategory" required class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                    <option value="items">‚öîÔ∏è Items</option>
                    <option value="jewels">üíé Joyas</option>
                    <option value="wings">ü¶Ö Alas</option>
                    <option value="sets">üõ°Ô∏è Sets</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2" for="productPrice">Precio (USDT)</label>
                  <input type="number" id="productPrice" step="0.01" min="0" required class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2" for="productStock">Stock</label>
                  <input type="number" id="productStock" min="0" required class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2" for="productDiscount">Descuento (%) - Opcional</label>
                  <input type="number" id="productDiscount" min="0" max="100" value="0" class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                  <p class="text-xs opacity-60 mt-1">0 = Sin descuento</p>
                </div>
                
                <div class="md:col-span-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="productOnSale" class="w-5 h-5 rounded">
                    <span class="font-semibold">üî• Marcar como Promoci√≥n (aparecer√° en categor√≠a Promociones)</span>
                  </label>
                </div>
                
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold mb-2" for="productDescription">Descripci√≥n</label>
                  <textarea id="productDescription" rows="3" required class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};"></textarea>
                </div>
                
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold mb-2" for="productImage">URL de Imagen (opcional)</label>
                  <input type="url" id="productImage" placeholder="https://..." class="w-full px-4 py-2 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                
                <div class="md:col-span-2">
                  <button type="submit" class="w-full py-3 rounded-lg font-bold text-lg transition" style="background-color: ${config.secondary_button}; color: white;">
                    ‚ûï Agregar Producto
                  </button>
                </div>
              </form>

              <div class="mt-6 p-5 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3);">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                  üì∏ ¬øC√≥mo subir im√°genes para tus productos?
                </h3>
                <div class="space-y-3 text-sm opacity-90">
                  <p><strong>Paso 1:</strong> Ve a <a href="https://imgur.com/upload" target="_blank" rel="noopener noreferrer" class="font-bold underline hover:opacity-80" style="color: ${config.primary_button};">Imgur.com/upload</a></p>
                  <p><strong>Paso 2:</strong> Haz clic en "Browse" o arrastra tu imagen</p>
                  <p><strong>Paso 3:</strong> Una vez subida, haz clic derecho en la imagen ‚Üí "Copiar direcci√≥n de imagen"</p>
                  <p><strong>Paso 4:</strong> Pega el link en el campo "URL de Imagen" arriba ‚¨ÜÔ∏è</p>
                  <div class="mt-3 p-3 rounded" style="background-color: rgba(16, 185, 129, 0.1);">
                    <p class="text-xs">üí° <strong>Tip:</strong> El link debe terminar en .jpg, .png o .gif. Si no, agrega ".jpg" al final del link de Imgur.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="rounded-xl p-6 shadow-lg" style="background-color: ${config.card_background};">
              <h2 class="text-2xl font-bold mb-6">üì¶ Mis Productos</h2>
              ${userProducts.length === 0 ? `
                <p class="text-center py-8 opacity-60">No tienes productos a√∫n</p>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b" style="border-color: rgba(255,255,255,0.1);">
                        <th class="text-left py-3 px-4">Producto</th>
                        ${currentUser.role === 'admin' ? '<th class="text-left py-3 px-4">Vendedor</th>' : ''}
                        <th class="text-left py-3 px-4">Categor√≠a</th>
                        <th class="text-left py-3 px-4">Precio</th>
                        <th class="text-left py-3 px-4">Descuento</th>
                        <th class="text-left py-3 px-4">Promo</th>
                        <th class="text-left py-3 px-4">Stock</th>
                        <th class="text-left py-3 px-4">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${userProducts.map(product => `
                        <tr class="border-b hover:bg-opacity-50" style="border-color: rgba(255,255,255,0.05);">
                          <td class="py-3 px-4 font-semibold">${product.name}</td>
                          ${currentUser.role === 'admin' ? `<td class="py-3 px-4 text-sm opacity-70">${product.seller_username}</td>` : ''}
                          <td class="py-3 px-4">${getCategoryIcon(product.category)} ${getCategoryName(product.category)}</td>
                          <td class="py-3 px-4">
                            ${product.discount > 0 ? `
                              <p class="text-xs line-through opacity-50">$${product.price.toFixed(2)}</p>
                              <p class="font-bold" style="color: ${config.secondary_button};">$${product.final_price.toFixed(2)} USDT</p>
                            ` : `
                              <p class="font-bold" style="color: ${config.secondary_button};">$${product.price.toFixed(2)} USDT</p>
                            `}
                          </td>
                          <td class="py-3 px-4">
                            ${product.discount > 0 ? `<span class="px-2 py-1 rounded-full text-xs font-bold bg-red-600 text-white">-${product.discount}%</span>` : '-'}
                          </td>
                          <td class="py-3 px-4 text-center">
                            ${product.on_sale ? 'üî•' : '-'}
                          </td>
                          <td class="py-3 px-4">${product.stock}</td>
                          <td class="py-3 px-4">
                            <button onclick="deleteProduct('${product.__backendId}');" class="px-3 py-1 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">
                              üóëÔ∏è
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          </main>
          <div id="modalContainer"></div>
        </div>
      `;
    }

    function renderModal() {
      const config = getConfig();

      if (showModal === 'login') {
        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { showModal = null; render(); }">
            <div class="rounded-xl shadow-2xl w-full max-w-md p-8" style="background-color: ${config.card_background}; color: ${config.text_color};" onclick="event.stopPropagation();">
              <h2 class="text-3xl font-bold mb-6 text-center">üîê Iniciar Sesi√≥n</h2>
              <form onsubmit="handleLogin(event);">
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="loginUsername">Usuario</label>
                  <input type="text" id="loginUsername" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-semibold mb-2" for="loginPassword">Contrase√±a</label>
                  <input type="password" id="loginPassword" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <button type="submit" class="w-full py-3 rounded-lg font-bold text-lg transition mb-3" style="background-color: ${config.primary_button}; color: white;">
                  Entrar
                </button>
                <button type="button" onclick="showModal = null; render();" class="w-full py-2 rounded-lg font-semibold transition" style="background-color: rgba(255,255,255,0.1); color: ${config.text_color};">
                  Cancelar
                </button>
              </form>
            </div>
          </div>
        `;
      }

      if (showModal === 'register') {
        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { showModal = null; render(); }">
            <div class="rounded-xl shadow-2xl w-full max-w-md p-8" style="background-color: ${config.card_background}; color: ${config.text_color};" onclick="event.stopPropagation();">
              <h2 class="text-3xl font-bold mb-6 text-center">üìù Registro de Comprador</h2>
              <form onsubmit="handleRegisterBuyer(event);">
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="buyerUsername">Usuario</label>
                  <input type="text" id="buyerUsername" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="buyerPassword">Contrase√±a</label>
                  <input type="password" id="buyerPassword" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-semibold mb-2" for="buyerDiscord">Discord Tag</label>
                  <input type="text" id="buyerDiscord" placeholder="Usuario#1234" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <button type="submit" class="w-full py-3 rounded-lg font-bold text-lg transition mb-3" style="background-color: ${config.secondary_button}; color: white;">
                  Registrarse
                </button>
                <button type="button" onclick="showModal = null; render();" class="w-full py-2 rounded-lg font-semibold transition" style="background-color: rgba(255,255,255,0.1); color: ${config.text_color};">
                  Cancelar
                </button>
              </form>
            </div>
          </div>
        `;
      }

      if (showModal === 'registerReseller') {
        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { showModal = null; render(); }">
            <div class="rounded-xl shadow-2xl w-full max-w-md p-8" style="background-color: ${config.card_background}; color: ${config.text_color};" onclick="event.stopPropagation();">
              <h2 class="text-3xl font-bold mb-6 text-center">üè™ Abrir Tienda</h2>
              <form onsubmit="handleRegisterReseller(event);">
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="resellerUsername">Usuario</label>
                  <input type="text" id="resellerUsername" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="resellerPassword">Contrase√±a</label>
                  <input type="password" id="resellerPassword" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="resellerShop">Nombre de Tienda</label>
                  <input type="text" id="resellerShop" placeholder="Mi Tienda √âpica" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-semibold mb-2" for="resellerDiscord">Discord Tag</label>
                  <input type="text" id="resellerDiscord" placeholder="Usuario#1234" required class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>
                <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1);">
                  <p class="text-sm opacity-80">
                    ‚ö†Ô∏è Tu solicitud ser√° revisada por un administrador antes de ser aprobada.
                  </p>
                </div>
                <button type="submit" class="w-full py-3 rounded-lg font-bold text-lg transition mb-3" style="background-color: ${config.primary_button}; color: white;">
                  Enviar Solicitud
                </button>
                <button type="button" onclick="showModal = null; render();" class="w-full py-2 rounded-lg font-semibold transition" style="background-color: rgba(255,255,255,0.1); color: ${config.text_color};">
                  Cancelar
                </button>
              </form>
            </div>
          </div>
        `;
      }

      if (showModal === 'importConfirm' && selectedOrder) {
        const importedData = selectedOrder;
        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
            <div class="rounded-xl shadow-2xl w-full max-w-md p-8" style="background-color: ${config.card_background}; color: ${config.text_color};">
              <h2 class="text-3xl font-bold mb-4 text-center">üì§ Confirmar Importaci√≥n</h2>
              
              <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3);">
                <p class="text-center font-bold mb-2">‚ö†Ô∏è ¬°Importante!</p>
                <p class="text-sm text-center opacity-90">Esto importar√° los datos del archivo JSON. Los datos duplicados ser√°n omitidos.</p>
              </div>

              <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                <p class="font-semibold mb-2">üìÑ Resumen del archivo:</p>
                <p class="text-sm">üë• Usuarios: ${importedData.users?.length || 0}</p>
                <p class="text-sm">üì¶ Productos: ${importedData.products?.length || 0}</p>
                <p class="text-sm">üõí Pedidos: ${importedData.orders?.length || 0}</p>
                <p class="text-sm">‚≠ê Rese√±as: ${importedData.reviews?.length || 0}</p>
                <p class="text-xs opacity-70 mt-2">üìÖ Exportado: ${new Date(importedData.exportDate).toLocaleString()}</p>
              </div>

              <button id="confirmImportBtn" onclick="confirmImport();" class="w-full py-3 rounded-lg font-bold text-lg transition mb-3" style="background-color: ${config.secondary_button}; color: white;">
                ‚úÖ Confirmar Importaci√≥n
              </button>
              
              <button type="button" onclick="showModal = null; selectedOrder = null; render();" class="w-full py-2 rounded-lg font-semibold transition" style="background-color: rgba(255,255,255,0.1); color: ${config.text_color};">
                Cancelar
              </button>
            </div>
          </div>
        `;
      }

      if (showModal === 'review' && selectedOrder && selectedOrder.order_status) {
        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
            <div class="rounded-xl shadow-2xl w-full max-w-md p-8" style="background-color: ${config.card_background}; color: ${config.text_color};">
              <h2 class="text-3xl font-bold mb-4 text-center">‚≠ê Calificar Pedido</h2>
              
              <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3);">
                <p class="text-center font-bold mb-2">‚ö†Ô∏è ¬°Calificaci√≥n Obligatoria!</p>
                <p class="text-sm text-center opacity-90">Debes calificar esta tienda para continuar usando el marketplace</p>
              </div>

              <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                <p class="font-semibold mb-1">üè™ Tienda: ${selectedOrder.seller_username}</p>
                <p class="text-sm opacity-70">üí∞ Total: $${selectedOrder.total.toFixed(2)} USDT</p>
                <p class="text-sm opacity-70">üì¶ Pedido #${selectedOrder.id.substring(0, 8)}</p>
              </div>

              <form onsubmit="handleSubmitReview(event);">
                <div class="mb-6">
                  <label class="block text-sm font-semibold mb-3 text-center">Calificaci√≥n *</label>
                  <div class="flex justify-center gap-2">
                    ${[1, 2, 3, 4, 5].map(star => `
                      <label class="cursor-pointer">
                        <input type="radio" name="rating" value="${star}" class="hidden" required>
                        <span class="star text-4xl hover:scale-110 transition" onclick="this.parentElement.querySelector('input').checked = true;">
                          ‚òÜ
                        </span>
                      </label>
                    `).join('')}
                  </div>
                </div>

                <div class="mb-6">
                  <label class="block text-sm font-semibold mb-2" for="reviewText">Comentario (opcional)</label>
                  <textarea id="reviewText" rows="4" placeholder="Comparte tu experiencia con esta tienda..." class="w-full px-4 py-3 rounded-lg" style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};"></textarea>
                </div>

                <button type="submit" class="w-full py-3 rounded-lg font-bold text-lg transition" style="background-color: ${config.secondary_button}; color: white;">
                  ‚≠ê Enviar Rese√±a
                </button>
              </form>
            </div>
          </div>
        `;
      }

      if (showModal === 'setupShop' && selectedOrder && !selectedOrder.order_status) {
        const user = selectedOrder;
        const isFromLogin = user.__backendId === currentUser?.__backendId;
        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
            <div class="rounded-xl shadow-2xl w-full max-w-md p-8" style="background-color: ${config.card_background}; color: ${config.text_color};">
              <h2 class="text-3xl font-bold mb-4 text-center">üè™ Configurar Tienda</h2>
              
              <div class="mb-6 p-4 rounded-lg" style="background-color: ${isFromLogin ? 'rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3)' : 'rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3)'};">
                <p class="text-center font-bold mb-2">${isFromLogin ? '‚ö†Ô∏è Configuraci√≥n Obligatoria' : 'üìã Informaci√≥n Requerida'}</p>
                <p class="text-sm text-center opacity-90">${isFromLogin ? 'Debes configurar tu tienda para poder acceder al marketplace' : `El usuario <span class="font-bold">${user.username}</span> necesita configurar su tienda para ser vendedor`}</p>
              </div>

              <form onsubmit="handleSetupShop(event);">
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2" for="setupShopName">Nombre de la Tienda *</label>
                  <input 
                    type="text" 
                    id="setupShopName" 
                    placeholder="Mi Tienda √âpica"
                    required 
                    class="w-full px-4 py-3 rounded-lg" 
                    style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>

                <div class="mb-6">
                  <label class="block text-sm font-semibold mb-2" for="setupDiscord">Discord Tag *</label>
                  <input 
                    type="text" 
                    id="setupDiscord" 
                    placeholder="Usuario#1234"
                    value="${user.discord_tag || ''}"
                    required 
                    class="w-full px-4 py-3 rounded-lg" 
                    style="background-color: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); color: ${config.text_color};">
                </div>

                <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(16, 185, 129, 0.1);">
                  <p class="text-sm opacity-80">
                    ‚úÖ Una vez configurada la tienda, ${isFromLogin ? 'podr√°s' : 'el usuario podr√°'} agregar productos y vender
                  </p>
                </div>

                <button type="submit" class="w-full py-3 rounded-lg font-bold text-lg transition mb-3" style="background-color: ${config.secondary_button}; color: white;">
                  üè™ Crear Tienda
                </button>
                
                ${!isFromLogin ? `
                  <button type="button" onclick="showModal = null; selectedOrder = null; render();" class="w-full py-2 rounded-lg font-semibold transition" style="background-color: rgba(255,255,255,0.1); color: ${config.text_color};">
                    Cancelar
                  </button>
                ` : ''}
              </form>
            </div>
          </div>
        `;
      }

      if (showModal === 'userProfile' && selectedOrder && !selectedOrder.order_status) {
        const user = selectedOrder;
        const userOrders = allOrders.filter(o => o.buyer_username === user.username || o.seller_username === user.username);
        const completedOrders = userOrders.filter(o => o.order_status === 'completed');
        const userProducts = allProducts.filter(p => p.seller_username === user.username);
        const userReviews = allReviews.filter(r => r.reviewed_seller === user.username);
        const rating = getSellerRating(user.username);
        const isOnline = onlineUsers.has(user.username);

        return `
          <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 overflow-y-auto" onclick="if(event.target === this) { showModal = null; selectedOrder = null; render(); }">
            <div class="rounded-xl shadow-2xl w-full max-w-4xl my-8 p-8" style="background-color: ${config.card_background}; color: ${config.text_color};" onclick="event.stopPropagation();">
              
              <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-4">
                  ${user.profile_picture ? `
                    <img src="${user.profile_picture}" alt="${user.username}" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500 shadow-lg" onerror="this.style.display='none'; this.parentElement.querySelector('.fallback-icon').style.display='flex';">
                    <div class="fallback-icon w-24 h-24 rounded-full items-center justify-center text-5xl border-4 border-blue-500 shadow-lg hidden" style="background-color: rgba(59, 130, 246, 0.2);">
                      üë§
                    </div>
                  ` : `
                    <div class="w-24 h-24 rounded-full flex items-center justify-center text-5xl border-4 border-blue-500 shadow-lg" style="background-color: rgba(59, 130, 246, 0.2);">
                      üë§
                    </div>
                  `}
                  <div>
                    <h2 class="text-3xl font-bold mb-2">
                      ${user.username}
                      <span class="text-xl ml-2">${isOnline ? 'üü¢ En L√≠nea' : '‚ö´ Desconectado'}</span>
                    </h2>
                    <div class="space-y-1">
                      <p class="opacity-70">üí¨ Discord: ${user.discord_tag || 'No especificado'}</p>
                      <p class="opacity-70">üìÖ Registrado: ${new Date(user.created_at).toLocaleDateString()}</p>
                      ${user.shop_name ? `<p class="opacity-70">üè™ Tienda: ${user.shop_name}</p>` : ''}
                      <p class="opacity-70">
                        üé≠ Rol: 
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                          user.role === 'admin' ? 'bg-purple-600' : 
                          user.role === 'reseller' ? 'bg-blue-600' : 
                          'bg-green-600'
                        } text-white ml-2">
                          ${user.role === 'admin' ? 'üëë Admin' : user.role === 'reseller' ? 'üè™ Vendedor' : 'üõí Comprador'}
                        </span>
                      </p>
                      ${rating.count > 0 ? `
                        <p class="text-lg mt-2">
                          ${renderStars(parseFloat(rating.average))} 
                          <span class="font-semibold">${rating.average}</span> 
                          <span class="text-sm opacity-70">(${rating.count} rese√±as)</span>
                        </p>
                      ` : ''}
                    </div>
                  </div>
                </div>
                <button onclick="showModal = null; selectedOrder = null; render();" class="text-3xl hover:scale-110 transition">
                  ‚ùå
                </button>
              </div>

              <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="rounded-lg p-4 text-center" style="background-color: rgba(59, 130, 246, 0.2);">
                  <p class="text-3xl font-bold text-blue-400">${userOrders.length}</p>
                  <p class="text-sm opacity-70">Pedidos Totales</p>
                </div>
                <div class="rounded-lg p-4 text-center" style="background-color: rgba(16, 185, 129, 0.2);">
                  <p class="text-3xl font-bold text-green-400">${completedOrders.length}</p>
                  <p class="text-sm opacity-70">Completados</p>
                </div>
                <div class="rounded-lg p-4 text-center" style="background-color: rgba(245, 158, 11, 0.2);">
                  <p class="text-3xl font-bold text-orange-400">${userProducts.length}</p>
                  <p class="text-sm opacity-70">Productos</p>
                </div>
              </div>

              ${completedOrders.length > 0 ? `
                <div class="mb-6">
                  <h3 class="text-2xl font-bold mb-4">üìä Historial de Pedidos Completados</h3>
                  <div class="max-h-96 overflow-y-auto rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                    <table class="w-full text-sm">
                      <thead class="sticky top-0" style="background-color: ${config.card_background};">
                        <tr class="border-b" style="border-color: rgba(255,255,255,0.2);">
                          <th class="text-left py-3 px-4">Pedido</th>
                          <th class="text-left py-3 px-4">Vendedor</th>
                          <th class="text-left py-3 px-4">Comprador</th>
                          <th class="text-left py-3 px-4">Total</th>
                          <th class="text-left py-3 px-4">Fecha</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${completedOrders.map(order => `
                          <tr class="border-b hover:bg-opacity-50" style="border-color: rgba(255,255,255,0.05);">
                            <td class="py-3 px-4 font-semibold">üì¶ #${order.id.substring(0, 8)}</td>
                            <td class="py-3 px-4">üè™ ${order.seller_username}</td>
                            <td class="py-3 px-4">üë§ ${order.buyer_username}</td>
                            <td class="py-3 px-4 font-bold" style="color: ${config.secondary_button};">$${order.total.toFixed(2)} USDT</td>
                            <td class="py-3 px-4 opacity-70">${new Date(order.created_at).toLocaleDateString()}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              ` : `
                <div class="mb-6 p-8 rounded-lg text-center" style="background-color: rgba(0,0,0,0.2);">
                  <p class="text-xl opacity-60">üì¶ Sin pedidos completados</p>
                </div>
              `}

              ${userReviews.length > 0 ? `
                <div class="mb-6">
                  <h3 class="text-2xl font-bold mb-4">‚≠ê Rese√±as Recibidas</h3>
                  <div class="space-y-3 max-h-64 overflow-y-auto">
                    ${userReviews.map(review => `
                      <div class="p-4 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                        <div class="flex justify-between items-start mb-2">
                          <div>
                            <p class="font-semibold">üë§ ${review.buyer_username}</p>
                            <p class="text-sm opacity-70">${new Date(review.created_at).toLocaleDateString()}</p>
                          </div>
                          <div class="text-xl">
                            ${renderStars(review.rating)}
                          </div>
                        </div>
                        ${review.review_text ? `
                          <p class="text-sm opacity-90 italic">"${review.review_text}"</p>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              <button 
                onclick="showModal = null; selectedOrder = null; render();" 
                class="w-full py-3 rounded-lg font-bold text-lg transition" 
                style="background-color: ${config.primary_button}; color: white;">
                ‚úÖ Cerrar Perfil
              </button>
            </div>
          </div>
        `;
      }
      return '';
    }

    init();
  </script>
 </body>
</html>

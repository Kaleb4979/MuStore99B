<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mu Online 99B Marketplace - V35 (Stock Funcional y Polling Corregido)</title>

  <script src="https://cdn.tailwindcss.com"></script>
 
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
 
  <style>
    /* ... (Estilos CSS sin cambios) ... */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
    }
    html {
      height: 100%;
    }

    .category-btn {
      transition: all 0.3s ease;
    }
    .category-btn:hover {
      transform: translateY(-2px);
    }

    .product-card {
      transition: all 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .shop-badge {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .shop-badge:hover {
      transform: scale(1.05);
      background-color: #4f46e5;
    }

    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
    }

    .rank-1 {
      border: 2px solid #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(0,0,0,0.4));
    }
    .rank-2 {
      border: 2px solid #C0C0C0;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
      background: linear-gradient(145deg, rgba(192,192,192,0.1), rgba(0,0,0,0.4));
    }
    .rank-3 {
      border: 2px solid #CD7F32;
      box-shadow: 0 0 10px rgba(205, 127, 50, 0.2);
      background: linear-gradient(145deg, rgba(205,127,50,0.1), rgba(0,0,0,0.4));
    }

    .live-indicator {
      height: 12px;
      width: 12px;
      background-color: #22c55e;
      border-radius: 50%;
      display: inline-block;
      margin-left: 8px;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }
   
    @keyframes bounceIn {
        0% { transform: scale(0.8); opacity: 0; }
        60% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); }
    }
    .animate-bounce-in {
        animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
   
    @view-transition { navigation: auto; }
   
    .chat-messages {
        height: 350px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .message-bubble {
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 18px;
        margin-bottom: 8px;
        word-wrap: break-word;
    }
    .message-self {
        background-color: #3b82f6;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }
    .message-other {
        background-color: #1e293b;
        color: #f1f5f9;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }
  </style>

  <script>
    // ---------------------------------------------------------
    // 1. CONFIGURACIÃ“N CRÃTICA (REEMPLAZAR ESTAS LÃNEAS)
    // ---------------------------------------------------------
    // *** ðŸš¨ VERIFICA TUS CREDENCIALES AQUÃ ðŸš¨ ***
    const BIN_ID = '691ddaa6ae596e708f6321c9'; 
    const SECRET_KEY = '$2a$10$eM.MLJKvj.vnFMVAoSsBEOUaXbJB3TjuYjYxB5N9I5bJOqr4z4doK'; 
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    const DB_KEY = 'mu_marketplace_db_v35_final'; 
    const SESSION_KEY = 'mu_session_user_v35_final';
   
    // ðŸ“¢ CONFIGURACIÃ“N SUPABASE (CHAT REALTIME)
    const SUPABASE_URL = 'https://ciysaobejtxfkpmbmswb.supabase.co'; 
    const SUPABASE_ANON_KEY = 'sb_publishable_ZVQXNGvJjurUNtqZNQrnPg_aw_wW9gY';
    const CHAT_TABLE_NAME = 'messages'; 
    
    // ðŸ”Š CONFIGURACIÃ“N DE SONIDOS (ASEGÃšRATE DE TENER ESTOS ARCHIVOS EN LA CARPETA 'sounds/')
    const SOUND_NEW_ORDER = 'sounds/new_order.mp3';
    const SOUND_NEW_MESSAGE = 'sounds/new_message.mp3';
    // ---------------------------------------------------------
   
    // 2. INICIALIZAR CLIENTE SUPABASE
    let supabase = null;
    if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.warn("Supabase no inicializado. Usando la simulaciÃ³n local de chat.");
    }
    // ---------------------------------------------------------

    // Base de datos simulada (solo para mantener la estructura, los datos reales vienen del BIN)
    window.mockDb = {
      data: [], 
      handler: null,
      notify() {} 
    };

    // SDK de ConfiguraciÃ³n Visual (sigue local, no necesita backend)
    window.elementSdk = {
      config: {},
      init: (options) => {
        window.elementSdk.config = options.defaultConfig;
        if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
      },
      setConfig: (newConfig) => {
        window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
      }
    };

    // ---------------------------------------------------------
    // SDK Base de Datos (ConexiÃ³n JSONBin) 
    // ---------------------------------------------------------
    window.dataSdk = {
        init: async (handler) => {
            window.mockDb.handler = handler;
            return window.dataSdk.read(); // Leer los datos al inicio
        },
       
        read: async () => {
            if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
                   console.error("JSONBin Config Error: BIN_ID o SECRET_KEY no configurados.");
                   const localData = localStorage.getItem(DB_KEY);
                   window.mockDb.data = localData ? JSON.parse(localData) : [];
                   window.mockDb.handler.onDataChanged(window.mockDb.data);
                   return { isOk: false };
            }

            try {
                // ðŸš¨ CORRECCIÃ“N 404: Usar /latest directamente en el fetch (ya que se usa la Master Key)
                const response = await fetch(`${JSONBIN_URL}/latest`, { 
                    method: 'GET',
                    headers: {
                        'X-Master-Key': SECRET_KEY 
                    }
                });

                if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const json = await response.json();
                const data = json.record || []; 
               
                localStorage.setItem(DB_KEY, JSON.stringify(data));
               
                window.mockDb.data = data;
                window.mockDb.handler.onDataChanged(data); 
                return { isOk: true };

            } catch (error) {
                console.error("JSONBin READ Error:", error);
                const localData = localStorage.getItem(DB_KEY);
                window.mockDb.data = localData ? JSON.parse(localData) : [];
                window.mockDb.handler.onDataChanged(window.mockDb.data);
                return { isOk: false };
            }
        },
       
        write: async (newData) => {
            if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
                   return { isOk: false };
            }
           
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT', 
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': SECRET_KEY
                    },
                    body: JSON.stringify(newData)
                });

                if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(`Error ${response.status}: ${errorText}`);
                }
               
                localStorage.setItem(DB_KEY, JSON.stringify(newData));
                window.mockDb.data = newData;
                // El Polling se encargarÃ¡ de notificar el cambio.
                return { isOk: true, item: null };

            } catch (error) {
                console.error("JSONBin WRITE Error:", error);
                showToast('âŒ Error de conexiÃ³n/escritura. Vuelve a intentarlo.');
                return { isOk: false };
            }
        },

        create: async (item) => {
            item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            const newData = [...window.mockDb.data, item];
            const result = await window.dataSdk.write(newData);
            return { isOk: result.isOk, item: item };
        },
       
        update: async (item) => {
            const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
            if (index === -1) {
                   console.error("No se encontrÃ³ el item para actualizar:", item);
                   return { isOk: false };
            }

            const newData = [...window.mockDb.data];
            newData[index] = {...item}; 
            const result = await window.dataSdk.write(newData);
            return { isOk: result.isOk, item: result.isOk ? newData[index] : null };
        },
       
        delete: async (item) => {
            const newData = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
            const result = await window.dataSdk.write(newData);
            return { isOk: result.isOk };
        }
    };
  </script>
 </head>
 <body>
  <div id="app" class="min-h-full"></div>
 
  <script>
    // ---------------------------------------------------------
    // 1. CONFIGURACIÃ“N Y CONSTANTES
    // ---------------------------------------------------------
    const defaultConfig = {
      site_title: "Mu Online 99B Marketplace",
      contact_info: "Contacto: Discord/WhatsApp",
      background_color: "#0f172a", 
      card_background: "#1e293b", 
      text_color: "#f1f5f9", 
      primary_button: "#3b82f6", 
      secondary_button: "#10b981", 
      font_family: "Inter",
      font_size: 16
    };

    let inactivityTimeout;
    const TIMEOUT_LIMIT = 5 * 60 * 1000; 
    
    let realtimePollingInterval;
    const POLLING_RATE = 10 * 1000; 

    // ---------------------------------------------------------
    // 2. ESTADO GLOBAL (VARIABLES EN MEMORIA)
    // ---------------------------------------------------------
    let currentUser = null;
    let currentView = 'catalog'; 
    let selectedCategory = 'all';
    let selectedShopFilter = null;
   
    let adminViewTarget = null; 
    let selectedProductToEdit = null; 
    let managedUser = null; 
    let selectedOrderToReject = null; 

    let allProducts = [];
    let allUsers = [];
    let allOrders = [];
    let allReviews = []; 
   
    let cart = JSON.parse(localStorage.getItem('mu_cart_v22') || '[]');
   
    let showModal = null; 
    let selectedOrder = null; 
   
    let chatTargetOrder = null; 
    let chatMessages = []; 
    let chatSubscription = null; 
   
    const CATEGORIES = [
      { id: 'all', name: 'Todos', icon: 'ðŸŽ®' },
      { id: 'promotions', name: 'Promociones', icon: 'ðŸ”¥' },
      { id: 'items', name: 'Items', icon: 'âš”ï¸' },
      { id: 'jewels', name: 'Joyas', icon: 'ðŸ’Ž' },
      { id: 'wings', name: 'Alas', icon: 'ðŸ¦…' },
      { id: 'sets', name: 'Sets', icon: 'ðŸ›¡ï¸' }
    ];

    const ADMIN_CREDENTIALS = {
      username: 'Kaleb',
      password: 'Kaleb.2021',
      discord_tag: 'KalebAdmin#9999'
    };
   
    let onlineUsers = new Set();
    let userActivityTimeout = null;
    
    let knownPendingOrderIds = new Set();
    
    // Bandera para saber si estamos editando un formulario de Admin
    let isEditingAdminForm = false; 

    // ---------------------------------------------------------
    // 3. SDK DE CHAT (INTEGRACIÃ“N SUPABASE REALTIME) 
    // ---------------------------------------------------------
    window.chatSdk = {
       
        getMessages: async (orderId) => {
            if (!supabase) return [];
            const { data, error } = await supabase
                .from(CHAT_TABLE_NAME)
                .select('id, sender, content, created_at, order_id')
                .eq('order_id', orderId)
                .order('created_at', { ascending: true });
            if (error) {
                console.error('Error al obtener mensajes de Supabase:', error);
                return [];
            }
            return data.map(msg => ({ ...msg, timestamp: msg.created_at }));
        },

        sendMessage: async (orderId, sender, content) => {
            if (!supabase || !content.trim()) return;
            const { error } = await supabase
                .from(CHAT_TABLE_NAME)
                .insert([{ order_id: orderId, sender: sender, content: content }]);
            if (error) {
                console.error('Error al enviar mensaje a Supabase:', error);
                showToast('âŒ Error al enviar mensaje.');
            }
        },

        handleRealtimeChange: (payload) => {
            if (payload.eventType === 'INSERT' && payload.new) {
                const newMessage = {
                    id: payload.new.id,
                    sender: payload.new.sender,
                    content: payload.new.content,
                    timestamp: payload.new.created_at || new Date().toISOString()
                };
               
                if (!chatMessages.find(msg => msg.id === newMessage.id)) {
                    chatMessages.push(newMessage);
                    
                    if (currentUser && newMessage.sender !== currentUser.username) {
                        playSound(SOUND_NEW_MESSAGE);
                    }
                    
                    if (showModal === 'chat') {
                        const messagesContainer = document.querySelector('.chat-messages');
                        if (messagesContainer) {
                            renderChatMessages(messagesContainer);
                        }
                    }
                }
            }
        },

        subscribeToOrder: async (orderId) => {
            if (!supabase) { showToast('âš ï¸ Supabase no configurado.'); return; }
            window.chatSdk.unsubscribe();
            chatMessages = await window.chatSdk.getMessages(orderId);
           
            chatSubscription = supabase
                .channel(`chat-order-${orderId}`)
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: CHAT_TABLE_NAME, filter: `order_id=eq.${orderId}` },
                    window.chatSdk.handleRealtimeChange
                )
                .subscribe();
           
            showToast('ðŸ’¬ Chat Realtime iniciado.');
        },

        unsubscribe: () => {
            if (chatSubscription) {
                supabase.removeChannel(chatSubscription);
                chatSubscription = null;
            }
        }
    };
    // ---------------------------------------------------------


    // ---------------------------------------------------------
    // 4. MANEJADOR DE DATOS (JSONBin) 
    // ---------------------------------------------------------
    const dataHandler = {
      onDataChanged(data) {
        const userRole = currentUser?.role;
        const currentUsername = currentUser?.username;
        const previousPendingOrderIds = new Set(allOrders.filter(o => 
            o.order_status === 'pending' && (userRole === 'admin' || o.seller_username === currentUsername)
        ).map(o => o.__backendId));

        const newProducts = data.filter(item => item.type === 'product') || [];
        const newUsers = data.filter(item => item.type === 'user') || [];
        const newOrders = data.filter(item => item.type === 'order') || [];
        const newReviews = data.filter(item => item.type === 'review') || []; 
        const activityRecords = data.filter(item => item.type === 'activity') || [];
        
        allProducts = newProducts;
        allUsers = newUsers;
        allOrders = newOrders;
        allReviews = newReviews;
       
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        onlineUsers = new Set(
          activityRecords
            .filter(a => a.type === 'activity' && new Date(a.last_activity).getTime() > fiveMinutesAgo)
            .map(a => a.username)
        );
       
        // DetecciÃ³n de NUEVOS PEDIDOS PENDIENTES
        if (currentUser && (currentUser.role === 'reseller' || currentUser.role === 'admin')) {
            const newPendingOrders = newOrders.filter(o => 
                o.order_status === 'pending' && 
                !previousPendingOrderIds.has(o.__backendId) &&
                (currentUser.role === 'admin' || o.seller_username === currentUser.username)
            );
            
            if (newPendingOrders.length > 0) {
                showToast(`ðŸ”” Â¡${newPendingOrders.length} Nuevo(s) Pedido(s) Pendiente(s)!`);
                playSound(SOUND_NEW_ORDER);
            }
        }
       
        validateCart();
        
        // CRÃTICO: ModificaciÃ³n de la llamada a render()
        if (currentView === 'admin') {
            // Si estamos en la vista admin, solo actualiza las secciones dinÃ¡micas (pedidos y usuarios)
            if (!isEditingAdminForm) {
                renderAdminSections(); 
            } else {
                 console.log("Polling: AdministraciÃ³n no repintada para evitar pÃ©rdida de foco.");
            }
        } else {
            // Si estamos en el catÃ¡logo o carrito, renderiza normalmente.
            render();
        }
      }
    };
    
    // ---------------------------------------------------------
    // 5. INICIALIZACIÃ“N Y FUNCIONES DE AUDIO
    // ---------------------------------------------------------
    
    function playSound(path) {
        try {
            const audio = new Audio(path);
            audio.play().catch(error => {
                console.warn("Error de reproducciÃ³n de audio (Autoplay bloqueado):", error.message);
            });
        } catch (e) {
            console.error("Error al crear objeto de Audio:", e);
        }
    }

    function startRealtimePolling() {
        if (realtimePollingInterval) {
            clearInterval(realtimePollingInterval);
        }
        
        realtimePollingInterval = setInterval(() => {
            console.log("Polling: Buscando actualizaciones del BIN...");
            window.dataSdk.read();
        }, POLLING_RATE);
        
        console.log(`Realtime Polling iniciado a cada ${POLLING_RATE / 1000} segundos.`);
    }

    async function init() {
      const storedUser = localStorage.getItem(SESSION_KEY);
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showToast(`ðŸ‘‹ SesiÃ³n restaurada: ${currentUser.username}`);
      }

      setupAutoLogout();

      await window.dataSdk.init(dataHandler);
     
      startRealtimePolling();
     
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
            document.body.style.color = config.text_color || defaultConfig.text_color;
            const baseSize = config.font_size || defaultConfig.font_size;
            document.body.style.fontSize = `${baseSize}px`;
            render();
          }
        });
      }
     
      if (currentUser) updateUserActivity();
      render();
    }

    function setupAutoLogout() {
        const events = ['mousemove', 'keypress', 'click', 'scroll'];
        events.forEach(event => document.addEventListener(event, resetTimer));
        resetTimer();
    }

    function resetTimer() {
        if (currentUser) {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => logout(true), TIMEOUT_LIMIT);
        }
    }
    
    // ---------------------------------------------------------
    // 6. FUNCIONES DE USUARIO, ADMIN, CARRITO, ETC.
    // ---------------------------------------------------------
    
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      const user = allUsers.find(u => u.username === username && u.password === password);

      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        currentUser = { username, role: 'admin', __backendId: 'admin', discord_tag: ADMIN_CREDENTIALS.discord_tag };
        localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
        showModal = null;
        currentView = 'admin';
        showToast('Bienvenido Admin Supremo (Modo Dios Activo)');
        await updateUserActivity();
        render();
        return;
      }
      
      if (user) {
        if (user.status === 'banned') {
            showToast('ðŸš« Tu cuenta ha sido suspendida/baneada.');
            return;
        }

        if (user.role === 'reseller' && !user.approved) {
          showToast('Tu cuenta aÃºn no ha sido aprobada por el Admin.');
          return;
        }
       
        currentUser = { 
          username: user.username,
          role: user.role, 
          shop_name: user.shop_name,
          discord_tag: user.discord_tag || 'No Informado', 
          __backendId: user.__backendId
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
       
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
          selectedOrder = user;
          showModal = 'setupShop';
          showToast('Por favor configura tu tienda para continuar');
          render();
          return;
        }
       
        showModal = null;
        
        if (user.role === 'reseller' || user.role === 'admin') {
          currentView = 'admin';
          if (user.role === 'admin') {
              showToast(`âœ… Bienvenido Admin: ${username}`);
          } else {
              showToast(`Bienvenido Reseller: ${username}`);
          }
        } else {
            showToast(`Bienvenido ${username}`);
        }
       
        await updateUserActivity();
        render();
      } else {
        showToast('Usuario o contraseÃ±a incorrectos');
      }
    }

    async function handleRegisterBuyer(e) {
      e.preventDefault();
      const username = document.getElementById('buyerUsername').value.trim();
      const password = document.getElementById('buyerPassword').value;
      const discord = document.getElementById('buyerDiscord').value.trim();

      if (allUsers.find(u => u.username === username)) {
        showToast('El usuario ya existe');
        return;
      }
      if (allUsers.find(u => u.discord_tag === discord)) {
        showToast('El Discord ya estÃ¡ registrado.');
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username,
        password,
        discord_tag: discord || 'No Informado', 
        profile_picture: '',
        role: 'buyer',
        approved: true,
        status: 'active',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);
      if (result.isOk) {
        showToast('Registro exitoso! Ahora puedes iniciar sesiÃ³n');
        showModal = 'login';
        await window.dataSdk.read();
        render();
      } else {
        showToast('Error al registrar usuario');
      }
    }

    async function handleRegisterReseller(e) {
      e.preventDefault();
      const username = document.getElementById('resellerUsername').value.trim();
      const password = document.getElementById('resellerPassword').value;
      const discord = document.getElementById('resellerDiscord').value.trim();
      const shopName = document.getElementById('resellerShop').value.trim();

      if (allUsers.find(u => u.username === username)) {
        showToast('El usuario ya existe');
        return;
      }
      if (allUsers.find(u => u.discord_tag === discord)) {
        showToast('El Discord ya estÃ¡ registrado.');
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username,
        password,
        discord_tag: discord || 'No Informado', 
        shop_name: shopName,
        profile_picture: '',
        role: 'reseller',
        approved: false,
        status: 'pending',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);
      if (result.isOk) {
        showToast('Solicitud enviada! Espera aprobaciÃ³n del admin.');
        showModal = null;
        await window.dataSdk.read();
        render();
      } else {
        showToast('Error al enviar solicitud');
      }
    }

    async function updateUserActivity() {
      if (!currentUser) return;
     
      const activityRecords = window.mockDb.data.filter(item => item.type === 'activity');
      const existingActivity = activityRecords.find(a => a.username === currentUser.username);
     
      const activityData = {
        id: 'activity_' + currentUser.username,
        type: 'activity',
        username: currentUser.username,
        last_activity: new Date().toISOString()
      };
     
      if (existingActivity) {
           const updatedActivity = {...existingActivity, last_activity: new Date().toISOString()};
           await window.dataSdk.update(updatedActivity);
      } else {
           await window.dataSdk.create(activityData);
      }
     
      await window.dataSdk.read();
     
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      userActivityTimeout = setTimeout(updateUserActivity, 3 * 60 * 1000);
    }

    function logout(auto = false) {
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      clearTimeout(inactivityTimeout);
      if (realtimePollingInterval) clearInterval(realtimePollingInterval);
      
      currentUser = null;
      localStorage.removeItem(SESSION_KEY);
      currentView = 'catalog';
      cart = [];
      localStorage.setItem('mu_cart_v22', '[]');
      selectedShopFilter = null;
      adminViewTarget = null;
      managedUser = null;
      window.chatSdk.unsubscribe();
      
      startRealtimePolling(); 
      
      showToast(auto ? 'ðŸ’¤ SesiÃ³n cerrada por inactividad' : 'SesiÃ³n cerrada');
      render();
    }

    async function handleSetupShop(e) {
      e.preventDefault();
      const user = selectedOrder;
      if(!user) return;
     
      const setupShopNameInput = document.getElementById('setupShopName');
      const setupDiscordInput = document.getElementById('setupDiscord');
     
      if (!setupShopNameInput || !setupDiscordInput) {
          showToast('Error: Campos de formulario no encontrados.');
          return;
      }
     
      const shopName = setupShopNameInput.value.trim();
      const discord = setupDiscordInput.value.trim();
     
      if(allUsers.find(u => u.discord_tag === discord && u.__backendId !== user.__backendId)) {
          showToast('Este Discord ya estÃ¡ en uso por otro usuario.');
          return;
      }
     
      const updatedUser = {
          ...user,
          shop_name: shopName,
          discord_tag: discord || 'No Informado',
          approved: true, 
          status: 'active' 
      };
     
      const result = await window.dataSdk.update(updatedUser);
     
      if (result.isOk) {
          if(currentUser && user.__backendId === currentUser.__backendId) {
              currentUser = updatedUser;
              localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
              currentView = 'admin';
          } 
         
          showModal = null;
          selectedOrder = null;
          showToast('âœ… ConfiguraciÃ³n de tienda guardada. Tienda Activada.');
          await window.dataSdk.read();
          render(); 
      } else {
          showToast('Error al actualizar la configuraciÃ³n de la tienda.');
      }
    }

    async function handleUpdateUserRole(e) {
        e.preventDefault();
        if (!managedUser || currentUser.role !== 'admin') {
            showToast('Acceso denegado. Solo el Admin Supremo puede cambiar roles.');
            return;
        }

        const newRole = document.getElementById('manageUserRole').value;

        if (managedUser.username === ADMIN_CREDENTIALS.username && managedUser.__backendId === 'admin') {
            showToast('ðŸš« No puedes cambiar el rol del Admin Supremo Hardcodeado.');
            return;
        }

        let updatedUser = {
            ...managedUser,
            role: newRole,
            approved: (newRole === 'admin' || newRole === 'buyer'),
            status: (newRole === 'admin' || newRole === 'buyer') ? 'active' : 'pending',
        };
        
        if (newRole === 'buyer') {
            updatedUser.shop_name = '';
            updatedUser.approved = true;
        }
        
        if (newRole === 'admin') {
             updatedUser.status = 'active';
             updatedUser.approved = true;
        }

        const result = await window.dataSdk.update(updatedUser);

        if (result.isOk) {
            showToast(`âœ… Rol de ${managedUser.username} cambiado a ${newRole.toUpperCase()}. Â¡Debe iniciar sesiÃ³n de nuevo para aplicar los privilegios!`);
            managedUser = result.item;
            if(currentUser && currentUser.__backendId === managedUser.__backendId) {
                logout();
            }
        } else {
            showToast('âŒ Error al actualizar el rol.');
        }
        await window.dataSdk.read();
        render();
    }
    
    function openProductManagement(username) {
        if (currentUser.role === 'admin' && currentUser.username !== username) {
            enterShopManagement(username);
        } else if (currentUser.username === username && (currentUser.role === 'reseller' || currentUser.role === 'admin')) {
            currentView = 'admin';
            render();
        } else {
            showToast('No tienes permisos para gestionar esta tienda.');
        }
        showModal = null;
    }
   
    // FunciÃ³n de ayuda para manejar el estado de ediciÃ³n (para evitar el refresco)
    function setEditingState(isEditing) {
        isEditingAdminForm = isEditing;
    }
   
    async function handleAddProduct(e) {
      e.preventDefault();
      setEditingState(true); // Activar estado de ediciÃ³n

      if (allProducts.length >= 999) {
        showToast('LÃ­mite de productos alcanzado');
        setEditingState(false);
        return;
      }

      const ownerUsername = adminViewTarget ? adminViewTarget : currentUser.username;
      const ownerData = allUsers.find(u => u.username === ownerUsername) || currentUser;

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      let imageUrl = document.getElementById('productImage').value.trim();
      if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        imageUrl = imageUrl + '.jpg';
      }

      const discount = parseInt(document.getElementById('productDiscount').value) || 0;
      const onSale = document.getElementById('productOnSale').checked;
      const originalPrice = parseFloat(document.getElementById('productPrice').value);
      const finalPrice = discount > 0 ? originalPrice * (1 - discount / 100) : originalPrice;

      const productData = {
        id: Date.now().toString(),
        type: 'product',
        name: document.getElementById('productName').value.trim(),
        category: document.getElementById('productCategory').value,
        price: originalPrice,
        final_price: parseFloat(finalPrice.toFixed(2)),
        discount: discount,
        on_sale: onSale,
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value.trim(),
        image_url: imageUrl,
        seller_username: ownerUsername,
        seller_shop_name: ownerData.shop_name || ownerUsername,
        seller_discord: ownerData.discord_tag || 'No Informado',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(productData);
      if (result.isOk) {
        showToast('Producto agregado exitosamente');
        e.target.reset();
      } else {
        showToast('Error al agregar producto');
      }

      await window.dataSdk.read();
      setEditingState(false); // Desactivar estado de ediciÃ³n

      btn.disabled = false;
      btn.innerHTML = 'Publicar Ahora';
    }

    function openEditModal(backendId) {
        const product = allProducts.find(p => p.__backendId === backendId);
        if (!product) return;
        selectedProductToEdit = product;
        showModal = 'editProduct';
        setEditingState(true); // Activar estado de ediciÃ³n
        render();
    }

    async function handleUpdateProduct(e) {
        e.preventDefault();
        setEditingState(true); // Activar estado de ediciÃ³n
        if (!selectedProductToEdit) return;

        const price = parseFloat(document.getElementById('editPrice').value);
        const discount = parseInt(document.getElementById('editDiscount').value) || 0;
       
        let imageUrl = document.getElementById('editImage').value.trim();
        if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
            imageUrl += '.jpg';
        }
       
        const finalPrice = discount > 0 ? price * (1 - discount / 100) : price;

        const updatedProduct = {
            ...selectedProductToEdit,
            name: document.getElementById('editName').value.trim(),
            stock: parseInt(document.getElementById('editStock').value),
            price: price,
            discount: discount,
            final_price: parseFloat(finalPrice.toFixed(2)),
            description: document.getElementById('editDescription').value.trim(),
            image_url: imageUrl,
            on_sale: document.getElementById('editOnSale').checked
        };

        const result = await window.dataSdk.update(updatedProduct);
       
        if (result.isOk) {
            showToast('âœ… Producto actualizado correctamente');
            showModal = null;
            selectedProductToEdit = null;
        } else {
            showToast('Error al actualizar producto');
        }
        
        await window.dataSdk.read();
        setEditingState(false); // Desactivar estado de ediciÃ³n
    }

    async function deleteProduct(backendId) {
      if(!confirm("Â¿EstÃ¡s seguro de borrar este producto?")) return;
      setEditingState(true); // Activar estado de ediciÃ³n
     
      const product = allProducts.find(p => p.__backendId === backendId);
      if (!product) { setEditingState(false); return; }
     
      const result = await window.dataSdk.delete(product); 
      if (result.isOk) {
        showToast('Producto eliminado');
      } else {
        showToast('Error al eliminar producto');
      }
      
      await window.dataSdk.read();
      setEditingState(false); // Desactivar estado de ediciÃ³n
    }

    function openManageUserModal(username) {
        managedUser = allUsers.find(u => u.username === username);
        if (!managedUser) {
            showToast('Usuario no encontrado.');
            return;
        }
        showModal = 'manageUser';
        render();
    }
   
    async function clearCompletedOrdersLog() {
        if (!currentUser || currentUser.role !== 'admin') {
            showToast('Acceso denegado.');
            return;
        }
       
        if (!confirm("âš ï¸ Â¡ADVERTENCIA CRÃTICA!\n\nEsta acciÃ³n eliminarÃ¡ PERMANENTEMENTE TODOS los pedidos con estado 'COMPLETADO' (Log HistÃ³rico). Â¿EstÃ¡s seguro de continuar?")) {
            return;
        }
       
        showToast('Limpiando log de pedidos completados...');
       
        const ordersToDelete = allOrders.filter(o => o.order_status === 'completed');
       
        const newDbData = window.mockDb.data.filter(item => 
            item.type !== 'order' || item.order_status === 'pending'
        );
       
        const result = await window.dataSdk.write(newDbData);
       
        if (result.isOk) {
            showToast(`âœ… Log HistÃ³rico de ${ordersToDelete.length} pedidos eliminado exitosamente.`);
            await window.dataSdk.read();
        } else {
            showToast('âŒ Error al eliminar el log histÃ³rico. Verifica el BIN.');
        }
    }
   
    async function approveUser(backendId) {
        const user = allUsers.find(u => u.__backendId === backendId);
        if (!user) {
            showToast('âŒ Usuario no encontrado o ID no vÃ¡lido.');
            return;
        }
       
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
            selectedOrder = user;
            showModal = 'setupShop';
            showToast('El vendedor necesita completar la configuraciÃ³n de su tienda antes de la activaciÃ³n final.');
            render();
            return;
        }
       
        const updatedUser = { ...user, status: 'active', approved: true };
        const result = await window.dataSdk.update(updatedUser);
        if (result.isOk) {
            showToast('âœ… Usuario ACEPTADO y activado');
        } else {
            showToast('âŒ Error al actualizar usuario. Verifica el estado del BIN.');
        }
        showModal = null;
        await window.dataSdk.read();
    }

    async function rejectUser(backendId) {
        deleteUserAccount(backendId);
    }

    async function banUser(backendId) {
        const user = allUsers.find(u => u.__backendId === backendId);
        if (!user) return;
        let updatedUser;
        if(user.status === 'banned') {
            updatedUser = {...user, status: 'active', approved: true};
            await window.dataSdk.update(updatedUser);
            showToast('Usuario desbaneado (activo)');
        } else {
            updatedUser = {...user, status: 'banned', approved: false};
            await window.dataSdk.update(updatedUser);
            showToast('ðŸš« Usuario BANEADO exitosamente');
        }
        showModal = null;
        await window.dataSdk.read();
    }

    async function deleteUserAccount(backendId) {
        if(!confirm("âš ï¸ Â¡ADVERTENCIA DE SEGURIDAD!\n\nÂ¿EstÃ¡s COMPLETAMENTE SEGURO de eliminar este usuario?\nEsta acciÃ³n borrarÃ¡ su cuenta y TODOS sus productos.")) return;
       
        const user = allUsers.find(u => u.__backendId === backendId);
        if (!user) return;

        if(user.role === 'reseller') {
            const userProducts = allProducts.filter(p => p.seller_username === user.username);
            for(const p of userProducts) {
                await window.dataSdk.delete(p);
            }
        }
        const result = await window.dataSdk.delete(user);
        if (result.isOk) showToast('ðŸ—‘ï¸ Cuenta eliminada correctamente');
        showModal = null;
        await window.dataSdk.read();
    }
   
    function enterShopManagement(targetUsername) {
        adminViewTarget = targetUsername;
        showToast(`ðŸ‘ï¸ Gestionando tienda de: ${targetUsername}`);
        showModal = null;
        currentView = 'admin';
        render();
    }
   
    function exitShopManagement() {
        adminViewTarget = null;
        showToast('ðŸ”™ Volviendo a vista global');
        render();
    }
   
    async function loadAdminView() {
        showToast('ðŸ”„ Sincronizando datos remotos (Polling forzado)...');
        await window.dataSdk.read(); 
        currentView = 'admin';
        render();
    }

    function updateCartStorage() {
        localStorage.setItem('mu_cart_v22', JSON.stringify(cart));
    }

    function validateCart() {
        if (cart.length === 0) return;
        let cartModified = false;
       
        const newCart = cart.filter(cartItem => {
            const correspondingProduct = allProducts.find(p => p.__backendId === cartItem.__backendId);
           
            if (!correspondingProduct) {
                showToast(`âŒ El item "${cartItem.name}" ha sido eliminado del catÃ¡logo.`);
                cartModified = true;
                return false; 
            }
           
            if (cartItem.quantity > correspondingProduct.stock) {
                cartItem.quantity = correspondingProduct.stock;
                cartModified = true;
                if (cartItem.quantity === 0) return false;
                showToast(`âš ï¸ Stock de "${cartItem.name}" limitado a ${cartItem.quantity}.`);
            }
           
            if (cartItem.price !== correspondingProduct.price || cartItem.final_price !== correspondingProduct.final_price) {
                cartItem.price = correspondingProduct.price;
                cartItem.final_price = correspondingProduct.final_price;
                cartItem.name = correspondingProduct.name;
                cartModified = true;
            }
            return true;
        });
       
        if (cartModified) {
            cart = newCart;
            updateCartStorage();
        }
    }

    function addToCart(backendId) {
      if (!currentUser) {
        showToast('Inicia sesiÃ³n para agregar al carrito');
        showModal = 'login';
        render();
        return;
      }

      const product = allProducts.find(p => p.__backendId === backendId);
      if (!product || product.stock <= 0) {
        showToast('Producto sin stock');
        return;
      }

      const existing = cart.find(item => item.__backendId === backendId);
      if (existing) {
        if (existing.quantity < product.stock) {
          existing.quantity++;
          showToast('Cantidad actualizada');
        } else {
          showToast('No hay mÃ¡s stock disponible');
        }
      } else {
        cart.push({ ...product, quantity: 1 });
        showToast('Agregado al carrito');
      }
      updateCartStorage();
      render();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartStorage();
      render();
    }

    function filterByShop(shopName) {
        selectedShopFilter = shopName;
        selectedCategory = 'all'; 
        showToast(`ðŸ›’ Viendo tienda: ${shopName}`);
        render();
    }

    function clearShopFilter() {
        selectedShopFilter = null;
        render();
    }

    async function createOrder() {
      if (cart.length === 0) return;
      validateCart(); 
      if (cart.length === 0) return;

      const ordersBySeller = {};
      cart.forEach(item => {
        if (!ordersBySeller[item.seller_username]) {
          ordersBySeller[item.seller_username] = {
            seller: item.seller_username,
            discord: item.seller_discord,
            items: [],
            total: 0
          };
        }
        const itemPrice = item.discount > 0 ? item.final_price : item.price;
        ordersBySeller[item.seller_username].items.push(item);
        ordersBySeller[item.seller_username].total += itemPrice * item.quantity;
      });

      let allOk = true;
      for (const sellerUsername in ordersBySeller) {
        const orderInfo = ordersBySeller[sellerUsername];
        const itemsDesc = orderInfo.items.map(item => {
          return `${item.name} x${item.quantity} ($${(item.final_price * item.quantity).toFixed(2)})`;
        }).join(' | ');

        const itemsData = JSON.stringify(orderInfo.items.map(item => ({
          backendId: item.__backendId,
          name: item.name,
          quantity: item.quantity
        })));

        const buyerDiscord = currentUser.discord_tag || 'No Informado';
        const sellerDiscord = orderInfo.discord || 'No Informado';

        const orderData = {
          id: Date.now().toString() + '_' + sellerUsername,
          type: 'order',
          buyer_username: currentUser.username,
          buyer_discord: buyerDiscord, 
          seller_username: sellerUsername,
          seller_discord: sellerDiscord,
          items: itemsDesc,
          items_data: itemsData,
          total: parseFloat(orderInfo.total.toFixed(2)),
          order_status: 'pending',
          seller_confirmed: false,
          buyer_confirmed: false,
          needs_review: false, 
          rejection_reason: null, 
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.create(orderData);
        if (!result.isOk) {
          allOk = false;
        } else {
            const notificationData = {
                id: 'ntf_' + Date.now(), 
                type: 'activity',
                username: sellerUsername, 
                message: `Â¡NUEVO PEDIDO de ${currentUser.username}!`,
                dismissed: false, 
                created_at: new Date().toISOString()
            };
            await window.dataSdk.create(notificationData);
        }
      }

      if (!allOk) {
          showToast('Error al crear uno o mÃ¡s pedidos');
          return;
      }

      showToast('Pedido(s) creado(s) exitosamente! Esperando confirmaciÃ³n del vendedor.');
      cart = [];
      updateCartStorage();
      currentView = 'orders';
      
      await window.dataSdk.read();
      
      render();
    }

    function openRejectModal(orderId) {
        selectedOrderToReject = allOrders.find(o => o.__backendId === orderId);
        if (selectedOrderToReject) {
            showModal = 'rejectOrder';
            render();
        } else {
            showToast('Pedido no encontrado.');
        }
    }
    
    async function handleRejectOrder(e) {
        e.preventDefault();
        if (!selectedOrderToReject) return;
        
        const reason = document.getElementById('rejectReason').value.trim();
        if (reason.length < 5) {
            showToast('Debes ingresar un motivo de rechazo de al menos 5 caracteres.');
            return;
        }
        
        const updatedOrder = {
            ...selectedOrderToReject,
            order_status: 'rejected',
            rejection_reason: reason,
            seller_confirmed: false, 
            buyer_confirmed: false,
            needs_review: false,
            updated_at: new Date().toISOString()
        };

        const result = await window.dataSdk.update(updatedOrder);

        if (result.isOk) {
            showToast(`âŒ Pedido ${updatedOrder.id} rechazado. Comprador notificado.`);
             // NotificaciÃ³n para el comprador sobre el rechazo
            const notificationData = {
                id: 'ntf_rej_' + Date.now(), 
                type: 'activity',
                username: updatedOrder.buyer_username, 
                message: `âŒ Tu pedido ${updatedOrder.id} ha sido rechazado: ${reason.substring(0, 30)}...`,
                dismissed: false, 
                created_at: new Date().toISOString()
            };
            await window.dataSdk.create(notificationData);
            
            showModal = null;
            selectedOrderToReject = null;
        } else {
            showToast('Error al rechazar el pedido.');
        }

        await window.dataSdk.read();
    }


    async function confirmOrder(backendId, isSeller) {
      const order = allOrders.find(o => o.__backendId === backendId);
      if (!order) return;

      let updatedOrder = {...order};

      if (isSeller) {
        updatedOrder.seller_confirmed = true;
        showToast('Vendedor confirma entrega. Â¡Ahora el comprador debe confirmar recepciÃ³n!');
      } else {
        if (!order.seller_confirmed) {
            showToast('âš ï¸ Error: El vendedor aÃºn no ha marcado el pedido como entregado. Esto es obligatorio para confirmar la recepciÃ³n.');
            return;
        }
        updatedOrder.buyer_confirmed = true;
      }

      const result = await window.dataSdk.update(updatedOrder); 
     
      if (result.isOk) {
          if (result.item.seller_confirmed && result.item.buyer_confirmed && result.item.order_status !== 'completed') {
              
              const completedOrder = {...result.item, order_status: 'completed', needs_review: true};
              
              // ðŸš¨ CORRECCIÃ“N CRÃTICA: Descontar stock aquÃ­
              try {
                const itemsData = JSON.parse(completedOrder.items_data);
                
                for (const item of itemsData) {
                  const product = allProducts.find(p => p.__backendId === item.backendId);
                  if (product) {
                    const updatedProduct = {...product, stock: Math.max(0, product.stock - item.quantity)};
                    // Se usa await para asegurar la actualizaciÃ³n de cada producto
                    const updateProductResult = await window.dataSdk.update(updatedProduct); 
                    if (!updateProductResult.isOk) {
                        console.error(`Fallo al actualizar stock de: ${product.name}`);
                    }
                  }
                }
                
                // Actualizar la orden como finalizada
                await window.dataSdk.update(completedOrder); 
                
                showToast('âœ… Â¡Pedido completado y Stock actualizado! Tienda entra en el Ranking.');
                
                await window.dataSdk.read(); 

              } catch (e) { 
                console.error("Error al procesar stock o actualizar orden final:", e);
                showToast("Error crÃ­tico al finalizar la orden. Stock no actualizado.");
              }
          } else if (result.item.buyer_confirmed) {
               showToast('âœ… RecepciÃ³n de items confirmada. Esperando finalizaciÃ³n de la venta.');
          } 
      }
      
      await window.dataSdk.read();
      render();
    }

    function getShopRating(username) {
        const reviews = allReviews.filter(r => r.reviewed_seller === username);
        const avg = reviews.length ? (reviews.reduce((a,b)=>a+b.rating,0)/reviews.length).toFixed(1) : 0;
        return { rating: parseFloat(avg), reviewCount: reviews.length };
    }

    function getStarHtml(rating) {
        const fullStars = Math.floor(rating);
        let html = '';
        for (let i = 0; i < fullStars; i++) {
            html += 'â­';
        }
        return html || (rating > 0 ? 'N/A' : 'Sin calificar'); 
    }

    async function handleSubmitReview(e) {
        e.preventDefault();
        if (!selectedOrder) return;
       
        const rating = parseInt(document.getElementById('reviewRating').value);
        const comment = document.getElementById('reviewComment').value.trim();
       
        if (rating < 1 || rating > 5) {
            showToast('La calificaciÃ³n debe ser entre 1 y 5.');
            return;
        }
       
        const reviewData = {
            id: Date.now().toString(),
            type: 'review',
            reviewed_order: selectedOrder.__backendId,
            reviewed_seller: selectedOrder.seller_username,
            reviewer: currentUser.username,
            rating: rating,
            comment: comment,
            created_at: new Date().toISOString()
        };
       
        const reviewResult = await window.dataSdk.create(reviewData);
       
        if (reviewResult.isOk) {
            const updatedOrder = {...selectedOrder, needs_review: false};
            await window.dataSdk.update(updatedOrder);
           
            showToast('âœ… Â¡ReseÃ±a enviada! Gracias por tu feedback.');
            showModal = null;
            selectedOrder = null;
        } else {
            showToast('âŒ Error al enviar la reseÃ±a.');
        }
        
        await window.dataSdk.read();
    }
   
    async function openChatModal(orderId) {
        const order = allOrders.find(o => o.__backendId === orderId);
        if (!order) return;
       
        chatTargetOrder = order;
        showModal = 'chat';
        render();
       
        await window.chatSdk.subscribeToOrder(orderId);
       
        setTimeout(() => {
             const messagesContainer = document.querySelector('.chat-messages');
             if (messagesContainer) {
                 renderChatMessages(messagesContainer);
                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
             }
        }, 50);
    }
   
    function closeChatModal() {
        window.chatSdk.unsubscribe();
        showModal = null;
        chatTargetOrder = null;
        chatMessages = [];
        render();
    }
   
    function handleChatMessageSend(e) {
        e.preventDefault();
        if (!chatTargetOrder || !currentUser) return;
       
        const input = document.getElementById('chatInput');
        const content = input.value;
        if (!content.trim()) return;
       
        window.chatSdk.sendMessage(chatTargetOrder.__backendId, currentUser.username, content);
        input.value = '';
       
        setTimeout(() => {
             const messagesContainer = document.querySelector('.chat-messages');
             if (messagesContainer) {
                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
             }
        }, 50);
    }

    function renderChatMessages(container) {
        if (!container) return;
       
        const messagesHtml = chatMessages.map(msg => {
            const isSelf = msg.sender === currentUser.username;
            const time = new Date(msg.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            return `
                <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
                    <div class="message-bubble ${isSelf ? 'message-self' : 'message-other'}">
                        <div class="font-bold text-xs ${isSelf ? '' : 'text-blue-300'} mb-1">${isSelf ? 'TÃº' : msg.sender}</div>
                        <div>${msg.content}</div>
                        <div class="text-right text-[10px] opacity-60 mt-1">${time}</div>
                    </div>
                </div>
            `;
        }).join('');
       
        container.innerHTML = messagesHtml;
        container.scrollTop = container.scrollHeight;
    }

    function getTopShops() {
      const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
      const shopsStats = resellers.map(seller => {
        const { rating, reviewCount } = getShopRating(seller.username);
        const sales = allOrders.filter(o => o.seller_username === seller.username && o.order_status === 'completed').length;
       
        return { 
            ...seller, 
            salesCount: sales,
            rating: rating,
            reviewCount: reviewCount
        }; 
      });
      return shopsStats.filter(s => s.salesCount > 0)
          .sort((a, b) => b.salesCount - a.salesCount).slice(0, 3); 
    }
   
    function getSellerSalesMap() {
        const salesMap = {};
        allOrders.forEach(order => {
            if (order.order_status === 'completed' && order.seller_username) {
                salesMap[order.seller_username] = (salesMap[order.seller_username] || 0) + 1;
            }
        });
        return salesMap;
    }

    function getCategoryIcon(id) {
      const cat = CATEGORIES.find(c => c.id === id);
      return cat ? cat.icon : 'ðŸ“¦';
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white animate-bounce bg-blue-600';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getConfig() {
      const configItem = window.mockDb.data.find(item => item.type === 'config');
      if (configItem) return configItem.config;
     
      return window.elementSdk ? window.elementSdk.config : defaultConfig;
    }
    
    // ðŸš¨ CRÃTICO: FunciÃ³n de renderizado para las secciones dinÃ¡micas del Admin
    function renderAdminSections() {
        if (currentView !== 'admin' || isEditingAdminForm) return;

        const viewingAs = adminViewTarget || currentUser.username;

        const containerStats = document.getElementById('admin-stats-container');
        const containerOrders = document.getElementById('admin-orders-log');
        const containerPending = document.getElementById('admin-pending-orders-content');
        const containerInventory = document.getElementById('admin-inventory-list-content');
        const containerUsers = document.getElementById('admin-user-panel');
        
        // Re-renderizar solo las secciones que no contienen formularios de ediciÃ³n/creaciÃ³n
        if (containerStats) containerStats.innerHTML = renderAdminStats(viewingAs);
        if (containerOrders) containerOrders.innerHTML = renderAdminLog();
        if (containerPending) containerPending.innerHTML = renderAdminPendingOrders();
        if (containerInventory) containerInventory.innerHTML = renderAdminInventoryList();
        if (containerUsers) containerUsers.innerHTML = renderAdminGlobalUserPanel();
    }

    function render() {
      const app = document.getElementById('app');
      const config = getConfig();
      document.body.style.backgroundColor = config.background_color;
      document.body.style.color = config.text_color;

      let content = '';
      if (currentView === 'catalog') content = renderCatalog();
      else if (currentView === 'cart') content = renderCart();
      else if (currentView === 'orders') content = renderOrders();
      else if (currentView === 'admin') content = renderAdmin();

      // NOTA: Si currentView es 'admin', render() solo carga la estructura inicial.
      app.innerHTML = content;

      const modalContainer = document.getElementById('modalContainer');
      const modalHTML = showModal ? renderModal() : '';
     
      if (modalContainer) {
           modalContainer.innerHTML = modalHTML;
      } else {
           const d = document.createElement('div'); 
           d.id = 'modalContainer';
           document.body.appendChild(d);
           d.innerHTML = modalHTML;
      }
      
      // Si la vista es admin, llama a la funciÃ³n de secciones dinÃ¡micas para cargar el contenido
      if (currentView === 'admin') {
          renderAdminSections();
      }
    }

    function renderCatalog() {
      const config = getConfig();
     
      let filteredProducts = allProducts;
     
      let shopStats = null;
     
      if (selectedShopFilter) {
          filteredProducts = allProducts.filter(p => p.seller_shop_name === selectedShopFilter);
         
          const shopOwner = allUsers.find(u => u.shop_name === selectedShopFilter);
          if (shopOwner) {
              const sales = allOrders.filter(o => o.seller_username === shopOwner.username && o.order_status === 'completed').length;
              const { rating, reviewCount } = getShopRating(shopOwner.username);
              shopStats = { owner: shopOwner, salesCount: sales, rating, reviewCount };
          }
      } else {
          filteredProducts = selectedCategory === 'all' 
            ? allProducts 
            : selectedCategory === 'promotions'
            ? allProducts.filter(p => p.on_sale === true)
            : allProducts.filter(p => p.category === selectedCategory);
      }

      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const topShops = getTopShops(); 

      return `
        <div class="min-h-full pb-20">
          <header class="shadow-lg sticky top-0 z-40 bg-slate-800 border-b border-slate-700 p-4">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                  <h1 class="text-2xl font-bold text-blue-400 tracking-tight">MU MARKET <span class="text-white text-xs bg-blue-600 px-1 rounded">V35</span></h1>
                  <p class="text-xs mt-1 opacity-60">${config.contact_info}</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center items-center">
                  ${currentUser ? `
                    <button onclick="currentView='cart'; render();" class="relative px-4 py-2 rounded-lg font-bold transition bg-slate-700 hover:bg-slate-600 text-sm border border-slate-600">
                      ðŸ›’ Carrito ${cartCount > 0 ? `<span class="cart-badge">${cartCount}</span>` : ''}
                    </button>
                    <button onclick="currentView='orders'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-slate-700 hover:bg-slate-600 text-sm border border-slate-600">
                      ðŸ“¦ Mis Pedidos
                    </button>
                    ${currentUser.role !== 'buyer' ? `
                      <button onclick="loadAdminView();" class="px-4 py-2 rounded-lg font-bold transition border border-blue-500 bg-slate-800 text-blue-400 text-sm hover:bg-blue-900/30">
                        âš™ï¸ Panel Tienda
                      </button>
                    ` : ''}
                    <button onclick="logout();" class="px-4 py-2 rounded-lg font-bold transition bg-red-600 hover:bg-red-500 text-white text-sm">
                      ðŸšª
                    </button>
                  ` : `
                    <button onclick="showModal='register'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-green-600 hover:bg-green-500 text-white text-sm shadow-lg">
                      Crear Cuenta
                    </button>
                    <button onclick="showModal='registerReseller'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-purple-600 hover:bg-purple-500 text-white text-sm shadow-lg">
                      Vender
                    </button>
                    <button onclick="showModal='login'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-blue-600 hover:bg-blue-500 text-white text-sm shadow-lg">
                      Iniciar SesiÃ³n
                    </button>
                  `}
                </div>
            </div>
          </header>

          ${!selectedShopFilter && topShops.length > 0 ? `
            <div class="max-w-7xl mx-auto px-4 py-6">
              <div class="mb-4 text-center">
                <h2 class="text-2xl font-bold text-yellow-400 mb-1">ðŸ† TOP VENDEDORES POR VENTAS</h2>
                <p class="text-xs opacity-60">Basado en Pedidos Completados</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                ${topShops.map((shop, index) => `
                  <div class="top-shop-card rank-${index+1} rounded-xl p-6 text-center bg-slate-800">
                    <div class="text-4xl mb-2">${index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}</div>
                    <h3 class="font-bold text-xl mb-1 shop-badge px-2 py-1 rounded inline-block hover:bg-white/10" onclick="filterByShop('${shop.shop_name}')">${shop.shop_name}</h3>
                    <p class="text-sm opacity-70 mb-3">ðŸ‘¤ ${shop.username}</p>
                   
                    <div class="flex justify-center mb-3 bg-slate-900/50 p-2 rounded-lg">
                        <div class="text-center px-4">
                          <p class="text-xl font-bold text-green-400">${shop.salesCount}</p>
                          <p class="text-xs opacity-70 uppercase">Ventas</p>
                        </div>
                        <div class="border-l border-slate-700/50 mx-2"></div>
                        <div class="text-center px-4">
                          <p class="text-xl font-bold text-yellow-400">${getStarHtml(shop.rating)}</p>
                          <p class="text-xs opacity-70 uppercase">(${shop.reviewCount} Reviews)</p>
                        </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="max-w-7xl mx-auto px-4 py-6">
            ${selectedShopFilter ? `
                <div class="bg-blue-900/30 border border-blue-500 p-4 rounded-lg mb-6 shadow-lg">
                    <div class="flex items-center justify-between border-b border-blue-800/50 pb-3 mb-3">
                        <h2 class="text-2xl font-bold text-blue-300">ðŸª Tienda: ${selectedShopFilter}</h2>
                        <button onclick="clearShopFilter()" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded font-bold text-sm shadow transition transform hover:scale-105">
                            Ver Todas las Tiendas
                        </button>
                    </div>
                   
                    ${shopStats ? `
                        <div class="flex justify-around text-center py-2 bg-slate-900/50 rounded-lg border border-slate-700">
                            <div class="px-3">
                                <p class="text-xl font-bold text-green-400">${shopStats.salesCount}</p>
                                <p class="text-xs opacity-70">Ventas Totales</p>
                            </div>
                            <div class="border-l border-slate-700/50 mx-2"></div>
                             <div class="px-3">
                                <p class="text-xl font-bold text-yellow-400">${getStarHtml(shopStats.rating)}</p>
                                <p class="text-xs opacity-70">(${shopStats.reviewCount} Reviews)</p>
                            </div>
                        </div>
                    ` : `<p class="text-center text-sm opacity-60 py-2">Cargando estadÃ­sticas o tienda sin datos aÃºn.</p>`}
                   
                </div>
            ` : `
                <div class="flex flex-wrap gap-3 justify-center">
                  ${CATEGORIES.map(cat => `
                    <button 
                      onclick="selectedCategory='${cat.id}'; render();" 
                      class="category-btn px-6 py-3 rounded-lg font-bold shadow-md border border-transparent ${selectedCategory === cat.id ? 'bg-blue-600 ring-2 ring-blue-400 border-blue-300' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">
                      ${cat.icon} ${cat.name}
                    </button>
                  `).join('')}
                </div>
            `}
          </div>

          <main class="max-w-7xl mx-auto px-4 pb-12">
            ${filteredProducts.length === 0 ? `
              <div class="text-center py-20 bg-slate-800/50 rounded-xl border border-slate-700 border-dashed">
                <p class="text-3xl opacity-40">ðŸ“¦</p>
                <p class="text-xl opacity-60 mt-2">No hay productos disponibles en esta tienda/categorÃ­a.</p>
              </div>
            ` : `
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                ${filteredProducts.map(product => {
                  return `
                    <div class="product-card rounded-xl shadow-lg overflow-hidden ${product.on_sale ? 'ring-2 ring-red-500' : 'border border-slate-700'} bg-slate-800 relative group">
                      ${product.on_sale ? `
                        <div class="absolute top-2 right-2 z-10">
                          <span class="px-2 py-1 rounded text-xs font-bold bg-red-600 text-white animate-pulse shadow-lg">
                            OFERTA
                          </span>
                        </div>
                      ` : ''}
                      
                      <div class="h-48 bg-slate-900 flex items-center justify-center text-6xl relative overflow-hidden">
                        ${product.image_url ? `
                          <img src="${product.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none';">
                        ` : getCategoryIcon(product.category)}
                      </div>

                      <div class="p-4 relative">
                        <div class="flex justify-center -mt-8 mb-3 relative z-20">
                            <button onclick="filterByShop('${product.seller_shop_name}')" class="shop-badge bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-blue-400 tracking-wide">
                              ðŸª ${product.seller_shop_name}
                            </button>
                        </div>

                        <h3 class="font-bold mb-1 truncate text-center text-lg">${product.name}</h3>
                       
                        <div class="text-center mb-3">
                          <span class="text-xs font-bold px-2 py-1 rounded ${product.stock < 5 ? 'bg-red-900/50 text-red-400 animate-pulse border border-red-500/50' : 'bg-slate-700 text-slate-400'}">
                              ðŸ“¦ Stock: ${product.stock}
                          </span>
                        </div>

                        <div class="flex items-center justify-between mt-2 border-t border-slate-700 pt-3">
                          <div>
                            ${product.discount > 0 ? `
                              <p class="text-xs line-through opacity-50">$${product.price}</p>
                              <p class="font-bold text-green-400 text-lg">$${product.final_price.toFixed(2)}</p>
                            ` : `
                              <p class="font-bold text-green-400 text-lg">$${product.price.toFixed(2)}</p>
                            `}
                          </div>
                          <button 
                            onclick="addToCart('${product.__backendId}')" 
                            ${product.stock <= 0 ? 'disabled' : ''}
                            class="px-4 py-2 rounded text-sm font-bold bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white shadow transition transform active:scale-95">
                            ${product.stock > 0 ? 'COMPRAR' : 'AGOTADO'}
                          </button>
                        </div>
                      </div>
                    </div>
                  `}).join('')}
              </div>
            `}
          </main>
         
        </div>
      `;
    }

    function renderCart() {
      const config = getConfig();
      const total = cart.reduce((sum, item) => {
        const itemPrice = item.discount > 0 ? item.final_price : item.price;
        return sum + (itemPrice * item.quantity);
      }, 0);

      return `
        <div class="min-h-full bg-slate-900 text-slate-100 p-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-blue-400 flex items-center gap-3">
                    ðŸ›’ Tu Carrito de Compras
                </h2>
               
                ${cart.length === 0 ? `
                    <div class="bg-slate-800 p-10 rounded-xl border border-slate-700 text-center shadow-lg">
                        <p class="text-4xl mb-4">ðŸ˜¢</p>
                        <p class="text-xl font-bold mb-2">Tu carrito estÃ¡ vacÃ­o</p>
                        <p class="text-slate-400 mb-6">Â¡Explora el catÃ¡logo y encuentra los mejores items!</p>
                        <button onclick="currentView='catalog'; render();" class="bg-blue-600 px-6 py-3 rounded-lg font-bold hover:bg-blue-500 shadow transition">
                            Volver al CatÃ¡logo
                        </button>
                    </div>
                ` : `
                    <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl mb-6">
                        <div class="p-4 bg-slate-900/50 border-b border-slate-700 font-bold text-slate-400 grid grid-cols-12 gap-4 text-sm uppercase tracking-wider">
                            <div class="col-span-6">Producto</div>
                            <div class="col-span-2 text-center">Precio</div>
                            <div class="col-span-2 text-center">Cantidad</div>
                            <div class="col-span-2 text-right">Total</div>
                        </div>
                       
                        ${cart.map((item, index) => `
                            <div class="p-4 border-b border-slate-700 grid grid-cols-12 gap-4 items-center hover:bg-slate-700/20 transition">
                                <div class="col-span-6 flex items-center gap-4">
                                    <div class="h-12 w-12 bg-slate-900 rounded border border-slate-600 flex items-center justify-center text-xl shrink-0">
                                        ${getCategoryIcon(item.category)}
                                    </div>
                                    <div class="overflow-hidden">
                                        <div class="font-bold truncate">${item.name}</div>
                                        <div class="text-xs text-blue-400">Tienda: ${item.seller_shop_name}</div>
                                    </div>
                                </div>
                                <div class="col-span-2 text-center font-mono text-sm">
                                    $${item.final_price.toFixed(2)}
                                </div>
                                <div class="col-span-2 text-center font-mono text-sm">
                                    x${item.quantity}
                                </div>
                                <div class="col-span-2 text-right flex items-center justify-end gap-3">
                                    <span class="font-bold text-green-400">$${(item.final_price * item.quantity).toFixed(2)}</span>
                                    <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-400 bg-red-900/20 hover:bg-red-900/40 h-8 w-8 rounded flex items-center justify-center transition">
                                        âœ•
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex flex-col md:flex-row justify-end items-center gap-6 bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                        <div class="text-right">
                            <p class="text-sm text-slate-400 uppercase">Total a Pagar</p>
                            <p class="text-4xl font-bold text-green-400">$${total.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg font-bold transition border border-slate-600">
                                Seguir Viendo
                            </button>
                            <button onclick="createOrder()" class="bg-green-600 hover:bg-green-500 px-8 py-3 rounded-lg font-bold text-white shadow-lg transform hover:scale-105 transition flex items-center gap-2">
                                âœ… CONFIRMAR COMPRA
                            </button>
                        </div>
                    </div>
                `}
            </div>
        </div>`;
    }

    function renderOrders() {
        const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username).reverse();
        const isSeller = currentUser.role !== 'buyer';
       
        return `
        <div class="min-h-full bg-slate-900 text-slate-100 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-blue-400">ðŸ“¦ Mis Pedidos</h2>
                    <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded font-bold text-sm border border-slate-600">
                        Volver al CatÃ¡logo
                    </button>
                </div>

                ${myOrders.length === 0 ? `
                    <div class="text-center py-12 opacity-50 border-2 border-dashed border-slate-700 rounded-xl">
                        <p>No has realizado ninguna compra todavÃ­a.</p>
                    </div>
                ` : ''}

                ${myOrders.map((o, index) => {
                    let statusText, statusClass;

                    if (o.order_status === 'completed') {
                        statusText = o.needs_review ? 'Completado (Pendiente de ReseÃ±a)' : 'Completado';
                        statusClass = o.needs_review ? 'bg-red-900 text-red-200 border border-red-700 animate-pulse' : 'bg-green-900 text-green-200 border border-green-700';
                    } else if (o.order_status === 'rejected') {
                        statusText = 'RECHAZADO';
                        statusClass = 'bg-red-700 text-white border border-red-500';
                    } else if (o.seller_confirmed) {
                        statusText = 'Pendiente de tu ConfirmaciÃ³n';
                        statusClass = 'bg-orange-900 text-orange-200 border border-orange-700 animate-pulse';
                    } else {
                        statusText = 'Esperando Entrega del Vendedor';
                        statusClass = 'bg-yellow-900 text-yellow-200 border border-yellow-700 animate-pulse';
                    }

                    return `
                    <div class="bg-slate-800 p-6 rounded-xl mb-6 border-l-4 shadow-lg transition hover:bg-slate-800/80 ${o.order_status==='completed'?'border-green-500':o.order_status==='rejected'?'border-red-500':o.seller_confirmed?'border-orange-500':'border-yellow-500'}">
                        <div class="flex justify-between items-start border-b border-slate-700 pb-4 mb-4">
                            <div>
                                <span class="font-bold text-xl text-white">PEDIDO #${myOrders.length - index}</span>
                                <div class="text-xs text-slate-500 font-mono mt-1">ID: ${o.id}</div>
                            </div>
                            <span class="px-3 py-1 rounded text-sm font-bold uppercase tracking-wider ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                       
                        ${o.order_status === 'rejected' ? `
                            <div class="bg-red-900/30 p-4 rounded-lg border border-red-700 mb-4">
                                <p class="text-sm font-bold text-red-400 mb-1">Motivo del Rechazo:</p>
                                <p class="text-sm text-white">${o.rejection_reason || 'Motivo no especificado.'}</p>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Datos del Vendedor</p>
                                <p class="text-lg font-bold text-white flex items-center gap-2">
                                    ðŸ‘¤ ${o.seller_username}
                                </p>
                                <div class="mt-2 inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded border border-purple-500/30 font-mono text-sm">
                                    ðŸ“± Discord: ${o.seller_discord}
                                </div>
                            </div>
                             <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Detalle de Items</p>
                                <p class="text-sm font-mono text-slate-300 leading-relaxed">${o.items}</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-between items-center pt-2 gap-4">
                           
                            ${o.order_status !== 'rejected' ? `
                                <button onclick="openChatModal('${o.__backendId}')" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95 text-sm">
                                    ðŸ’¬ CHAT con Vendedor
                                </button>
                            ` : `
                                <div class="text-xs text-slate-500">Puedes volver a realizar el pedido.</div>
                            `}
                           
                            <div class="text-2xl font-bold text-white flex-1 text-right">
                                Total: <span class="text-green-400">$${o.total.toFixed(2)}</span>
                            </div>

                            ${o.order_status === 'completed' ? `
                                ${o.needs_review ? `
                                    <button onclick="selectedOrder = allOrders.find(ord => ord.__backendId === '${o.__backendId}'); showModal='review'; render();" class="w-full sm:w-auto bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform hover:scale-105">
                                        â­ DEJAR RESEÃ‘A
                                    </button>
                                ` : `
                                    <div class="flex items-center gap-2 text-green-400 font-bold bg-green-900/20 px-4 py-2 rounded-lg border border-green-900/50">
                                        <span>âœ… Pedido Finalizado</span>
                                    </div>
                                `}
                            ` : o.order_status === 'rejected' ? `
                                <button onclick="currentView='catalog'; clearShopFilter(); render();" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95">
                                    ðŸ›’ Buscar Alternativa
                                </button>
                            ` : `
                                ${o.seller_confirmed ? `
                                    <button onclick="confirmOrder('${o.__backendId}', false)" ${o.buyer_confirmed ? 'disabled' : ''} 
                                        class="w-full sm:w-auto bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95">
                                        âœ… CONFIRMAR QUE RECIBÃ LOS ITEMS
                                    </button>
                                ` : `
                                    <button disabled class="w-full sm:w-auto bg-yellow-700/50 px-6 py-3 rounded-lg font-bold text-white disabled:opacity-100 disabled:cursor-wait">
                                        â³ Esperando que el Vendedor Entregue/Confirme
                                    </button>
                                `}
                            `}
                        </div>
                    </div>
                    `}).join('')}
            </div>
        </div>`;
    }
    
    // --- NUEVAS FUNCIONES PARA RENDERIZAR PARTES PEQUEÃ‘AS DEL ADMIN ---
    
    function renderAdminStats(viewingAs) {
      const viewingUser = allUsers.find(u => u.username === viewingAs) || currentUser;
      const myProducts = allProducts.filter(p => p.seller_username === viewingAs);
      const myOrders = allOrders.filter(o => o.seller_username === viewingAs);
      const pending = myOrders.filter(o => o.order_status === 'pending').length;

      const stats = {
          total: myProducts.length,
          sales: myOrders.filter(o => o.order_status === 'completed').length,
          online: onlineUsers.size
      };

      return `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-purple-500 shadow-lg">
                <div class="text-3xl font-bold text-white">${stats.total}</div>
                <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Productos Activos</div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-green-500 shadow-lg">
                <div class="text-3xl font-bold text-green-400">${stats.sales}</div>
                <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Ventas Completadas</div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-yellow-500 shadow-lg">
                <div class="text-3xl font-bold text-yellow-400">${pending}</div>
                <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Pedidos Pendientes</div>
            </div>
             <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-blue-500 shadow-lg">
                <div class="text-xs opacity-70 font-bold uppercase tracking-wide mb-1">Discord Tienda</div>
                <div class="text-sm font-bold font-mono text-blue-300 truncate bg-slate-900/50 p-1 rounded">${viewingUser.discord_tag}</div>
            </div>
        </div>
      `;
    }
    
    function renderAdminLog() {
        const user = currentUser;
        const viewingAs = adminViewTarget || user.username;
        const completedOrdersLog = user.role === 'admin' 
            ? allOrders.filter(o => o.order_status === 'completed' || o.order_status === 'rejected').reverse() 
            : allOrders.filter(o => o.seller_username === viewingAs && (o.order_status === 'completed' || o.order_status === 'rejected')).reverse();
            
        return `
            <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
                <h2 class="text-xl font-bold mb-6 text-green-400 border-b border-slate-700 pb-2 flex items-center gap-2">
                    ðŸ“œ LOG DE PEDIDOS COMPLETADOS/RECHAZADOS (${completedOrdersLog.length})
                    ${user.role === 'admin' ? `
                        <button onclick="clearCompletedOrdersLog()" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-bold transition ml-auto">
                            ðŸ—‘ï¸ LIMPIAR LOG COMPLETO
                        </button>
                    ` : ''}
                </h2>
                <div class="overflow-x-auto rounded-lg border border-slate-700 max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="bg-slate-900 text-white uppercase font-bold text-xs sticky top-0 z-10">
                            <tr>
                                <th class="p-3">Estado</th>
                                <th class="p-3">Fecha</th>
                                <th class="p-3">Tienda/Vendedor</th>
                                <th class="p-3">Comprador</th>
                                <th class="p-3">Items</th>
                                <th class="p-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            ${completedOrdersLog.length === 0 ? `
                                <tr><td colspan="6" class="p-4 text-center opacity-50">No hay registro de pedidos.</td></tr>
                            ` : completedOrdersLog.map(o => `
                                <tr class="hover:bg-slate-700/30 transition font-mono ${o.order_status === 'rejected' ? 'bg-red-900/10' : ''}">
                                    <td class="p-3 text-xs font-bold whitespace-nowrap">
                                        <span class="px-2 py-1 rounded text-xs ${o.order_status === 'rejected' ? 'bg-red-700 text-white' : 'bg-green-700 text-green-100'}">
                                            ${o.order_status.toUpperCase()}
                                        </span>
                                    </td>
                                    <td class="p-3 text-xs text-slate-500">${new Date(o.created_at).toLocaleDateString()}</td>
                                    <td class="p-3 font-bold text-blue-300">${o.seller_username}</td>
                                    <td class="p-3 text-white">${o.buyer_username}</td>
                                    <td class="p-3 text-xs truncate max-w-xs">${o.items}</td>
                                    <td class="p-3 text-right font-bold text-green-400">$${o.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    function renderAdminPendingOrders() {
        const user = currentUser;
        const viewingAs = adminViewTarget || user.username;
        const myOrders = allOrders.filter(o => o.seller_username === viewingAs);
        const pending = myOrders.filter(o => o.order_status === 'pending').reverse();
        
        return `
            <h2 class="text-xl font-bold mb-4 text-yellow-400 border-b border-slate-700 pb-2 flex items-center gap-2">
                ðŸ“¦ Pedidos por Despachar <span class="bg-slate-700 text-white px-2 rounded text-sm">${pending.length}</span>
            </h2>
           
            ${pending.length === 0 ? `
                <div class="text-center py-8 opacity-50">
                    <p class="italic">No tienes pedidos pendientes. Â¡Buen trabajo!</p>
                </div>
            ` : pending.map((o, i) => {
                const sellerConfirmed = o.seller_confirmed;
                const buyerConfirmed = o.buyer_confirmed;
               
                let confirmButtonText, confirmButtonClass, confirmButtonAction;
               
                if (buyerConfirmed) {
                    confirmButtonText = 'Cliente CONFIRMADO';
                    confirmButtonClass = 'bg-orange-700/50 disabled:opacity-100 disabled:cursor-wait';
                    confirmButtonAction = 'disabled';
                } else if (sellerConfirmed) {
                    confirmButtonText = 'â³ Esperando Cliente';
                    confirmButtonClass = 'bg-yellow-600/50 disabled:opacity-100 disabled:cursor-wait';
                    confirmButtonAction = 'disabled';
                } else {
                    confirmButtonText = 'âœ… MARCAR ENTREGADO';
                    confirmButtonClass = 'bg-green-600 hover:bg-green-500';
                    confirmButtonAction = `onclick="confirmOrder('${o.__backendId}', true)"`;
                }
               
                const statusBadgeText = buyerConfirmed ? 'Cliente ConfirmÃ³' : (sellerConfirmed ? 'TÃº Confirmaste (Esperando Cliente)' : 'Pendiente de tu Entrega');
                const statusBadgeClass = buyerConfirmed ? 'bg-orange-900 text-orange-200' : (sellerConfirmed ? 'bg-yellow-900 text-yellow-200' : 'bg-red-900 text-red-200');

                return `
                <div class="bg-slate-900 p-5 rounded-lg mb-4 border border-slate-600 flex flex-col md:flex-row justify-between gap-6 shadow-sm hover:bg-slate-900/80 transition">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="font-bold text-lg text-blue-300">PEDIDO #${pending.length - i}</span>
                            <span class="px-2 py-1 rounded text-xs font-bold ${statusBadgeClass} whitespace-nowrap">${statusBadgeText}</span>
                        </div>
                        <div class="mb-1">Cliente: <span class="font-bold text-white">${o.buyer_username}</span></div>
                        <div class="inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded text-xs font-mono border border-purple-500/30 mb-3">
                            ðŸ“± Discord: ${o.buyer_discord}
                        </div>
                        <div class="text-sm text-slate-300 bg-slate-800/50 p-3 rounded border-l-2 border-green-500 font-mono">
                            ${o.items}
                        </div>
                    </div>
                    <div class="text-right flex flex-col justify-between items-end min-w-[200px]">
                        <div>
                            <p class="text-xs text-slate-500 uppercase">Total a Cobrar</p>
                            <div class="text-3xl font-bold text-green-400">$${o.total.toFixed(2)}</div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="openRejectModal('${o.__backendId}')" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-bold text-sm shadow transition text-white">
                                âŒ RECHAZAR PEDIDO
                            </button>
                            <button onclick="openChatModal('${o.__backendId}')" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-bold text-sm shadow transition text-white">
                                ðŸ’¬ CHAT
                            </button>
                        </div>
                        <button ${confirmButtonAction} class="${confirmButtonClass} px-4 py-2 rounded font-bold text-sm shadow transition text-white mt-2 w-full">
                            ${confirmButtonText}
                        </button>
                    </div>
                </div>
                `}).join('')}
        `;
    }
    
    function renderAdminInventoryList() {
        const user = currentUser;
        const viewingAs = adminViewTarget || user.username;
        const myProducts = allProducts.filter(p => p.seller_username === viewingAs);
        
        return `
            <h2 class="text-xl font-bold mb-6 text-blue-400 border-b border-slate-700 pb-2">ðŸ›ï¸ GestiÃ³n de Inventario</h2>
           
            <div class="mb-8 p-5 bg-slate-900 rounded-lg border border-slate-600">
                <h3 class="text-sm font-bold mb-3 uppercase text-slate-400 flex items-center gap-2">
                    <span>âž•</span> Publicar Nuevo Item
                </h3>
                <form onsubmit="handleAddProduct(event)" class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-4">
                        <input id="productName" placeholder="Nombre del Item" required class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500 outline-none">
                    </div>
                    <div class="md:col-span-2">
                        <select id="productCategory" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500">
                            <option value="items">Arma/Escudo</option>
                            <option value="sets">Set Completo</option>
                            <option value="wings">Alas</option>
                            <option value="jewels">Joyas</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <input id="productPrice" type="number" step="0.01" placeholder="Precio $" required class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <input id="productStock" type="number" placeholder="Stock" required class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full h-full bg-blue-600 hover:bg-blue-500 font-bold rounded text-white shadow transition uppercase text-sm">
                            Publicar
                        </button>
                    </div>
                   
                    <input id="productDiscount" type="hidden" value="0">
                    <input id="productImage" type="hidden" value="">
                    <input id="productDescription" type="hidden" value="">
                    <input id="productOnSale" type="checkbox" class="hidden">
                </form>
                <p class="text-xs text-slate-500 mt-3 ml-1 flex items-center gap-1">
                    â„¹ï¸ Para agregar imagen, descuento o descripciÃ³n, usa el botÃ³n <span class="font-bold text-blue-400 bg-slate-800 px-1 rounded">EDITAR</span> una vez creado el item.
                </p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                ${myProducts.map(p => `
                    <div class="bg-slate-900 rounded-lg border border-slate-600 p-4 relative group hover:border-blue-500 transition shadow-sm flex flex-col justify-between h-full">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold truncate text-white text-lg pr-2" title="${p.name}">${p.name}</div>
                                <div class="font-mono text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 border border-slate-700 whitespace-nowrap">
                                    ðŸ“¦ Stock: ${p.stock}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-green-400 font-bold text-2xl">$${p.final_price.toFixed(2)}</div>
                                ${p.discount > 0 ? `<div class="text-xs text-red-400 font-bold bg-red-900/20 inline-block px-1 rounded border border-red-900/50">-${p.discount}% OFF</div>` : '<div class="h-5"></div>'}
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-auto pt-3 border-t border-slate-800">
                            <button onclick="openEditModal('${p.__backendId}')" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold text-white shadow transition flex items-center justify-center gap-1">
                                âœï¸ EDITAR
                            </button>
                            <button onclick="deleteProduct('${p.__backendId}')" class="bg-red-600 hover:bg-red-500 px-3 py-2 rounded text-xs font-bold text-white shadow transition flex items-center justify-center">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function renderAdminGlobalUserPanel() {
        const user = currentUser;
        const sellerSalesMap = getSellerSalesMap();

        const displayUsers = allUsers.sort((a, b) => {
            if (a.status === 'pending' && b.status !== 'pending') return -1;
            if (a.status !== 'pending' && b.status === 'pending') return 1;
            if (a.username === ADMIN_CREDENTIALS.username && user.username !== ADMIN_CREDENTIALS.username) return -1;
            if (b.username === ADMIN_CREDENTIALS.username && user.username !== ADMIN_CREDENTIALS.username) return 1;
            if (a.username === user.username) return -1;
            if (b.username === user.username) return 1;
            return a.username.localeCompare(b.username);
        });
        
        if (user.role !== 'admin' || adminViewTarget) return '';

        return `
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                <h2 class="text-xl font-bold mb-6 text-purple-400 border-b border-slate-700 pb-2 flex items-center gap-2">
                    ðŸŒ Panel Global de Usuarios <span class="text-xs bg-slate-900 text-slate-400 px-2 py-1 rounded ml-auto">Total: ${displayUsers.length}</span>
                </h2>
               
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="bg-slate-900 text-white uppercase font-bold text-xs">
                            <tr>
                                <th class="p-4">Usuario (Tienda)</th>
                                <th class="p-4">Rol</th>
                                <th class="p-4">Estado</th>
                                <th class="p-4 text-center">VENTAS</th> 
                                <th class="p-4">Discord</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            ${displayUsers.map(u => `
                                <tr class="hover:bg-slate-700/30 transition ${u.status === 'pending' ? 'bg-yellow-900/20 border-l-4 border-yellow-500' : ''}">
                                    <td class="p-4 font-bold flex flex-col justify-start">
                                        <span class="text-white cursor-pointer hover:text-blue-400" onclick="openManageUserModal('${u.username}')">
                                            ${u.username}
                                        </span>
                                        ${u.role === 'reseller' && u.shop_name ? `<span class="text-xs opacity-60 text-blue-300 italic">${u.shop_name}</span>` : ''}
                                    </td>
                                    <td class="p-4">
                                        <span class="bg-slate-900 px-2 py-1 rounded text-xs border border-slate-600 font-mono">
                                            ${u.role.toUpperCase()}
                                        </span>
                                    </td>
                                    <td class="p-4">
                                        <span class="px-2 py-1 rounded text-xs font-bold ${u.status==='banned'?'bg-red-900/30 text-red-400':u.status==='pending'?'bg-yellow-900/30 text-yellow-400':'bg-green-900/30 text-green-400'}">
                                            ${u.status.toUpperCase()}
                                        </span>
                                    </td>
                                    <td class="p-4 text-center">
                                        ${u.role === 'reseller' ? `<span class="font-bold text-green-400">${sellerSalesMap[u.username] || 0}</span>` : 'N/A'}
                                    </td>
                                    <td class="p-4 font-mono text-xs text-blue-300">
                                        ${u.discord_tag}
                                    </td>
                                    <td class="p-4 text-right flex justify-end gap-2">
                                        ${u.status === 'pending' ? `
                                            <button onclick="approveUser('${u.__backendId}')" class="bg-green-600 px-3 py-1 rounded text-xs font-bold hover:bg-green-500 text-white shadow transition">ACEPTAR</button>
                                            <button onclick="deleteUserAccount('${u.__backendId}')" class="bg-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-500 text-white shadow transition">RECHAZAR</button>
                                        ` : `
                                            ${u.role === 'reseller' ? `
                                                <button onclick="enterShopManagement('${u.username}')" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-1 rounded text-xs font-bold text-white shadow transition flex items-center gap-1 border border-indigo-400">
                                                    ðŸ‘ï¸ GESTIONAR
                                                </button>
                                            ` : ''}
                                            
                                            <button onclick="openManageUserModal('${u.username}')" class="border border-blue-500 text-blue-500 px-2 py-1 rounded text-xs font-bold hover:bg-blue-500 hover:text-black transition">
                                                âš™ï¸ DETALLE
                                            </button>
                                            
                                        `}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // --- VISTA ADMIN / RESELLER (PANEL COMPLETO) ---
    function renderAdmin() {
      const user = currentUser;
      const viewingAs = adminViewTarget || user.username;
      const viewingUser = allUsers.find(u => u.username === viewingAs) || user;
     
      return `
        <div class="min-h-full bg-slate-900 text-slate-100 p-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-slate-700 pb-6">
                    <div class="flex items-center gap-4">
                        <h1 class="text-3xl font-bold flex items-center gap-2">
                            ${adminViewTarget ? `ðŸ‘ï¸ GESTIONANDO TIENDA: <span class="text-yellow-400 underline">${viewingUser.shop_name}</span>` : (user.role==='admin'?'âš™ï¸ PANEL ADMINISTRADOR':'ðŸª MI TIENDA')}
                        </h1>
                        ${adminViewTarget ? `
                            <button onclick="exitShopManagement()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold text-sm shadow animate-pulse">
                                âŒ SALIR DEL MODO GESTIÃ“N
                            </button>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${user.role === 'admin' ? `
                            <button onclick="showModal='dataTools';render()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-yellow-400 border-yellow-500/50">
                                ðŸ’¾ RESPALDO SYSTEM
                            </button>
                        ` : ''}
                        <button onclick="loadAdminView()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-blue-400 border-blue-500/50">
                            ðŸ”„ REFRESCAR DATOS (Forzado)
                        </button>
                        <button onclick="currentView='catalog';render()" class="bg-blue-600 px-6 py-2 rounded font-bold shadow hover:bg-blue-500 transition">
                            ðŸ  Volver al Inicio
                        </button>
                    </div>
                </div>

                <div id="admin-stats-container" class="mb-8">
                </div>
               
                <div id="admin-orders-log" class="mb-8">
                </div>
                
                <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
                    <div id="admin-pending-orders-content">
                    </div>
                </div>
                
                <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
                    <div id="admin-inventory-list-content">
                    </div>
                </div>

                <div id="admin-user-panel">
                </div>

            </div>
        </div>
      `;
    }

    function renderModal() {
        // La funciÃ³n close ahora debe resetear selectedOrderToReject si estÃ¡ activo
        const close = `onclick="closeChatModal(); showModal=null;selectedProductToEdit=null;managedUser=null;selectedOrder=null;selectedOrderToReject=null;setEditingState(false);render()"`;
        const box = "bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full border border-slate-600 relative transform transition-all scale-100";
       
        // --- MODAL: RECHAZAR PEDIDO ---
        if (showModal === 'rejectOrder' && selectedOrderToReject) {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 animate-bounce-in" ${close}>
                <div class="${box} max-w-lg" onclick="event.stopPropagation()">
                    <div class="flex justify-between mb-6 border-b border-slate-700 pb-4">
                        <h2 class="text-xl font-bold text-red-400 flex items-center gap-2">âŒ Rechazar Pedido #${selectedOrderToReject.id.slice(-8)}</h2>
                        <button ${close} class="text-slate-400 hover:text-white font-bold text-xl">âœ•</button>
                    </div>
                    <p class="text-slate-300 mb-4">Ingresa el motivo exacto por el cual se rechaza el pedido del comprador <span class="font-bold text-yellow-400">${selectedOrderToReject.buyer_username}</span>.</p>
                    <form onsubmit="handleRejectOrder(event)">
                        <div class="mb-6">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Motivo del Rechazo</label>
                            <textarea id="rejectReason" rows="4" placeholder="Ej: Producto agotado, no disponible en su servidor, error de precio." class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600 resize-none" required minlength="5"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-500 py-4 rounded-lg font-bold text-white shadow-lg uppercase tracking-wide transition transform active:scale-95">
                            CONFIRMAR RECHAZO
                        </button>
                    </form>
                </div>
            </div>`;
        }

        // --- MODAL: CHAT (SUPABASE REALTIME) ---
        if (showModal === 'chat' && chatTargetOrder) {
            const partnerName = chatTargetOrder.buyer_username === currentUser.username ? chatTargetOrder.seller_username : chatTargetOrder.buyer_username;
            const partnerDiscord = chatTargetOrder.buyer_username === currentUser.username ? chatTargetOrder.seller_discord : chatTargetOrder.buyer_discord;
           
            setTimeout(() => {
                const messagesContainer = document.querySelector('.chat-messages');
                if (messagesContainer) {
                    renderChatMessages(messagesContainer);
                }
            }, 0);
           
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 animate-bounce-in">
                <div class="${box} max-w-lg p-0" onclick="event.stopPropagation()">
                    <div class="bg-slate-900 p-4 rounded-t-xl flex justify-between items-center border-b border-slate-700">
                        <div>
                            <h2 class="text-xl font-bold text-blue-400">ðŸ’¬ Chat de Pedido #${chatTargetOrder.id.slice(-8)}</h2>
                            <p class="text-sm text-slate-400">Hablando con: <span class="text-white font-bold">${partnerName}</span> (${partnerDiscord})</p>
                        </div>
                        <button onclick="closeChatModal()" class="text-slate-400 hover:text-white font-bold text-xl">âœ•</button>
                    </div>

                    <div class="p-4 flex flex-col">
                        <div class="chat-messages space-y-2 mb-4 p-2 bg-slate-900/50 rounded-lg border border-slate-700/50">
                            ${chatMessages.length === 0 ? '<div class="text-center text-slate-500 text-xs py-10">Cargando historial de mensajes...</div>' : ''}
                        </div>

                        <form onsubmit="handleChatMessageSend(event)" class="flex gap-2">
                            <input id="chatInput" type="text" placeholder="Escribe tu mensaje..." class="flex-1 p-3 rounded bg-slate-700 text-white border border-slate-600 focus:border-blue-500 outline-none" required autocomplete="off">
                            <button type="submit" class="bg-green-600 hover:bg-green-500 px-4 py-3 rounded font-bold text-white shadow transition">
                                ENVIAR
                            </button>
                        </form>
                           <p class="text-xs text-slate-500 mt-2">Nota: Este chat estÃ¡ conectado a Supabase Realtime.</p>
                    </div>
                </div>
            </div>`;
        }
       
        // --- MODAL: GESTIÃ“N DE USUARIO (ADMIN) ---
        if(showModal === 'manageUser' && managedUser) {
              const u = managedUser;
              const userOrders = allOrders.filter(o => o.buyer_username === u.username || o.seller_username === u.username);
              const userProducts = allProducts.filter(p => p.seller_username === u.username);
             
              const sellerSalesMap = getSellerSalesMap();
              const salesCount = sellerSalesMap[u.username] || 0;
              const { rating, reviewCount } = getShopRating(u.username);
             
              return `
              <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
                  <div class="${box} max-w-2xl w-full" onclick="event.stopPropagation()">
                      <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                          <h2 class="text-xl font-bold text-white flex items-center gap-2">
                              ðŸ‘¤ GestiÃ³n de Usuario: <span class="text-blue-400">${u.username}</span>
                          </h2>
                          <button ${close} class="text-slate-400 hover:text-white font-bold text-xl">âœ•</button>
                      </div>
                     
                      <div class="grid grid-cols-2 gap-4 mb-6">
                          <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                              <p class="text-xs uppercase text-slate-500 font-bold">Discord</p>
                              <p class="font-mono text-blue-300 text-lg">${u.discord_tag}</p>
                          </div>
                          <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                              <p class="text-xs uppercase text-slate-500 font-bold">Pedidos Involucrados</p>
                              <p class="font-bold text-white text-xl">${userOrders.length}</p>
                          </div>
                          ${u.role === 'reseller' ? `
                              <div class="col-span-2 bg-slate-900 p-3 rounded-lg border border-slate-700">
                                  <p class="text-xs uppercase text-slate-500 font-bold">Tienda</p>
                                  <p class="font-bold text-yellow-400 text-xl">${u.shop_name || 'Sin configurar'}</p>
                              </div>
                              <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                                   <p class="text-xs uppercase text-slate-500 font-bold">Items Publicados</p>
                                   <p class="font-bold text-white text-xl">${userProducts.length}</p>
                               </div>
                              <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                                   <p class="text-xs uppercase text-slate-500 font-bold">Ventas Completadas</p>
                                   <p class="font-bold text-green-400 text-xl">${salesCount}</p>
                               </div>
                               <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                                   <p class="text-xs uppercase text-slate-500 font-bold">Rating / Reviews</p>
                                   <p class="font-bold text-yellow-400 text-lg">${rating} ${getStarHtml(rating)} (${reviewCount})</p>
                               </div>
                          ` : ''}
                      </div>
                     
                      <div class="border-t border-slate-700 pt-4 mb-4">
                          <h3 class="text-lg font-bold text-green-400 mb-3">Cambio de Rol y Estado</h3>
                          <form onsubmit="handleUpdateUserRole(event)" class="flex flex-col sm:flex-row gap-3 items-center">
                              <div class="flex-1 w-full">
                                  <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Rol Actual: <span class="text-white">${u.role.toUpperCase()}</span></label>
                                  <select id="manageUserRole" class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600" ${u.username === ADMIN_CREDENTIALS.username ? 'disabled' : ''}>
                                      <option value="buyer" ${u.role === 'buyer' ? 'selected' : ''}>Comprador</option>
                                      <option value="reseller" ${u.role === 'reseller' ? 'selected' : ''}>Reseller</option>
                                      <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin (Supremo)</option>
                                  </select>
                              </div>
                              <button type="submit" class="w-full sm:w-auto mt-4 sm:mt-0 bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded text-sm font-bold shadow transition transform active:scale-95" ${u.username === ADMIN_CREDENTIALS.username ? 'disabled' : ''}>
                                  ACTUALIZAR ROL
                              </button>
                          </form>
                           <p class="text-xs text-red-400 mt-2 italic">Advertencia: Cambiar a 'Comprador' quitarÃ¡ los permisos de tienda. Usar 'Admin' le darÃ¡ control total. El Admin Supremo de origen no puede ser modificado.</p>
                      </div>
                      
                      <div class="border-t border-slate-700 pt-4">
                          <h3 class="text-lg font-bold text-purple-400 mb-2">Acciones CrÃ­ticas</h3>
                          <div class="flex flex-wrap gap-2">
                              ${u.role === 'reseller' ? `
                                  <button onclick="enterShopManagement('${u.username}')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-bold">
                                      ðŸ‘ï¸ Gestionar Items
                                  </button>
                                  ${u.status === 'pending' ? `
                                      <button onclick="approveUser('${u.__backendId}')" class="bg-green-600 px-4 py-2 rounded text-sm font-bold text-white">Aprobar Tienda</button>
                                  ` : ''}
                              ` : ''}
                              
                              <button onclick="banUser('${u.__backendId}')" class="border border-yellow-500 text-yellow-500 px-4 py-2 rounded text-sm font-bold hover:bg-yellow-500 hover:text-black">
                                  ${u.status.includes('banned') ? 'UNBAN' : 'BAN'}
                              </button>
                              <button onclick="deleteUserAccount('${u.__backendId}')" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded text-sm font-bold">
                                  ðŸ—‘ï¸ Eliminar Cuenta
                              </button>
                          </div>
                      </div>
                  </div>
              </div>`;
        }

        // --- MODAL: DATA TOOLS (IMPORT/EXPORT) ---
        if(showModal === 'dataTools') {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
                <div class="${box}" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-center mb-4 text-white">ðŸ› ï¸ GestiÃ³n de Datos (JSONBin)</h2>
                    <p class="text-center text-slate-400 text-sm mb-6">Guarda una copia de seguridad o restaura los datos REMOTOS.</p>
                   
                    <div class="grid gap-4">
                        <button onclick="downloadBackup()" class="bg-blue-600 hover:bg-blue-500 py-4 rounded-lg font-bold text-white shadow-lg transition flex items-center justify-center gap-3">
                            â¬‡ï¸ EXPORTAR (Descargar Backup del BIN)
                        </button>
                       
                        <div class="border-t border-slate-600 my-2"></div>
                       
                        <button onclick="triggerUpload()" class="bg-red-600 hover:bg-red-500 py-4 rounded-lg font-bold text-white shadow-lg transition flex items-center justify-center gap-3">
                            â¬†ï¸ IMPORTAR (Reemplazar BIN Remoto)
                        </button>
                        <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>`;
        }

        // --- MODAL: EDITAR PRODUCTO ---
        if(showModal === 'editProduct' && selectedProductToEdit) {
            const p = selectedProductToEdit;
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 animate-fadeIn">
                <div class="${box} max-w-lg" onclick="event.stopPropagation()">
                    <div class="flex justify-between mb-6 border-b border-slate-700 pb-4">
                        <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2">âœï¸ Editar Producto</h2>
                        <button ${close} class="text-slate-400 hover:text-white font-bold text-xl">âœ•</button>
                    </div>
                    <form onsubmit="handleUpdateProduct(event)" class="grid grid-cols-2 gap-5">
                        <div class="col-span-2">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Nombre del Item</label>
                            <input id="editName" value="${p.name}" class="w-full bg-slate-700 p-3 rounded text-white border border-slate-600 focus:border-blue-500 outline-none font-bold">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Precio (USDT)</label>
                            <input id="editPrice" type="number" step="0.01" value="${p.price}" class="w-full bg-slate-700 p-3 rounded text-white border border-slate-600">
                        </div>
                         <div>
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Stock Disponible</label>
                            <input id="editStock" type="number" value="${p.stock}" class="w-full bg-slate-700 p-3 rounded text-white border border-slate-600">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Descuento (%)</label>
                            <input id="editDiscount" type="number" value="${p.discount}" class="w-full bg-slate-700 p-3 rounded text-white border border-slate-600">
                        </div>
                        <div class="flex items-center justify-center h-full pt-6">
                            <label class="flex items-center cursor-pointer bg-slate-700 px-3 py-2 rounded border border-slate-600 hover:bg-slate-600 transition w-full">
                                <input id="editOnSale" type="checkbox" class="w-5 h-5 accent-red-500 mr-2" ${p.on_sale?'checked':''}> 
                                <span class="text-sm font-bold text-red-400">ðŸ”¥ En Oferta</span>
                            </label>
                        </div>
                         <div class="col-span-2">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">URL Imagen (Imgur/Directa)</label>
                            <input id="editImage" value="${p.image_url||''}" class="w-full bg-slate-700 p-3 rounded text-white border border-slate-600">
                        </div>
                         <div class="col-span-2">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">DescripciÃ³n Detallada</label>
                            <textarea id="editDescription" class="w-full bg-slate-700 p-3 rounded text-white mb-4 border border-slate-600 h-24 resize-none">${p.description||''}</textarea>
                        </div>
                        <button class="col-span-2 bg-blue-600 hover:bg-blue-500 py-4 rounded-lg font-bold text-white shadow-lg mt-2 uppercase tracking-wide transition transform hover:scale-[1.02]">
                            Guardar Cambios
                        </button>
                    </form>
                </div>
            </div>`;
        }

        if(showModal === 'login') {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
                <div class="${box}" onclick="event.stopPropagation()">
                    <h2 class="text-3xl font-bold text-center mb-6 text-white">Bienvenido</h2>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Usuario</label>
                            <input id="loginUsername" class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600 focus:border-blue-500 outline-none" required>
                        </div>
                        <div class="mb-8">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">ContraseÃ±a</label>
                            <input id="loginPassword" type="password" class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600 focus:border-blue-500 outline-none" required>
                        </div>
                        <button class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-lg font-bold text-white shadow-lg transition transform active:scale-95">
                            INICIAR SESIÃ“N
                        </button>
                        <p class="text-center mt-4 text-sm text-slate-500 cursor-pointer hover:text-blue-400" onclick="showModal='register';render()">Â¿No tienes cuenta? RegÃ­strate</p>
                    </form>
                </div>
            </div>`;
        }

        if(showModal === 'register') {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
                <div class="${box}" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-center mb-6 text-green-400">Registro Comprador</h2>
                    <form onsubmit="handleRegisterBuyer(event)">
                        <input id="buyerUsername" placeholder="Nombre de Usuario" class="w-full mb-3 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                        <input id="buyerPassword" type="password" placeholder="ContraseÃ±a" class="w-full mb-3 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                        <div class="mb-6 relative">
                            <input id="buyerDiscord" placeholder="Discord Tag (Ej: User#1234)" class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600 pl-10" required>
                            <span class="absolute left-3 top-3 text-slate-400">ðŸ“±</span>
                        </div>
                        <button class="w-full bg-green-600 hover:bg-green-500 py-3 rounded font-bold text-white shadow-lg transition">CREAR CUENTA</button>
                    </form>
                </div>
            </div>`;
        }

        if(showModal === 'registerReseller') {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
                <div class="${box}" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-center mb-6 text-purple-400">Solicitud Vendedor</h2>
                    <p class="text-center text-slate-400 text-sm mb-4">La cuenta estarÃ¡ pendiente de aprobaciÃ³n por el Admin.</p>
                    <form onsubmit="handleRegisterReseller(event)">
                        <input id="resellerUsername" placeholder="Usuario" class="w-full mb-3 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                        <input id="resellerPassword" type="password" placeholder="ContraseÃ±a" class="w-full mb-3 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                        <input id="resellerShop" placeholder="Nombre de tu Tienda" class="w-full mb-3 p-3 rounded bg-slate-700 text-white border border-slate-600 font-bold" required>
                        <input id="resellerDiscord" placeholder="Discord Tag" class="w-full mb-6 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                        <button class="w-full bg-purple-600 hover:bg-purple-500 py-3 rounded font-bold text-white shadow-lg transition">ENVIAR SOLICITUD</button>
                    </form>
                </div>
            </div>`;
        }

        if(showModal === 'setupShop' && selectedOrder) {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="logout(false); showToast('Cierre de sesiÃ³n forzado por configuraciÃ³n incompleta.');">
                <div class="${box}" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-center mb-4 text-blue-400">Configura tu Tienda</h2>
                    <p class="text-center text-slate-400 text-sm mb-6">Necesitas completar estos datos para ${selectedOrder.status === 'pending' ? 'activar' : 'continuar con'} tu panel de vendedor.</p>
                    <form onsubmit="handleSetupShop(event)">
                        <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Nombre de la Tienda</label>
                        <input id="setupShopName" placeholder="Ej: Kaleb Store" value="${selectedOrder.shop_name||''}" class="w-full mb-4 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                       
                        <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Tu Discord</label>
                        <input id="setupDiscord" placeholder="User#0000" value="${selectedOrder.discord_tag||''}" class="w-full mb-6 p-3 rounded bg-slate-700 text-white border border-slate-600" required>
                       
                        <button class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold text-white shadow-lg transition">GUARDAR Y ENTRAR</button>
                        <p class="text-center mt-4 text-xs text-red-500">Nota: Al cerrar esta ventana, se cerrarÃ¡ tu sesiÃ³n.</p>
                    </form>
                </div>
            </div>`;
        }
       
        if(showModal === 'review' && selectedOrder) {
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 animate-bounce-in" ${close}>
                <div class="${box} max-w-lg" onclick="event.stopPropagation()">
                    <h2 class="text-2xl font-bold text-center mb-2 text-yellow-400">Â¿CÃ³mo fue tu experiencia?</h2>
                    <p class="text-center text-slate-400 mb-6">EvalÃºa al vendedor: <span class="font-bold text-white">${selectedOrder.seller_username}</span></p>

                    <form onsubmit="handleSubmitReview(event)">
                        <div class="mb-6 text-center">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">CalificaciÃ³n (1 a 5)</label>
                            <select id="reviewRating" class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600 text-center font-bold text-lg" required>
                                <option value="5">â­â­â­â­â­ Excelente</option>
                                <option value="4">â­â­â­â­ Muy Bueno</option>
                                <option value="3">â­â­â­ Neutral</option>
                                <option value="2">â­â­ Malo</option>
                                <option value="1">â­ PÃ©simo</option>
                            </select>
                        </div>
                       
                        <div class="mb-6">
                            <label class="text-xs text-slate-400 font-bold uppercase mb-1 block">Comentario (Opcional)</label>
                            <textarea id="reviewComment" rows="3" placeholder="Comparte tu opiniÃ³n sobre la entrega y el servicio..." class="w-full p-3 rounded bg-slate-700 text-white border border-slate-600 resize-none"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded font-bold text-white shadow-lg transition transform active:scale-95">
                            ENVIAR RESEÃ‘A
                        </button>
                    </form>
                </div>
            </div>`;
        }

        return '';
    }

    // ---------------------------------------------------------
    // 16. INICIO DE LA APLICACIÃ“N
    // ---------------------------------------------------------
    init();
  </script>
 </body>
</html>

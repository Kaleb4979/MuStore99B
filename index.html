<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mu Online 99B Marketplace - V30 (Chat Realtime Supabase)</title>
 
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
 
  <style>
    /* Configuraci√≥n Base */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
    }
    html {
      height: 100%;
    }

    /* Animaciones de Botones y Tarjetas */
    .category-btn {
      transition: all 0.3s ease;
    }
    .category-btn:hover {
      transform: translateY(-2px);
    }

    .product-card {
      transition: all 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .shop-badge {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .shop-badge:hover {
      transform: scale(1.05);
      background-color: #4f46e5; /* Indigo-600 */
    }

    /* Spinner de Carga */
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notificaci√≥n en el Carrito */
    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Fondo Oscuro para Modales */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
    }

    /* Estilos para el Ranking (Oro, Plata, Bronce) */
    .rank-1 {
      border: 2px solid #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(0,0,0,0.4));
    }
    .rank-2 {
      border: 2px solid #C0C0C0;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
      background: linear-gradient(145deg, rgba(192,192,192,0.1), rgba(0,0,0,0.4));
    }
    .rank-3 {
      border: 2px solid #CD7F32;
      box-shadow: 0 0 10px rgba(205, 127, 50, 0.2);
      background: linear-gradient(145deg, rgba(205,127,50,0.1), rgba(0,0,0,0.4));
    }

    /* Animaci√≥n Bounce In */
    @keyframes bounceIn {
        0% { transform: scale(0.8); opacity: 0; }
        60% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); }
    }
    .animate-bounce-in {
        animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    /* Transiciones de Vista Suaves */
    @view-transition { navigation: auto; }
    
    /* Estilos del Chat */
    .chat-messages {
        height: 350px; /* Altura Fija */
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .message-bubble {
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 18px;
        margin-bottom: 8px;
        word-wrap: break-word;
    }
    .message-self {
        background-color: #3b82f6; /* Blue-500 */
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }
    .message-other {
        background-color: #1e293b; /* Slate-800 */
        color: #f1f5f9;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }
  </style>

  <script>
    // ---------------------------------------------------------
    // 1. CONFIGURACI√ìN CR√çTICA (REEMPLAZAR ESTAS L√çNEAS)
    // ---------------------------------------------------------
    // *** üö® VERIFICA TUS CREDENCIALES AQU√ç üö® ***
    const BIN_ID = '691ddaa6ae596e708f6321c9'; 
    const SECRET_KEY = '$2a$10$6.Y19X/sB3np.3CIJmbJZesuwRVxU77ns.FyAdL2dUc46k1vWFG9S'; 
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    const DB_KEY = 'mu_marketplace_db_v22_final'; 
    const SESSION_KEY = 'mu_session_user_v22_final';
    
    // üì¢ CONFIGURACI√ìN SUPABASE (CHAT REALTIME) - UTILIZAR LOS VALORES REALES
    const SUPABASE_URL = 'https://ciysaobejtxfkpmbmswb.supabase.co'; // <--- REEMPLAZADO CON SU URL REAL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpeXNhb2JlanR4ZmtwbWJtc3diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTAyNTksImV4cCI6MjA3OTE4NjI1OX0.WDg1v-2UK8yow7uXK8UyqOt3xOp_-BMMEVqyJeExb3w'; // <--- REEMPLAZADO CON SU CLAVE REAL
    
    let supabaseClient = null;
    if (window.supabase) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("SDK de Supabase no cargado. El chat no funcionar√° en tiempo real.");
    }
    // ---------------------------------------------------------

    // Base de datos simulada (solo para mantener la estructura, los datos reales vienen del BIN)
    window.mockDb = {
      data: [], 
      handler: null,
      notify() {} 
    };

    // SDK de Configuraci√≥n Visual (sigue local, no necesita backend)
    window.elementSdk = {
      config: {},
      init: (options) => {
        window.elementSdk.config = options.defaultConfig;
        if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
      },
      setConfig: (newConfig) => {
        window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
      }
    };

    // ---------------------------------------------------------
    // SDK Base de Datos (Conexi√≥n JSONBin)
    // ---------------------------------------------------------
    window.dataSdk = {
        init: async (handler) => {
            window.mockDb.handler = handler;
            return window.dataSdk.read(); // Leer los datos al inicio
        },
        
        // FUNCI√ìN DE LECTURA: Obtiene todos los datos del BIN
        read: async () => {
            if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
                 console.error("JSONBin Config Error: BIN_ID o SECRET_KEY no configurados.");
                 showToast('‚ùå Error de Config: BIN ID o Key faltantes.');
                 const localData = localStorage.getItem(DB_KEY);
                 window.mockDb.data = localData ? JSON.parse(localData) : [];
                 window.mockDb.handler.onDataChanged(window.mockDb.data);
                 return { isOk: false };
            }

            try {
                const response = await fetch(JSONBIN_URL + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': SECRET_KEY 
                    }
                });

                if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const json = await response.json();
                const data = json.record || []; 
                
                // Almacenar en localStorage como fallback local y para velocidad
                localStorage.setItem(DB_KEY, JSON.stringify(data));
                
                // Actualizar la DB local y notificar
                window.mockDb.data = data;
                window.mockDb.handler.onDataChanged(data); 
                return { isOk: true };

            } catch (error) {
                console.error("JSONBin READ Error:", error);
                showToast('‚ùå Error al cargar datos remotos. Usando datos locales (LocalStorage).');
                // Si falla la red, usar el √∫ltimo backup local
                const localData = localStorage.getItem(DB_KEY);
                window.mockDb.data = localData ? JSON.parse(localData) : [];
                window.mockDb.handler.onDataChanged(window.mockDb.data);
                return { isOk: false };
            }
        },
        
        // FUNCI√ìN DE ESCRITURA: Actualiza TODOS los datos en el BIN
        write: async (newData) => {
            if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
                 showToast('‚ùå Error de Config: BIN ID o Key faltantes.');
                 return { isOk: false };
            }
            
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT', // PUT se usa para reemplazar todo el contenido
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': SECRET_KEY
                    },
                    body: JSON.stringify(newData)
                });

                if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                // Si la escritura es exitosa, actualizamos localStorage y notificamos
                localStorage.setItem(DB_KEY, JSON.stringify(newData));
                window.mockDb.data = newData;
                window.mockDb.handler.onDataChanged(newData);
                return { isOk: true, item: null }; // A√±adir item: null para consistencia si es necesario

            } catch (error) {
                console.error("JSONBin WRITE Error:", error);
                showToast('‚ùå Error de conexi√≥n/escritura. Vuelve a intentarlo.');
                return { isOk: false };
            }
        },

        // CREAR: Agrega un item y reescribe todo el BIN
        create: async (item) => {
            item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            const newData = [...window.mockDb.data, item];
            const result = await window.dataSdk.write(newData);
            return { isOk: result.isOk, item: item };
        },
        
        // ACTUALIZAR: Modifica un item y reescribe todo el BIN
        update: async (item) => {
            const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
            if (index === -1) {
                 console.error("No se encontr√≥ el item para actualizar:", item);
                 showToast('‚ùå Error: No se encontr√≥ el registro para actualizar.');
                 return { isOk: false };
            }

            const newData = [...window.mockDb.data];
            // Clonar para evitar mutar el estado antes de la escritura
            newData[index] = {...item}; 
            const result = await window.dataSdk.write(newData);
            return { isOk: result.isOk, item: result.isOk ? newData[index] : null };
        },
        
        // BORRAR: Elimina un item y reescribe todo el BIN
        delete: async (item) => {
            const newData = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
            const result = await window.dataSdk.write(newData);
            return { isOk: result.isOk };
        }
    };

    // ---------------------------------------------------------
    // 3. SDK DE CHAT REALTIME (Conexi√≥n REAL a Supabase)
    // ---------------------------------------------------------
    let chatChannel = null;
    
    window.chatSdk = {
        
        // üö® 3.1. FUNCI√ìN DE ENV√çO DE MENSAJE (Inserci√≥n en la tabla 'chats')
        sendMessage: async (orderId, sender, content) => {
            if (!supabaseClient || !content.trim()) {
                showToast('‚ùå Error de conexi√≥n o mensaje vac√≠o.');
                return;
            }
            
            const { error } = await supabaseClient
                .from('chats')
                .insert({ 
                    order_id: orderId, 
                    sender: sender, 
                    content: content 
                });

            if (error) {
                console.error("Error al enviar mensaje a Supabase:", error);
                showToast('‚ùå Error al enviar mensaje: ' + error.message);
            }
        },

        // üö® 3.2. FUNCI√ìN DE SUSCRIPCI√ìN (Realtime y Carga Inicial)
        subscribeToOrder: async (orderId) => {
            if (!supabaseClient) return;

            // 1. Desuscribirse del canal anterior
            window.chatSdk.unsubscribe();
            
            // 2. Cargar historial de mensajes (primero)
            const { data, error } = await supabaseClient
                .from('chats')
                .select('*')
                .eq('order_id', orderId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error("Error al cargar historial de chat:", error);
                showToast('‚ùå Error al cargar historial de chat.');
                chatMessages = [{ id: 'error', sender: 'System', content: 'No se pudo cargar el chat.', created_at: new Date().toISOString() }];
                window.chatSdk.listener(orderId);
                return;
            }
            
            chatMessages = data || [];
            window.chatSdk.listener(orderId); // Renderizar historial
            
            // 3. Suscribirse a nuevos mensajes (Realtime)
            chatChannel = supabaseClient.channel(`chat_${orderId}`);
            
            chatChannel
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'chats', filter: `order_id=eq.${orderId}` },
                    (payload) => {
                        // Un nuevo mensaje lleg√≥, a√±adirlo y re-renderizar
                        chatMessages.push(payload.new);
                        window.chatSdk.listener(orderId);
                        showToast(`üîî Nuevo mensaje de ${payload.new.sender}`);
                    }
                )
                .subscribe();

            showToast('üí¨ Chat iniciado. Conectado en tiempo real con Supabase.');
        },

        // 3.3. Funci√≥n para re-renderizar la interfaz de chat
        listener: (orderId) => {
            // Esto forza la actualizaci√≥n solo del modal de chat si est√° abierto
            if (showModal === 'chat') {
                const messagesContainer = document.querySelector('.chat-messages');
                if (messagesContainer) {
                    renderChatMessages(messagesContainer);
                }
            }
        },

        // 3.4. Funci√≥n que se llamar√≠a al cerrar el chat
        unsubscribe: () => {
            if (chatChannel) {
                supabaseClient.removeChannel(chatChannel);
                chatChannel = null;
            }
        }
    };
    // ---------------------------------------------------------


    // ---------------------------------------------------------
    // 4. MANEJADOR DE DATOS (JSONBin)
    // ---------------------------------------------------------
    const dataHandler = {
      onDataChanged(data) {
        // Separar los datos por tipo
        allProducts = data.filter(item => item.type === 'product') || [];
        allUsers = data.filter(item => item.type === 'user') || [];
        allOrders = data.filter(item => item.type === 'order') || [];
        allReviews = data.filter(item => item.type === 'review') || []; 
        const activityRecords = data.filter(item => item.type === 'activity') || [];
        
        // Notificaciones en tiempo real
        if (currentUser) {
            const newOrderAlert = activityRecords.find(a => 
                a.type === 'activity' &&
                a.message && 
                !a.dismissed && 
                (a.username === currentUser.username || currentUser.role === 'admin') 
            );

            if (newOrderAlert) {
                showToast(`üîî ${newOrderAlert.message}`);
                // Marcar como visto para que no salga de nuevo
                const updatedAlert = {...newOrderAlert, dismissed: true};
                // Usar update, pero sin esperar el resultado para no bloquear el flujo
                window.dataSdk.update(updatedAlert); 
            }
        }
        
        // Funciones de refresco
        validateCart(); // Chequear si algo en el carrito cambi√≥ de precio o stock
        render(); // Volver a pintar la pantalla
      }
    };

    // ---------------------------------------------------------
    // 5. INICIALIZACI√ìN (ARRANQUE)
    // ---------------------------------------------------------
    async function init() {
      // Intentar recuperar sesi√≥n guardada
      const storedUser = localStorage.getItem(SESSION_KEY);
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showToast(`üëã Sesi√≥n restaurada: ${currentUser.username}`);
      }

      // Configurar listeners de inactividad
      setupAutoLogout();

      // Conectar a la "Base de Datos" (JSONBin)
      await window.dataSdk.init(dataHandler);
      
      // Configurar SDK visual
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
            document.body.style.color = config.text_color || defaultConfig.text_color;
            const baseSize = config.font_size || defaultConfig.font_size;
            document.body.style.fontSize = `${baseSize}px`;
            render();
          }
        });
      }
      
      if (currentUser) updateUserActivity();
      render();
    }

    function setupAutoLogout() {
        const events = ['mousemove', 'keypress', 'click', 'scroll'];
        events.forEach(event => document.addEventListener(event, resetTimer));
        resetTimer();
    }

    function resetTimer() {
        if (currentUser) {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => logout(true), TIMEOUT_LIMIT);
        }
    }

    // ---------------------------------------------------------
    // 6. FUNCIONES DE USUARIO (LOGIN/REGISTRO/LOGOUT)
    // ---------------------------------------------------------
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      // Caso Especial: Login Admin Hardcodeado
      const ADMIN_CREDENTIALS = {
        username: 'Kaleb',
        password: 'Kaleb.2021',
        discord_tag: 'KalebAdmin#9999'
      };
      
      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        currentUser = { 
            username, 
            role: 'admin', 
            __backendId: 'admin',
            discord_tag: ADMIN_CREDENTIALS.discord_tag 
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
        showModal = null;
        currentView = 'admin';
        showToast('Bienvenido Admin (Modo Dios Activo)');
        await updateUserActivity();
        render();
        return;
      }

      // Login Normal
      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        if (user.status === 'banned') {
            showToast('üö´ Tu cuenta ha sido suspendida/baneada.');
            return;
        }

        if (user.role === 'reseller' && !user.approved) {
          showToast('Tu cuenta a√∫n no ha sido aprobada por el Admin.');
          return;
        }
        
        // Guardamos sesi√≥n con datos frescos
        currentUser = { 
          username: user.username,
          role: user.role,
          shop_name: user.shop_name,
          discord_tag: user.discord_tag || 'No Informado', 
          __backendId: user.__backendId
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
        
        // Si es vendedor sin configurar o pendiente de aprobaci√≥n (pero ya tiene usuario)
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
          selectedOrder = user;
          showModal = 'setupShop';
          showToast('Por favor configura tu tienda para continuar');
          render();
          return;
        }
        
        showModal = null;
        if (user.role === 'reseller' || user.role === 'admin') {
          currentView = 'admin';
        }
        showToast(`Bienvenido ${username}`);
        
        await updateUserActivity();
        render();
      } else {
        showToast('Usuario o contrase√±a incorrectos');
      }
    }
    
    // ... (El resto de las funciones de usuario/productos/pedidos se mantienen) ...

    // ---------------------------------------------------------
    // 10. FUNCIONES DE RESE√ëA
    // ---------------------------------------------------------
    function getShopRating(username) {
        const reviews = allReviews.filter(r => r.reviewed_seller === username);
        const avg = reviews.length ? (reviews.reduce((a,b)=>a+b.rating,0)/reviews.length).toFixed(1) : 0;
        return { rating: parseFloat(avg), reviewCount: reviews.length };
    }

    function getStarHtml(rating) {
        const fullStars = Math.floor(rating);
        let html = '';
        for (let i = 0; i < fullStars; i++) {
            html += '‚≠ê';
        }
        return html || (rating > 0 ? 'N/A' : 'Sin calificar'); 
    }

    async function handleSubmitReview(e) {
        e.preventDefault();
        if (!selectedOrder) return;
        
        const rating = parseInt(document.getElementById('reviewRating').value);
        const comment = document.getElementById('reviewComment').value.trim();
        
        if (rating < 1 || rating > 5) {
            showToast('La calificaci√≥n debe ser entre 1 y 5.');
            return;
        }
        
        const reviewData = {
            id: Date.now().toString(),
            type: 'review',
            reviewed_order: selectedOrder.__backendId,
            reviewed_seller: selectedOrder.seller_username,
            reviewer: currentUser.username,
            rating: rating,
            comment: comment,
            created_at: new Date().toISOString()
        };
        
        const reviewResult = await window.dataSdk.create(reviewData);
        
        if (reviewResult.isOk) {
            // Marcar la orden como revisada
            const updatedOrder = {...selectedOrder, needs_review: false};
            await window.dataSdk.update(updatedOrder);
            
            showToast('‚úÖ ¬°Rese√±a enviada! Gracias por tu feedback.');
            showModal = null;
            selectedOrder = null;
        } else {
            showToast('‚ùå Error al enviar la rese√±a.');
        }
    }
    
    // ---------------------------------------------------------
    // 11. FUNCIONES DE CHAT
    // ---------------------------------------------------------
    function openChatModal(orderId) {
        const order = allOrders.find(o => o.__backendId === orderId);
        if (!order) return;
        
        chatTargetOrder = order;
        showModal = 'chat';
        render(); // Abrir el modal
        
        // Iniciar la conexi√≥n en tiempo real con Supabase
        window.chatSdk.subscribeToOrder(orderId);
    }
    
    function closeChatModal() {
        window.chatSdk.unsubscribe();
        showModal = null;
        chatTargetOrder = null;
        render();
    }
    
    async function handleChatMessageSend(e) {
        e.preventDefault();
        if (!chatTargetOrder || !currentUser) return;
        
        const input = document.getElementById('chatInput');
        const content = input.value;
        if (!content.trim()) return;
        
        await window.chatSdk.sendMessage(chatTargetOrder.__backendId, currentUser.username, content);
        input.value = ''; // Limpiar input
        
        // No forzamos el re-renderizado aqu√≠; Supabase lo har√° con el evento Realtime
        
        // Asegurar scroll al fondo
        setTimeout(() => {
             const messagesContainer = document.querySelector('.chat-messages');
             if (messagesContainer) {
                 messagesContainer.scrollTop = messagesContainer.scrollHeight;
             }
        }, 50);
    }

    function renderChatMessages(container) {
        if (!container) return;
        
        const messagesHtml = chatMessages.map(msg => {
            // Supabase devuelve created_at como propiedad
            const timestamp = msg.created_at || new Date().toISOString(); 
            const isSelf = msg.sender === currentUser.username;
            const time = new Date(timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            return `
                <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
                    <div class="message-bubble ${isSelf ? 'message-self' : 'message-other'}">
                        <div class="font-bold text-xs ${isSelf ? '' : 'text-blue-300'} mb-1">${isSelf ? 'T√∫' : msg.sender}</div>
                        <div>${msg.content}</div>
                        <div class="text-right text-[10px] opacity-60 mt-1">${time}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = messagesHtml;
        container.scrollTop = container.scrollHeight; // Scroll al √∫ltimo mensaje
    }


    // ---------------------------------------------------------
    // 12. UTILIDADES DE RENDERIZADO
    // ---------------------------------------------------------
    function getTopShops() {
      const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
      const shopsStats = resellers.map(seller => {
        // 1. Obtener stats de reviews
        const { rating, reviewCount } = getShopRating(seller.username);
        // 2. Contar ventas
        const sales = allOrders.filter(o => o.seller_username === seller.username && o.order_status === 'completed').length;
        
        return { 
            ...seller, 
            salesCount: sales, // M√©trica principal de ranking
            rating: rating,     // Para visibilidad
            reviewCount: reviewCount // Para visibilidad
        }; 
      });
      // Ranking basado SOLO en Ventas (salesCount)
      return shopsStats.filter(s => s.salesCount > 0)
            .sort((a, b) => b.salesCount - a.salesCount).slice(0, 3); 
    }
    
    // Funci√≥n para obtener el conteo de ventas de todos los vendedores
    function getSellerSalesMap() {
        const salesMap = {};
        allOrders.forEach(order => {
            if (order.order_status === 'completed' && order.seller_username) {
                salesMap[order.seller_username] = (salesMap[order.seller_username] || 0) + 1;
            }
        });
        return salesMap;
    }

    function getCategoryIcon(id) {
      const cat = CATEGORIES.find(c => c.id === id);
      return cat ? cat.icon : 'üì¶';
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white animate-bounce bg-blue-600';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getConfig() {
      const configItem = window.mockDb.data.find(item => item.type === 'config');
      if (configItem) return configItem.config;
      
      return window.elementSdk ? window.elementSdk.config : defaultConfig;
    }

    // ---------------------------------------------------------
    // 13. RENDERIZADO PRINCIPAL (EL C√ìDIGO VISUAL)
    // ---------------------------------------------------------
    function render() {
      const app = document.getElementById('app');
      const config = getConfig();
      document.body.style.backgroundColor = config.background_color;
      document.body.style.color = config.text_color;

      let content = '';
      if (currentView === 'catalog') content = renderCatalog();
      else if (currentView === 'cart') content = renderCart();
      else if (currentView === 'orders') content = renderOrders();
      else if (currentView === 'admin') content = renderAdmin();

      app.innerHTML = content;

      // Renderizar Modal si existe
      const modalContainer = document.getElementById('modalContainer');
      const modalHTML = showModal ? renderModal() : '';
      
      if (modalContainer) {
          modalContainer.innerHTML = modalHTML;
      } else {
          const d = document.createElement('div'); 
          d.id = 'modalContainer';
          document.body.appendChild(d);
          d.innerHTML = modalHTML;
      }
    }
    
    // ... (Se omiten renderCatalog, renderCart y renderAdmin por longitud, ya que no cambiaron de forma cr√≠tica) ...


    // --- VISTA PEDIDOS (EXPANDIDA) ---
    function renderOrders() {
        const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username).reverse();
        const isSeller = currentUser.role !== 'buyer';
        
        return `
        <div class="min-h-full bg-slate-900 text-slate-100 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-blue-400">üì¶ Mis Pedidos</h2>
                    <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded font-bold text-sm border border-slate-600">
                        Volver al Cat√°logo
                    </button>
                </div>

                ${myOrders.length === 0 ? `
                    <div class="text-center py-12 opacity-50 border-2 border-dashed border-slate-700 rounded-xl">
                        <p>No has realizado ninguna compra todav√≠a.</p>
                    </div>
                ` : ''}

                ${myOrders.map((o, index) => {
                    const statusText = o.order_status === 'completed' 
                        ? (o.needs_review ? 'Completado (Pendiente de Rese√±a)' : 'Completado') 
                        : o.seller_confirmed 
                            ? 'Pendiente de tu Confirmaci√≥n' 
                            : 'Esperando Entrega del Vendedor';
                    const statusClass = o.order_status === 'completed'
                        ? (o.needs_review ? 'bg-red-900 text-red-200 border border-red-700 animate-pulse' : 'bg-green-900 text-green-200 border border-green-700')
                        : o.seller_confirmed 
                            ? 'bg-orange-900 text-orange-200 border border-orange-700 animate-pulse'
                            : 'bg-yellow-900 text-yellow-200 border border-yellow-700 animate-pulse';

                    return `
                    <div class="bg-slate-800 p-6 rounded-xl mb-6 border-l-4 shadow-lg transition hover:bg-slate-800/80 ${o.order_status==='completed'?'border-green-500':o.seller_confirmed?'border-orange-500':'border-yellow-500'}">
                        <div class="flex justify-between items-start border-b border-slate-700 pb-4 mb-4">
                            <div>
                                <span class="font-bold text-xl text-white">PEDIDO #${myOrders.length - index}</span>
                                <div class="text-xs text-slate-500 font-mono mt-1">ID: ${o.id}</div>
                            </div>
                            <span class="px-3 py-1 rounded text-sm font-bold uppercase tracking-wider ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Datos del Vendedor</p>
                                <p class="text-lg font-bold text-white flex items-center gap-2">
                                    üë§ ${o.seller_username}
                                </p>
                                <div class="mt-2 inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded border border-purple-500/30 font-mono text-sm">
                                    üì± Discord: ${o.seller_discord}
                                </div>
                            </div>
                             <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Detalle de Items</p>
                                <p class="text-sm font-mono text-slate-300 leading-relaxed">${o.items}</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-between items-center pt-2 gap-4">
                            
                            <button onclick="openChatModal('${o.__backendId}')" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95 text-sm">
                                üí¨ CHAT con Vendedor
                            </button>
                            
                            <div class="text-2xl font-bold text-white flex-1 text-right">
                                Total: <span class="text-green-400">$${o.total.toFixed(2)}</span>
                            </div>

                            ${o.order_status === 'completed' ? `
                                ${o.needs_review ? `
                                    <button onclick="selectedOrder = allOrders.find(ord => ord.__backendId === '${o.__backendId}'); showModal='review'; render();" class="w-full sm:w-auto bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform hover:scale-105">
                                        ‚≠ê DEJAR RESE√ëA
                                    </button>
                                ` : `
                                    <div class="flex items-center gap-2 text-green-400 font-bold bg-green-900/20 px-4 py-2 rounded-lg border border-green-900/50">
                                        <span>‚úÖ Pedido Finalizado</span>
                                    </div>
                                `}
                            ` : `
                                ${o.seller_confirmed ? `
                                    <button onclick="confirmOrder('${o.__backendId}', false)" ${o.buyer_confirmed ? 'disabled' : ''} 
                                        class="w-full sm:w-auto bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95">
                                        ‚úÖ CONFIRMAR QUE RECIB√ç LOS ITEMS
                                    </button>
                                ` : `
                                    <button disabled class="w-full sm:w-auto bg-yellow-700/50 px-6 py-3 rounded-lg font-bold text-white disabled:opacity-100 disabled:cursor-wait">
                                        ‚è≥ Esperando que el Vendedor Entregue/Confirme
                                    </button>
                                `}
                            `}
                        </div>
                    </div>
                `}).join('')}
            </div>
        </div>`;
    }
    
    // ... (Se omiten renderAdmin y otros modals) ...
    
    // --- MODAL: CHAT (ACTUALIZADO PARA SUPABASE) ---
    function renderChatModal() {
        const close = `onclick="closeChatModal(); showModal=null;selectedProductToEdit=null;managedUser=null;selectedOrder=null;render()"`;
        const box = "bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full border border-slate-600 relative transform transition-all scale-100";
        
        if (showModal === 'chat' && chatTargetOrder) {
            const partnerName = chatTargetOrder.buyer_username === currentUser.username ? chatTargetOrder.seller_username : chatTargetOrder.buyer_username;
            const partnerDiscord = chatTargetOrder.buyer_username === currentUser.username ? chatTargetOrder.seller_discord : chatTargetOrder.buyer_discord;
            
            // Renderiza los mensajes cargados en chatMessages
            setTimeout(() => {
                const messagesContainer = document.querySelector('.chat-messages');
                if (messagesContainer) {
                    renderChatMessages(messagesContainer);
                }
            }, 0);
            
            return `
            <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 animate-bounce-in">
                <div class="${box} max-w-lg p-0" onclick="event.stopPropagation()">
                    <div class="bg-slate-900 p-4 rounded-t-xl flex justify-between items-center border-b border-slate-700">
                        <div>
                            <h2 class="text-xl font-bold text-blue-400">üí¨ Chat de Pedido #${chatTargetOrder.id.slice(-8)}</h2>
                            <p class="text-sm text-slate-400">Hablando con: <span class="text-white font-bold">${partnerName}</span> (${partnerDiscord})</p>
                        </div>
                        <button onclick="closeChatModal()" class="text-slate-400 hover:text-white font-bold text-xl">‚úï</button>
                    </div>

                    <div class="p-4 flex flex-col">
                        <div class="chat-messages space-y-2 mb-4 p-2 bg-slate-900/50 rounded-lg border border-slate-700/50">
                            <div class="text-center text-slate-500 text-xs py-10">Cargando historial de mensajes...</div>
                        </div>

                        <form onsubmit="handleChatMessageSend(event)" class="flex gap-2">
                            <input id="chatInput" type="text" placeholder="Escribe tu mensaje..." class="flex-1 p-3 rounded bg-slate-700 text-white border border-slate-600 focus:border-blue-500 outline-none" required autocomplete="off">
                            <button type="submit" class="bg-green-600 hover:bg-green-500 px-4 py-3 rounded font-bold text-white shadow transition">
                                ENVIAR
                            </button>
                        </form>
                         <p class="text-xs text-slate-500 mt-2">‚úÖ Chat conectado a Supabase Realtime.</p>
                    </div>
                </div>
            </div>`;
        }
        
        // ... (El resto de los modals se mantienen) ...

        return '';
    }

    // ---------------------------------------------------------
    // 15. INICIO DE LA APLICACI√ìN
    // ---------------------------------------------------------
    init();
  </script>
 </body>
</html>

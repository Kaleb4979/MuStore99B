<!doctype html>
<html lang="es">
ย<head>
ย <meta charset="UTF-8">
ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย <title>Mu Online 99B Marketplace - V29 (Chat con Supabase Realtime)</title>

ย <script src="https://cdn.tailwindcss.com"></script>
ยย
ย <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
ยย
ย <link rel="preconnect" href="https://fonts.googleapis.com">
ย <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
ย <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
ย
ย <style>
ย ย /* Configuraciรณn Base */
ย ย body {
ย ย ย box-sizing: border-box;
ย ย ย margin: 0;
ย ย ย padding: 0;
ย ย ย height: 100%;
ย ย ย font-family: 'Inter', sans-serif;
ย ย }
ย ย html {
ย ย ย height: 100%;
ย ย }

ย ย /* Animaciones de Botones y Tarjetas */
ย ย .category-btn {
ย ย ย transition: all 0.3s ease;
ย ย }
ย ย .category-btn:hover {
ย ย ย transform: translateY(-2px);
ย ย }

ย ย .product-card {
ย ย ย transition: all 0.3s ease;
ย ย }
ย ย .product-card:hover {
ย ย ย transform: translateY(-5px);
ย ย ย box-shadow: 0 10px 25px rgba(0,0,0,0.3);
ย ย }

ย ย .shop-badge {
ย ย ย ย cursor: pointer;
ย ย ย ย transition: all 0.2s ease;
ย ย }
ย ย .shop-badge:hover {
ย ย ย transform: scale(1.05);
ย ย ย background-color: #4f46e5; /* Indigo-600 */
ย ย }

ย ย /* Spinner de Carga */
ย ย .loading-spinner {
ย ย ย border: 3px solid rgba(255,255,255,0.3);
ย ย ย border-top: 3px solid white;
ย ย ย border-radius: 50%;
ย ย ย width: 20px;
ย ย ย height: 20px;
ย ย ย animation: spin 1s linear infinite;
ย ย }
ย ย @keyframes spin {
ย ย ย 0% { transform: rotate(0deg); }
ย ย ย 100% { transform: rotate(360deg); }
ย ย }

ย ย /* Notificaciรณn en el Carrito */
ย ย .cart-badge {
ย ย ย position: absolute;
ย ย ย top: -8px;
ย ย ย right: -8px;
ย ย ย background-color: #ef4444;
ย ย ย color: white;
ย ย ย border-radius: 50%;
ย ย ย width: 24px;
ย ย ย height: 24px;
ย ย ย display: flex;
ย ย ย align-items: center;
ย ย ย justify-content: center;
ย ย ย font-size: 12px;
ย ย ย font-weight: bold;
ย ย ย box-shadow: 0 2px 5px rgba(0,0,0,0.2);
ย ย }

ย ย /* Fondo Oscuro para Modales */
ย ย .modal-backdrop {
ย ย ย background-color: rgba(0, 0, 0, 0.85);
ย ย ย backdrop-filter: blur(5px);
ย ย }

ย ย /* Estilos para el Ranking (Oro, Plata, Bronce) */
ย ย .rank-1 {
ย ย ย border: 2px solid #FFD700;
ย ย ย box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
ย ย ย background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(0,0,0,0.4));
ย ย }
ย ย .rank-2 {
ย ย ย border: 2px solid #C0C0C0;
ย ย ย box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
ย ย ย background: linear-gradient(145deg, rgba(192,192,192,0.1), rgba(0,0,0,0.4));
ย ย }
ย ย .rank-3 {
ย ย ย border: 2px solid #CD7F32;
ย ย ย box-shadow: 0 0 10px rgba(205, 127, 50, 0.2);
ย ย ย background: linear-gradient(145deg, rgba(205,127,50,0.1), rgba(0,0,0,0.4));
ย ย }

ย ย /* Indicador de Usuario Online (Punto Verde) */
ย ย .live-indicator {
ย ย ย height: 12px;
ย ย ย width: 12px;
ย ย ย background-color: #22c55e; /* Green-500 */
ย ย ย border-radius: 50%;
ย ย ย display: inline-block;
ย ย ย margin-left: 8px;
ย ย ย box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
ย ย ย animation: pulse-green 2s infinite;
ย ย }

ย ย @keyframes pulse-green {
ย ย ย 0% {
ย ย ย ย transform: scale(0.95);
ย ย ย ย box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
ย ย ย }
ย ย ย 70% {
ย ย ย ย transform: scale(1);
ย ย ย ย box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
ย ย ย }
ย ย ย 100% {
ย ย ย ย transform: scale(0.95);
ย ย ย ย box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
ย ย ย }
ย ย }
ย ยย
ย ย /* Animaciรณn Bounce In */
ย ย @keyframes bounceIn {
ย ย ย ย 0% { transform: scale(0.8); opacity: 0; }
ย ย ย ย 60% { transform: scale(1.05); opacity: 1; }
ย ย ย ย 100% { transform: scale(1); }
ย ย }
ย ย .animate-bounce-in {
ย ย ย ย animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
ย ย }
ย ยย
ย ย /* Transiciones de Vista Suaves */
ย ย @view-transition { navigation: auto; }
ย ยย
ย ย /* Estilos del Chat */
ย ย .chat-messages {
ย ย ย ย height: 350px; /* Altura Fija */
ย ย ย ย overflow-y: auto;
ย ย ย ย display: flex;
ย ย ย ย flex-direction: column;
ย ย }
ย ย .message-bubble {
ย ย ย ย max-width: 80%;
ย ย ย ย padding: 8px 12px;
ย ย ย ย border-radius: 18px;
ย ย ย ย margin-bottom: 8px;
ย ย ย ย word-wrap: break-word;
ย ย }
ย ย .message-self {
ย ย ย ย background-color: #3b82f6; /* Blue-500 */
ย ย ย ย color: white;
ย ย ย ย align-self: flex-end;
ย ย ย ย border-bottom-right-radius: 2px;
ย ย }
ย ย .message-other {
ย ย ย ย background-color: #1e293b; /* Slate-800 */
ย ย ย ย color: #f1f5f9;
ย ย ย ย align-self: flex-start;
ย ย ย ย border-bottom-left-radius: 2px;
ย ย }
ย </style>

ย <script>
ย ย // ---------------------------------------------------------
ย ย // 1. CONFIGURACIรN CRรTICA (REEMPLAZAR ESTAS LรNEAS)
ย ย // ---------------------------------------------------------
ย ย // *** ๐จ VERIFICA TUS CREDENCIALES AQUร ๐จ ***
ย ย const BIN_ID = '691ddaa6ae596e708f6321c9';ย
ย ย const SECRET_KEY = '$2a$10$6.Y19X/sB3np.3CIJmbJZesuwRVxU77ns.FyAdL2dUc46k1vWFG9S';ย
ย ย const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

ย ย const DB_KEY = 'mu_marketplace_db_v22_final';ย
ย ย const SESSION_KEY = 'mu_session_user_v22_final';
ย ยย
ย ย // ๐ข CONFIGURACIรN SUPABASE (CHAT REALTIME)
ย ย // *** ๐จ REEMPLAZAR CON SUS CLAVES REALES DE SUPABASE ๐จ ***
ย ย const SUPABASE_URL = 'https://ciysaobejtxfkpmbmswb.supabase.co';ย
ย ย const SUPABASE_ANON_KEY = 'sb_publishable_ZVQXNGvJjurUNtqZNQrnPg_aw_wW9gY';
ย ย const CHAT_TABLE_NAME = 'messages'; // Nombre de tu tabla de mensajes en Supabase
ย ย // ---------------------------------------------------------
ย ยย
ย ย // 2. INICIALIZAR CLIENTE SUPABASE
ย ย let supabase = null;
ย ย if (SUPABASE_URL !== 'https://su_instancia.supabase.co' && SUPABASE_ANON_KEY !== 'su_clave_publica_anonima' && window.supabase) {
ย ย ย ย supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
ย ย ย ย // showToast('โ Cliente Supabase inicializado.'); // Se comenta para evitar spam
ย ย } else {
ย ย ย ย console.warn("Supabase no inicializado. Usando la simulaciรณn local de chat.");
ย ย }
ย ย // ---------------------------------------------------------


ย ย // Base de datos simulada (solo para mantener la estructura, los datos reales vienen del BIN)
ย ย window.mockDb = {
ย ย ย data: [],ย
ย ย ย handler: null,
ย ย ย notify() {}ย
ย ย };

ย ย // SDK de Configuraciรณn Visual (sigue local, no necesita backend)
ย ย window.elementSdk = {
ย ย ย config: {},
ย ย ย init: (options) => {
ย ย ย ย window.elementSdk.config = options.defaultConfig;
ย ย ย ย if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
ย ย ย },
ย ย ย setConfig: (newConfig) => {
ย ย ย ย window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
ย ย ย }
ย ย };

ย ย // ---------------------------------------------------------
ย ย // SDK Base de Datos (Conexiรณn JSONBin) - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ย window.dataSdk = {
ย ย ย ย init: async (handler) => {
ย ย ย ย ย ย window.mockDb.handler = handler;
ย ย ย ย ย ย return window.dataSdk.read(); // Leer los datos al inicio
ย ย ย ย },
ย ย ย ยย
ย ย ย ย // FUNCIรN DE LECTURA: Obtiene todos los datos del BIN
ย ย ย ย read: async () => {
ย ย ย ย ย ย if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
ย ย ย ย ย ย ย ย ยconsole.error("JSONBin Config Error: BIN_ID o SECRET_KEY no configurados.");
ย ย ย ย ย ย ย ย ยshowToast('โ Error de Config: BIN ID o Key faltantes.');
ย ย ย ย ย ย ย ย ยconst localData = localStorage.getItem(DB_KEY);
ย ย ย ย ย ย ย ย ยwindow.mockDb.data = localData ? JSON.parse(localData) : [];
ย ย ย ย ย ย ย ย ยwindow.mockDb.handler.onDataChanged(window.mockDb.data);
ย ย ย ย ย ย ย ย ยreturn { isOk: false };
ย ย ย ย ย ย }

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(JSONBIN_URL + '/latest', {
ย ย ย ย ย ย ย ย ย ย method: 'GET',
ย ย ย ย ย ย ย ย ย ย headers: {
ย ย ย ย ย ย ย ย ย ย ย ย 'X-Master-Key': SECRET_KEYย
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย ย ยconst errorText = await response.text();
ย ย ย ย ย ย ย ย ย ยthrow new Error(`Error ${response.status}: ${errorText}`);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const json = await response.json();
ย ย ย ย ย ย ย ย const data = json.record || [];ย
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Almacenar en localStorage como fallback local y para velocidad
ย ย ย ย ย ย ย ย localStorage.setItem(DB_KEY, JSON.stringify(data));
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Actualizar la DB local y notificar
ย ย ย ย ย ย ย ย window.mockDb.data = data;
ย ย ย ย ย ย ย ย window.mockDb.handler.onDataChanged(data);ย
ย ย ย ย ย ย ย ย return { isOk: true };

ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error("JSONBin READ Error:", error);
ย ย ย ย ย ย ย ย showToast('โ Error al cargar datos remotos. Usando datos locales (LocalStorage).');
ย ย ย ย ย ย ย ย // Si falla la red, usar el รบltimo backup local
ย ย ย ย ย ย ย ย const localData = localStorage.getItem(DB_KEY);
ย ย ย ย ย ย ย ย window.mockDb.data = localData ? JSON.parse(localData) : [];
ย ย ย ย ย ย ย ย window.mockDb.handler.onDataChanged(window.mockDb.data);
ย ย ย ย ย ย ย ย return { isOk: false };
ย ย ย ย ย ย }
ย ย ย ย },
ย ย ย ยย
ย ย ย ย // FUNCIรN DE ESCRITURA: Actualiza TODOS los datos en el BIN
ย ย ย ย write: async (newData) => {
ย ย ย ย ย ย if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
ย ย ย ย ย ย ย ย ยshowToast('โ Error de Config: BIN ID o Key faltantes.');
ย ย ย ย ย ย ย ย ยreturn { isOk: false };
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(JSONBIN_URL, {
ย ย ย ย ย ย ย ย ย ย method: 'PUT', // PUT se usa para reemplazar todo el contenido
ย ย ย ย ย ย ย ย ย ย headers: {
ย ย ย ย ย ย ย ย ย ย ย ย 'Content-Type': 'application/json',
ย ย ย ย ย ย ย ย ย ย ย ย 'X-Master-Key': SECRET_KEY
ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(newData)
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย ย ยconst errorText = await response.text();
ย ย ย ย ย ย ย ย ย ยthrow new Error(`Error ${response.status}: ${errorText}`);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Si la escritura es exitosa, actualizamos localStorage y notificamos
ย ย ย ย ย ย ย ย localStorage.setItem(DB_KEY, JSON.stringify(newData));
ย ย ย ย ย ย ย ย window.mockDb.data = newData;
ย ย ย ย ย ย ย ย window.mockDb.handler.onDataChanged(newData);
ย ย ย ย ย ย ย ย return { isOk: true, item: null }; // Aรฑadir item: null para consistencia si es necesario

ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error("JSONBin WRITE Error:", error);
ย ย ย ย ย ย ย ย showToast('โ Error de conexiรณn/escritura. Vuelve a intentarlo.');
ย ย ย ย ย ย ย ย return { isOk: false };
ย ย ย ย ย ย }
ย ย ย ย },

ย ย ย ย // CREAR: Agrega un item y reescribe todo el BIN
ย ย ย ย create: async (item) => {
ย ย ย ย ย ย item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
ย ย ย ย ย ย const newData = [...window.mockDb.data, item];
ย ย ย ย ย ย const result = await window.dataSdk.write(newData);
ย ย ย ย ย ย return { isOk: result.isOk, item: item };
ย ย ย ย },
ย ย ย ยย
ย ย ย ย // ACTUALIZAR: Modifica un item y reescribe todo el BIN
ย ย ย ย update: async (item) => {
ย ย ย ย ย ย const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
ย ย ย ย ย ย if (index === -1) {
ย ย ย ย ย ย ย ย ยconsole.error("No se encontrรณ el item para actualizar:", item);
ย ย ย ย ย ย ย ย ยshowToast('โ Error: No se encontrรณ el registro para actualizar.');
ย ย ย ย ย ย ย ย ยreturn { isOk: false };
ย ย ย ย ย ย }

ย ย ย ย ย ย const newData = [...window.mockDb.data];
ย ย ย ย ย ย // Clonar para evitar mutar el estado antes de la escritura
ย ย ย ย ย ย newData[index] = {...item};ย
ย ย ย ย ย ย const result = await window.dataSdk.write(newData);
ย ย ย ย ย ย return { isOk: result.isOk, item: result.isOk ? newData[index] : null };
ย ย ย ย },
ย ย ย ยย
ย ย ย ย // BORRAR: Elimina un item y reescribe todo el BIN
ย ย ย ย delete: async (item) => {
ย ย ย ย ย ย const newData = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
ย ย ย ย ย ย const result = await window.dataSdk.write(newData);
ย ย ย ย ย ย return { isOk: result.isOk };
ย ย ย ย }
ย ย };
ย </script>
ย</head>
ย<body>
ย <div id="app" class="min-h-full"></div>
ยย
ย <script>
ย ย // ---------------------------------------------------------
ย ย // 1. CONFIGURACIรN Y CONSTANTES
ย ย // ---------------------------------------------------------
ย ย const defaultConfig = {
ย ย ย site_title: "Mu Online 99B Marketplace",
ย ย ย contact_info: "Contacto: Discord/WhatsApp",
ย ย ย background_color: "#0f172a", // Slate-900
ย ย ย card_background: "#1e293b", // Slate-800
ย ย ย text_color: "#f1f5f9", // Slate-100
ย ย ย primary_button: "#3b82f6", // Blue-500
ย ย ย secondary_button: "#10b981", // Emerald-500
ย ย ย font_family: "Inter",
ย ย ย font_size: 16
ย ย };

ย ย // Variables de Timeout para Auto-Logout
ย ย let inactivityTimeout;
ย ย const TIMEOUT_LIMIT = 5 * 60 * 1000; // 5 minutos

ย ย // ---------------------------------------------------------
ย ย // 2. ESTADO GLOBAL (VARIABLES EN MEMORIA)
ย ย // ---------------------------------------------------------
ย ย let currentUser = null;
ย ย let currentView = 'catalog'; // 'catalog', 'cart', 'orders', 'admin'
ย ย let selectedCategory = 'all';
ย ย let selectedShopFilter = null;
ย ยย
ย ย // Variables para el "Modo Dios" del Admin
ย ย let adminViewTarget = null;ย
ย ย let selectedProductToEdit = null;ย
ย ย let managedUser = null;ย

ย ย // Arrays de datos (Poblados por dataSdk.read)
ย ย let allProducts = [];
ย ย let allUsers = [];
ย ย let allOrders = [];
ย ย let allReviews = [];ย
ย ยย
ย ย // Carrito
ย ย let cart = JSON.parse(localStorage.getItem('mu_cart_v22') || '[]');
ย ยย
ย ย // Control de Modales
ย ย let showModal = null;ย
ย ย let selectedOrder = null;ย
ย ยย
ย ย // ESTADO DEL CHAT
ย ย let chatTargetOrder = null;ย
ย ย let chatMessages = []; // Almacena mensajes
ย ย let chatSubscription = null; // Variable para la suscripciรณn de Supabase
ย ยย
ย ย // Categorรญas del Mu Online
ย ย const CATEGORIES = [
ย ย ย { id: 'all', name: 'Todos', icon: '๐ฎ' },
ย ย ย { id: 'promotions', name: 'Promociones', icon: '๐ฅ' },
ย ย ย { id: 'items', name: 'Items', icon: 'โ๏ธ' },
ย ย ย { id: 'jewels', name: 'Joyas', icon: '๐' },
ย ย ย { id: 'wings', name: 'Alas', icon: '๐ฆ' },
ย ย ย { id: 'sets', name: 'Sets', icon: '๐ก๏ธ' }
ย ย ];

ย ย // MODIFICACIรN CRรTICA: Array de Credenciales de Admin Supremo
ย ย const ADMIN_CREDENTIALS = [
ย ย ย {
ย ย ย ย username: 'Kaleb',
ย ย ย ย password: 'Kaleb.2021',
ย ย ย ย discord_tag: 'KalebAdmin#9999'
ย ย ย },
ย ย ย // --- NUEVO ADMIN SUPREMO AรADIDO ---
ย ย ย {
ย ย ย ย username: 'kilen',
ย ย ย ย password: '03080506000',
ย ย ย ย discord_tag: 'newkilen1'
ย ย ย }
ย ย ];
ย ยย
ย ย // Control de Usuarios Online
ย ย let onlineUsers = new Set();
ย ย let userActivityTimeout = null;

ย ย // ---------------------------------------------------------
ย ย // 3. SDK DE CHAT (INTEGRACIรN SUPABASE REALTIME)
ย ย // ---------------------------------------------------------
ย ย window.chatSdk = {
ย ย ย ยย
ย ย ย ย // FUNCIรN PARA OBTENER EL HISTORIAL DE MENSAJES
ย ย ย ย getMessages: async (orderId) => {
ย ย ย ย ย ย if (!supabase) return [];
ย ย ย ย ย ยย
ย ย ย ย ย ย const { data, error } = await supabase
ย ย ย ย ย ย ย ย .from(CHAT_TABLE_NAME)
ย ย ย ย ย ย ย ย .select('id, sender, content, created_at, order_id')
ย ย ย ย ย ย ย ย .eq('order_id', orderId)
ย ย ย ย ย ย ย ย .order('created_at', { ascending: true });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย if (error) {
ย ย ย ย ย ย ย ย console.error('Error al obtener mensajes de Supabase:', error);
ย ย ย ย ย ย ย ย showToast('โ Error al cargar mensajes del chat.');
ย ย ย ย ย ย ย ย return [];
ย ย ย ย ย ย }
ย ย ย ย ย ย // Mapear created_at a timestamp para mantener consistencia con el cรณdigo original
ย ย ย ย ย ย return data.map(msg => ({
ย ย ย ย ย ย ย ย ...msg,
ย ย ย ย ย ย ย ย timestamp: msg.created_at
ย ย ย ย ย ย }));
ย ย ย ย },

ย ย ย ย // FUNCIรN PARA ENVIAR UN MENSAJE
ย ย ย ย sendMessage: async (orderId, sender, content) => {
ย ย ย ย ย ย if (!supabase || !content.trim()) return;
ย ย ย ย ย ยย
ย ย ย ย ย ย const { error } = await supabase
ย ย ย ย ย ย ย ย .from(CHAT_TABLE_NAME)
ย ย ย ย ย ย ย ย .insert([
ย ย ย ย ย ย ย ย ย ย {
ย ย ย ย ย ย ย ย ย ย ย ย order_id: orderId,
ย ย ย ย ย ย ย ย ย ย ย ย sender: sender,
ย ย ย ย ย ย ย ย ย ย ย ย content: content,
ย ย ย ย ย ย ย ย ย ย ย ย // created_at se genera automรกticamente en Supabase si la columna estรก configurada
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ]);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย if (error) {
ย ย ย ย ย ย ย ย console.error('Error al enviar mensaje a Supabase:', error);
ย ย ย ย ย ย ย ย showToast('โ Error al enviar mensaje.');
ย ย ย ย ย ย }
ย ย ย ย },

ย ย ย ย // MANEJADOR DE CAMBIOS DE REALTIME
ย ย ย ย handleRealtimeChange: (payload) => {
ย ย ย ย ย ย console.log('Realtime Change:', payload);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (payload.eventType === 'INSERT' && payload.new) {
ย ย ย ย ย ย ย ย const newMessage = {
ย ย ย ย ย ย ย ย ย ย id: payload.new.id,
ย ย ย ย ย ย ย ย ย ย sender: payload.new.sender,
ย ย ย ย ย ย ย ย ย ย content: payload.new.content,
ย ย ย ย ย ย ย ย ย ย timestamp: payload.new.created_at || new Date().toISOString()
ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Solo aรฑadir si no existe (evita duplicados si se refresca la vista despuรฉs de un INSERT)
ย ย ย ย ย ย ย ย if (!chatMessages.find(msg => msg.id === newMessage.id)) {
ย ย ย ย ย ย ย ย ย ย chatMessages.push(newMessage);
ย ย ย ย ย ย ย ย ย ย // Esto forza la actualizaciรณn solo del modal de chat si estรก abierto
ย ย ย ย ย ย ย ย ย ย if (showModal === 'chat') {
ย ย ย ย ย ย ย ย ย ย ย ย const messagesContainer = document.querySelector('.chat-messages');
ย ย ย ย ย ย ย ย ย ย ย ย if (messagesContainer) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย renderChatMessages(messagesContainer);
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย },

ย ย ย ย // FUNCIรN PARA INICIAR LA SUSCRIPCIรN EN TIEMPO REAL
ย ย ย ย subscribeToOrder: async (orderId) => {
ย ย ย ย ย ย if (!supabase) {
ย ย ย ย ย ย ย ย showToast('โ๏ธ Supabase no configurado. Chat en modo simulado/local.');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // 1. Limpiar suscripciรณn anterior si existe
ย ย ย ย ย ย window.chatSdk.unsubscribe();
ย ย ย ย ย ยย
ย ย ย ย ย ย // 2. Cargar mensajes iniciales
ย ย ย ย ย ย chatMessages = await window.chatSdk.getMessages(orderId);
ย ย ย ย ย ยย
ย ย ย ย ย ย // 3. Crear la suscripciรณn al canal
ย ย ย ย ย ย chatSubscription = supabase
ย ย ย ย ย ย ย ย .channel(`chat-order-${orderId}`) // Un canal รบnico para cada orden
ย ย ย ย ย ย ย ย .on(
ย ย ย ย ย ย ย ย ย ย 'postgres_changes',
ย ย ย ย ย ย ย ย ย ย { event: 'INSERT', schema: 'public', table: CHAT_TABLE_NAME, filter: `order_id=eq.${orderId}` },
ย ย ย ย ย ย ย ย ย ย window.chatSdk.handleRealtimeChange
ย ย ย ย ย ย ย ย )
ย ย ย ย ย ย ย ย .subscribe();
ย ย ย ย ย ยย
ย ย ย ย ย ย showToast('๐ฌ Chat Realtime iniciado con Supabase.');
ย ย ย ย },

ย ย ย ย // FUNCIรN PARA CERRAR LA SUSCRIPCIรN
ย ย ย ย unsubscribe: () => {
ย ย ย ย ย ย if (chatSubscription) {
ย ย ย ย ย ย ย ย supabase.removeChannel(chatSubscription);
ย ย ย ย ย ย ย ย chatSubscription = null;
ย ย ย ย ย ย ย ย // console.log('Chat Subscription Unsubscribed');
ย ย ย ย ย ย }
ย ย ย ย }
ย ย };
ย ย // ---------------------------------------------------------


ย ย // ---------------------------------------------------------
ย ย // 4. MANEJADOR DE DATOS (JSONBin) - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ย const dataHandler = {
ย ย ย onDataChanged(data) {
ย ย ย ย // Separar los datos por tipo
ย ย ย ย allProducts = data.filter(item => item.type === 'product') || [];
ย ย ย ย allUsers = data.filter(item => item.type === 'user') || [];
ย ย ย ย allOrders = data.filter(item => item.type === 'order') || [];
ย ย ย ย allReviews = data.filter(item => item.type === 'review') || [];ย
ย ย ย ย const activityRecords = data.filter(item => item.type === 'activity') || [];
ย ย ย ยย
ย ย ย ย // Notificaciones en tiempo real
ย ย ย ย if (currentUser) {
ย ย ย ย ย ย const newOrderAlert = activityRecords.find(a =>ย
ย ย ย ย ย ย ย ย a.type === 'activity' &&
ย ย ย ย ย ย ย ย a.message &&ย
ย ย ย ย ย ย ย ย !a.dismissed &&ย
ย ย ย ย ย ย ย ย (a.username === currentUser.username || currentUser.role === 'admin')ย
ย ย ย ย ย ย );

ย ย ย ย ย ย if (newOrderAlert) {
ย ย ย ย ย ย ย ย showToast(`๐ ${newOrderAlert.message}`);
ย ย ย ย ย ย ย ย // Marcar como visto para que no salga de nuevo
ย ย ย ย ย ย ย ย const updatedAlert = {...newOrderAlert, dismissed: true};
ย ย ย ย ย ย ย ย // Usar update, pero sin esperar el resultado para no bloquear el flujo
ย ย ย ย ย ย ย ย window.dataSdk.update(updatedAlert);ย
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย // Calcular quiรฉn estรก online (actividad < 5 min)
ย ย ย ย const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
ย ย ย ย onlineUsers = new Set(
ย ย ย ย ย activityRecords
ย ย ย ย ย ย .filter(a => a.type === 'activity' && new Date(a.last_activity).getTime() > fiveMinutesAgo)
ย ย ย ย ย ย .map(a => a.username)
ย ย ย ย );
ย ย ย ยย
ย ย ย ย // Funciones de refresco
ย ย ย ย validateCart(); // Chequear si algo en el carrito cambiรณ de precio o stock
ย ย ย ย render(); // Volver a pintar la pantalla
ย ย ย }
ย ย };

ย ย // ---------------------------------------------------------
ย ย // 5. INICIALIZACIรN (ARRANQUE) - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ย async function init() {
ย ย ย // Intentar recuperar sesiรณn guardada
ย ย ย const storedUser = localStorage.getItem(SESSION_KEY);
ย ย ย if (storedUser) {
ย ย ย ย currentUser = JSON.parse(storedUser);
ย ย ย ย showToast(`๐ Sesiรณn restaurada: ${currentUser.username}`);
ย ย ย }

ย ย ย // Configurar listeners de inactividad
ย ย ย setupAutoLogout();

ย ย ย // Conectar a la "Base de Datos" (JSONBin)
ย ย ย await window.dataSdk.init(dataHandler);
ย ย ยย
ย ย ย // Configurar SDK visual
ย ย ย if (window.elementSdk) {
ย ย ย ย window.elementSdk.init({
ย ย ย ย ย defaultConfig,
ย ย ย ย ย onConfigChange: async (config) => {
ย ย ย ย ย ย document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
ย ย ย ย ย ย document.body.style.color = config.text_color || defaultConfig.text_color;
ย ย ย ย ย ย const baseSize = config.font_size || defaultConfig.font_size;
ย ย ย ย ย ย document.body.style.fontSize = `${baseSize}px`;
ย ย ย ย ย ย render();
ย ย ย ย ย }
ย ย ย ย });
ย ย ย }
ย ย ยย
ย ย ย if (currentUser) updateUserActivity();
ย ย ย render();
ย ย }

ย ย function setupAutoLogout() {
ย ย ย ย const events = ['mousemove', 'keypress', 'click', 'scroll'];
ย ย ย ย events.forEach(event => document.addEventListener(event, resetTimer));
ย ย ย ย resetTimer();
ย ย }

ย ย function resetTimer() {
ย ย ย ย if (currentUser) {
ย ย ย ย ย ย clearTimeout(inactivityTimeout);
ย ย ย ย ย ย inactivityTimeout = setTimeout(() => logout(true), TIMEOUT_LIMIT);
ย ย ย ย }
ย ย }

ย ย // ---------------------------------------------------------
ย ย // 6. FUNCIONES DE USUARIO (LOGIN/REGISTRO/LOGOUT) - MODIFICADO
ย ย // ---------------------------------------------------------
ย ย async function handleLogin(e) {
ย ย ย e.preventDefault();
ย ย ย const username = document.getElementById('loginUsername').value.trim();
ย ย ย const password = document.getElementById('loginPassword').value;

ย ย ย // MODIFICACIรN: Caso Especial: Login Admin Hardcodeado (Busca en el array)
ย ย ย const matchedAdmin = ADMIN_CREDENTIALS.find(admin => 
ย ย ย ย admin.username === username && admin.password === password
ย ย ย );

ย ย ย if (matchedAdmin) {
ย ย ย ย currentUser = {ย
ย ย ย ย ย ย username: matchedAdmin.username, 
ย ย ย ย ย ย role: 'admin',ย
ย ย ย ย ย ย __backendId: 'admin_' + matchedAdmin.username,
ย ย ย ย ย ย discord_tag: matchedAdmin.discord_tagย
ย ย ย ย };
ย ย ย ย localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
ย ย ย ย showModal = null;
ย ย ย ย currentView = 'admin';
ย ย ย ย showToast('Bienvenido Admin Supremo (Modo Dios Activo)');
ย ย ย ย await updateUserActivity();
ย ย ย ย render();
ย ย ย ย return;
ย ย ย }

ย ย ย // Login Normal
ย ย ย const user = allUsers.find(u => u.username === username && u.password === password);
ย ย ย if (user) {
ย ย ย ย if (user.status === 'banned') {
ย ย ย ย ย ย showToast('๐ซ Tu cuenta ha sido suspendida/baneada.');
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย if (user.role === 'reseller' && !user.approved) {
ย ย ย ย ย showToast('Tu cuenta aรบn no ha sido aprobada por el Admin.');
ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย // Guardamos sesiรณn con datos frescos
ย ย ย ย currentUser = {ย
ย ย ย ย ย username: user.username,
ย ย ย ย ย role: user.role,
ย ย ย ย ย shop_name: user.shop_name,
ย ย ย ย ย discord_tag: user.discord_tag || 'No Informado',ย
ย ย ย ย ย __backendId: user.__backendId
ย ย ย ย };
ย ย ย ย localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
ย ย ย ยย
ย ย ย ย // Si es vendedor sin configurar o pendiente de aprobaciรณn (pero ya tiene usuario)
ย ย ย ย if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
ย ย ย ย ย selectedOrder = user;
ย ย ย ย ย showModal = 'setupShop';
ย ย ย ย ย showToast('Por favor configura tu tienda para continuar');
ย ย ย ย ย render();
ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย showModal = null;
ย ย ย ย if (user.role === 'reseller' || user.role === 'admin') {
ย ย ย ย ย currentView = 'admin';
ย ย ย ย }
ย ย ย ย showToast(`Bienvenido ${username}`);
ย ย ย ยย
ย ย ย ย await updateUserActivity();
ย ย ย ย render();
ย ย ย } else {
ย ย ย ย showToast('Usuario o contraseรฑa incorrectos');
ย ย ย }
ย ย }

ย ย async function handleRegisterBuyer(e) {
ย ย ย e.preventDefault();
ย ย ย const username = document.getElementById('buyerUsername').value.trim();
ย ย ย const password = document.getElementById('buyerPassword').value;
ย ย ย const discord = document.getElementById('buyerDiscord').value.trim();

ย ย ย if (allUsers.find(u => u.username === username)) {
ย ย ย ย showToast('El usuario ya existe');
ย ย ย ย return;
ย ย ย }
ย ย ย if (allUsers.find(u => u.discord_tag === discord)) {
ย ย ย ย showToast('El Discord ya estรก registrado.');
ย ย ย ย return;
ย ย ย }

ย ย ย const userData = {
ย ย ย ย id: Date.now().toString(),
ย ย ย ย type: 'user',
ย ย ย ย username,
ย ย ย ย password,
ย ย ย ย discord_tag: discord || 'No Informado',ย
ย ย ย ย profile_picture: '',
ย ย ย ย role: 'buyer',
ย ย ย ย approved: true,
ย ย ย ย status: 'active',
ย ย ย ย created_at: new Date().toISOString()
ย ย ย };

ย ย ย const result = await window.dataSdk.create(userData);
ย ย ย if (result.isOk) {
ย ย ย ย showToast('Registro exitoso! Ahora puedes iniciar sesiรณn');
ย ย ย ย showModal = 'login';
ย ย ย ย render();
ย ย ย } else {
ย ย ย ย showToast('Error al registrar usuario');
ย ย ย }
ย ย }

ย ย async function handleRegisterReseller(e) {
ย ย ย e.preventDefault();
ย ย ย const username = document.getElementById('resellerUsername').value.trim();
ย ย ย const password = document.getElementById('resellerPassword').value;
ย ย ย const discord = document.getElementById('resellerDiscord').value.trim();
ย ย ย const shopName = document.getElementById('resellerShop').value.trim();

ย ย ย if (allUsers.find(u => u.username === username)) {
ย ย ย ย showToast('El usuario ya existe');
ย ย ย ย return;
ย ย ย }
ย ย ย if (allUsers.find(u => u.discord_tag === discord)) {
ย ย ย ย showToast('El Discord ya estรก registrado.');
ย ย ย ย return;
ย ย ย }

ย ย ย const userData = {
ย ย ย ย id: Date.now().toString(),
ย ย ย ย type: 'user',
ย ย ย ย username,
ย ย ย ย password,
ย ย ย ย discord_tag: discord || 'No Informado',ย
ย ย ย ย shop_name: shopName,
ย ย ย ย profile_picture: '',
ย ย ย ย role: 'reseller',
ย ย ย ย approved: false, // Inicia como no aprobado
ย ย ย ย status: 'pending', // Inicia en pendiente
ย ย ย ย created_at: new Date().toISOString()
ย ย ย };

ย ย ย const result = await window.dataSdk.create(userData);
ย ย ย if (result.isOk) {
ย ย ย ย showToast('Solicitud enviada! Espera aprobaciรณn del admin.');
ย ย ย ย showModal = null;
ย ย ย ย render();
ย ย ย } else {
ย ย ย ย showToast('Error al enviar solicitud');
ย ย ย }
ย ย }

ย ย async function updateUserActivity() {
ย ย ย if (!currentUser) return;
ย ย ยย
ย ย ย const activityRecords = window.mockDb.data.filter(item => item.type === 'activity');
ย ย ย const existingActivity = activityRecords.find(a => a.username === currentUser.username);
ย ย ยย
ย ย ย const activityData = {
ย ย ย ย id: 'activity_' + currentUser.username,
ย ย ย ย type: 'activity',
ย ย ย ย username: currentUser.username,
ย ย ย ย last_activity: new Date().toISOString()
ย ย ย };
ย ย ยย
ย ย ย // Intenta actualizar si existe, si no, lo crea.
ย ย ย if (existingActivity) {
ย ย ย ย ย ยconst updatedActivity = {...existingActivity, last_activity: new Date().toISOString()};
ย ย ย ย ย ยawait window.dataSdk.update(updatedActivity);
ย ย ย } else {
ย ย ย ย ย ยawait window.dataSdk.create(activityData);
ย ย ย }
ย ย ยย
ย ย ย if (userActivityTimeout) clearTimeout(userActivityTimeout);
ย ย ย userActivityTimeout = setTimeout(updateUserActivity, 3 * 60 * 1000);
ย ย }

ย ย function logout(auto = false) {
ย ย ย if (userActivityTimeout) clearTimeout(userActivityTimeout);
ย ย ย clearTimeout(inactivityTimeout);
ย ย ย currentUser = null;
ย ย ย localStorage.removeItem(SESSION_KEY);
ย ย ย currentView = 'catalog';
ย ย ย cart = [];
ย ย ย localStorage.setItem('mu_cart_v22', '[]');
ย ย ย selectedShopFilter = null;
ย ย ย adminViewTarget = null; // Resetear modo gestiรณn
ย ย ย managedUser = null; // Resetear usuario gestionado
ย ย ย window.chatSdk.unsubscribe(); // Detener el listener del chat
ย ย ย showToast(auto ? '๐ค Sesiรณn cerrada por inactividad' : 'Sesiรณn cerrada');
ย ย ย render();
ย ย }
ย ยย
ย ย // Funciรณn para completar la configuraciรณn de tienda (Admin lo activa o Vendedor lo completa)
ย ย async function handleSetupShop(e) {
ย ย ย e.preventDefault();
ย ย ย const user = selectedOrder; // Usuario que necesita configuraciรณn
ย ย ย if(!user) return;
ย ย ยย
ย ย ย const setupShopNameInput = document.getElementById('setupShopName');
ย ย ย const setupDiscordInput = document.getElementById('setupDiscord');
ย ย ยย
ย ย ย if (!setupShopNameInput || !setupDiscordInput) {
ย ย ย ย ย showToast('Error: Campos de formulario no encontrados.');
ย ย ย ย ย return;
ย ย ย }
ย ย ยย
ย ย ย const shopName = setupShopNameInput.value.trim();
ย ย ย const discord = setupDiscordInput.value.trim();
ย ย ยย
ย ย ย // Validar discord unico (excluyendo al usuario actual)
ย ย ย if(allUsers.find(u => u.discord_tag === discord && u.__backendId !== user.__backendId)) {
ย ย ย ย ย showToast('Este Discord ya estรก en uso por otro usuario.');
ย ย ย ย ย return;
ย ย ย }
ย ย ยย
ย ย ย const updatedUser = {
ย ย ย ย ย ...user,
ย ย ย ย ย shop_name: shopName,
ย ย ย ย ย discord_tag: discord || 'No Informado',
ย ย ย ย ย approved: true,ย
ย ย ย ย ย status: 'active'ย
ย ย ย };
ย ย ยย
ย ย ย const result = await window.dataSdk.update(updatedUser);
ย ย ยย
ย ย ย if (result.isOk) {
ย ย ย ย ย // Si el usuario que completa es el mismo que estรก logueado
ย ย ย ย ย if(currentUser && user.__backendId === currentUser.__backendId) {
ย ย ย ย ย ย ย // Actualizar el estado de la sesiรณn
ย ย ย ย ย ย ย currentUser = updatedUser;
ย ย ย ย ย ย ย localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
ย ย ย ย ย ย ย currentView = 'admin'; // Mover al panel
ย ย ย ย ย }ย
ย ย ย ย ยย
ย ย ย ย ย showModal = null;
ย ย ย ย ย selectedOrder = null;
ย ย ย ย ย showToast('โ Configuraciรณn de tienda guardada. Tienda Activada.');
ย ย ย ย ย render();ย
ย ย ย } else {
ย ย ย ย ย showToast('Error al actualizar la configuraciรณn de la tienda.');
ย ย ย }
ย ย }


ย ย // ---------------------------------------------------------
ย ย // 7. GESTIรN DE PRODUCTOS (CRUD COMPLETO) - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ยย
ย ย // Funciรณn centralizada para abrir la gestiรณn de productos de cualquier usuario
ย ย function openProductManagement(username) {
ย ย ย ย if (currentUser.role === 'admin' && currentUser.username !== username) {
ย ย ย ย ย ย enterShopManagement(username);
ย ย ย ย } else if (currentUser.username === username && (currentUser.role === 'reseller' || currentUser.role === 'admin')) {
ย ย ย ย ย ย currentView = 'admin';
ย ย ย ย ย ย render();
ย ย ย ย } else {
ย ย ย ย ย ย showToast('No tienes permisos para gestionar esta tienda.');
ย ย ย ย }
ย ย ย ย showModal = null;
ย ย }
ย ยย
ย ย async function handleAddProduct(e) {
ย ย ย e.preventDefault();
ย ย ย if (allProducts.length >= 999) {
ย ย ย ย showToast('Lรญmite de productos alcanzado');
ย ย ย ย return;
ย ย ย }

ย ย ย // Determinar quiรฉn es el dueรฑo (Soporte para Admin Gestionando Tienda ajena)
ย ย ย const ownerUsername = adminViewTarget ? adminViewTarget : currentUser.username;
ย ย ย const ownerData = allUsers.find(u => u.username === ownerUsername) || currentUser;

ย ย ย const btn = e.target.querySelector('button[type="submit"]');
ย ย ย btn.disabled = true;
ย ย ย btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

ย ย ย let imageUrl = document.getElementById('productImage').value.trim();
ย ย ย // Asegurar formato de Imgur para display (si es link directo)
ย ย ย if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
ย ย ย ย imageUrl = imageUrl + '.jpg';
ย ย ย }

ย ย ย const discount = parseInt(document.getElementById('productDiscount').value) || 0;
ย ย ย const onSale = document.getElementById('productOnSale').checked;
ย ย ย const originalPrice = parseFloat(document.getElementById('productPrice').value);
ย ย ย const finalPrice = discount > 0 ? originalPrice * (1 - discount / 100) : originalPrice;

ย ย ย const productData = {
ย ย ย ย id: Date.now().toString(),
ย ย ย ย type: 'product',
ย ย ย ย name: document.getElementById('productName').value.trim(),
ย ย ย ย category: document.getElementById('productCategory').value,
ย ย ย ย price: originalPrice,
ย ย ย ย final_price: parseFloat(finalPrice.toFixed(2)), // Fix para evitar errores de coma flotante en precios
ย ย ย ย discount: discount,
ย ย ย ย on_sale: onSale,
ย ย ย ย stock: parseInt(document.getElementById('productStock').value),
ย ย ย ย description: document.getElementById('productDescription').value.trim(),
ย ย ย ย image_url: imageUrl,
ย ย ย ย seller_username: ownerUsername,
ย ย ย ย seller_shop_name: ownerData.shop_name || ownerUsername,
ย ย ย ย seller_discord: ownerData.discord_tag || 'No Informado',
ย ย ย ย created_at: new Date().toISOString()
ย ย ย };

ย ย ย const result = await window.dataSdk.create(productData);
ย ย ย if (result.isOk) {
ย ย ย ย showToast('Producto agregado exitosamente');
ย ย ย ย e.target.reset();
ย ย ย } else {
ย ย ย ย showToast('Error al agregar producto');
ย ย ย }

ย ย ย btn.disabled = false;
ย ย ย btn.innerHTML = 'Publicar Ahora';
ย ย }

ย ย // Funciรณn para Abrir Modal de Ediciรณn
ย ย function openEditModal(backendId) {
ย ย ย ย const product = allProducts.find(p => p.__backendId === backendId);
ย ย ย ย if (!product) return;
ย ย ย ย selectedProductToEdit = product;
ย ย ย ย showModal = 'editProduct';
ย ย ย ย render();
ย ย }

ย ย // Funciรณn para Guardar Cambios del Producto
ย ย async function handleUpdateProduct(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย if (!selectedProductToEdit) return;

ย ย ย ย const price = parseFloat(document.getElementById('editPrice').value);
ย ย ย ย const discount = parseInt(document.getElementById('editDiscount').value) || 0;
ย ย ย ยย
ย ย ย ย let imageUrl = document.getElementById('editImage').value.trim();
ย ย ย ย if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
ย ย ย ย ย ย imageUrl += '.jpg';
ย ย ย ย }
ย ย ย ยย
ย ย ย ย const finalPrice = discount > 0 ? price * (1 - discount / 100) : price;

ย ย ย ย const updatedProduct = {
ย ย ย ย ย ย ...selectedProductToEdit,
ย ย ย ย ย ย name: document.getElementById('editName').value.trim(),
ย ย ย ย ย ย stock: parseInt(document.getElementById('editStock').value),
ย ย ย ย ย ย price: price,
ย ย ย ย ย ย discount: discount,
ย ย ย ย ย ย final_price: parseFloat(finalPrice.toFixed(2)), // Fix para consistencia
ย ย ย ย ย ย description: document.getElementById('editDescription').value.trim(),
ย ย ย ย ย ย image_url: imageUrl,
ย ย ย ย ย ย on_sale: document.getElementById('editOnSale').checked
ย ย ย ย };

ย ย ย ย const result = await window.dataSdk.update(updatedProduct);
ย ย ย ยย
ย ย ย ย if (result.isOk) {
ย ย ย ย ย ย showToast('โ Producto actualizado correctamente');
ย ย ย ย ย ย showModal = null;
ย ย ย ย ย ย selectedProductToEdit = null;
ย ย ย ย } else {
ย ย ย ย ย ย showToast('Error al actualizar producto');
ย ย ย ย }
ย ย }

ย ย async function deleteProduct(backendId) {
ย ย ย if(!confirm("ยฟEstรกs seguro de borrar este producto?")) return;
ย ย ยย
ย ย ย const product = allProducts.find(p => p.__backendId === backendId);
ย ย ย if (!product) return;
ย ย ยย
ย ย ย const result = await window.dataSdk.delete(product);ย
ย ย ย if (result.isOk) {
ย ย ย ย showToast('Producto eliminado');
ย ย ย } else {
ย ย ย ย showToast('Error al eliminar producto');
ย ย ย }
ย ย }

ย ย // ---------------------------------------------------------
ย ย // 8. GESTIรN DE USUARIOS (ADMIN) - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ยย
ย ย // Nueva funciรณn para abrir el modal de gestiรณn
ย ย function openManageUserModal(username) {
ย ย ย ย managedUser = allUsers.find(u => u.username === username);
ย ย ย ย if (!managedUser) {
ย ย ย ย ย ย showToast('Usuario no encontrado.');
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ย showModal = 'manageUser';
ย ย ย ย render();
ย ย }
ย ยย
ย ย // Funciรณn para eliminar todos los pedidos completados (LOG HISTรRICO)
ย ย async function clearCompletedOrdersLog() {
ย ย ย ย if (!currentUser || currentUser.role !== 'admin') {
ย ย ย ย ย ย showToast('Acceso denegado.');
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย if (!confirm("โ๏ธ ยกADVERTENCIA CRรTICA!\n\nEsta acciรณn eliminarรก PERMANENTEMENTE TODOS los pedidos con estado 'COMPLETADO' (Log Histรณrico). ยฟEstรกs seguro de continuar?")) {
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย showToast('Limpiando log de pedidos completados...');
ย ย ย ยย
ย ย ย ย const ordersToDelete = allOrders.filter(o => o.order_status === 'completed');
ย ย ย ยย
ย ย ย ย // Crear una nueva lista de datos sin los pedidos completados
ย ย ย ย const newDbData = window.mockDb.data.filter(item =>ย
ย ย ย ย ย ย item.type !== 'order' || item.order_status !== 'completed'
ย ย ย ย );
ย ย ย ยย
ย ย ย ย const result = await window.dataSdk.write(newDbData);
ย ย ย ยย
ย ย ย ย if (result.isOk) {
ย ย ย ย ย ย showToast(`โ Log Histรณrico de ${ordersToDelete.length} pedidos eliminado exitosamente.`);
ย ย ย ย } else {
ย ย ย ย ย ย showToast('โ Error al eliminar el log histรณrico. Verifica el BIN.');
ย ย ย ย }
ย ย }
ย ยย
ย ย async function approveUser(backendId) {
ย ย ย ย const user = allUsers.find(u => u.__backendId === backendId);
ย ย ย ย if (!user) {
ย ย ย ย ย ย showToast('โ Usuario no encontrado o ID no vรกlido.');
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย // Si el vendedor no tiene nombre de tienda o discord, forzar setup (Admin lo puede hacer por รฉl o forzar que lo haga)
ย ย ย ย if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
ย ย ย ย ย ย selectedOrder = user;
ย ย ย ย ย ย showModal = 'setupShop';
ย ย ย ย ย ย showToast('El vendedor necesita completar la configuraciรณn de su tienda antes de la activaciรณn final.');
ย ย ย ย ย ย render();
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย const updatedUser = { ...user, status: 'active', approved: true };
ย ย ย ย const result = await window.dataSdk.update(updatedUser);
ย ย ย ย if (result.isOk) {
ย ย ย ย ย ย showToast('โ Usuario ACEPTADO y activado');
ย ย ย ย } else {
ย ย ย ย ย ย showToast('โ Error al actualizar usuario. Verifica el estado del BIN.');
ย ย ย ย }
ย ย ย ย showModal = null; // Cerrar cualquier modal que estรฉ abierto
ย ย }

ย ย async function rejectUser(backendId) {
ย ย ย ย deleteUserAccount(backendId);
ย ย }

ย ย async function banUser(backendId) {
ย ย ย ย const user = allUsers.find(u => u.__backendId === backendId);
ย ย ย ย if (!user) return;
ย ย ย ย let updatedUser;
ย ย ย ย if(user.status === 'banned') {
ย ย ย ย ย ย updatedUser = {...user, status: 'active', approved: true};
ย ย ย ย ย ย await window.dataSdk.update(updatedUser);
ย ย ย ย ย ย showToast('Usuario desbaneado (activo)');
ย ย ย ย } else {
ย ย ย ย ย ย updatedUser = {...user, status: 'banned', approved: false};
ย ย ย ย ย ย await window.dataSdk.update(updatedUser);
ย ย ย ย ย ย showToast('๐ซ Usuario BANEADO exitosamente');
ย ย ย ย }
ย ย ย ย showModal = null;
ย ย }

ย ย async function deleteUserAccount(backendId) {
ย ย ย ย if(!confirm("โ๏ธ ยกADVERTENCIA DE SEGURIDAD!\n\nยฟEstรกs COMPLETAMENTE SEGURO de eliminar este usuario?\nEsta acciรณn borrarรก su cuenta y TODOS sus productos.")) return;
ย ย ย ยย
ย ย ย ย const user = allUsers.find(u => u.__backendId === backendId);
ย ย ย ย if (!user) return;

ย ย ย ย if(user.role === 'reseller') {
ย ย ย ย ย ย const userProducts = allProducts.filter(p => p.seller_username === user.username);
ย ย ย ย ย ย // El dataSDK.delete elimina de la lista y reescribe, esto es costoso
ย ย ย ย ย ย for(const p of userProducts) {
ย ย ย ย ย ย ย ย await window.dataSdk.delete(p);
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย const result = await window.dataSdk.delete(user);
ย ย ย ย if (result.isOk) showToast('๐๏ธ Cuenta eliminada correctamente');
ย ย ย ย showModal = null;
ย ย }
ย ยย
ย ย // --- FUNCIONES DE MODO DIOS (ADMIN ENTRA EN TIENDA) ---
ย ย function enterShopManagement(targetUsername) {
ย ย ย ย adminViewTarget = targetUsername;
ย ย ย ย showToast(`๐๏ธ Gestionando tienda de: ${targetUsername}`);
ย ย ย ย showModal = null;
ย ย ย ย currentView = 'admin';
ย ย ย ย render();
ย ย }
ย ยย
ย ย function exitShopManagement() {
ย ย ย ย adminViewTarget = null;
ย ย ย ย showToast('๐ Volviendo a vista global');
ย ย ย ย render();
ย ย }
ย ยย
ย ย // Funciรณn para refrescar datos en la vista Admin
ย ย async function loadAdminView() {
ย ย ย ย showToast('๐ Sincronizando datos remotos...');
ย ย ย ย // Forzamos la lectura para asegurar los รบltimos cambios de usuarios/pedidos
ย ย ย ย const result = await window.dataSdk.read();ย
ย ย ย ยย
ย ย ย ย if (result.isOk) {
ย ย ย ย ย ย ยshowToast('โ Sincronizaciรณn completa.');
ย ย ย ย } else {
ย ย ย ย ย ย ยshowToast('โ๏ธ No se pudo sincronizar la lista de usuarios del BIN.');
ย ย ย ย }
ย ย ย ยย
ย ย ย ย currentView = 'admin';
ย ย ย ย render();
ย ย }

ย ย // ---------------------------------------------------------
ย ย // 9. CARRITO Y PEDIDOS - SIN CAMBIOS RELEVANTES
ย ย // ---------------------------------------------------------
ย ย function updateCartStorage() {
ย ย ย ย localStorage.setItem('mu_cart_v22', JSON.stringify(cart));
ย ย }

ย ย function validateCart() {
ย ย ย ย if (cart.length === 0) return;
ย ย ย ย let cartModified = false;
ย ย ย ยย
ย ย ย ย const newCart = cart.filter(cartItem => {
ย ย ย ย ย ย const correspondingProduct = allProducts.find(p => p.__backendId === cartItem.__backendId);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!correspondingProduct) {
ย ย ย ย ย ย ย ย showToast(`โ El item "${cartItem.name}" ha sido eliminado del catรกlogo.`);
ย ย ย ย ย ย ย ย cartModified = true;
ย ย ย ย ย ย ย ย return false;ย
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย if (cartItem.quantity > correspondingProduct.stock) {
ย ย ย ย ย ย ย ย cartItem.quantity = correspondingProduct.stock;
ย ย ย ย ย ย ย ย cartModified = true;
ย ย ย ย ย ย ย ย if (cartItem.quantity === 0) return false;
ย ย ย ย ย ย ย ย showToast(`โ๏ธ Stock de "${cartItem.name}" limitado a ${cartItem.quantity}.`);
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // Sincronizar precios en vivo
ย ย ย ย ย ย if (cartItem.price !== correspondingProduct.price || cartItem.final_price !== correspondingProduct.final_price) {
ย ย ย ย ย ย ย ย cartItem.price = correspondingProduct.price;
ย ย ย ย ย ย ย ย cartItem.final_price = correspondingProduct.final_price;
ย ย ย ย ย ย ย ย cartItem.name = correspondingProduct.name;
ย ย ย ย ย ย ย ย cartModified = true;
ย ย ย ย ย ย }
ย ย ย ย ย ย return true;
ย ย ย ย });
ย ย ย ยย
ย ย ย ย if (cartModified) {
ย ย ย ย ย ย cart = newCart;
ย ย ย ย ย ย updateCartStorage();
ย ย ย ย }
ย ย }

ย ย function addToCart(backendId) {
ย ย ย if (!currentUser) {
ย ย ย ย showToast('Inicia sesiรณn para agregar al carrito');
ย ย ย ย showModal = 'login';
ย ย ย ย render();
ย ย ย ย return;
ย ย ย }

ย ย ย const product = allProducts.find(p => p.__backendId === backendId);
ย ย ย if (!product || product.stock <= 0) {
ย ย ย ย showToast('Producto sin stock');
ย ย ย ย return;
ย ย ย }

ย ย ย const existing = cart.find(item => item.__backendId === backendId);
ย ย ย if (existing) {
ย ย ย ย if (existing.quantity < product.stock) {
ย ย ย ย ย existing.quantity++;
ย ย ย ย ย showToast('Cantidad actualizada');
ย ย ย ย } else {
ย ย ย ย ย showToast('No hay mรกs stock disponible');
ย ย ย ย }
ย ย ย } else {
ย ย ย ย cart.push({ ...product, quantity: 1 });
ย ย ย ย showToast('Agregado al carrito');
ย ย ย }
ย ย ย updateCartStorage();
ย ย ย render();
ย ย }

ย ย function removeFromCart(index) {
ย ย ย cart.splice(index, 1);
ย ย ย updateCartStorage();
ย ย ย render();
ย ย }

ย ย // FILTROS
ย ย function filterByShop(shopName) {
ย ย ย ย selectedShopFilter = shopName;
ย ย ย ย selectedCategory = 'all';ย
ย ย ย ย showToast(`๐ Viendo tienda: ${shopName}`);
ย ย ย ย render();
ย ย }

ย ย function clearShopFilter() {
ย ย ย ย selectedShopFilter = null;
ย ย ย ย render();
ย ย }

ย ย // CREAR PEDIDO
ย ย async function createOrder() {
ย ย ย if (cart.length === 0) return;
ย ย ย validateCart();ย
ย ย ย if (cart.length === 0) return;

ย ย ย // Agrupar productos por vendedor
ย ย ย const ordersBySeller = {};
ย ย ย cart.forEach(item => {
ย ย ย ย if (!ordersBySeller[item.seller_username]) {
ย ย ย ย ย ordersBySeller[item.seller_username] = {
ย ย ย ย ย ย seller: item.seller_username,
ย ย ย ย ย ย discord: item.seller_discord,
ย ย ย ย ย ย items: [],
ย ย ย ย ย ย total: 0
ย ย ย ย ย };
ย ย ย ย }
ย ย ย ย const itemPrice = item.discount > 0 ? item.final_price : item.price;
ย ย ย ย ordersBySeller[item.seller_username].items.push(item);
ย ย ย ย ordersBySeller[item.seller_username].total += itemPrice * item.quantity;
ย ย ย });

ย ย ย let allOk = true;
ย ย ย for (const sellerUsername in ordersBySeller) {
ย ย ย ย const orderInfo = ordersBySeller[sellerUsername];
ย ย ย ย const itemsDesc = orderInfo.items.map(item => {
ย ย ย ย ย return `${item.name} x${item.quantity} ($${(item.final_price * item.quantity).toFixed(2)})`;
ย ย ย ย }).join(' | ');

ย ย ย ย const itemsData = JSON.stringify(orderInfo.items.map(item => ({
ย ย ย ย ย backendId: item.__backendId,
ย ย ย ย ย name: item.name,
ย ย ย ย ย quantity: item.quantity
ย ย ย ย })));

ย ย ย ย // Asegurar Discord del Comprador y Vendedor
ย ย ย ย const buyerDiscord = currentUser.discord_tag || 'No Informado';
ย ย ย ย const sellerDiscord = orderInfo.discord || 'No Informado';

ย ย ย ย const orderData = {
ย ย ย ย ย id: Date.now().toString() + '_' + sellerUsername,
ย ย ย ย ย type: 'order',
ย ย ย ย ย buyer_username: currentUser.username,
ย ย ย ย ย buyer_discord: buyerDiscord,ย
ย ย ย ย ย seller_username: sellerUsername,
ย ย ย ย ย seller_discord: sellerDiscord,
ย ย ย ย ย items: itemsDesc,
ย ย ย ย ย items_data: itemsData,
ย ย ย ย ย total: parseFloat(orderInfo.total.toFixed(2)), // Fix para consistencia
ย ย ย ย ย order_status: 'pending',
ย ย ย ย ย seller_confirmed: false,
ย ย ย ย ย buyer_confirmed: false,
ย ย ย ย ย needs_review: false,ย
ย ย ย ย ย created_at: new Date().toISOString()
ย ย ย ย };

ย ย ย ย const result = await window.dataSdk.create(orderData);
ย ย ย ย if (!result.isOk) {
ย ย ย ย ย allOk = false;
ย ย ย ย } else {
ย ย ย ย ย ย // Notificaciรณn Interna para el vendedor
ย ย ย ย ย ย const notificationData = {
ย ย ย ย ย ย ย ย id: 'ntf_' + Date.now(),ย
ย ย ย ย ย ย ย ย type: 'activity',
ย ย ย ย ย ย ย ย username: sellerUsername,ย
ย ย ย ย ย ย ย ย message: `ยกNUEVO PEDIDO de ${currentUser.username}!`,
ย ย ย ย ย ย ย ย dismissed: false,ย
ย ย ย ย ย ย ย ย created_at: new Date().toISOString()
ย ย ย ย ย ย };
ย ย ย ย ย ย await window.dataSdk.create(notificationData);
ย ย ย ย }
ย ย ย }

ย ย ย if (!allOk) {
ย ย ย ย ย showToast('Error al crear uno o mรกs pedidos');
ย ย ย ย ย return;
ย ย ย }

ย ย ย showToast('Pedido(s) creado(s) exitosamente! Esperando confirmaciรณn del vendedor.');
ย ย ย cart = [];
ย ย ย updateCartStorage();
ย ย ย currentView = 'orders';
ย ย ย render();
ย ย }

ย ย async function confirmOrder(backendId, isSeller) {
ย ย ย const order = allOrders.find(o => o.__backendId === backendId);
ย ย ย if (!order) return;

ย ย ย let updatedOrder = {...order};

ย ย ย if (isSeller) {
ย ย ย ย // Vendedor confirma entrega (PRIMER PASO)
ย ย ย ย updatedOrder.seller_confirmed = true;
ย ย ย ย showToast('Vendedor confirma entrega. ยกAhora el comprador debe confirmar recepciรณn!');
ย ย ย } else {
ย ย ย ย // Comprador confirma recepciรณn (SEGUNDO PASO)
ย ย ย ย if (!order.seller_confirmed) {
ย ย ย ย ย ย showToast('โ๏ธ Error: El vendedor aรบn no ha marcado el pedido como entregado. Esto es obligatorio para confirmar la recepciรณn.');
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ย updatedOrder.buyer_confirmed = true;
ย ย ย }

ย ย ย const result = await window.dataSdk.update(updatedOrder);ย
ย ย ยย
ย ย ย if (result.isOk) {
ย ย ย ย ย // SI AMBOS CONFIRMARON, RESTAR STOCK Y FINALIZAR
ย ย ย ย ย if (result.item.seller_confirmed && result.item.buyer_confirmed && result.item.order_status !== 'completed') {
ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย const completedOrder = {...result.item, order_status: 'completed', needs_review: true}; // <-- needs_review activado
ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const itemsData = JSON.parse(completedOrder.items_data);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 1. Restar Stock de todos los productos
ย ย ย ย ย ย ย ย for (const item of itemsData) {
ย ย ย ย ย ย ย ย ย const product = allProducts.find(p => p.__backendId === item.backendId);
ย ย ย ย ย ย ย ย ย if (product) {
ย ย ย ย ย ย ย ย ย ย const updatedProduct = {...product, stock: Math.max(0, product.stock - item.quantity)};
ย ย ย ย ย ย ย ย ย ย // Disparamos la actualizaciรณn de producto, pero no esperamos.
ย ย ย ย ย ย ย ย ย ย window.dataSdk.update(updatedProduct);ย
ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 2. Actualizar el estado de la orden a completada
ย ย ย ย ย ย ย ย await window.dataSdk.update(completedOrder);ย
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย showToast('โ ยกPedido completado y Stock actualizado! Tienda entra en el Ranking.');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // ๐จ OPTIMIZACIรN CRรTICA: Forzar recarga completa de datos del BIN
ย ย ย ย ย ย ย ย await window.dataSdk.read();ย

ย ย ย ย ย ย ย } catch (e) {ย
ย ย ย ย ย ย ย ย console.error("Error al procesar stock o actualizar orden final:", e);
ย ย ย ย ย ย ย ย showToast("Error crรญtico al finalizar la orden. Stock no actualizado.");
ย ย ย ย ย ย ย }
ย ย ย ย ย } else if (result.item.buyer_confirmed) {
ย ย ย ย ย ย ย showToast('โ Recepciรณn de items confirmada. Esperando finalizaciรณn de la venta.');
ย ย ย ย ย } else if (result.item.seller_confirmed) {
ย ย ย ย ย ย ย// El vendedor ya confirmรณ, el toast ya se mostrรณ arriba.
ย ย ย ย ย }
ย ย ย }
ย ย ย render();
ย ย }

ย ย // ---------------------------------------------------------
ย ย // 10. FUNCIONES DE RESEรA - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ย function getShopRating(username) {
ย ย ย ย const reviews = allReviews.filter(r => r.reviewed_seller === username);
ย ย ย ย const avg = reviews.length ? (reviews.reduce((a,b)=>a+b.rating,0)/reviews.length).toFixed(1) : 0;
ย ย ย ย return { rating: parseFloat(avg), reviewCount: reviews.length };
ย ย }

ย ย function getStarHtml(rating) {
ย ย ย ย const fullStars = Math.floor(rating);
ย ย ย ย let html = '';
ย ย ย ย for (let i = 0; i < fullStars; i++) {
ย ย ย ย ย ย html += 'โญ';
ย ย ย ย }
ย ย ย ย return html || (rating > 0 ? 'N/A' : 'Sin calificar');ย
ย ย }

ย ย async function handleSubmitReview(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย if (!selectedOrder) return;
ย ย ย ยย
ย ย ย ย const rating = parseInt(document.getElementById('reviewRating').value);
ย ย ย ย const comment = document.getElementById('reviewComment').value.trim();
ย ย ย ยย
ย ย ย ย if (rating < 1 || rating > 5) {
ย ย ย ย ย ย showToast('La calificaciรณn debe ser entre 1 y 5.');
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย const reviewData = {
ย ย ย ย ย ย id: Date.now().toString(),
ย ย ย ย ย ย type: 'review',
ย ย ย ย ย ย reviewed_order: selectedOrder.__backendId,
ย ย ย ย ย ย reviewed_seller: selectedOrder.seller_username,
ย ย ย ย ย ย reviewer: currentUser.username,
ย ย ย ย ย ย rating: rating,
ย ย ย ย ย ย comment: comment,
ย ย ย ย ย ย created_at: new Date().toISOString()
ย ย ย ย };
ย ย ย ยย
ย ย ย ย const reviewResult = await window.dataSdk.create(reviewData);
ย ย ย ยย
ย ย ย ย if (reviewResult.isOk) {
ย ย ย ย ย ย // Marcar la orden como revisada
ย ย ย ย ย ย const updatedOrder = {...selectedOrder, needs_review: false};
ย ย ย ย ย ย await window.dataSdk.update(updatedOrder);
ย ย ย ย ย ยย
ย ย ย ย ย ย showToast('โ ยกReseรฑa enviada! Gracias por tu feedback.');
ย ย ย ย ย ย showModal = null;
ย ย ย ย ย ย selectedOrder = null;
ย ย ย ย } else {
ย ย ย ย ย ย showToast('โ Error al enviar la reseรฑa.');
ย ย ย ย }
ย ย }
ย ยย
ย ย // ---------------------------------------------------------
ย ย // 11. FUNCIONES DE CHAT (AJUSTADAS PARA SUPABASE)
ย ย // ---------------------------------------------------------
ย ย async function openChatModal(orderId) {
ย ย ย ย const order = allOrders.find(o => o.__backendId === orderId);
ย ย ย ย if (!order) return;
ย ย ย ยย
ย ย ย ย chatTargetOrder = order;
ย ย ย ย showModal = 'chat';
ย ย ย ย render(); // Abrir el modal
ย ย ย ยย
ย ย ย ย // Iniciar la suscripciรณn de chat (AHORA REALTIME SUPABASE)
ย ย ย ย await window.chatSdk.subscribeToOrder(orderId);
ย ย ย ยย
ย ย ย ย // El renderChatMessages se llama automรกticamente cuando se cargan los mensajes iniciales y en cada cambio
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ยconst messagesContainer = document.querySelector('.chat-messages');
ย ย ย ย ย ย ยif (messagesContainer) {
ย ย ย ย ย ย ย ย ยrenderChatMessages(messagesContainer);
ย ย ย ย ย ย ย ย ยmessagesContainer.scrollTop = messagesContainer.scrollHeight;
ย ย ย ย ย ย ย}
ย ย ย ย }, 50);
ย ย }
ย ยย
ย ย function closeChatModal() {
ย ย ย ย window.chatSdk.unsubscribe();
ย ย ย ย showModal = null;
ย ย ย ย chatTargetOrder = null;
ย ย ย ย chatMessages = []; // Limpiar mensajes al cerrar
ย ย ย ย render();
ย ย }
ย ยย
ย ย function handleChatMessageSend(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย if (!chatTargetOrder || !currentUser) return;
ย ย ย ยย
ย ย ย ย const input = document.getElementById('chatInput');
ย ย ย ย const content = input.value;
ย ย ย ย if (!content.trim()) return;
ย ย ย ยย
ย ย ย ย // Llama a la funciรณn de envรญo de Supabase
ย ย ย ย window.chatSdk.sendMessage(chatTargetOrder.__backendId, currentUser.username, content);
ย ย ย ย input.value = ''; // Limpiar input
ย ย ย ยย
ย ย ย ย // Asegurar scroll al fondo (el realtime se encargarรก de aรฑadir el mensaje)
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย const messagesContainer = document.querySelector('.chat-messages');
ย ย ย ย ย ย ย if (messagesContainer) {
ย ย ย ย ย ย ย ย ย messagesContainer.scrollTop = messagesContainer.scrollHeight;
ย ย ย ย ย ย ย }
ย ย ย ย }, 50);
ย ย }

ย ย function renderChatMessages(container) {
ย ย ย ย if (!container) return;
ย ย ย ยย
ย ย ย ย const messagesHtml = chatMessages.map(msg => {
ย ย ย ย ย ย const isSelf = msg.sender === currentUser.username;
ย ย ย ย ย ย const time = new Date(msg.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
ย ย ย ย ย ย ย ย ย ย <div class="message-bubble ${isSelf ? 'message-self' : 'message-other'}">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="font-bold text-xs ${isSelf ? '' : 'text-blue-300'} mb-1">${isSelf ? 'Tรบ' : msg.sender}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>${msg.content}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-right text-[10px] opacity-60 mt-1">${time}</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;
ย ย ย ย }).join('');
ย ย ย ยย
ย ย ย ย container.innerHTML = messagesHtml;
ย ย ย ย container.scrollTop = container.scrollHeight; // Scroll al รบltimo mensaje
ย ย }


ย ย // ---------------------------------------------------------
ย ย // 12. UTILIDADES DE RENDERIZADO - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ย function getTopShops() {
ย ย ย const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
ย ย ย const shopsStats = resellers.map(seller => {
ย ย ย ย // 1. Obtener stats de reviews
ย ย ย ย const { rating, reviewCount } = getShopRating(seller.username);
ย ย ย ย // 2. Contar ventas
ย ย ย ย const sales = allOrders.filter(o => o.seller_username === seller.username && o.order_status === 'completed').length;
ย ย ย ยย
ย ย ย ย return {ย
ย ย ย ย ย ย ...seller,ย
ย ย ย ย ย ย salesCount: sales, // Mรฉtrica principal de ranking
ย ย ย ย ย ย rating: rating,ย ย ย// Para visibilidad
ย ย ย ย ย ย reviewCount: reviewCount // Para visibilidad
ย ย ย ย };ย
ย ย ย });
ย ย ย // Ranking basado SOLO en Ventas (salesCount)
ย ย ย return shopsStats.filter(s => s.salesCount > 0)
ย ย ย ย ย .sort((a, b) => b.salesCount - a.salesCount).slice(0, 3);ย
ย ย }
ย ยย
ย ย // Funciรณn para obtener el conteo de ventas de todos los vendedores
ย ย function getSellerSalesMap() {
ย ย ย ย const salesMap = {};
ย ย ย ย allOrders.forEach(order => {
ย ย ย ย ย ย if (order.order_status === 'completed' && order.seller_username) {
ย ย ย ย ย ย ย ย salesMap[order.seller_username] = (salesMap[order.seller_username] || 0) + 1;
ย ย ย ย ย ย }
ย ย ย ย });
ย ย ย ย return salesMap;
ย ย }

ย ย function getCategoryIcon(id) {
ย ย ย const cat = CATEGORIES.find(c => c.id === id);
ย ย ย return cat ? cat.icon : '๐ฆ';
ย ย }

ย ย function showToast(message) {
ย ย ย const toast = document.createElement('div');
ย ย ย toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white animate-bounce bg-blue-600';
ย ย ย toast.textContent = message;
ย ย ย document.body.appendChild(toast);
ย ย ย setTimeout(() => toast.remove(), 3000);
ย ย }

ย ย function getConfig() {
ย ย ย const configItem = window.mockDb.data.find(item => item.type === 'config');
ย ย ย if (configItem) return configItem.config;
ย ย ยย
ย ย ย return window.elementSdk ? window.elementSdk.config : defaultConfig;
ย ย }

ย ย // ---------------------------------------------------------
ย ย // 13. RENDERIZADO PRINCIPAL (EL CรDIGO VISUAL) - SIN CAMBIOS
ย ย // ---------------------------------------------------------
ย ย function render() {
ย ย ย const app = document.getElementById('app');
ย ย ย const config = getConfig();
ย ย ย document.body.style.backgroundColor = config.background_color;
ย ย ย document.body.style.color = config.text_color;

ย ย ย let content = '';
ย ย ย if (currentView === 'catalog') content = renderCatalog();
ย ย ย else if (currentView === 'cart') content = renderCart();
ย ย ย else if (currentView === 'orders') content = renderOrders();
ย ย ย else if (currentView === 'admin') content = renderAdmin();

ย ย ย app.innerHTML = content;

ย ย ย // Renderizar Modal si existe
ย ย ย const modalContainer = document.getElementById('modalContainer');
ย ย ย const modalHTML = showModal ? renderModal() : '';
ย ย ยย
ย ย ย if (modalContainer) {
ย ย ย ย ย modalContainer.innerHTML = modalHTML;
ย ย ย } else {
ย ย ย ย ย const d = document.createElement('div');ย
ย ย ย ย ย d.id = 'modalContainer';
ย ย ย ย ย document.body.appendChild(d);
ย ย ย ย ย d.innerHTML = modalHTML;
ย ย ย }
ย ย }

ย ย // --- VISTA CATรLOGO (HOME) ---
ย ย function renderCatalog() {
ย ย ย const config = getConfig();
ย ย ยย
ย ย ย let filteredProducts = allProducts;
ย ย ยย
ย ย ย let shopStats = null;
ย ย ยย
ย ย ย if (selectedShopFilter) {
ย ย ย ย ย filteredProducts = allProducts.filter(p => p.seller_shop_name === selectedShopFilter);
ย ย ย ย ยย
ย ย ย ย ย // 1. Calcular estadรญsticas de la tienda seleccionada
ย ย ย ย ย const shopOwner = allUsers.find(u => u.shop_name === selectedShopFilter);
ย ย ย ย ย if (shopOwner) {
ย ย ย ย ย ย ย const sales = allOrders.filter(o => o.seller_username === shopOwner.username && o.order_status === 'completed').length;
ย ย ย ย ย ย ย const { rating, reviewCount } = getShopRating(shopOwner.username);
ย ย ย ย ย ย ย shopStats = { owner: shopOwner, salesCount: sales, rating, reviewCount };
ย ย ย ย ย }
ย ย ย } else {
ย ย ย ย ย filteredProducts = selectedCategory === 'all'ย
ย ย ย ย ย ย ? allProductsย
ย ย ย ย ย ย : selectedCategory === 'promotions'
ย ย ย ย ย ย ? allProducts.filter(p => p.on_sale === true)
ย ย ย ย ย ย : allProducts.filter(p => p.category === selectedCategory);
ย ย ย }

ย ย ย const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
ย ย ย const topShops = getTopShops();ย

ย ย ย return `
ย ย ย ย <div class="min-h-full pb-20">
ย ย ย ย ย <header class="shadow-lg sticky top-0 z-40 bg-slate-800 border-b border-slate-700 p-4">
ย ย ย ย ย ย <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
ย ย ย ย ย ย ย ย <div class="text-center md:text-left">
ย ย ย ย ย ย ย ย ย <h1 class="text-2xl font-bold text-blue-400 tracking-tight">MU MARKET <span class="text-white text-xs bg-blue-600 px-1 rounded">V29</span></h1>
ย ย ย ย ย ย ย ย ย <p class="text-xs mt-1 opacity-60">${config.contact_info}</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="flex flex-wrap gap-2 justify-center items-center">
ย ย ย ย ย ย ย ย ย ${currentUser ? `
ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='cart'; render();" class="relative px-4 py-2 rounded-lg font-bold transition bg-slate-700 hover:bg-slate-600 text-sm border border-slate-600">
ย ย ย ย ย ย ย ย ย ย ย ๐ Carrito ${cartCount > 0 ? `<span class="cart-badge">${cartCount}</span>` : ''}
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='orders'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-slate-700 hover:bg-slate-600 text-sm border border-slate-600">
ย ย ย ย ย ย ย ย ย ย ย ๐ฆ Mis Pedidos
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ${currentUser.role !== 'buyer' ? `
ย ย ย ย ย ย ย ย ย ย ย <button onclick="loadAdminView();" class="px-4 py-2 rounded-lg font-bold transition border border-blue-500 bg-slate-800 text-blue-400 text-sm hover:bg-blue-900/30">
ย ย ย ย ย ย ย ย ย ย ย ย โ๏ธ Panel Tienda
ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ` : ''}
ย ย ย ย ย ย ย ย ย ย <button onclick="logout();" class="px-4 py-2 rounded-lg font-bold transition bg-red-600 hover:bg-red-500 text-white text-sm">
ย ย ย ย ย ย ย ย ย ย ย ๐ช
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย ย ย <button onclick="showModal='register'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-green-600 hover:bg-green-500 text-white text-sm shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย Crear Cuenta
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="showModal='registerReseller'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-purple-600 hover:bg-purple-500 text-white text-sm shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย Vender
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="showModal='login'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-blue-600 hover:bg-blue-500 text-white text-sm shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย Iniciar Sesiรณn
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย `}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย </header>

ย ย ย ย ย ${!selectedShopFilter && topShops.length > 0 ? `
ย ย ย ย ย ย <div class="max-w-7xl mx-auto px-4 py-6">
ย ย ย ย ย ย ย <div class="mb-4 text-center">
ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-yellow-400 mb-1">๐ TOP VENDEDORES POR VENTAS</h2>
ย ย ย ย ย ย ย ย <p class="text-xs opacity-60">Basado en Pedidos Completados</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
ย ย ย ย ย ย ย ย ${topShops.map((shop, index) => `
ย ย ย ย ย ย ย ย ย <div class="top-shop-card rank-${index+1} rounded-xl p-6 text-center bg-slate-800">
ย ย ย ย ย ย ย ย ย ย <div class="text-4xl mb-2">${index === 0 ? '๐ฅ' : index === 1 ? '๐ฅ' : '๐ฅ'}</div>
ย ย ย ย ย ย ย ย ย ย <h3 class="font-bold text-xl mb-1 shop-badge px-2 py-1 rounded inline-block hover:bg-white/10" onclick="filterByShop('${shop.shop_name}')">${shop.shop_name}</h3>
ย ย ย ย ย ย ย ย ย ย <p class="text-sm opacity-70 mb-3">๐ค ${shop.username}</p>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="flex justify-center mb-3 bg-slate-900/50 p-2 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center px-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xl font-bold text-green-400">${shop.salesCount}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs opacity-70 uppercase">Ventas</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="border-l border-slate-700/50 mx-2"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center px-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xl font-bold text-yellow-400">${getStarHtml(shop.rating)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs opacity-70 uppercase">(${shop.reviewCount} Reviews)</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ` : ''}

ย ย ย ย ย <div class="max-w-7xl mx-auto px-4 py-6">
ย ย ย ย ย ย ${selectedShopFilter ? `
ย ย ย ย ย ย ย ย <div class="bg-blue-900/30 border border-blue-500 p-4 rounded-lg mb-6 shadow-lg">
ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between border-b border-blue-800/50 pb-3 mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-blue-300">๐ช Tienda: ${selectedShopFilter}</h2>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="clearShopFilter()" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded font-bold text-sm shadow transition transform hover:scale-105">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Ver Todas las Tiendas
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ${shopStats ? `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-around text-center py-2 bg-slate-900/50 rounded-lg border border-slate-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="px-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xl font-bold text-green-400">${shopStats.salesCount}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs opacity-70">Ventas Totales</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="border-l border-slate-700/50 mx-2"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="px-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xl font-bold text-yellow-400">${getStarHtml(shopStats.rating)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs opacity-70">(${shopStats.reviewCount} Reviews)</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ` : `<p class="text-center text-sm opacity-60 py-2">Cargando estadรญsticas o tienda sin datos aรบn.</p>`}
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย <div class="flex flex-wrap gap-3 justify-center">
ย ย ย ย ย ย ย ย ย ${CATEGORIES.map(cat => `
ย ย ย ย ย ย ย ย ย ย <buttonย
ย ย ย ย ย ย ย ย ย ย ย onclick="selectedCategory='${cat.id}'; render();"ย
ย ย ย ย ย ย ย ย ย ย ย class="category-btn px-6 py-3 rounded-lg font-bold shadow-md border border-transparent ${selectedCategory === cat.id ? 'bg-blue-600 ring-2 ring-blue-400 border-blue-300' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">
ย ย ย ย ย ย ย ย ย ย ย ${cat.icon} ${cat.name}
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `}
ย ย ย ย ย </div>

ย ย ย ย ย <main class="max-w-7xl mx-auto px-4 pb-12">
ย ย ย ย ย ย ${filteredProducts.length === 0 ? `
ย ย ย ย ย ย ย <div class="text-center py-20 bg-slate-800/50 rounded-xl border border-slate-700 border-dashed">
ย ย ย ย ย ย ย ย <p class="text-3xl opacity-40">๐ฆ</p>
ย ย ย ย ย ย ย ย <p class="text-xl opacity-60 mt-2">No hay productos disponibles en esta tienda/categorรญa.</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
ย ย ย ย ย ย ย ย ${filteredProducts.map(product => {
ย ย ย ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย ย ย <div class="product-card rounded-xl shadow-lg overflow-hidden ${product.on_sale ? 'ring-2 ring-red-500' : 'border border-slate-700'} bg-slate-800 relative group">
ย ย ย ย ย ย ย ย ย ย ย ${product.on_sale ? `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="absolute top-2 right-2 z-10">
ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="px-2 py-1 rounded text-xs font-bold bg-red-600 text-white animate-pulse shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย OFERTA
ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ` : ''}
ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย <div class="h-48 bg-slate-900 flex items-center justify-center text-6xl relative overflow-hidden">
ย ย ย ย ย ย ย ย ย ย ย ย ${product.image_url ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย <img src="${product.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none';">
ย ย ย ย ย ย ย ย ย ย ย ย ` : getCategoryIcon(product.category)}
ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย <div class="p-4 relative">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-center -mt-8 mb-3 relative z-20">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="filterByShop('${product.seller_shop_name}')" class="shop-badge bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-blue-400 tracking-wide">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ช ${product.seller_shop_name}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-bold mb-1 truncate text-center text-lg">${product.name}</h3>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs font-bold px-2 py-1 rounded ${product.stock < 5 ? 'bg-red-900/50 text-red-400 animate-pulse border border-red-500/50' : 'bg-slate-700 text-slate-400'}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ฆ Stock: ${product.stock}
ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between mt-2 border-t border-slate-700 pt-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${product.discount > 0 ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs line-through opacity-50">$${product.price}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="font-bold text-green-400 text-lg">$${product.final_price.toFixed(2)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="font-bold text-green-400 text-lg">$${product.price.toFixed(2)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `}
ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย <buttonย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย onclick="addToCart('${product.__backendId}')"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${product.stock <= 0 ? 'disabled' : ''}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="px-4 py-2 rounded text-sm font-bold bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white shadow transition transform active:scale-95">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${product.stock > 0 ? 'COMPRAR' : 'AGOTADO'}
ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย `}).join('')}
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `}
ย ย ย ย ย </main>
ย ย ย ย ยย
ย ย ย ย </div>
ย ย ย `;
ย ย }

ย ย // --- VISTA CARRITO (EXPANDIDA) ---
ย ย function renderCart() {
ย ย ย const config = getConfig();
ย ย ย const total = cart.reduce((sum, item) => {
ย ย ย ย const itemPrice = item.discount > 0 ? item.final_price : item.price;
ย ย ย ย return sum + (itemPrice * item.quantity);
ย ย ย }, 0);

ย ย ย return `
ย ย ย ย <div class="min-h-full bg-slate-900 text-slate-100 p-8">
ย ย ย ย ย ย <div class="max-w-4xl mx-auto">
ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold mb-6 text-blue-400 flex items-center gap-3">
ย ย ย ย ย ย ย ย ย ย ๐ Tu Carrito de Compras
ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ${cart.length === 0 ? `
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-10 rounded-xl border border-slate-700 text-center shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-4xl mb-4">๐ข</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xl font-bold mb-2">Tu carrito estรก vacรญo</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-slate-400 mb-6">ยกExplora el catรกlogo y encuentra los mejores items!</p>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='catalog'; render();" class="bg-blue-600 px-6 py-3 rounded-lg font-bold hover:bg-blue-500 shadow transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Volver al Catรกlogo
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="p-4 bg-slate-900/50 border-b border-slate-700 font-bold text-slate-400 grid grid-cols-12 gap-4 text-sm uppercase tracking-wider">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-6">Producto</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2 text-center">Precio</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2 text-center">Cantidad</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2 text-right">Total</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ${cart.map((item, index) => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="p-4 border-b border-slate-700 grid grid-cols-12 gap-4 items-center hover:bg-slate-700/20 transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-6 flex items-center gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="h-12 w-12 bg-slate-900 rounded border border-slate-600 flex items-center justify-center text-xl shrink-0">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${getCategoryIcon(item.category)}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="overflow-hidden">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="font-bold truncate">${item.name}</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs text-blue-400">Tienda: ${item.seller_shop_name}</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2 text-center font-mono text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย $${item.final_price.toFixed(2)}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2 text-center font-mono text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย x${item.quantity}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2 text-right flex items-center justify-end gap-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-bold text-green-400">$${(item.final_price * item.quantity).toFixed(2)}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-400 bg-red-900/20 hover:bg-red-900/40 h-8 w-8 rounded flex items-center justify-center transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โ
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="flex flex-col md:flex-row justify-end items-center gap-6 bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-right">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-slate-400 uppercase">Total a Pagar</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-4xl font-bold text-green-400">$${total.toFixed(2)}</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex gap-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg font-bold transition border border-slate-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Seguir Viendo
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="createOrder()" class="bg-green-600 hover:bg-green-500 px-8 py-3 rounded-lg font-bold text-white shadow-lg transform hover:scale-105 transition flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โ CONFIRMAR COMPRA
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `}
ย ย ย ย ย ย </div>
ย ย ย ย </div>`;
ย ย }

ย ย // --- VISTA PEDIDOS (EXPANDIDA) ---
ย ย function renderOrders() {
ย ย ย ย const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username).reverse();
ย ย ย ย const isSeller = currentUser.role !== 'buyer';
ย ย ย ยย
ย ย ย ย return `
ย ย ย ย <div class="min-h-full bg-slate-900 text-slate-100 p-8">
ย ย ย ย ย ย <div class="max-w-4xl mx-auto">
ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold text-blue-400">๐ฆ Mis Pedidos</h2>
ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded font-bold text-sm border border-slate-600">
ย ย ย ย ย ย ย ย ย ย ย ย Volver al Catรกlogo
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ${myOrders.length === 0 ? `
ย ย ย ย ย ย ย ย ย ย <div class="text-center py-12 opacity-50 border-2 border-dashed border-slate-700 rounded-xl">
ย ย ย ย ย ย ย ย ย ย ย ย <p>No has realizado ninguna compra todavรญa.</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ` : ''}

ย ย ย ย ย ย ย ย ${myOrders.map((o, index) => {
ย ย ย ย ย ย ย ย ย ย const statusText = o.order_status === 'completed'ย
ย ย ย ย ย ย ย ย ย ย ย ย ? (o.needs_review ? 'Completado (Pendiente de Reseรฑa)' : 'Completado')ย
ย ย ย ย ย ย ย ย ย ย ย ย : o.seller_confirmedย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ? 'Pendiente de tu Confirmaciรณn'ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย : 'Esperando Entrega del Vendedor';
ย ย ย ย ย ย ย ย ย ย const statusClass = o.order_status === 'completed'
ย ย ย ย ย ย ย ย ย ย ย ย ? (o.needs_review ? 'bg-red-900 text-red-200 border border-red-700 animate-pulse' : 'bg-green-900 text-green-200 border border-green-700')
ย ย ย ย ย ย ย ย ย ย ย ย : o.seller_confirmedย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ? 'bg-orange-900 text-orange-200 border border-orange-700 animate-pulse'
ย ย ย ย ย ย ย ย ย ย ย ย ย ย : 'bg-yellow-900 text-yellow-200 border border-yellow-700 animate-pulse';

ย ย ย ย ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl mb-6 border-l-4 shadow-lg transition hover:bg-slate-800/80 ${o.order_status==='completed'?'border-green-500':o.seller_confirmed?'border-orange-500':'border-yellow-500'}">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-start border-b border-slate-700 pb-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-bold text-xl text-white">PEDIDO #${myOrders.length - index}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs text-slate-500 font-mono mt-1">ID: ${o.id}</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="px-3 py-1 rounded text-sm font-bold uppercase tracking-wider ${statusClass}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${statusText}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs uppercase text-slate-500 font-bold mb-2">Datos del Vendedor</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-lg font-bold text-white flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ค ${o.seller_username}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-2 inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded border border-purple-500/30 font-mono text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ฑ Discord: ${o.seller_discord}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs uppercase text-slate-500 font-bold mb-2">Detalle de Items</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm font-mono text-slate-300 leading-relaxed">${o.items}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex flex-col sm:flex-row justify-between items-center pt-2 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="openChatModal('${o.__backendId}')" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ฌ CHAT con Vendedor
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-white flex-1 text-right">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Total: <span class="text-green-400">$${o.total.toFixed(2)}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${o.order_status === 'completed' ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${o.needs_review ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="selectedOrder = allOrders.find(ord => ord.__backendId === '${o.__backendId}'); showModal='review'; render();" class="w-full sm:w-auto bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform hover:scale-105">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โญ DEJAR RESEรA
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center gap-2 text-green-400 font-bold bg-green-900/20 px-4 py-2 rounded-lg border border-green-900/50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span>โ Pedido Finalizado</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย `}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${o.seller_confirmed ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="confirmOrder('${o.__backendId}', false)" ${o.buyer_confirmed ? 'disabled' : ''}ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full sm:w-auto bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โ CONFIRMAR QUE RECIBร LOS ITEMS
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ` : `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button disabled class="w-full sm:w-auto bg-yellow-700/50 px-6 py-3 rounded-lg font-bold text-white disabled:opacity-100 disabled:cursor-wait">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โณ Esperando que el Vendedor Entregue/Confirme
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย `}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `}
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `}).join('')}
ย ย ย ย ย ย </div>
ย ย ย ย </div>`;
ย ย }

ย ย // --- VISTA ADMIN / RESELLER (PANEL COMPLETO) ---
ย ย function renderAdmin() {
ย ย ย const user = currentUser;
ย ย ย const viewingAs = adminViewTarget || user.username;
ย ย ย const viewingUser = allUsers.find(u => u.username === viewingAs) || user;
ย ย ยย
ย ย ย const myProducts = allProducts.filter(p => p.seller_username === viewingAs);
ย ย ย const myOrders = allOrders.filter(o => o.seller_username === viewingAs);
ย ย ย const pending = myOrders.filter(o => o.order_status === 'pending').reverse();
ย ย ยย
ย ย ย const completedOrdersLog = allOrders.filter(o => o.order_status === 'completed').reverse();
ย ย ยย
ย ย ย // 1. Calcular las ventas de todos los revendedores (para la tabla global)
ย ย ย const sellerSalesMap = getSellerSalesMap();

ย ย ย const displayUsers = allUsers.sort((a, b) => {
ย ย ย ย ย if (a.status === 'pending' && b.status !== 'pending') return -1;
ย ย ย ย ย if (a.status !== 'pending' && b.status === 'pending') return 1;
ย ย ย ย ย if (a.role === 'admin') return 1;
ย ย ย ย ย if (b.role === 'admin') return -1;
ย ย ย ย ย return a.username.localeCompare(b.username);
ย ย ย });

ย ย ย const stats = {
ย ย ย ย ย total: myProducts.length,
ย ย ย ย ย sales: myOrders.filter(o => o.order_status === 'completed').length,
ย ย ย ย ย revenue: myOrders.filter(o => o.order_status === 'completed').reduce((a,b)=>a+b.total,0),
ย ย ย ย ย online: onlineUsers.size
ย ย ย };

ย ย ย return `
ย ย ย ย <div class="min-h-full bg-slate-900 text-slate-100 p-6">
ย ย ย ย ย ย <div class="max-w-7xl mx-auto">
ย ย ย ย ย ย ย ย <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-slate-700 pb-6">
ย ย ย ย ย ย ย ย ย ย <div class="flex items-center gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย <h1 class="text-3xl font-bold flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${adminViewTarget ? `๐๏ธ GESTIONANDO TIENDA: <span class="text-yellow-400 underline">${viewingUser.shop_name}</span>` : (user.role==='admin'?'โ๏ธ PANEL ADMINISTRADOR':'๐ช MI TIENDA')}
ย ย ย ย ย ย ย ย ย ย ย ย </h1>
ย ย ย ย ย ย ย ย ย ย ย ย ${adminViewTarget ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="exitShopManagement()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold text-sm shadow animate-pulse">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โ SALIR DEL MODO GESTIรN
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ` : ''}
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ${user.role === 'admin' ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="showModal='dataTools';render()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-yellow-400 border-yellow-500/50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐พ RESPALDO SYSTEM
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ` : ''}
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="loadAdminView()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-blue-400 border-blue-500/50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ REFRESCAR DATOS
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='catalog';render()" class="bg-blue-600 px-6 py-2 rounded font-bold shadow hover:bg-blue-500 transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ Volver al Inicio
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-purple-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-white">${stats.total}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Productos Activos</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-green-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-green-400">${stats.sales}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Ventas Completadas</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-yellow-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-yellow-400">${pending.length}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Pedidos Pendientes</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย<div class="bg-slate-800 p-6 rounded-xl border-t-4 border-blue-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide mb-1">Discord Tienda</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm font-bold font-mono text-blue-300 truncate bg-slate-900/50 p-1 rounded">${viewingUser.discord_tag}</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ${(user.role === 'admin' && !adminViewTarget) ? `
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold mb-6 text-green-400 border-b border-slate-700 pb-2 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ LOG HISTรRICO DE PEDIDOS (${completedOrdersLog.length})
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="clearCompletedOrdersLog()" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-bold transition ml-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐๏ธ LIMPIAR LOG
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="overflow-x-auto rounded-lg border border-slate-700 max-h-64 overflow-y-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <table class="w-full text-sm text-left text-slate-300">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-slate-900 text-white uppercase font-bold text-xs sticky top-0 z-10">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Fecha</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Tienda/Vendedor</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Comprador</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Items</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3 text-right">Total</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tbody class="divide-y divide-slate-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${completedOrdersLog.length === 0 ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><td colspan="5" class="p-4 text-center opacity-50">No hay registro de pedidos completados.</td></tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ` : completedOrdersLog.map(o => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr class="hover:bg-slate-700/30 transition font-mono">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-xs text-slate-500">${new Date(o.created_at).toLocaleDateString()}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 font-bold text-blue-300">${o.seller_username}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-white">${o.buyer_username}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-xs truncate max-w-xs">${o.items}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-right font-bold text-green-400">$${o.total.toFixed(2)}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ` : ''}

ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold mb-4 text-yellow-400 border-b border-slate-700 pb-2 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ๐ฆ Pedidos por Despachar <span class="bg-slate-700 text-white px-2 rounded text-sm">${pending.length}</span>
ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ${pending.length === 0 ? `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center py-8 opacity-50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="italic">No tienes pedidos pendientes. ยกBuen trabajo!</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ` : pending.map((o, i) => {
ย ย ย ย ย ย ย ย ย ย ย ย const sellerConfirmed = o.seller_confirmed;
ย ย ย ย ย ย ย ย ย ย ย ย const buyerConfirmed = o.buyer_confirmed;
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย let buttonText, buttonClass, buttonAction;
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย if (buyerConfirmed) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonText = 'Cliente CONFIRMADO';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonClass = 'bg-orange-700/50 disabled:opacity-100 disabled:cursor-wait';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonAction = 'disabled';
ย ย ย ย ย ย ย ย ย ย ย ย } else if (sellerConfirmed) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonText = 'โณ Esperando Cliente';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonClass = 'bg-yellow-600/50 disabled:opacity-100 disabled:cursor-wait';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonAction = 'disabled';
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonText = 'โ MARCAR ENTREGADO';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonClass = 'bg-green-600 hover:bg-green-500';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonAction = `onclick="confirmOrder('${o.__backendId}', true)"`;
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย const statusBadgeText = buyerConfirmed ? 'Cliente Confirmรณ' : (sellerConfirmed ? 'Tรบ Confirmaste (Esperando Cliente)' : 'Pendiente de tu Entrega');
ย ย ย ย ย ย ย ย ย ย ย ย const statusBadgeClass = buyerConfirmed ? 'bg-orange-900 text-orange-200' : (sellerConfirmed ? 'bg-yellow-900 text-yellow-200' : 'bg-red-900 text-red-200');

ย ย ย ย ย ย ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-900 p-5 rounded-lg mb-4 border border-slate-600 flex flex-col md:flex-row justify-between gap-6 shadow-sm hover:bg-slate-900/80 transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center gap-3 mb-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-bold text-lg text-blue-300">PEDIDO #${pending.length - i}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="px-2 py-1 rounded text-xs font-bold ${statusBadgeClass} whitespace-nowrap">${statusBadgeText}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mb-1">Cliente: <span class="font-bold text-white">${o.buyer_username}</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded text-xs font-mono border border-purple-500/30 mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ฑ Discord: ${o.buyer_discord}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm text-slate-300 bg-slate-800/50 p-3 rounded border-l-2 border-green-500 font-mono">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${o.items}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-right flex flex-col justify-between items-end min-w-[150px]">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-slate-500 uppercase">Total a Cobrar</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-green-400">$${o.total.toFixed(2)}</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="openChatModal('${o.__backendId}')" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-bold text-sm shadow transition text-white">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ฌ CHAT
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button ${buttonAction} class="${buttonClass} px-4 py-2 rounded font-bold text-sm shadow transition text-white">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${buttonText}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย `}).join('')}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย </div>`;
ย ย }

ย ย // --- VISTA ADMIN / RESELLER (PANEL COMPLETO) ---
ย ย function renderAdmin() {
ย ย ย const user = currentUser;
ย ย ย const viewingAs = adminViewTarget || user.username;
ย ย ย const viewingUser = allUsers.find(u => u.username === viewingAs) || user;
ย ย ยย
ย ย ย const myProducts = allProducts.filter(p => p.seller_username === viewingAs);
ย ย ย const myOrders = allOrders.filter(o => o.seller_username === viewingAs);
ย ย ย const pending = myOrders.filter(o => o.order_status === 'pending').reverse();
ย ย ยย
ย ย ย const completedOrdersLog = allOrders.filter(o => o.order_status === 'completed').reverse();
ย ย ยย
ย ย ย // 1. Calcular las ventas de todos los revendedores (para la tabla global)
ย ย ย const sellerSalesMap = getSellerSalesMap();

ย ย ย const displayUsers = allUsers.sort((a, b) => {
ย ย ย ย ย if (a.status === 'pending' && b.status !== 'pending') return -1;
ย ย ย ย ย if (a.status !== 'pending' && b.status === 'pending') return 1;
ย ย ย ย ย if (a.role === 'admin') return 1;
ย ย ย ย ย if (b.role === 'admin') return -1;
ย ย ย ย ย return a.username.localeCompare(b.username);
ย ย ย });

ย ย ย const stats = {
ย ย ย ย ย total: myProducts.length,
ย ย ย ย ย sales: myOrders.filter(o => o.order_status === 'completed').length,
ย ย ย ย ย revenue: myOrders.filter(o => o.order_status === 'completed').reduce((a,b)=>a+b.total,0),
ย ย ย ย ย online: onlineUsers.size
ย ย ย };

ย ย ย return `
ย ย ย ย <div class="min-h-full bg-slate-900 text-slate-100 p-6">
ย ย ย ย ย ย <div class="max-w-7xl mx-auto">
ย ย ย ย ย ย ย ย <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-slate-700 pb-6">
ย ย ย ย ย ย ย ย ย ย <div class="flex items-center gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย <h1 class="text-3xl font-bold flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${adminViewTarget ? `๐๏ธ GESTIONANDO TIENDA: <span class="text-yellow-400 underline">${viewingUser.shop_name}</span>` : (user.role==='admin'?'โ๏ธ PANEL ADMINISTRADOR':'๐ช MI TIENDA')}
ย ย ย ย ย ย ย ย ย ย ย ย </h1>
ย ย ย ย ย ย ย ย ย ย ย ย ${adminViewTarget ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="exitShopManagement()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold text-sm shadow animate-pulse">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย โ SALIR DEL MODO GESTIรN
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ` : ''}
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ${user.role === 'admin' ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="showModal='dataTools';render()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-yellow-400 border-yellow-500/50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐พ RESPALDO SYSTEM
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ` : ''}
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="loadAdminView()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-blue-400 border-blue-500/50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ REFRESCAR DATOS
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="currentView='catalog';render()" class="bg-blue-600 px-6 py-2 rounded font-bold shadow hover:bg-blue-500 transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ Volver al Inicio
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-purple-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-white">${stats.total}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Productos Activos</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-green-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-green-400">${stats.sales}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Ventas Completadas</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-yellow-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-yellow-400">${pending.length}</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Pedidos Pendientes</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย<div class="bg-slate-800 p-6 rounded-xl border-t-4 border-blue-500 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs opacity-70 font-bold uppercase tracking-wide mb-1">Discord Tienda</div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm font-bold font-mono text-blue-300 truncate bg-slate-900/50 p-1 rounded">${viewingUser.discord_tag}</div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ${(user.role === 'admin' && !adminViewTarget) ? `
ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold mb-6 text-green-400 border-b border-slate-700 pb-2 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ LOG HISTรRICO DE PEDIDOS (${completedOrdersLog.length})
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="clearCompletedOrdersLog()" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-bold transition ml-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐๏ธ LIMPIAR LOG
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="overflow-x-auto rounded-lg border border-slate-700 max-h-64 overflow-y-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <table class="w-full text-sm text-left text-slate-300">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-slate-900 text-white uppercase font-bold text-xs sticky top-0 z-10">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Fecha</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Tienda/Vendedor</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Comprador</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3">Items</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-3 text-right">Total</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tbody class="divide-y divide-slate-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${completedOrdersLog.length === 0 ? `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><td colspan="5" class="p-4 text-center opacity-50">No hay registro de pedidos completados.</td></tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ` : completedOrdersLog.map(o => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr class="hover:bg-slate-700/30 transition font-mono">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-xs text-slate-500">${new Date(o.created_at).toLocaleDateString()}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 font-bold text-blue-300">${o.seller_username}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-white">${o.buyer_username}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-xs truncate max-w-xs">${o.items}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-3 text-right font-bold text-green-400">$${o.total.toFixed(2)}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ` : ''}

ย ย ย ย ย ย ย ย <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold mb-4 text-yellow-400 border-b border-slate-700 pb-2 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ๐ฆ Pedidos por Despachar <span class="bg-slate-700 text-white px-2 rounded text-sm">${pending.length}</span>
ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ${pending.length === 0 ? `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center py-8 opacity-50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="italic">No tienes pedidos pendientes. ยกBuen trabajo!</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ` : pending.map((o, i) => {
ย ย ย ย ย ย ย ย ย ย ย ย const sellerConfirmed = o.seller_confirmed;
ย ย ย ย ย ย ย ย ย ย ย ย const buyerConfirmed = o.buyer_confirmed;
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย let buttonText, buttonClass, buttonAction;
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย if (buyerConfirmed) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonText = 'Cliente CONFIRMADO';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonClass = 'bg-orange-700/50 disabled:opacity-100 disabled:cursor-wait';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonAction = 'disabled';
ย ย ย ย ย ย ย ย ย ย ย ย } else if (sellerConfirmed) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonText = 'โณ Esperando Cliente';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonClass = 'bg-yellow-600/50 disabled:opacity-100 disabled:cursor-wait';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonAction = 'disabled';
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonText = 'โ MARCAR ENTREGADO';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonClass = 'bg-green-600 hover:bg-green-500';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย buttonAction = `onclick="confirmOrder('${o.__backendId}', true)"`;
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย const statusBadgeText = buyerConfirmed ? 'Cliente Confirmรณ' : (sellerConfirmed ? 'Tรบ Confirmaste (Esperando Cliente)' : 'Pendiente de tu Entrega');
ย ย ย ย ย ย ย ย ย ย ย ย const statusBadgeClass = buyerConfirmed ? 'bg-orange-900 text-orange-200' : (sellerConfirmed ? 'bg-yellow-900 text-yellow-200' : 'bg-red-900 text-red-200');

ย ย ย ย ย ย ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-slate-900 p-5 rounded-lg mb-4 border border-slate-600 flex flex-col md:flex-row justify-between gap-6 shadow-sm hover:bg-slate-900/80 transition">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center gap-3 mb-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-bold text-lg text-blue-300">PEDIDO #${pending.length - i}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="px-2 py-1 rounded text-xs font

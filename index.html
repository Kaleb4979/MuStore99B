<!doctype html>
<html lang="es">
Â <head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Mu Online 99B Marketplace - V30 (Chat Realtime Supabase)</title>
Â 
Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â Â 
Â  <script src="https://cdn.tailwindcss.com"></script>
Â 
Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
Â 
Â  <style>
Â  Â  /* ConfiguraciÃ³n Base */
Â  Â  body {
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  height: 100%;
Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  }
Â  Â  html {
Â  Â  Â  height: 100%;
Â  Â  }

Â  Â  /* Animaciones de Botones y Tarjetas */
Â  Â  .category-btn {
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }
Â  Â  .category-btn:hover {
Â  Â  Â  transform: translateY(-2px);
Â  Â  }

Â  Â  .product-card {
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }
Â  Â  .product-card:hover {
Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
Â  Â  }

Â  Â  .shop-badge {
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .shop-badge:hover {
Â  Â  Â  transform: scale(1.05);
Â  Â  Â  background-color: #4f46e5; /* Indigo-600 */
Â  Â  }

Â  Â  /* Spinner de Carga */
Â  Â  .loading-spinner {
Â  Â  Â  border: 3px solid rgba(255,255,255,0.3);
Â  Â  Â  border-top: 3px solid white;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  }
Â  Â  @keyframes spin {
Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  }

Â  Â  /* NotificaciÃ³n en el Carrito */
Â  Â  .cart-badge {
Â  Â  Â  position: absolute;
Â  Â  Â  top: -8px;
Â  Â  Â  right: -8px;
Â  Â  Â  background-color: #ef4444;
Â  Â  Â  color: white;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 24px;
Â  Â  Â  height: 24px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 12px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
Â  Â  }

Â  Â  /* Fondo Oscuro para Modales */
Â  Â  .modal-backdrop {
Â  Â  Â  background-color: rgba(0, 0, 0, 0.85);
Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  }

Â  Â  /* Estilos para el Ranking (Oro, Plata, Bronce) */
Â  Â  .rank-1 {
Â  Â  Â  border: 2px solid #FFD700;
Â  Â  Â  box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
Â  Â  Â  background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(0,0,0,0.4));
Â  Â  }
Â  Â  .rank-2 {
Â  Â  Â  border: 2px solid #C0C0C0;
Â  Â  Â  box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
Â  Â  Â  background: linear-gradient(145deg, rgba(192,192,192,0.1), rgba(0,0,0,0.4));
Â  Â  }
Â  Â  .rank-3 {
Â  Â  Â  border: 2px solid #CD7F32;
Â  Â  Â  box-shadow: 0 0 10px rgba(205, 127, 50, 0.2);
Â  Â  Â  background: linear-gradient(145deg, rgba(205,127,50,0.1), rgba(0,0,0,0.4));
Â  Â  }

Â  Â  /* AnimaciÃ³n Bounce In */
Â  Â  @keyframes bounceIn {
Â  Â  Â  Â  0% { transform: scale(0.8); opacity: 0; }
Â  Â  Â  Â  60% { transform: scale(1.05); opacity: 1; }
Â  Â  Â  Â  100% { transform: scale(1); }
Â  Â  }
Â  Â  .animate-bounce-in {
Â  Â  Â  Â  animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  }
Â  Â Â 
Â  Â  /* Transiciones de Vista Suaves */
Â  Â  @view-transition { navigation: auto; }
Â  Â Â 
Â  Â  /* Estilos del Chat */
Â  Â  .chat-messages {
Â  Â  Â  Â  height: 350px; /* Altura Fija */
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .message-bubble {
Â  Â  Â  Â  max-width: 80%;
Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  border-radius: 18px;
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  word-wrap: break-word;
Â  Â  }
Â  Â  .message-self {
Â  Â  Â  Â  background-color: #3b82f6; /* Blue-500 */
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  align-self: flex-end;
Â  Â  Â  Â  border-bottom-right-radius: 2px;
Â  Â  }
Â  Â  .message-other {
Â  Â  Â  Â  background-color: #1e293b; /* Slate-800 */
Â  Â  Â  Â  color: #f1f5f9;
Â  Â  Â  Â  align-self: flex-start;
Â  Â  Â  Â  border-bottom-left-radius: 2px;
Â  Â  }
Â  </style>

Â  <script>
Â  Â  // ---------------------------------------------------------
Â  Â  // 1. CONFIGURACIÃ“N CRÃTICA (REEMPLAZAR ESTAS LÃNEAS)
Â  Â  // ---------------------------------------------------------
Â  Â  // *** ðŸš¨ VERIFICA TUS CREDENCIALES AQUÃ ðŸš¨ ***
Â  Â  const BIN_ID = '691ddaa6ae596e708f6321c9';Â 
Â  Â  const SECRET_KEY = '$2a$10$6.Y19X/sB3np.3CIJmbJZesuwRVxU77ns.FyAdL2dUc46k1vWFG9S';Â 
Â  Â  const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

Â  Â  const DB_KEY = 'mu_marketplace_db_v22_final';Â 
Â  Â  const SESSION_KEY = 'mu_session_user_v22_final';
Â  Â Â 
Â  Â  // ðŸ“¢ CONFIGURACIÃ“N SUPABASE (CHAT REALTIME) - UTILIZAR LOS VALORES REALES
Â  Â  // NOTA: Estas claves son pÃºblicas y se exponen en el cliente.
Â  Â  const SUPABASE_URL = 'https://ciysaobejtxfkpmbmswb.supabase.co';Â 
Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpeXNhb2JlanR4ZmtwbWJtc3diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTAyNTksImV4cCI6MjA3OTE4NjI1OX0.WDg1v-2UK8yow7uXK8UyqOt3xOp_-BMMEVqyJeExb3w';Â 
Â  Â Â 
Â  Â  let supabaseClient = null;
Â  Â  if (window.supabase) {
Â  Â  Â  Â  supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â  Â  } else {
Â  Â  Â  Â  console.error("SDK de Supabase no cargado. El chat no funcionarÃ¡ en tiempo real.");
Â  Â  }
Â  Â  // ---------------------------------------------------------

Â  Â  // Base de datos simulada (solo para mantener la estructura, los datos reales vienen del BIN)
Â  Â  window.mockDb = {
Â  Â  Â  data: [],Â 
Â  Â  Â  handler: null,
Â  Â  Â  notify() {}Â 
Â  Â  };

Â  Â  // SDK de ConfiguraciÃ³n Visual (sigue local, no necesita backend)
Â  Â  window.elementSdk = {
Â  Â  Â  config: {},
Â  Â  Â  init: (options) => {
Â  Â  Â  Â  window.elementSdk.config = options.defaultConfig;
Â  Â  Â  Â  if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
Â  Â  Â  },
Â  Â  Â  setConfig: (newConfig) => {
Â  Â  Â  Â  window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
Â  Â  Â  }
Â  Â  };

Â  Â  // DefiniciÃ³n de la configuraciÃ³n base (necesario para elementSdk)
Â  Â  const defaultConfig = {
Â  Â  Â  background_color: '#1e293b',
Â  Â  Â  text_color: '#f1f5f9',
Â  Â  Â  font_size: 16,
Â  Â  Â  contact_info: 'Contacta a Kaleb Admin por Discord para soporte.'
Â  Â  };

Â  Â  // ---------------------------------------------------------
Â  Â  // SDK Base de Datos (ConexiÃ³n JSONBin)
Â  Â  // ---------------------------------------------------------
Â  Â  window.dataSdk = {
Â  Â  Â  Â  init: async (handler) => {
Â  Â  Â  Â  Â  Â  window.mockDb.handler = handler;
Â  Â  Â  Â  Â  Â  return window.dataSdk.read(); // Leer los datos al inicio
Â  Â  Â  Â  },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FUNCIÃ“N DE LECTURA: Obtiene todos los datos del BIN
Â  Â  Â  Â  read: async () => {
Â  Â  Â  Â  Â  Â  if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("JSONBin Config Error: BIN_ID o SECRET_KEY no configurados.");
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast('âŒ Error de Config: BIN ID o Key faltantes.');
Â  Â  Â  Â  Â  Â  Â  Â  Â const localData = localStorage.getItem(DB_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  Â window.mockDb.data = localData ? JSON.parse(localData) : [];
Â  Â  Â  Â  Â  Â  Â  Â  Â window.mockDb.handler.onDataChanged(window.mockDb.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â return { isOk: false };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(JSONBIN_URL + '/latest', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'X-Master-Key': SECRET_KEYÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const errorText = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Error ${response.status}: ${errorText}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const json = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const data = json.record || [];Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Almacenar en localStorage como fallback local y para velocidad
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(DB_KEY, JSON.stringify(data));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Actualizar la DB local y notificar
Â  Â  Â  Â  Â  Â  Â  Â  window.mockDb.data = data;
Â  Â  Â  Â  Â  Â  Â  Â  window.mockDb.handler.onDataChanged(data);Â 
Â  Â  Â  Â  Â  Â  Â  Â  return { isOk: true };

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("JSONBin READ Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error al cargar datos remotos. Usando datos locales (LocalStorage).');
Â  Â  Â  Â  Â  Â  Â  Â  // Si falla la red, usar el Ãºltimo backup local
Â  Â  Â  Â  Â  Â  Â  Â  const localData = localStorage.getItem(DB_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  window.mockDb.data = localData ? JSON.parse(localData) : [];
Â  Â  Â  Â  Â  Â  Â  Â  window.mockDb.handler.onDataChanged(window.mockDb.data);
Â  Â  Â  Â  Â  Â  Â  Â  return { isOk: false };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FUNCIÃ“N DE ESCRITURA: Actualiza TODOS los datos en el BIN
Â  Â  Â  Â  write: async (newData) => {
Â  Â  Â  Â  Â  Â  if (!BIN_ID || !SECRET_KEY || BIN_ID.includes('AQUI')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast('âŒ Error de Config: BIN ID o Key faltantes.');
Â  Â  Â  Â  Â  Â  Â  Â  Â return { isOk: false };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(JSONBIN_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'PUT', // PUT se usa para reemplazar todo el contenido
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'X-Master-Key': SECRET_KEY
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(newData)
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const errorText = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Error ${response.status}: ${errorText}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Si la escritura es exitosa, actualizamos localStorage y notificamos
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(DB_KEY, JSON.stringify(newData));
Â  Â  Â  Â  Â  Â  Â  Â  window.mockDb.data = newData;
Â  Â  Â  Â  Â  Â  Â  Â  window.mockDb.handler.onDataChanged(newData);
Â  Â  Â  Â  Â  Â  Â  Â  return { isOk: true, item: null }; // AÃ±adir item: null para consistencia si es necesario

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("JSONBin WRITE Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error de conexiÃ³n/escritura. Vuelve a intentarlo.');
Â  Â  Â  Â  Â  Â  Â  Â  return { isOk: false };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  // CREAR: Agrega un item y reescribe todo el BIN
Â  Â  Â  Â  create: async (item) => {
Â  Â  Â  Â  Â  Â  item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
Â  Â  Â  Â  Â  Â  const newData = [...window.mockDb.data, item];
Â  Â  Â  Â  Â  Â  const result = await window.dataSdk.write(newData);
Â  Â  Â  Â  Â  Â  return { isOk: result.isOk, item: item };
Â  Â  Â  Â  },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ACTUALIZAR: Modifica un item y reescribe todo el BIN
Â  Â  Â  Â  update: async (item) => {
Â  Â  Â  Â  Â  Â  const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
Â  Â  Â  Â  Â  Â  if (index === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("No se encontrÃ³ el item para actualizar:", item);
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast('âŒ Error: No se encontrÃ³ el registro para actualizar.');
Â  Â  Â  Â  Â  Â  Â  Â  Â return { isOk: false };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const newData = [...window.mockDb.data];
Â  Â  Â  Â  Â  Â  // Clonar para evitar mutar el estado antes de la escritura
Â  Â  Â  Â  Â  Â  newData[index] = {...item};Â 
Â  Â  Â  Â  Â  Â  const result = await window.dataSdk.write(newData);
Â  Â  Â  Â  Â  Â  return { isOk: result.isOk, item: result.isOk ? newData[index] : null };
Â  Â  Â  Â  },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // BORRAR: Elimina un item y reescribe todo el BIN
Â  Â  Â  Â  delete: async (item) => {
Â  Â  Â  Â  Â  Â  const newData = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
Â  Â  Â  Â  Â  Â  const result = await window.dataSdk.write(newData);
Â  Â  Â  Â  Â  Â  return { isOk: result.isOk };
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // ---------------------------------------------------------
Â  Â  // 3. SDK DE CHAT REALTIME (ConexiÃ³n REAL a Supabase)
Â  Â  // ---------------------------------------------------------
Â  Â  let chatChannel = null;
Â  Â Â 
Â  Â  window.chatSdk = {
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ðŸš¨ 3.1. FUNCIÃ“N DE ENVÃO DE MENSAJE (InserciÃ³n en la tabla 'chats')
Â  Â  Â  Â  sendMessage: async (orderId, sender, content) => {
Â  Â  Â  Â  Â  Â  if (!supabaseClient || !content.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error de conexiÃ³n o mensaje vacÃ­o.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // AsegÃºrese de que la tabla 'chats' exista en su Supabase con la columna 'order_id'
Â  Â  Â  Â  Â  Â  const { error } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  .from('chats')
Â  Â  Â  Â  Â  Â  Â  Â  .insert({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_id: orderId,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sender: sender,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content: contentÂ 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al enviar mensaje a Supabase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error al enviar mensaje: ' + error.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  // ðŸš¨ 3.2. FUNCIÃ“N DE SUSCRIPCIÃ“N (Realtime y Carga Inicial)
Â  Â  Â  Â  subscribeToOrder: async (orderId) => {
Â  Â  Â  Â  Â  Â  if (!supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error: Supabase Client no inicializado.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Desuscribirse del canal anterior
Â  Â  Â  Â  Â  Â  window.chatSdk.unsubscribe();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Cargar historial de mensajes (primero)
Â  Â  Â  Â  Â  Â  const { data, error } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  .from('chats')
Â  Â  Â  Â  Â  Â  Â  Â  .select('sender, content, created_at') // Seleccionamos solo las columnas necesarias
Â  Â  Â  Â  Â  Â  Â  Â  .eq('order_id', orderId)
Â  Â  Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: true });

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar historial de chat:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error al cargar historial de chat.');
Â  Â  Â  Â  Â  Â  Â  Â  chatMessages = [{ sender: 'System', content: 'No se pudo cargar el chat.', created_at: new Date().toISOString() }];
Â  Â  Â  Â  Â  Â  Â  Â  window.chatSdk.listener(orderId); // Renderizar con mensaje de error
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  chatMessages = data || [];
Â  Â  Â  Â  Â  Â  window.chatSdk.listener(orderId); // Renderizar historial
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Suscribirse a nuevos mensajes (Realtime)
Â  Â  Â  Â  Â  Â  // Se asume que usted habilitÃ³ la opciÃ³n de Realtime para la tabla 'chats' en Supabase
Â  Â  Â  Â  Â  Â  chatChannel = supabaseClient.channel(`chat_${orderId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  chatChannel
Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: 'INSERT', schema: 'public', table: 'chats', filter: `order_id=eq.${orderId}` },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (payload) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Un nuevo mensaje llegÃ³, aÃ±adirlo y re-renderizar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatMessages.push(payload.new);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.chatSdk.listener(orderId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`ðŸ”” Nuevo mensaje de ${payload.new.sender}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  .subscribe();

Â  Â  Â  Â  Â  Â  showToast('ðŸ’¬ Chat iniciado. Conectado en tiempo real con Supabase.');
Â  Â  Â  Â  },

Â  Â  Â  Â  // 3.3. FunciÃ³n para re-renderizar la interfaz de chat
Â  Â  Â  Â  listener: (orderId) => {
Â  Â  Â  Â  Â  Â  // Esto forza la actualizaciÃ³n solo del modal de chat si estÃ¡ abierto
Â  Â  Â  Â  Â  Â  if (showModal === 'chat') {
Â  Â  Â  Â  Â  Â  Â  Â  const messagesContainer = document.querySelector('.chat-messages');
Â  Â  Â  Â  Â  Â  Â  Â  if (messagesContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderChatMessages(messagesContainer);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },

Â  Â  Â  Â  // 3.4. FunciÃ³n que se llamarÃ­a al cerrar el chat
Â  Â  Â  Â  unsubscribe: () => {
Â  Â  Â  Â  Â  Â  if (chatChannel) {
Â  Â  Â  Â  Â  Â  Â  Â  supabaseClient.removeChannel(chatChannel);
Â  Â  Â  Â  Â  Â  Â  Â  chatChannel = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  };
Â  Â  // ---------------------------------------------------------


Â  Â  // ---------------------------------------------------------
Â  Â  // 4. MANEJADOR DE DATOS (JSONBin)
Â  Â  // ---------------------------------------------------------
Â  Â  const dataHandler = {
Â  Â  Â  onDataChanged(data) {
Â  Â  Â  Â  // Separar los datos por tipo
Â  Â  Â  Â  allProducts = data.filter(item => item.type === 'product') || [];
Â  Â  Â  Â  allUsers = data.filter(item => item.type === 'user') || [];
Â  Â  Â  Â  allOrders = data.filter(item => item.type === 'order') || [];
Â  Â  Â  Â  allReviews = data.filter(item => item.type === 'review') || [];Â 
Â  Â  Â  Â  const activityRecords = data.filter(item => item.type === 'activity') || [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Notificaciones en tiempo real
Â  Â  Â  Â  if (currentUser) {
Â  Â  Â  Â  Â  Â  const newOrderAlert = activityRecords.find(a =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  a.type === 'activity' &&
Â  Â  Â  Â  Â  Â  Â  Â  a.message &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  !a.dismissed &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  (a.username === currentUser.username || currentUser.role === 'admin')Â 
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (newOrderAlert) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`ðŸ”” ${newOrderAlert.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  // Marcar como visto para que no salga de nuevo
Â  Â  Â  Â  Â  Â  Â  Â  const updatedAlert = {...newOrderAlert, dismissed: true};
Â  Â  Â  Â  Â  Â  Â  Â  // Usar update, pero sin esperar el resultado para no bloquear el flujo
Â  Â  Â  Â  Â  Â  Â  Â  window.dataSdk.update(updatedAlert);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Funciones de refresco
Â  Â  Â  Â  validateCart(); // Chequear si algo en el carrito cambiÃ³ de precio o stock
Â  Â  Â  Â  render(); // Volver a pintar la pantalla
Â  Â  Â  }
Â  Â  };

Â  Â  // ---------------------------------------------------------
Â  Â  // 5. ESTADO GLOBAL (VARIABLES EN MEMORIA) - Corregido para definiciÃ³n temprana
Â  Â  // ---------------------------------------------------------
Â  Â  let currentUser = null; // ðŸš¨ Corregido: DeclaraciÃ³n al inicio
Â  Â  let currentView = 'catalog';Â 
Â  Â  let selectedCategory = 'all';
Â  Â  let selectedShopFilter = null;
Â  Â  let adminViewTarget = null;Â 
Â  Â  let selectedProductToEdit = null;Â 
Â  Â  let managedUser = null;Â 
Â  Â  let allProducts = [];
Â  Â  let allUsers = [];
Â  Â  let allOrders = [];
Â  Â  let allReviews = [];Â 
Â  Â  let cart = JSON.parse(localStorage.getItem('mu_cart_v22') || '[]');
Â  Â  let showModal = null;Â 
Â  Â  let selectedOrder = null;Â 
Â  Â  let chatTargetOrder = null;Â 
Â  Â  let chatMessages = [];
Â  Â  // let chatChannel = null; // <--- ERROR DE SINTAXIS CORREGIDO: Declarado en la lÃ­nea 193
Â  Â  let inactivityTimeout;
Â  Â  const TIMEOUT_LIMIT = 5 * 60 * 1000;Â 
Â  Â  const CATEGORIES = [
Â  Â  Â  { id: 'all', name: 'Todos', icon: 'ðŸŽ®' },
Â  Â  Â  { id: 'promotions', name: 'Promociones', icon: 'ðŸ”¥' },
Â  Â  Â  { id: 'items', name: 'Items', icon: 'âš”ï¸' },
Â  Â  Â  { id: 'jewels', name: 'Joyas', icon: 'ðŸ’Ž' },
Â  Â  Â  { id: 'wings', name: 'Alas', icon: 'ðŸ¦…' },
Â  Â  Â  { id: 'sets', name: 'Sets', icon: 'ðŸ›¡ï¸' }
Â  Â  ];
Â  Â  const ADMIN_CREDENTIALS = {
Â  Â  Â  username: 'Kaleb',
Â  Â  Â  password: 'Kaleb.2021',
Â  Â  Â  discord_tag: 'KalebAdmin#9999'
Â  Â  };
Â  Â  let onlineUsers = new Set();
Â  Â  let userActivityTimeout = null;
Â  Â  // ---------------------------------------------------------

Â  Â  // ---------------------------------------------------------
Â  Â  // 6. INICIALIZACIÃ“N (ARRANQUE)
Â  Â  // ---------------------------------------------------------
Â  Â  async function init() {
Â  Â  Â  // Intentar recuperar sesiÃ³n guardada
Â  Â  Â  const storedUser = localStorage.getItem(SESSION_KEY);
Â  Â  Â  if (storedUser) {
Â  Â  Â  Â  currentUser = JSON.parse(storedUser);
Â  Â  Â  Â  showToast(`ðŸ‘‹ SesiÃ³n restaurada: ${currentUser.username}`);
Â  Â  Â  }

Â  Â  Â  // Configurar listeners de inactividad
Â  Â  Â  setupAutoLogout(); // Ya no fallarÃ¡ porque currentUser estÃ¡ definido como null

Â  Â  Â  // Conectar a la "Base de Datos" (JSONBin)
Â  Â  Â  await window.dataSdk.init(dataHandler);
Â  Â  Â Â 
Â  Â  Â  // Configurar SDK visual
Â  Â  Â  if (window.elementSdk) {
Â  Â  Â  Â  window.elementSdk.init({
Â  Â  Â  Â  Â  defaultConfig,
Â  Â  Â  Â  Â  onConfigChange: async (config) => {
Â  Â  Â  Â  Â  Â  document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
Â  Â  Â  Â  Â  Â  document.body.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  Â  const baseSize = config.font_size || defaultConfig.font_size;
Â  Â  Â  Â  Â  Â  document.body.style.fontSize = `${baseSize}px`;
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (currentUser) updateUserActivity();
Â  Â  Â  render();
Â  Â  }

Â  Â  function setupAutoLogout() {
Â  Â  Â  Â  const events = ['mousemove', 'keypress', 'click', 'scroll'];
Â  Â  Â  Â  events.forEach(event => document.addEventListener(event, resetTimer));
Â  Â  Â  Â  resetTimer();
Â  Â  }

Â  Â  function resetTimer() {
Â  Â  Â  Â  if (currentUser) {
Â  Â  Â  Â  Â  Â  clearTimeout(inactivityTimeout);
Â  Â  Â  Â  Â  Â  inactivityTimeout = setTimeout(() => logout(true), TIMEOUT_LIMIT);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------------------------------------
Â  Â  // 7. FUNCIONES DE USUARIO (LOGIN/REGISTRO/LOGOUT)
Â  Â  // ---------------------------------------------------------
Â  Â  async function handleLogin(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const username = document.getElementById('loginUsername').value.trim();
Â  Â  Â  const password = document.getElementById('loginPassword').value;

Â  Â  Â  // Caso Especial: Login Admin Hardcodeado
Â  Â  Â  const ADMIN_CREDENTIALS = {
Â  Â  Â  Â  username: 'Kaleb',
Â  Â  Â  Â  password: 'Kaleb.2021',
Â  Â  Â  Â  discord_tag: 'KalebAdmin#9999'
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
Â  Â  Â  Â  currentUser = {Â 
Â  Â  Â  Â  Â  Â  username,Â 
Â  Â  Â  Â  Â  Â  role: 'admin',Â 
Â  Â  Â  Â  Â  Â  __backendId: 'admin',
Â  Â  Â  Â  Â  Â  discord_tag: ADMIN_CREDENTIALS.discord_tagÂ 
Â  Â  Â  Â  };
Â  Â  Â  Â  localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  currentView = 'admin';
Â  Â  Â  Â  showToast('Bienvenido Admin (Modo Dios Activo)');
Â  Â  Â  Â  await updateUserActivity();
Â  Â  Â  Â  render();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Login Normal
Â  Â  Â  const user = allUsers.find(u => u.username === username && u.password === password);
Â  Â  Â  if (user) {
Â  Â  Â  Â  if (user.status === 'banned') {
Â  Â  Â  Â  Â  Â  showToast('ðŸš« Tu cuenta ha sido suspendida/baneada.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (user.role === 'reseller' && !user.approved) {
Â  Â  Â  Â  Â  showToast('Tu cuenta aÃºn no ha sido aprobada por el Admin.');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Guardamos sesiÃ³n con datos frescos
Â  Â  Â  Â  currentUser = {Â 
Â  Â  Â  Â  Â  username: user.username,
Â  Â  Â  Â  Â  role: user.role,
Â  Â  Â  Â  Â  shop_name: user.shop_name,
Â  Â  Â  Â  Â  discord_tag: user.discord_tag || 'No Informado',Â 
Â  Â  Â  Â  Â  __backendId: user.__backendId
Â  Â  Â  Â  };
Â  Â  Â  Â  localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Si es vendedor sin configurar o pendiente de aprobaciÃ³n (pero ya tiene usuario)
Â  Â  Â  Â  if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
Â  Â  Â  Â  Â  selectedOrder = user;
Â  Â  Â  Â  Â  showModal = 'setupShop';
Â  Â  Â  Â  Â  showToast('Por favor configura tu tienda para continuar');
Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  if (user.role === 'reseller' || user.role === 'admin') {
Â  Â  Â  Â  Â  currentView = 'admin';
Â  Â  Â  Â  }
Â  Â  Â  Â  showToast(`Bienvenido ${username}`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  await updateUserActivity();
Â  Â  Â  Â  render();
Â  Â  Â  } else {
Â  Â  Â  Â  showToast('Usuario o contraseÃ±a incorrectos');
Â  Â  Â  }
Â  Â  }

Â  Â  async function handleRegisterBuyer(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const username = document.getElementById('buyerUsername').value.trim();
Â  Â  Â  const password = document.getElementById('buyerPassword').value;
Â  Â  Â  const discord = document.getElementById('buyerDiscord').value.trim();

Â  Â  Â  if (allUsers.find(u => u.username === username)) {
Â  Â  Â  Â  showToast('El usuario ya existe');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (allUsers.find(u => u.discord_tag === discord)) {
Â  Â  Â  Â  showToast('El Discord ya estÃ¡ registrado.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const userData = {
Â  Â  Â  Â  id: Date.now().toString(),
Â  Â  Â  Â  type: 'user',
Â  Â  Â  Â  username,
Â  Â  Â  Â  password,
Â  Â  Â  Â  discord_tag: discord || 'No Informado',Â 
Â  Â  Â  Â  profile_picture: '',
Â  Â  Â  Â  role: 'buyer',
Â  Â  Â  Â  approved: true,
Â  Â  Â  Â  status: 'active',
Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  };

Â  Â  Â  const result = await window.dataSdk.create(userData);
Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  showToast('Registro exitoso! Ahora puedes iniciar sesiÃ³n');
Â  Â  Â  Â  showModal = 'login';
Â  Â  Â  Â  render();
Â  Â  Â  } else {
Â  Â  Â  Â  showToast('Error al registrar usuario');
Â  Â  Â  }
Â  Â  }

Â  Â  async function handleRegisterReseller(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const username = document.getElementById('resellerUsername').value.trim();
Â  Â  Â  const password = document.getElementById('resellerPassword').value;
Â  Â  Â  const discord = document.getElementById('resellerDiscord').value.trim();
Â  Â  Â  const shopName = document.getElementById('resellerShop').value.trim();

Â  Â  Â  if (allUsers.find(u => u.username === username)) {
Â  Â  Â  Â  showToast('El usuario ya existe');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (allUsers.find(u => u.discord_tag === discord)) {
Â  Â  Â  Â  showToast('El Discord ya estÃ¡ registrado.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const userData = {
Â  Â  Â  Â  id: Date.now().toString(),
Â  Â  Â  Â  type: 'user',
Â  Â  Â  Â  username,
Â  Â  Â  Â  password,
Â  Â  Â  Â  discord_tag: discord || 'No Informado',Â 
Â  Â  Â  Â  shop_name: shopName,
Â  Â  Â  Â  profile_picture: '',
Â  Â  Â  Â  role: 'reseller',
Â  Â  Â  Â  approved: false, // Inicia como no aprobado
Â  Â  Â  Â  status: 'pending', // Inicia en pendiente
Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  };

Â  Â  Â  const result = await window.dataSdk.create(userData);
Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  showToast('Solicitud enviada! Espera aprobaciÃ³n del admin.');
Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  render();
Â  Â  Â  } else {
Â  Â  Â  Â  showToast('Error al enviar solicitud');
Â  Â  Â  }
Â  Â  }

Â  Â  async function updateUserActivity() {
Â  Â  Â  if (!currentUser) return;
Â  Â  Â Â 
Â  Â  Â  const activityRecords = window.mockDb.data.filter(item => item.type === 'activity');
Â  Â  Â  const existingActivity = activityRecords.find(a => a.username === currentUser.username);
Â  Â  Â Â 
Â  Â  Â  const activityData = {
Â  Â  Â  Â  id: 'activity_' + currentUser.username,
Â  Â  Â  Â  type: 'activity',
Â  Â  Â  Â  username: currentUser.username,
Â  Â  Â  Â  last_activity: new Date().toISOString()
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  // Intenta actualizar si existe, si no, lo crea.
Â  Â  Â  if (existingActivity) {
Â  Â  Â  Â  Â  Â const updatedActivity = {...existingActivity, last_activity: new Date().toISOString()};
Â  Â  Â  Â  Â  Â await window.dataSdk.update(updatedActivity);
Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â await window.dataSdk.create(activityData);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (userActivityTimeout) clearTimeout(userActivityTimeout);
Â  Â  Â  userActivityTimeout = setTimeout(updateUserActivity, 3 * 60 * 1000);
Â  Â  }

Â  Â  function logout(auto = false) {
Â  Â  Â  if (userActivityTimeout) clearTimeout(userActivityTimeout);
Â  Â  Â  clearTimeout(inactivityTimeout);
Â  Â  Â  currentUser = null;
Â  Â  Â  localStorage.removeItem(SESSION_KEY);
Â  Â  Â  currentView = 'catalog';
Â  Â  Â  cart = [];
Â  Â  Â  localStorage.setItem('mu_cart_v22', '[]');
Â  Â  Â  selectedShopFilter = null;
Â  Â  Â  adminViewTarget = null; // Resetear modo gestiÃ³n
Â  Â  Â  managedUser = null; // Resetear usuario gestionado
Â  Â  Â  window.chatSdk.unsubscribe(); // Detener el listener del chat
Â  Â  Â  showToast(auto ? 'ðŸ’¤ SesiÃ³n cerrada por inactividad' : 'SesiÃ³n cerrada');
Â  Â  Â  render();
Â  Â  }
Â  Â Â 
Â  Â  // FunciÃ³n para completar la configuraciÃ³n de tienda (Admin lo activa o Vendedor lo completa)
Â  Â  async function handleSetupShop(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const user = selectedOrder; // Usuario que necesita configuraciÃ³n
Â  Â  Â  if(!user) return;
Â  Â  Â Â 
Â  Â  Â  const setupShopNameInput = document.getElementById('setupShopName');
Â  Â  Â  const setupDiscordInput = document.getElementById('setupDiscord');
Â  Â  Â Â 
Â  Â  Â  if (!setupShopNameInput || !setupDiscordInput) {
Â  Â  Â  Â  Â  showToast('Error: Campos de formulario no encontrados.');
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const shopName = setupShopNameInput.value.trim();
Â  Â  Â  const discord = setupDiscordInput.value.trim();
Â  Â  Â Â 
Â  Â  Â  // Validar discord unico (excluyendo al usuario actual)
Â  Â  Â  if(allUsers.find(u => u.discord_tag === discord && u.__backendId !== user.__backendId)) {
Â  Â  Â  Â  Â  showToast('Este Discord ya estÃ¡ en uso por otro usuario.');
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const updatedUser = {
Â  Â  Â  Â  Â  ...user,
Â  Â  Â  Â  Â  shop_name: shopName,
Â  Â  Â  Â  Â  discord_tag: discord || 'No Informado',
Â  Â  Â  Â  Â  approved: true,Â 
Â  Â  Â  Â  Â  status: 'active'Â 
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  const result = await window.dataSdk.update(updatedUser);
Â  Â  Â Â 
Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  // Si el usuario que completa es el mismo que estÃ¡ logueado
Â  Â  Â  Â  Â  if(currentUser && user.__backendId === currentUser.__backendId) {
Â  Â  Â  Â  Â  Â  Â  // Actualizar el estado de la sesiÃ³n
Â  Â  Â  Â  Â  Â  Â  currentUser = updatedUser;
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
Â  Â  Â  Â  Â  Â  Â  currentView = 'admin'; // Mover al panel
Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  Â  selectedOrder = null;
Â  Â  Â  Â  Â  showToast('âœ… ConfiguraciÃ³n de tienda guardada. Tienda Activada.');
Â  Â  Â  Â  Â  render();Â 
Â  Â  Â  } else {
Â  Â  Â  Â  Â  showToast('Error al actualizar la configuraciÃ³n de la tienda.');
Â  Â  Â  }
Â  Â  }


Â  Â  // ---------------------------------------------------------
Â  Â  // 8. GESTIÃ“N DE PRODUCTOS (CRUD COMPLETO)
Â  Â  // ---------------------------------------------------------
Â  Â Â 
Â  Â  // FunciÃ³n centralizada para abrir la gestiÃ³n de productos de cualquier usuario
Â  Â  function openProductManagement(username) {
Â  Â  Â  Â  if (currentUser.role === 'admin' && currentUser.username !== username) {
Â  Â  Â  Â  Â  Â  enterShopManagement(username);
Â  Â  Â  Â  } else if (currentUser.username === username && (currentUser.role === 'reseller' || currentUser.role === 'admin')) {
Â  Â  Â  Â  Â  Â  currentView = 'admin';
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('No tienes permisos para gestionar esta tienda.');
Â  Â  Â  Â  }
Â  Â  Â  Â  showModal = null;
Â  Â  }
Â  Â Â 
Â  Â  async function handleAddProduct(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  if (allProducts.length >= 999) {
Â  Â  Â  Â  showToast('LÃ­mite de productos alcanzado');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Determinar quiÃ©n es el dueÃ±o (Soporte para Admin Gestionando Tienda ajena)
Â  Â  Â  const ownerUsername = adminViewTarget ? adminViewTarget : currentUser.username;
Â  Â  Â  const ownerData = allUsers.find(u => u.username === ownerUsername) || currentUser;

Â  Â  Â  const btn = e.target.querySelector('button[type="submit"]');
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

Â  Â  Â  let imageUrl = document.getElementById('productImage').value.trim();
Â  Â  Â  // Asegurar formato de Imgur para display (si es link directo)
Â  Â  Â  if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
Â  Â  Â  Â  imageUrl = imageUrl + '.jpg';
Â  Â  Â  }

Â  Â  Â  const discount = parseInt(document.getElementById('productDiscount').value) || 0;
Â  Â  Â  const onSale = document.getElementById('productOnSale').checked;
Â  Â  Â  const originalPrice = parseFloat(document.getElementById('productPrice').value);
Â  Â  Â  const finalPrice = discount > 0 ? originalPrice * (1 - discount / 100) : originalPrice;

Â  Â  Â  const productData = {
Â  Â  Â  Â  id: Date.now().toString(),
Â  Â  Â  Â  type: 'product',
Â  Â  Â  Â  name: document.getElementById('productName').value.trim(),
Â  Â  Â  Â  category: document.getElementById('productCategory').value,
Â  Â  Â  Â  price: originalPrice,
Â  Â  Â  Â  final_price: parseFloat(finalPrice.toFixed(2)), // Fix para evitar errores de coma flotante en precios
Â  Â  Â  Â  discount: discount,
Â  Â  Â  Â  on_sale: onSale,
Â  Â  Â  Â  stock: parseInt(document.getElementById('productStock').value),
Â  Â  Â  Â  description: document.getElementById('productDescription').value.trim(),
Â  Â  Â  Â  image_url: imageUrl,
Â  Â  Â  Â  seller_username: ownerUsername,
Â  Â  Â  Â  seller_shop_name: ownerData.shop_name || ownerUsername,
Â  Â  Â  Â  seller_discord: ownerData.discord_tag || 'No Informado',
Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  };

Â  Â  Â  const result = await window.dataSdk.create(productData);
Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  showToast('Producto agregado exitosamente');
Â  Â  Â  Â  e.target.reset();
Â  Â  Â  } else {
Â  Â  Â  Â  showToast('Error al agregar producto');
Â  Â  Â  }

Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Publicar Ahora';
Â  Â  }

Â  Â  // FunciÃ³n para Abrir Modal de EdiciÃ³n
Â  Â  function openEditModal(backendId) {
Â  Â  Â  Â  const product = allProducts.find(p => p.__backendId === backendId);
Â  Â  Â  Â  if (!product) return;
Â  Â  Â  Â  selectedProductToEdit = product;
Â  Â  Â  Â  showModal = 'editProduct';
Â  Â  Â  Â  render();
Â  Â  }

Â  Â  // FunciÃ³n para Guardar Cambios del Producto
Â  Â  async function handleUpdateProduct(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (!selectedProductToEdit) return;

Â  Â  Â  Â  const price = parseFloat(document.getElementById('editPrice').value);
Â  Â  Â  Â  const discount = parseInt(document.getElementById('editDiscount').value) || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let imageUrl = document.getElementById('editImage').value.trim();
Â  Â  Â  Â  if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
Â  Â  Â  Â  Â  Â  imageUrl += '.jpg';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const finalPrice = discount > 0 ? price * (1 - discount / 100) : price;

Â  Â  Â  Â  const updatedProduct = {
Â  Â  Â  Â  Â  Â  ...selectedProductToEdit,
Â  Â  Â  Â  Â  Â  name: document.getElementById('editName').value.trim(),
Â  Â  Â  Â  Â  Â  stock: parseInt(document.getElementById('editStock').value),
Â  Â  Â  Â  Â  Â  price: price,
Â  Â  Â  Â  Â  Â  discount: discount,
Â  Â  Â  Â  Â  Â  final_price: parseFloat(finalPrice.toFixed(2)), // Fix para consistencia
Â  Â  Â  Â  Â  Â  description: document.getElementById('editDescription').value.trim(),
Â  Â  Â  Â  Â  Â  image_url: imageUrl,
Â  Â  Â  Â  Â  Â  on_sale: document.getElementById('editOnSale').checked
Â  Â  Â  Â  };

Â  Â  Â  Â  const result = await window.dataSdk.update(updatedProduct);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  Â  showToast('âœ… Producto actualizado correctamente');
Â  Â  Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  Â  Â  selectedProductToEdit = null;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('Error al actualizar producto');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function deleteProduct(backendId) {
Â  Â  Â  if(!confirm("Â¿EstÃ¡s seguro de borrar este producto?")) return;
Â  Â  Â Â 
Â  Â  Â  const product = allProducts.find(p => p.__backendId === backendId);
Â  Â  Â  if (!product) return;
Â  Â  Â Â 
Â  Â  Â  const result = await window.dataSdk.delete(product);Â 
Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  showToast('Producto eliminado');
Â  Â  Â  } else {
Â  Â  Â  Â  showToast('Error al eliminar producto');
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------------------------------------------------
Â  Â  // 9. GESTIÃ“N DE USUARIOS (ADMIN)
Â  Â  // ---------------------------------------------------------
Â  Â Â 
Â  Â  // Nueva funciÃ³n para abrir el modal de gestiÃ³n
Â  Â  function openManageUserModal(username) {
Â  Â  Â  Â  managedUser = allUsers.find(u => u.username === username);
Â  Â  Â  Â  if (!managedUser) {
Â  Â  Â  Â  Â  Â  showToast('Usuario no encontrado.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  showModal = 'manageUser';
Â  Â  Â  Â  render();
Â  Â  }
Â  Â Â 
Â  Â  // FunciÃ³n para eliminar todos los pedidos completados (LOG HISTÃ“RICO)
Â  Â  async function clearCompletedOrdersLog() {
Â  Â  Â  Â  if (!currentUser || currentUser.role !== 'admin') {
Â  Â  Â  Â  Â  Â  showToast('Acceso denegado.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!confirm("âš ï¸ Â¡ADVERTENCIA CRÃTICA!\n\nEsta acciÃ³n eliminarÃ¡ PERMANENTEMENTE TODOS los pedidos con estado 'COMPLETADO' (Log HistÃ³rico). Â¿EstÃ¡s seguro de continuar?")) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showToast('Limpiando log de pedidos completados...');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const ordersToDelete = allOrders.filter(o => o.order_status === 'completed');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Crear una nueva lista de datos sin los pedidos completados
Â  Â  Â  Â  const newDbData = window.mockDb.data.filter(item =>Â 
Â  Â  Â  Â  Â  Â  item.type !== 'order' || item.order_status !== 'completed'
Â  Â  Â  Â  );
Â  Â  Â  Â Â 
Â  Â  Â  Â  const result = await window.dataSdk.write(newDbData);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  Â  showToast(`âœ… Log HistÃ³rico de ${ordersToDelete.length} pedidos eliminado exitosamente.`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('âŒ Error al eliminar el log histÃ³rico. Verifica el BIN.');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function approveUser(backendId) {
Â  Â  Â  Â  const user = allUsers.find(u => u.__backendId === backendId);
Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  showToast('âŒ Usuario no encontrado o ID no vÃ¡lido.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Si el vendedor no tiene nombre de tienda o discord, forzar setup (Admin lo puede hacer por Ã©l o forzar que lo haga)
Â  Â  Â  Â  if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag || user.status === 'pending')) {
Â  Â  Â  Â  Â  Â  selectedOrder = user;
Â  Â  Â  Â  Â  Â  showModal = 'setupShop';
Â  Â  Â  Â  Â  Â  showToast('El vendedor necesita completar la configuraciÃ³n de su tienda antes de la activaciÃ³n final.');
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const updatedUser = { ...user, status: 'active', approved: true };
Â  Â  Â  Â  const result = await window.dataSdk.update(updatedUser);
Â  Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  Â  showToast('âœ… Usuario ACEPTADO y activado');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('âŒ Error al actualizar usuario. Verifica el estado del BIN.');
Â  Â  Â  Â  }
Â  Â  Â  Â  showModal = null; // Cerrar cualquier modal que estÃ© abierto
Â  Â  }

Â  Â  async function rejectUser(backendId) {
Â  Â  Â  Â  deleteUserAccount(backendId);
Â  Â  }

Â  Â  async function banUser(backendId) {
Â  Â  Â  Â  const user = allUsers.find(u => u.__backendId === backendId);
Â  Â  Â  Â  if (!user) return;
Â  Â  Â  Â  let updatedUser;
Â  Â  Â  Â  if(user.status === 'banned') {
Â  Â  Â  Â  Â  Â  updatedUser = {...user, status: 'active', approved: true};
Â  Â  Â  Â  Â  Â  await window.dataSdk.update(updatedUser);
Â  Â  Â  Â  Â  Â  showToast('Usuario desbaneado (activo)');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  updatedUser = {...user, status: 'banned', approved: false};
Â  Â  Â  Â  Â  Â  await window.dataSdk.update(updatedUser);
Â  Â  Â  Â  Â  Â  showToast('ðŸš« Usuario BANEADO exitosamente');
Â  Â  Â  Â  }
Â  Â  Â  Â  showModal = null;
Â  Â  }

Â  Â  async function deleteUserAccount(backendId) {
Â  Â  Â  Â  if(!confirm("âš ï¸ Â¡ADVERTENCIA DE SEGURIDAD!\n\nÂ¿EstÃ¡s COMPLETAMENTE SEGURO de eliminar este usuario?\nEsta acciÃ³n borrarÃ¡ su cuenta y TODOS sus productos.")) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const user = allUsers.find(u => u.__backendId === backendId);
Â  Â  Â  Â  if (!user) return;

Â  Â  Â  Â  if(user.role === 'reseller') {
Â  Â  Â  Â  Â  Â  const userProducts = allProducts.filter(p => p.seller_username === user.username);
Â  Â  Â  Â  Â  Â  // El dataSDK.delete elimina de la lista y reescribe, esto es costoso
Â  Â  Â  Â  Â  Â  for(const p of userProducts) {
Â  Â  Â  Â  Â  Â  Â  Â  await window.dataSdk.delete(p);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  const result = await window.dataSdk.delete(user);
Â  Â  Â  Â  if (result.isOk) showToast('ðŸ—‘ï¸ Cuenta eliminada correctamente');
Â  Â  Â  Â  showModal = null;
Â  Â  }
Â  Â Â 
Â  Â  // --- FUNCIONES DE MODO DIOS (ADMIN ENTRA EN TIENDA) ---
Â  Â  function enterShopManagement(targetUsername) {
Â  Â  Â  Â  adminViewTarget = targetUsername;
Â  Â  Â  Â  showToast(`ðŸ‘ï¸ Gestionando tienda de: ${targetUsername}`);
Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  currentView = 'admin';
Â  Â  Â  Â  render();
Â  Â  }
Â  Â Â 
Â  Â  function exitShopManagement() {
Â  Â  Â  Â  adminViewTarget = null;
Â  Â  Â  Â  showToast('ðŸ”™ Volviendo a vista global');
Â  Â  Â  Â  render();
Â  Â  }
Â  Â Â 
Â  Â  // FunciÃ³n para refrescar datos en la vista Admin
Â  Â  async function loadAdminView() {
Â  Â  Â  Â  showToast('ðŸ”„ Sincronizando datos remotos...');
Â  Â  Â  Â  // Forzamos la lectura para asegurar los Ãºltimos cambios de usuarios/pedidos
Â  Â  Â  Â  const result = await window.dataSdk.read();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  Â  Â showToast('âœ… SincronizaciÃ³n completa.');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â showToast('âš ï¸ No se pudo sincronizar la lista de usuarios del BIN.');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  currentView = 'admin';
Â  Â  Â  Â  render();
Â  Â  }

Â  Â  // ---------------------------------------------------------
Â  Â  // 10. CARRITO Y PEDIDOS
Â  Â  // ---------------------------------------------------------
Â  Â  function updateCartStorage() {
Â  Â  Â  Â  localStorage.setItem('mu_cart_v22', JSON.stringify(cart));
Â  Â  }

Â  Â  function validateCart() {
Â  Â  Â  Â  if (cart.length === 0) return;
Â  Â  Â  Â  let cartModified = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const newCart = cart.filter(cartItem => {
Â  Â  Â  Â  Â  Â  const correspondingProduct = allProducts.find(p => p.__backendId === cartItem.__backendId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!correspondingProduct) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`âŒ El item "${cartItem.name}" ha sido eliminado del catÃ¡logo.`);
Â  Â  Â  Â  Â  Â  Â  Â  cartModified = true;
Â  Â  Â  Â  Â  Â  Â  Â  return false;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (cartItem.quantity > correspondingProduct.stock) {
Â  Â  Â  Â  Â  Â  Â  Â  cartItem.quantity = correspondingProduct.stock;
Â  Â  Â  Â  Â  Â  Â  Â  cartModified = true;
Â  Â  Â  Â  Â  Â  Â  Â  if (cartItem.quantity === 0) return false;
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`âš ï¸ Stock de "${cartItem.name}" limitado a ${cartItem.quantity}.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Sincronizar precios en vivo
Â  Â  Â  Â  Â  Â  if (cartItem.price !== correspondingProduct.price || cartItem.final_price !== correspondingProduct.final_price) {
Â  Â  Â  Â  Â  Â  Â  Â  cartItem.price = correspondingProduct.price;
Â  Â  Â  Â  Â  Â  Â  Â  cartItem.final_price = correspondingProduct.final_price;
Â  Â  Â  Â  Â  Â  Â  Â  cartItem.name = correspondingProduct.name;
Â  Â  Â  Â  Â  Â  Â  Â  cartModified = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (cartModified) {
Â  Â  Â  Â  Â  Â  cart = newCart;
Â  Â  Â  Â  Â  Â  updateCartStorage();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function addToCart(backendId) {
Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  showToast('Inicia sesiÃ³n para agregar al carrito');
Â  Â  Â  Â  showModal = 'login';
Â  Â  Â  Â  render();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const product = allProducts.find(p => p.__backendId === backendId);
Â  Â  Â  if (!product || product.stock <= 0) {
Â  Â  Â  Â  showToast('Producto sin stock');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const existing = cart.find(item => item.__backendId === backendId);
Â  Â  Â  if (existing) {
Â  Â  Â  Â  if (existing.quantity < product.stock) {
Â  Â  Â  Â  Â  existing.quantity++;
Â  Â  Â  Â  Â  showToast('Cantidad actualizada');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showToast('No hay mÃ¡s stock disponible');
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  cart.push({ ...product, quantity: 1 });
Â  Â  Â  Â  showToast('Agregado al carrito');
Â  Â  Â  }
Â  Â  Â  updateCartStorage();
Â  Â  Â  render();
Â  Â  }

Â  Â  function removeFromCart(index) {
Â  Â  Â  cart.splice(index, 1);
Â  Â  Â  updateCartStorage();
Â  Â  Â  render();
Â  Â  }

Â  Â  // FILTROS
Â  Â  function filterByShop(shopName) {
Â  Â  Â  Â  selectedShopFilter = shopName;
Â  Â  Â  Â  selectedCategory = 'all';Â 
Â  Â  Â  Â  showToast(`ðŸ›’ Viendo tienda: ${shopName}`);
Â  Â  Â  Â  render();
Â  Â  }

Â  Â  function clearShopFilter() {
Â  Â  Â  Â  selectedShopFilter = null;
Â  Â  Â  Â  render();
Â  Â  }

Â  Â  // CREAR PEDIDO
Â  Â  async function createOrder() {
Â  Â  Â  if (cart.length === 0) return;
Â  Â  Â  validateCart();Â 
Â  Â  Â  if (cart.length === 0) return;

Â  Â  Â  // Agrupar productos por vendedor
Â  Â  Â  const ordersBySeller = {};
Â  Â  Â  cart.forEach(item => {
Â  Â  Â  Â  if (!ordersBySeller[item.seller_username]) {
Â  Â  Â  Â  Â  ordersBySeller[item.seller_username] = {
Â  Â  Â  Â  Â  Â  seller: item.seller_username,
Â  Â  Â  Â  Â  Â  discord: item.seller_discord,
Â  Â  Â  Â  Â  Â  items: [],
Â  Â  Â  Â  Â  Â  total: 0
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â  const itemPrice = item.discount > 0 ? item.final_price : item.price;
Â  Â  Â  Â  ordersBySeller[item.seller_username].items.push(item);
Â  Â  Â  Â  ordersBySeller[item.seller_username].total += itemPrice * item.quantity;
Â  Â  Â  });

Â  Â  Â  let allOk = true;
Â  Â  Â  for (const sellerUsername in ordersBySeller) {
Â  Â  Â  Â  const orderInfo = ordersBySeller[sellerUsername];
Â  Â  Â  Â  const itemsDesc = orderInfo.items.map(item => {
Â  Â  Â  Â  Â  return `${item.name} x${item.quantity} ($${(item.final_price * item.quantity).toFixed(2)})`;
Â  Â  Â  Â  }).join(' | ');

Â  Â  Â  Â  const itemsData = JSON.stringify(orderInfo.items.map(item => ({
Â  Â  Â  Â  Â  backendId: item.__backendId,
Â  Â  Â  Â  Â  name: item.name,
Â  Â  Â  Â  Â  quantity: item.quantity
Â  Â  Â  Â  })));

Â  Â  Â  Â  // Asegurar Discord del Comprador y Vendedor
Â  Â  Â  Â  const buyerDiscord = currentUser.discord_tag || 'No Informado';
Â  Â  Â  Â  const sellerDiscord = orderInfo.discord || 'No Informado';

Â  Â  Â  Â  const orderData = {
Â  Â  Â  Â  Â  id: Date.now().toString() + '_' + sellerUsername,
Â  Â  Â  Â  Â  type: 'order',
Â  Â  Â  Â  Â  buyer_username: currentUser.username,
Â  Â  Â  Â  Â  buyer_discord: buyerDiscord,Â 
Â  Â  Â  Â  Â  seller_username: sellerUsername,
Â  Â  Â  Â  Â  seller_discord: sellerDiscord,
Â  Â  Â  Â  Â  items: itemsDesc,
Â  Â  Â  Â  Â  items_data: itemsData,
Â  Â  Â  Â  Â  total: parseFloat(orderInfo.total.toFixed(2)), // Fix para consistencia
Â  Â  Â  Â  Â  order_status: 'pending',
Â  Â  Â  Â  Â  seller_confirmed: false,
Â  Â  Â  Â  Â  buyer_confirmed: false,
Â  Â  Â  Â  Â  needs_review: false,Â 
Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  };

Â  Â  Â  Â  const result = await window.dataSdk.create(orderData);
Â  Â  Â  Â  if (!result.isOk) {
Â  Â  Â  Â  Â  allOk = false;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // NotificaciÃ³n Interna para el vendedor
Â  Â  Â  Â  Â  Â  const notificationData = {
Â  Â  Â  Â  Â  Â  Â  Â  id: 'ntf_' + Date.now(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  type: 'activity',
Â  Â  Â  Â  Â  Â  Â  Â  username: sellerUsername,Â 
Â  Â  Â  Â  Â  Â  Â  Â  message: `Â¡NUEVO PEDIDO de ${currentUser.username}!`,
Â  Â  Â  Â  Â  Â  Â  Â  dismissed: false,Â 
Â  Â  Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  await window.dataSdk.create(notificationData);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if (!allOk) {
Â  Â  Â  Â  Â  showToast('Error al crear uno o mÃ¡s pedidos');
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  showToast('Pedido(s) creado(s) exitosamente! Esperando confirmaciÃ³n del vendedor.');
Â  Â  Â  cart = [];
Â  Â  Â  updateCartStorage();
Â  Â  Â  currentView = 'orders';
Â  Â  Â  render();
Â  Â  }

Â  Â  async function confirmOrder(backendId, isSeller) {
Â  Â  Â  const order = allOrders.find(o => o.__backendId === backendId);
Â  Â  Â  if (!order) return;

Â  Â  Â  let updatedOrder = {...order};

Â  Â  Â  if (isSeller) {
Â  Â  Â  Â  // Vendedor confirma entrega (PRIMER PASO)
Â  Â  Â  Â  updatedOrder.seller_confirmed = true;
Â  Â  Â  Â  showToast('Vendedor confirma entrega. Â¡Ahora el comprador debe confirmar recepciÃ³n!');
Â  Â  Â  } else {
Â  Â  Â  Â  // Comprador confirma recepciÃ³n (SEGUNDO PASO)
Â  Â  Â  Â  if (!order.seller_confirmed) {
Â  Â  Â  Â  Â  Â  showToast('âš ï¸ Error: El vendedor aÃºn no ha marcado el pedido como entregado. Esto es obligatorio para confirmar la recepciÃ³n.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  updatedOrder.buyer_confirmed = true;
Â  Â  Â  }

Â  Â  Â  const result = await window.dataSdk.update(updatedOrder);Â 
Â  Â  Â Â 
Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  // SI AMBOS CONFIRMARON, RESTAR STOCK Y FINALIZAR
Â  Â  Â  Â  Â  if (result.item.seller_confirmed && result.item.buyer_confirmed && result.item.order_status !== 'completed') {
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  const completedOrder = {...result.item, order_status: 'completed', needs_review: true}; // <-- needs_review activado
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const itemsData = JSON.parse(completedOrder.items_data);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Restar Stock de todos los productos
Â  Â  Â  Â  Â  Â  Â  Â  for (const item of itemsData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const product = allProducts.find(p => p.__backendId === item.backendId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (product) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedProduct = {...product, stock: Math.max(0, product.stock - item.quantity)};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Disparamos la actualizaciÃ³n de producto, pero no esperamos.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.dataSdk.update(updatedProduct);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Actualizar el estado de la orden a completada
Â  Â  Â  Â  Â  Â  Â  Â  await window.dataSdk.update(completedOrder);Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âœ… Â¡Pedido completado y Stock actualizado! Tienda entra en el Ranking.');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ðŸš¨ OPTIMIZACIÃ“N CRÃTICA: Forzar recarga completa de datos del BIN
Â  Â  Â  Â  Â  Â  Â  Â  await window.dataSdk.read();Â 

Â  Â  Â  Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al procesar stock o actualizar orden final:", e);
Â  Â  Â  Â  Â  Â  Â  Â  showToast("Error crÃ­tico al finalizar la orden. Stock no actualizado.");
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else if (result.item.buyer_confirmed) {
Â  Â  Â  Â  Â  Â  Â  showToast('âœ… RecepciÃ³n de items confirmada. Esperando finalizaciÃ³n de la venta.');
Â  Â  Â  Â  Â  } else if (result.item.seller_confirmed) {
Â  Â  Â  Â  Â  Â  Â // El vendedor ya confirmÃ³, el toast ya se mostrÃ³ arriba.
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  render();
Â  Â  }

Â  Â  // ---------------------------------------------------------
Â  Â  // 11. FUNCIONES DE RESEÃ‘A
Â  Â  // ---------------------------------------------------------
Â  Â  function getShopRating(username) {
Â  Â  Â  Â  const reviews = allReviews.filter(r => r.reviewed_seller === username);
Â  Â  Â  Â  const avg = reviews.length ? (reviews.reduce((a,b)=>a+b.rating,0)/reviews.length).toFixed(1) : 0;
Â  Â  Â  Â  return { rating: parseFloat(avg), reviewCount: reviews.length };
Â  Â  }

Â  Â  function getStarHtml(rating) {
Â  Â  Â  Â  const fullStars = Math.floor(rating);
Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  for (let i = 0; i < fullStars; i++) {
Â  Â  Â  Â  Â  Â  html += 'â­';
Â  Â  Â  Â  }
Â  Â  Â  Â  return html || (rating > 0 ? 'N/A' : 'Sin calificar');Â 
Â  Â  }

Â  Â  async function handleSubmitReview(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (!selectedOrder) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const rating = parseInt(document.getElementById('reviewRating').value);
Â  Â  Â  Â  const comment = document.getElementById('reviewComment').value.trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (rating < 1 || rating > 5) {
Â  Â  Â  Â  Â  Â  showToast('La calificaciÃ³n debe ser entre 1 y 5.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const reviewData = {
Â  Â  Â  Â  Â  Â  id: Date.now().toString(),
Â  Â  Â  Â  Â  Â  type: 'review',
Â  Â  Â  Â  Â  Â  reviewed_order: selectedOrder.__backendId,
Â  Â  Â  Â  Â  Â  reviewed_seller: selectedOrder.seller_username,
Â  Â  Â  Â  Â  Â  reviewer: currentUser.username,
Â  Â  Â  Â  Â  Â  rating: rating,
Â  Â  Â  Â  Â  Â  comment: comment,
Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const reviewResult = await window.dataSdk.create(reviewData);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (reviewResult.isOk) {
Â  Â  Â  Â  Â  Â  // Marcar la orden como revisada
Â  Â  Â  Â  Â  Â  const updatedOrder = {...selectedOrder, needs_review: false};
Â  Â  Â  Â  Â  Â  await window.dataSdk.update(updatedOrder);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showToast('âœ… Â¡ReseÃ±a enviada! Gracias por tu feedback.');
Â  Â  Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  Â  Â  selectedOrder = null;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('âŒ Error al enviar la reseÃ±a.');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // ---------------------------------------------------------
Â  Â  // 12. FUNCIONES DE CHAT
Â  Â  // ---------------------------------------------------------
Â  Â  function openChatModal(orderId) {
Â  Â  Â  Â  const order = allOrders.find(o => o.__backendId === orderId);
Â  Â  Â  Â  if (!order) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  chatTargetOrder = order;
Â  Â  Â  Â  showModal = 'chat';
Â  Â  Â  Â  render(); // Abrir el modal
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Iniciar la conexiÃ³n en tiempo real con Supabase
Â  Â  Â  Â  window.chatSdk.subscribeToOrder(orderId);
Â  Â  }
Â  Â Â 
Â  Â  function closeChatModal() {
Â  Â  Â  Â  window.chatSdk.unsubscribe();
Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  chatTargetOrder = null;
Â  Â  Â  Â  render();
Â  Â  }
Â  Â Â 
Â  Â  async function handleChatMessageSend(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (!chatTargetOrder || !currentUser) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const input = document.getElementById('chatInput');
Â  Â  Â  Â  const content = input.value;
Â  Â  Â  Â  if (!content.trim()) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Usamos el __backendId que es el ID Ãºnico del pedido en JSONBin
Â  Â  Â  Â  await window.chatSdk.sendMessage(chatTargetOrder.__backendId, currentUser.username, content);
Â  Â  Â  Â  input.value = ''; // Limpiar input
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Asegurar scroll al fondo
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â const messagesContainer = document.querySelector('.chat-messages');
Â  Â  Â  Â  Â  Â  Â if (messagesContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â messagesContainer.scrollTop = messagesContainer.scrollHeight;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }, 50);
Â  Â  }

Â  Â  function renderChatMessages(container) {
Â  Â  Â  Â  if (!container) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const messagesHtml = chatMessages.map(msg => {
Â  Â  Â  Â  Â  Â  // Supabase devuelve created_at como propiedad
Â  Â  Â  Â  Â  Â  const timestamp = msg.created_at || new Date().toISOString();Â 
Â  Â  Â  Â  Â  Â  const isSelf = msg.sender === currentUser.username;
Â  Â  Â  Â  Â  Â  const time = new Date(timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble ${isSelf ? 'message-self' : 'message-other'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold text-xs ${isSelf ? '' : 'text-blue-300'} mb-1">${isSelf ? 'TÃº' : msg.sender}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>${msg.content}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right text-[10px] opacity-60 mt-1">${time}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }).join('');
Â  Â  Â  Â Â 
Â  Â  Â  Â  container.innerHTML = messagesHtml;
Â  Â  Â  Â  container.scrollTop = container.scrollHeight; // Scroll al Ãºltimo mensaje
Â  Â  }


Â  Â  // ---------------------------------------------------------
Â  Â  // 13. UTILIDADES DE RENDERIZADO
Â  Â  // ---------------------------------------------------------
Â  Â  function getTopShops() {
Â  Â  Â  const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
Â  Â  Â  const shopsStats = resellers.map(seller => {
Â  Â  Â  Â  // 1. Obtener stats de reviews
Â  Â  Â  Â  const { rating, reviewCount } = getShopRating(seller.username);
Â  Â  Â  Â  // 2. Contar ventas
Â  Â  Â  Â  const sales = allOrders.filter(o => o.seller_username === seller.username && o.order_status === 'completed').length;
Â  Â  Â  Â Â 
Â  Â  Â  Â  return {Â 
Â  Â  Â  Â  Â  Â  ...seller,Â 
Â  Â  Â  Â  Â  Â  salesCount: sales, // MÃ©trica principal de ranking
Â  Â  Â  Â  Â  Â  rating: rating,Â  Â  Â // Para visibilidad
Â  Â  Â  Â  Â  Â  reviewCount: reviewCount // Para visibilidad
Â  Â  Â  Â  };Â 
Â  Â  Â  });
Â  Â  Â  // Ranking basado SOLO en Ventas (salesCount)
Â  Â  Â  return shopsStats.filter(s => s.salesCount > 0)
Â  Â  Â  Â  Â  Â  .sort((a, b) => b.salesCount - a.salesCount).slice(0, 3);Â 
Â  Â  }
Â  Â Â 
Â  Â  // FunciÃ³n para obtener el conteo de ventas de todos los vendedores
Â  Â  function getSellerSalesMap() {
Â  Â  Â  Â  const salesMap = {};
Â  Â  Â  Â  allOrders.forEach(order => {
Â  Â  Â  Â  Â  Â  if (order.order_status === 'completed' && order.seller_username) {
Â  Â  Â  Â  Â  Â  Â  Â  salesMap[order.seller_username] = (salesMap[order.seller_username] || 0) + 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return salesMap;
Â  Â  }

Â  Â  function getCategoryIcon(id) {
Â  Â  Â  const cat = CATEGORIES.find(c => c.id === id);
Â  Â  Â  return cat ? cat.icon : 'ðŸ“¦';
Â  Â  }

Â  Â  function showToast(message) {
Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white animate-bounce bg-blue-600';
Â  Â  Â  toast.textContent = message;
Â  Â  Â  document.body.appendChild(toast);
Â  Â  Â  setTimeout(() => toast.remove(), 3000);
Â  Â  }

Â  Â  function getConfig() {
Â  Â  Â  const configItem = window.mockDb.data.find(item => item.type === 'config');
Â  Â  Â  if (configItem) return configItem.config;
Â  Â  Â Â 
Â  Â  Â  return window.elementSdk ? window.elementSdk.config : defaultConfig;
Â  Â  }
Â  Â  
Â  Â  // ---------------------------------------------------------
Â  Â  // 13.1. FUNCIONES DE BACKUP (Faltantes en la versiÃ³n original)
Â  Â  // ---------------------------------------------------------
Â  Â  function downloadBackup() {
Â  Â  Â  Â  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.mockDb.data));
Â  Â  Â  Â  const downloadAnchorNode = document.createElement('a');
Â  Â  Â  Â  downloadAnchorNode.setAttribute("href", dataStr);
Â  Â  Â  Â  downloadAnchorNode.setAttribute("download", `mu_marketplace_backup_${new Date().toISOString().slice(0,10)}.json`);
Â  Â  Â  Â  document.body.appendChild(downloadAnchorNode);
Â  Â  Â  Â  downloadAnchorNode.click();
Â  Â  Â  Â  downloadAnchorNode.remove();
Â  Â  Â  Â  showToast('âœ… Backup descargado');
Â  Â  }

Â  Â  function triggerUpload() {
Â  Â  Â  Â  document.getElementById('fileInput').click();
Â  Â  }
Â  Â  
Â  Â  async function handleFileUpload(event) {
Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = async (e) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const importedData = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(importedData)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("El archivo no contiene un array de datos vÃ¡lido.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!confirm(`Se encontraron ${importedData.length} registros. Â¿EstÃ¡s seguro de reemplazar TODO el contenido del BIN remoto con este archivo?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  showToast('â³ Subiendo y reemplazando datos en el BIN...');
Â  Â  Â  Â  Â  Â  Â  Â  const result = await window.dataSdk.write(importedData);

Â  Â  Â  Â  Â  Â  Â  Â  if (result.isOk) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('âœ… ImportaciÃ³n exitosa. Datos remotos actualizados.');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error de ImportaciÃ³n/Escritura. Verifica tu API Key.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  showModal = null;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al procesar archivo:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('âŒ Error: Archivo JSON no vÃ¡lido.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  }


Â  Â  // ---------------------------------------------------------
Â  Â  // 14. RENDERIZADO PRINCIPAL (EL CÃ“DIGO VISUAL)
Â  Â  // ---------------------------------------------------------
Â  Â  function render() {
Â  Â  Â  const app = document.getElementById('app');
Â  Â  Â  const config = getConfig();
Â  Â  Â  document.body.style.backgroundColor = config.background_color;
Â  Â  Â  document.body.style.color = config.text_color;

Â  Â  Â  let content = '';
Â  Â  Â  if (currentView === 'catalog') content = renderCatalog();
Â  Â  Â  else if (currentView === 'cart') content = renderCart();
Â  Â  Â  else if (currentView === 'orders') content = renderOrders();
Â  Â  Â  else if (currentView === 'admin') content = renderAdmin();

Â  Â  Â  app.innerHTML = content;

Â  Â  Â  // Renderizar Modal si existe
Â  Â  Â  const modalContainer = document.getElementById('modalContainer');
Â  Â  Â  const modalHTML = showModal ? renderModal() : '';
Â  Â  Â Â 
Â  Â  Â  if (modalContainer) {
Â  Â  Â  Â  Â  modalContainer.innerHTML = modalHTML;
Â  Â  Â  } else {
Â  Â  Â  Â  Â  const d = document.createElement('div');Â 
Â  Â  Â  Â  Â  d.id = 'modalContainer';
Â  Â  Â  Â  Â  document.body.appendChild(d);
Â  Â  Â  Â  Â  d.innerHTML = modalHTML;
Â  Â  Â  }
Â  Â  }

Â  Â  // --- VISTA CATÃLOGO (HOME) ---
Â  Â  function renderCatalog() {
Â  Â  Â  const config = getConfig();
Â  Â  Â Â 
Â  Â  Â  let filteredProducts = allProducts;
Â  Â  Â Â 
Â  Â  Â  let shopStats = null;
Â  Â  Â Â 
Â  Â  Â  if (selectedShopFilter) {
Â  Â  Â  Â  Â  filteredProducts = allProducts.filter(p => p.seller_shop_name === selectedShopFilter);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // 1. Calcular estadÃ­sticas de la tienda seleccionada
Â  Â  Â  Â  Â  const shopOwner = allUsers.find(u => u.shop_name === selectedShopFilter);
Â  Â  Â  Â  Â  if (shopOwner) {
Â  Â  Â  Â  Â  Â  Â  Â  const sales = allOrders.filter(o => o.seller_username === shopOwner.username && o.order_status === 'completed').length;
Â  Â  Â  Â  Â  Â  Â  Â  const { rating, reviewCount } = getShopRating(shopOwner.username);
Â  Â  Â  Â  Â  Â  Â  Â  shopStats = { owner: shopOwner, salesCount: sales, rating, reviewCount };
Â  Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  Â  filteredProducts = selectedCategory === 'all'Â 
Â  Â  Â  Â  Â  Â  ? allProductsÂ 
Â  Â  Â  Â  Â  Â  : selectedCategory === 'promotions'
Â  Â  Â  Â  Â  Â  ? allProducts.filter(p => p.on_sale === true)
Â  Â  Â  Â  Â  Â  : allProducts.filter(p => p.category === selectedCategory);
Â  Â  Â  }

Â  Â  Â  const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
Â  Â  Â  const topShops = getTopShops();Â 

Â  Â  Â  return `
Â  Â  Â  Â  <div class="min-h-full pb-20">
Â  Â  Â  Â  Â  <header class="shadow-lg sticky top-0 z-40 bg-slate-800 border-b border-slate-700 p-4">
Â  Â  Â  Â  Â  Â  <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center md:text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-bold text-blue-400 tracking-tight">MU MARKET <span class="text-white text-xs bg-blue-600 px-1 rounded">V30</span></h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs mt-1 opacity-60">${config.contact_info}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-2 justify-center items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${currentUser ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="currentView='cart'; render();" class="relative px-4 py-2 rounded-lg font-bold transition bg-slate-700 hover:bg-slate-600 text-sm border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ›’ Carrito ${cartCount > 0 ? `<span class="cart-badge">${cartCount}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="currentView='orders'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-slate-700 hover:bg-slate-600 text-sm border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“¦ Mis Pedidos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${currentUser.role !== 'buyer' ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="loadAdminView();" class="px-4 py-2 rounded-lg font-bold transition border border-blue-500 bg-slate-800 text-blue-400 text-sm hover:bg-blue-900/30">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âš™ï¸ Panel Tienda
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="logout();" class="px-4 py-2 rounded-lg font-bold transition bg-red-600 hover:bg-red-500 text-white text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸšª
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showModal='register'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-green-600 hover:bg-green-500 text-white text-sm shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Crear Cuenta
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showModal='registerReseller'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-purple-600 hover:bg-purple-500 text-white text-sm shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Vender
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showModal='login'; render();" class="px-4 py-2 rounded-lg font-bold transition bg-blue-600 hover:bg-blue-500 text-white text-sm shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Iniciar SesiÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </header>

Â  Â  Â  Â  Â  ${!selectedShopFilter && topShops.length > 0 ? `
Â  Â  Â  Â  Â  Â  <div class="max-w-7xl mx-auto px-4 py-6">
Â  Â  Â  Â  Â  Â  Â  <div class="mb-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-yellow-400 mb-1">ðŸ† TOP VENDEDORES POR VENTAS</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs opacity-60">Basado en Pedidos Completados</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  ${topShops.map((shop, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="top-shop-card rank-${index+1} rounded-xl p-6 text-center bg-slate-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-4xl mb-2">${index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-xl mb-1 shop-badge px-2 py-1 rounded inline-block hover:bg-white/10" onclick="filterByShop('${shop.shop_name}')">${shop.shop_name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm opacity-70 mb-3">ðŸ‘¤ ${shop.username}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-center mb-3 bg-slate-900/50 p-2 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center px-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold text-green-400">${shop.salesCount}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs opacity-70 uppercase">Ventas</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-l border-slate-700/50 mx-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center px-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold text-yellow-400">${getStarHtml(shop.rating)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs opacity-70 uppercase">(${shop.reviewCount} Reviews)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  ` : ''}

Â  Â  Â  Â  Â  <div class="max-w-7xl mx-auto px-4 py-6">
Â  Â  Â  Â  Â  Â  ${selectedShopFilter ? `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-blue-900/30 border border-blue-500 p-4 rounded-lg mb-6 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between border-b border-blue-800/50 pb-3 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-blue-300">ðŸª Tienda: ${selectedShopFilter}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="clearShopFilter()" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded font-bold text-sm shadow transition transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ver Todas las Tiendas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${shopStats ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-around text-center py-2 bg-slate-900/50 rounded-lg border border-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="px-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold text-green-400">${shopStats.salesCount}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs opacity-70">Ventas Totales</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-l border-slate-700/50 mx-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="px-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold text-yellow-400">${getStarHtml(shopStats.rating)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs opacity-70">(${shopStats.reviewCount} Reviews)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `<p class="text-center text-sm opacity-60 py-2">Cargando estadÃ­sticas o tienda sin datos aÃºn.</p>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-3 justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${CATEGORIES.map(cat => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="selectedCategory='${cat.id}'; render();"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="category-btn px-6 py-3 rounded-lg font-bold shadow-md border border-transparent ${selectedCategory === cat.id ? 'bg-blue-600 ring-2 ring-blue-400 border-blue-300' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cat.icon} ${cat.name}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <main class="max-w-7xl mx-auto px-4 pb-12">
Â  Â  Â  Â  Â  Â  ${filteredProducts.length === 0 ? `
Â  Â  Â  Â  Â  Â  Â  <div class="text-center py-20 bg-slate-800/50 rounded-xl border border-slate-700 border-dashed">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl opacity-40">ðŸ“¦</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl opacity-60 mt-2">No hay productos disponibles en esta tienda/categorÃ­a.</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  ${filteredProducts.map(product => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-card rounded-xl shadow-lg overflow-hidden ${product.on_sale ? 'ring-2 ring-red-500' : 'border border-slate-700'} bg-slate-800 relative group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${product.on_sale ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute top-2 right-2 z-10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-2 py-1 rounded text-xs font-bold bg-red-600 text-white animate-pulse shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  OFERTA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-48 bg-slate-900 flex items-center justify-center text-6xl relative overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${product.image_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${product.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none';">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : getCategoryIcon(product.category)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-center -mt-8 mb-3 relative z-20">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="filterByShop('${product.seller_shop_name}')" class="shop-badge bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-blue-400 tracking-wide">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸª ${product.seller_shop_name}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold mb-1 truncate text-center text-lg">${product.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs font-bold px-2 py-1 rounded ${product.stock < 5 ? 'bg-red-900/50 text-red-400 animate-pulse border border-red-500/50' : 'bg-slate-700 text-slate-400'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“¦ Stock: ${product.stock}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between mt-2 border-t border-slate-700 pt-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${product.discount > 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs line-through opacity-50">$${product.price}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-green-400 text-lg">$${product.final_price.toFixed(2)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-green-400 text-lg">$${product.price.toFixed(2)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="addToCart('${product.__backendId}')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${product.stock <= 0 ? 'disabled' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="px-4 py-2 rounded text-sm font-bold bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white shadow transition transform active:scale-95">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${product.stock > 0 ? 'COMPRAR' : 'AGOTADO'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  `}).join('')}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  }

Â  Â  // --- VISTA CARRITO (EXPANDIDA) ---
Â  Â  function renderCart() {
Â  Â  Â  const config = getConfig();
Â  Â  Â  const total = cart.reduce((sum, item) => {
Â  Â  Â  Â  const itemPrice = item.discount > 0 ? item.final_price : item.price;
Â  Â  Â  Â  return sum + (itemPrice * item.quantity);
Â  Â  Â  }, 0);

Â  Â  Â  return `
Â  Â  Â  Â  <div class="min-h-full bg-slate-900 text-slate-100 p-8">
Â  Â  Â  Â  Â  Â  <div class="max-w-4xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold mb-6 text-blue-400 flex items-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ›’ Tu Carrito de Compras
Â  Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ${cart.length === 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-10 rounded-xl border border-slate-700 text-center shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-4xl mb-4">ðŸ˜¢</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold mb-2">Tu carrito estÃ¡ vacÃ­o</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-400 mb-6">Â¡Explora el catÃ¡logo y encuentra los mejores items!</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="currentView='catalog'; render();" class="bg-blue-600 px-6 py-3 rounded-lg font-bold hover:bg-blue-500 shadow transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Volver al CatÃ¡logo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-slate-900/50 border-b border-slate-700 font-bold text-slate-400 grid grid-cols-12 gap-4 text-sm uppercase tracking-wider">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-6">Producto</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 text-center">Precio</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 text-center">Cantidad</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 text-right">Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cart.map((item, index) => {
    // Necesitamos el producto actual en la base de datos para comparar stock.
    const currentProduct = allProducts.find(p => p.__backendId === item.__backendId);
    const availableStock = currentProduct ? currentProduct.stock : 0;
    const isOverstocked = item.quantity > availableStock && availableStock > 0;
    const isOutOfStock = availableStock === 0;

    let stockWarning = '';
    if (isOutOfStock) {
        stockWarning = '<span class="text-red-400 text-xs font-bold block">Agotado!</span>';
    } else if (isOverstocked) {
        stockWarning = `<span class="text-yellow-400 text-xs font-bold block">Max: ${availableStock}</span>`;
    }
    
    return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 border-b border-slate-700 grid grid-cols-12 gap-4 items-center hover:bg-slate-700/20 transition ${isOutOfStock || isOverstocked ? 'bg-red-900/10' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-6 flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-12 w-12 bg-slate-900 rounded border border-slate-600 flex items-center justify-center text-xl shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${getCategoryIcon(item.category)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold truncate">${item.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-blue-400">Tienda: ${item.seller_shop_name}</div>
                                        ${stockWarning}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 text-center font-mono text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $${item.final_price.toFixed(2)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 text-center font-mono text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x${item.quantity}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 text-right flex items-center justify-end gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-green-400">$${(item.final_price * item.quantity).toFixed(2)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-400 bg-red-900/20 hover:bg-red-900/40 h-8 w-8 rounded flex items-center justify-center transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ•
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col md:flex-row justify-end items-center gap-6 bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-slate-400 uppercase">Total a Pagar</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-4xl font-bold text-green-400">$${total.toFixed(2)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg font-bold transition border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Seguir Viendo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="createOrder()" class="bg-green-600 hover:bg-green-500 px-8 py-3 rounded-lg font-bold text-white shadow-lg transform hover:scale-105 transition flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… CONFIRMAR COMPRA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  // --- VISTA PEDIDOS (EXPANDIDA) ---
Â  Â  function renderOrders() {
Â  Â  Â  Â  const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username).reverse();
Â  Â  Â  Â  const isSeller = currentUser.role !== 'buyer';
Â  Â  Â  Â Â 
Â  Â  Â  Â  return `
Â  Â  Â  Â  <div class="min-h-full bg-slate-900 text-slate-100 p-8">
Â  Â  Â  Â  Â  Â  <div class="max-w-4xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-blue-400">ðŸ“¦ Mis Pedidos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="currentView='catalog';render()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded font-bold text-sm border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Volver al CatÃ¡logo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  ${myOrders.length === 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center py-12 opacity-50 border-2 border-dashed border-slate-700 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>No has realizado ninguna compra todavÃ­a.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}

Â  Â  Â  Â  Â  Â  Â  Â  ${myOrders.map((o, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusText = o.order_status === 'completed'Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? (o.needs_review ? 'Completado (Pendiente de ReseÃ±a)' : 'Completado')Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : o.seller_confirmedÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'Pendiente de tu ConfirmaciÃ³n'Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'Esperando Entrega del Vendedor';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusClass = o.order_status === 'completed'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? (o.needs_review ? 'bg-red-900 text-red-200 border border-red-700 animate-pulse' : 'bg-green-900 text-green-200 border border-green-700')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : o.seller_confirmedÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'bg-orange-900 text-orange-200 border border-orange-700 animate-pulse'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'bg-yellow-900 text-yellow-200 border border-yellow-700 animate-pulse';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl mb-6 border-l-4 shadow-lg transition hover:bg-slate-800/80 ${o.order_status==='completed'?'border-green-500':o.seller_confirmed?'border-orange-500':'border-yellow-500'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start border-b border-slate-700 pb-4 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-xl text-white">PEDIDO #${myOrders.length - index}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-slate-500 font-mono mt-1">ID: ${o.id}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-3 py-1 rounded text-sm font-bold uppercase tracking-wider ${statusClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs uppercase text-slate-500 font-bold mb-2">Datos del Vendedor</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold text-white flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ‘¤ ${o.seller_username}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded border border-purple-500/30 font-mono text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“± Discord: ${o.seller_discord}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs uppercase text-slate-500 font-bold mb-2">Detalle de Items</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-mono text-slate-300 leading-relaxed">${o.items}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row justify-between items-center pt-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openChatModal('${o.__backendId}')" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ’¬ CHAT con Vendedor
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-2xl font-bold text-white flex-1 text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Total: <span class="text-green-400">$${o.total.toFixed(2)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${o.order_status === 'completed' ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${o.needs_review ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="selectedOrder = allOrders.find(ord => ord.__backendId === '${o.__backendId}'); showModal='review'; render();" class="w-full sm:w-auto bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â­ DEJAR RESEÃ‘A
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2 text-green-400 font-bold bg-green-900/20 px-4 py-2 rounded-lg border border-green-900/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âœ… Pedido Finalizado</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${o.seller_confirmed ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="confirmOrder('${o.__backendId}', false)" ${o.buyer_confirmed ? 'disabled' : ''}Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full sm:w-auto bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-bold text-white shadow transition transform active:scale-95">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… CONFIRMAR QUE RECIBÃ LOS ITEMS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button disabled class="w-full sm:w-auto bg-yellow-700/50 px-6 py-3 rounded-lg font-bold text-white disabled:opacity-100 disabled:cursor-wait">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â³ Esperando que el Vendedor Entregue/Confirme
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `}).join('')}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  // --- VISTA ADMIN / RESELLER (PANEL COMPLETO) ---
Â  Â  function renderAdmin() {
Â  Â  Â  const user = currentUser;
Â  Â  Â  const viewingAs = adminViewTarget || user.username;
Â  Â  Â  const viewingUser = allUsers.find(u => u.username === viewingAs) || user;
Â  Â  Â Â 
Â  Â  Â  const myProducts = allProducts.filter(p => p.seller_username === viewingAs);
Â  Â  Â  const myOrders = allOrders.filter(o => o.seller_username === viewingAs);
Â  Â  Â  const pending = myOrders.filter(o => o.order_status === 'pending').reverse();
Â  Â  Â Â 
Â  Â  Â  const completedOrdersLog = allOrders.filter(o => o.order_status === 'completed').reverse();
Â  Â  Â Â 
Â  Â  Â  // 1. Calcular las ventas de todos los revendedores (para la tabla global)
Â  Â  Â  const sellerSalesMap = getSellerSalesMap();

Â  Â  Â  const displayUsers = allUsers.sort((a, b) => {
Â  Â  Â  Â  Â  if (a.status === 'pending' && b.status !== 'pending') return -1;
Â  Â  Â  Â  Â  if (a.status !== 'pending' && b.status === 'pending') return 1;
Â  Â  Â  Â  Â  if (a.role === 'admin') return 1;
Â  Â  Â  Â  Â  if (b.role === 'admin') return -1;
Â  Â  Â  Â  Â  return a.username.localeCompare(b.username);
Â  Â  Â  });

Â  Â  Â  const stats = {
Â  Â  Â  Â  Â  total: myProducts.length,
Â  Â  Â  Â  Â  sales: myOrders.filter(o => o.order_status === 'completed').length,
Â  Â  Â  Â  Â  revenue: myOrders.filter(o => o.order_status === 'completed').reduce((a,b)=>a+b.total,0),
Â  Â  Â  Â  Â  online: onlineUsers.size
Â  Â  Â  };

Â  Â  Â  return `
Â  Â  Â  Â  <div class="min-h-full bg-slate-900 text-slate-100 p-6">
Â  Â  Â  Â  Â  Â  <div class="max-w-7xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-slate-700 pb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${adminViewTarget ? `ðŸ‘ï¸ GESTIONANDO TIENDA: <span class="text-yellow-400 underline">${viewingUser.shop_name}</span>` : (user.role==='admin'?'âš™ï¸ PANEL ADMINISTRADOR':'ðŸª MI TIENDA')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${adminViewTarget ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="exitShopManagement()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold text-sm shadow animate-pulse">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âŒ SALIR DEL MODO GESTIÃ“N
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${user.role === 'admin' ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showModal='dataTools';render()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-yellow-400 border-yellow-500/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ’¾ RESPALDO SYSTEM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="loadAdminView()" class="bg-slate-700 px-6 py-2 rounded font-bold shadow hover:bg-slate-600 transition border border-slate-500 text-blue-400 border-blue-500/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ðŸ”„ REFRESCAR DATOS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="currentView='catalog';render()" class="bg-blue-600 px-6 py-2 rounded font-bold shadow hover:bg-blue-500 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ  Volver al Inicio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-purple-500 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-3xl font-bold text-white">${stats.total}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Productos Activos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-green-500 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-3xl font-bold text-green-400">${stats.sales}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Ventas Completadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-yellow-500 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-3xl font-bold text-yellow-400">${pending.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs opacity-70 font-bold uppercase tracking-wide">Pedidos Pendientes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="bg-slate-800 p-6 rounded-xl border-t-4 border-blue-500 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs opacity-70 font-bold uppercase tracking-wide mb-1">Discord Tienda</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm font-bold font-mono text-blue-300 truncate bg-slate-900/50 p-1 rounded">${viewingUser.discord_tag}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ${(user.role === 'admin' && !adminViewTarget) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-6 text-green-400 border-b border-slate-700 pb-2 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“œ LOG HISTÃ“RICO DE PEDIDOS (${completedOrdersLog.length})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="clearCompletedOrdersLog()" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-bold transition ml-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ—‘ï¸ LIMPIAR LOG
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-x-auto rounded-lg border border-slate-700 max-h-64 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm text-left text-slate-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-slate-900 text-white uppercase font-bold text-xs sticky top-0 z-10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-3">Fecha</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-3">Tienda/Vendedor</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-3">Comprador</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-3">Items</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-3 text-right">Total</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody class="divide-y divide-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${completedOrdersLog.length === 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="5" class="p-4 text-center opacity-50">No hay registro de pedidos completados.</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : completedOrdersLog.map(o => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="hover:bg-slate-700/30 transition font-mono">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 text-xs text-slate-500">${new Date(o.created_at).toLocaleDateString()}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 font-bold text-blue-300">${o.seller_username}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 text-white">${o.buyer_username}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 text-xs truncate max-w-xs">${o.items}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 text-right font-bold text-green-400">$${o.total.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}

Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-yellow-400 border-b border-slate-700 pb-2 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“¦ Pedidos por Despachar <span class="bg-slate-700 text-white px-2 rounded text-sm">${pending.length}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${pending.length === 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center py-8 opacity-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="italic">No tienes pedidos pendientes. Â¡Buen trabajo!</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : pending.map((o, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sellerConfirmed = o.seller_confirmed;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const buyerConfirmed = o.buyer_confirmed;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let buttonText, buttonClass, buttonAction;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (buyerConfirmed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â buttonText = 'Cliente CONFIRMADO';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â buttonClass = 'bg-orange-700/50 disabled:opacity-100 disabled:cursor-wait';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â buttonAction = 'disabled';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (sellerConfirmed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonText = 'â³ Esperando Cliente';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonClass = 'bg-yellow-600/50 disabled:opacity-100 disabled:cursor-wait';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonAction = 'disabled';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonText = 'âœ… MARCAR ENTREGADO';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonClass = 'bg-green-600 hover:bg-green-500';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonAction = `onclick="confirmOrder('${o.__backendId}', true)"`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusBadgeText = buyerConfirmed ? 'Cliente ConfirmÃ³' : (sellerConfirmed ? 'TÃº Confirmaste (Esperando Cliente)' : 'Pendiente de tu Entrega');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusBadgeClass = buyerConfirmed ? 'bg-orange-900 text-orange-200' : (sellerConfirmed ? 'bg-yellow-900 text-yellow-200' : 'bg-red-900 text-red-200');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-900 p-5 rounded-lg mb-4 border border-slate-600 flex flex-col md:flex-row justify-between gap-6 shadow-sm hover:bg-slate-900/80 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3 mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-lg text-blue-300">PEDIDO #${pending.length - i}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-2 py-1 rounded text-xs font-bold ${statusBadgeClass} whitespace-nowrap">${statusBadgeText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-1">Cliente: <span class="font-bold text-white">${o.buyer_username}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-block bg-purple-900/30 text-purple-300 px-2 py-1 rounded text-xs font-mono border border-purple-500/30 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“± Discord: ${o.buyer_discord}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-slate-300 bg-slate-800/50 p-3 rounded border-l-2 border-green-500 font-mono">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${o.items}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right flex flex-col justify-between items-end min-w-[150px]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-slate-500 uppercase">Total a Cobrar</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-3xl font-bold text-green-400">$${o.total.toFixed(2)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openChatModal('${o.__backendId}')" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-bold text-sm shadow transition text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ’¬ CHAT
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button ${buttonAction} class="${buttonClass} px-4 py-2 rounded font-bold text-sm shadow transition text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${buttonText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl mb-8 border border-slate-700 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-6 text-blue-400 border-b border-slate-700 pb-2">ðŸ›ï¸ GestiÃ³n de Inventario</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-8 p-5 bg-slate-900 rounded-lg border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-sm font-bold mb-3 uppercase text-slate-400 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âž•</span> Publicar Nuevo Item
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form onsubmit="handleAddProduct(event)" class="grid grid-cols-1 md:grid-cols-12 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productName" placeholder="Nombre del Item" required class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500 outline-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="productCategory" class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="items">Arma/Escudo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="sets">Set Completo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="wings">Alas</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="jewels">Joyas</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productPrice" type="number" step="0.01" placeholder="Precio $" required class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productStock" type="number" placeholder="Stock" required class="w-full bg-slate-800 p-3 rounded text-white border border-slate-600 focus:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full h-full bg-blue-600 hover:bg-blue-500 font-bold rounded text-white shadow transition uppercase text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Publicar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productDiscount" type="hidden" value="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productImage" type="hidden" value="">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productDescription" type="hidden" value="">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="productOnSale" type="checkbox" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-slate-500 mt-3 ml-1 flex items-center gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â„¹ï¸ Para agregar imagen, descuento o descripciÃ³n, usa el botÃ³n <span class="font-bold text-blue-400 bg-slate-800 px-1 rounded">EDITAR</span> una vez creado el item.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${myProducts.map(p => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-900 rounded-lg border border-slate-600 p-4 relative group hover:border-blue-500 transition shadow-sm flex flex-col justify-between h-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold truncate text-white text-lg pr-2" title="${p.name}">${p.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-mono text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 border border-slate-700 whitespace-nowrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ“¦ Stock: ${p.stock}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-green-400 font-bold text-2xl">$${p.final_price.toFixed(2)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.discount > 0 ? `<div class="text-xs text-red-400 font-bold bg-red-900/20 inline-block px-1 rounded border border-red-900/50">-${p.discount}% OFF</div>` : '<div class="h-5"></div>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2 mt-auto pt-3 border-t border-slate-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openEditModal('${p.__backendId}')" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold text-white shadow transition flex items-center justify-center gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœï¸ EDITAR
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteProduct('${p.__backendId}')" class="bg-red-600 hover:bg-red-500 px-3 py-2 rounded text-xs font-bold text-white shadow transition flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ—‘ï¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  ${(user.role === 'admin' && !adminViewTarget) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-6 text-purple-400 border-b border-slate-700 pb-2 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸŒ Panel Global de Usuarios <span class="text-xs bg-slate-900 text-slate-400 px-2 py-1 rounded ml-auto">Total: ${displayUsers.length}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-x-auto rounded-lg border border-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm text-left text-slate-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-slate-900 text-white uppercase font-bold text-xs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-4">Usuario (Tienda)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-4">Rol</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-4">Estado</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-4 text-center">VENTAS</th>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-4">Discord</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-4 text-right">Acciones</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody class="divide-y divide-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${displayUsers.map(u => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="hover:bg-slate-700/30 transition ${u.status === 'pending' ? 'bg-yellow-900/20 border-l-4 border-yellow-500' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 font-bold flex flex-col justify-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-white cursor-pointer hover:text-blue-400" onclick="openManageUserModal('${u.username}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.username}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.role === 'reseller' && u.shop_name ? `<span class="text-xs opacity-60 text-blue-300 italic">${u.shop_name}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="bg-slate-900 px-2 py-1 rounded text-xs border border-slate-600 font-mono">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.role.toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-2 py-1 rounded text-xs font-bold ${u.status==='banned'?'bg-red-900/30 text-red-400':u.status==='pending'?'bg-yellow-900/30 text-yellow-400':'bg-green-900/30 text-green-400'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.status.toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.role === 'reseller' ? `<span class="font-bold text-

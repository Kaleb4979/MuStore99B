<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mu Online 99B Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; }
    html { height: 100%; }
    .category-btn { transition: all 0.3s ease; }
    .category-btn:hover { transform: translateY(-2px); }
    .product-card { transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .loading-spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .cart-badge { position: absolute; top: -8px; right: -8px; background-color: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
    .btn-primary { transition: all 0.2s ease; }
    .btn-primary:hover { transform: scale(1.05); }
    .star:hover { transform: scale(1.2); }
    .top-shop-card { transition: all 0.3s ease; }
    .top-shop-card:hover { transform: translateX(5px); }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="min-h-full"></div>
  <div id="modalContainer"></div>

  <script>
    // ==========================================
    // 1. MOTOR DE BASE DE DATOS (Reemplaza al data_sdk.js)
    // ==========================================
    const BIN_ID = "691ddaa6ae596e708f6321c9"; 
    const API_KEY = "$2a$10$6.Y19X/sB3np.3CIJmbJZesuwRVxU77ns.FyAdL2dUc46k1vWFG9S"; 

    window.dataSdk = {
      init: async (handler) => {
        window.dataHandler = handler;
        await window.dataSdk.refresh();
        return { isOk: true };
      },
      refresh: async () => {
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { 'X-Master-Key': API_KEY }
          });
          if (!res.ok) throw new Error("Error API");
          const json = await res.json();
          window.currentData = Array.isArray(json.record) ? json.record : [];
          window.dataHandler.onDataChanged(window.currentData);
        } catch (e) {
          console.error("Error:", e);
          window.currentData = []; 
          window.dataHandler.onDataChanged(window.currentData);
        }
      },
      create: async (item) => {
        item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        window.currentData.push(item);
        return await window.dataSdk.save();
      },
      update: async (item) => {
        const idx = window.currentData.findIndex(i => i.__backendId === item.__backendId);
        if (idx !== -1) { window.currentData[idx] = item; return await window.dataSdk.save(); }
        return { isOk: false };
      },
      delete: async (item) => {
        window.currentData = window.currentData.filter(i => i.__backendId !== item.__backendId);
        return await window.dataSdk.save();
      },
      save: async () => {
        try {
          await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
            body: JSON.stringify(window.currentData)
          });
          window.dataHandler.onDataChanged(window.currentData);
          return { isOk: true };
        } catch (e) { return { isOk: false }; }
      }
    };

    // ==========================================
    // 2. MOTOR VISUAL (Reemplaza al element_sdk.js)
    // ==========================================
    window.elementSdk = {
      config: null,
      init: (opts) => { 
        window.elementSdk.config = opts.defaultConfig;
        if(opts.onConfigChange) opts.onConfigChange(opts.defaultConfig); 
      },
      setConfig: (newConfig) => { window.elementSdk.config = { ...window.elementSdk.config, ...newConfig }; },
      getConfig: () => window.elementSdk.config
    };

    // ==========================================
    // 3. TU C√ìDIGO ORIGINAL (ADAPTADO)
    // ==========================================
    const defaultConfig = {
      site_title: "Mu Online 99B Marketplace",
      welcome_message: "Bienvenido a nuestra tienda de items premium",
      contact_info: "Contacto: Discord/WhatsApp",
      background_color: "#0f172a",
      card_background: "#1e293b",
      text_color: "#f1f5f9",
      primary_button: "#3b82f6",
      secondary_button: "#10b981",
      font_family: "Inter",
      font_size: 16
    };

    let currentUser = null;
    let currentView = 'catalog';
    let selectedCategory = 'all';
    let allProducts = [], allUsers = [], allOrders = [], allReviews = [], cart = [];
    let showModal = null, selectedOrder = null;
    let onlineUsers = new Set(), userActivityTimeout = null;

    const CATEGORIES = [
      { id: 'all', name: 'Todos', icon: 'üéÆ' },
      { id: 'promotions', name: 'Promociones', icon: 'üî•' },
      { id: 'items', name: 'Items', icon: '‚öîÔ∏è' },
      { id: 'jewels', name: 'Joyas', icon: 'üíé' },
      { id: 'wings', name: 'Alas', icon: 'ü¶Ö' },
      { id: 'sets', name: 'Sets', icon: 'üõ°Ô∏è' }
    ];

    const ADMIN_CREDENTIALS = { username: 'Kaleb', password: 'Kaleb.2021' };

    const dataHandler = {
      onDataChanged(data) {
        if(!Array.isArray(data)) data = [];
        allProducts = data.filter(i => i.type === 'product');
        allUsers = data.filter(i => i.type === 'user');
        allOrders = data.filter(i => i.type === 'order');
        allReviews = data.filter(i => i.type === 'review');
        
        const activity = data.filter(i => i.type === 'activity');
        const fiveMinAgo = Date.now() - (5*60*1000);
        onlineUsers = new Set(activity.filter(a => new Date(a.last_activity).getTime() > fiveMinAgo).map(a => a.username));
        
        checkPendingReviews();
        render();
      }
    };

    async function init() {
      await window.dataSdk.init(dataHandler);
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.body.style.backgroundColor = config.background_color;
            document.body.style.color = config.text_color;
            document.body.style.fontFamily = config.font_family;
            render();
          }
        });
      }
      render();
    }

    function checkPendingReviews() {
      if (!currentUser || currentUser.role !== 'buyer') return;
      const pending = allOrders.find(o => o.buyer_username === currentUser.username && o.order_status === 'completed' && o.needs_review);
      if (pending) { selectedOrder = pending; showModal = 'review'; render(); }
    }

    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white bg-blue-600';
      t.textContent = msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
    }

    function getConfig() { return window.elementSdk.config || defaultConfig; }
    function getCurrentUserData() { return currentUser?.role==='admin'?currentUser:allUsers.find(u=>u.username===currentUser?.username); }
    function getCategoryIcon(id) { const c=CATEGORIES.find(x=>x.id===id); return c?c.icon:'üì¶'; }
    function getCategoryName(id) { const c=CATEGORIES.find(x=>x.id===id); return c?c.name:'Otro'; }
    
    // --- AUTH ---
    async function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value;
      if (u === ADMIN_CREDENTIALS.username && p === ADMIN_CREDENTIALS.password) {
        currentUser = { username: u, role: 'admin', __backendId: 'admin' };
        currentView = 'admin'; showModal = null; showToast('Bienvenido Admin'); updateUserActivity(); render(); return;
      }
      const user = allUsers.find(us => us.username === u && us.password === p);
      if (user) {
        if (user.status === 'banned') { selectedOrder=user; showModal='bannedInfo'; render(); return; }
        if (user.role === 'reseller' && !user.approved) return showToast('Cuenta no aprobada');
        currentUser = user;
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag)) { selectedOrder=user; showModal='setupShop'; render(); return; }
        showModal = null; if (user.role !== 'buyer') currentView = 'admin';
        showToast(`Hola ${u}`); updateUserActivity(); render();
      } else { showToast('Datos incorrectos'); }
    }

    async function handleRegisterBuyer(e) {
      e.preventDefault();
      const u = document.getElementById('buyerUsername').value.trim();
      if(allUsers.find(x=>x.username===u)) return showToast('Usuario existe');
      await window.dataSdk.create({
        id:Date.now().toString(), type:'user', username:u, 
        password:document.getElementById('buyerPassword').value,
        discord_tag:document.getElementById('buyerDiscord').value,
        role:'buyer', approved:true, status:'active', created_at:new Date().toISOString()
      });
      showToast('Registrado'); showModal='login'; render();
    }

    async function handleRegisterReseller(e) {
      e.preventDefault();
      const u = document.getElementById('resellerUsername').value.trim();
      if(allUsers.find(x=>x.username===u)) return showToast('Usuario existe');
      await window.dataSdk.create({
        id:Date.now().toString(), type:'user', username:u,
        password:document.getElementById('resellerPassword').value,
        discord_tag:document.getElementById('resellerDiscord').value,
        shop_name:document.getElementById('resellerShop').value,
        role:'reseller', approved:false, status:'pending', created_at:new Date().toISOString()
      });
      showToast('Solicitud enviada'); showModal=null; render();
    }

    async function updateUserActivity() {
        if(!currentUser) return;
        const act = window.currentData.find(i=>i.type==='activity' && i.username===currentUser.username);
        if(act) { act.last_activity=new Date().toISOString(); await window.dataSdk.update(act); }
        else await window.dataSdk.create({id:'act_'+currentUser.username, type:'activity', username:currentUser.username, last_activity:new Date().toISOString()});
        setTimeout(updateUserActivity, 120000);
    }

    function logout() { currentUser=null; currentView='catalog'; cart=[]; showToast('Adi√≥s'); render(); }

    // --- CART & ORDERS ---
    function addToCart(bid) {
        if(!currentUser) { showModal='login'; render(); return showToast('Login requerido'); }
        const p = allProducts.find(x=>x.__backendId===bid);
        if(!p || p.stock<1) return showToast('Sin stock');
        const ex = cart.find(x=>x.__backendId===bid);
        if(ex) { if(ex.quantity<p.stock) ex.quantity++; else showToast('Max stock'); }
        else cart.push({...p, quantity:1});
        showToast('Agregado'); render();
    }
    function removeFromCart(idx) { cart.splice(idx,1); render(); }
    
    async function createOrder() {
        if(cart.length===0) return;
        const sellers = {};
        cart.forEach(i => {
            if(!sellers[i.seller_username]) sellers[i.seller_username] = {items:[], total:0, discord:i.seller_discord};
            sellers[i.seller_username].items.push(i);
            sellers[i.seller_username].total += (i.discount>0?i.final_price:i.price)*i.quantity;
        });
        for(const s in sellers) {
            const info = sellers[s];
            await window.dataSdk.create({
                id:Date.now().toString()+'_'+s, type:'order',
                buyer_username:currentUser.username, buyer_discord:currentUser.discord_tag,
                seller_username:s, seller_discord:info.discord,
                items: info.items.map(x=>`${x.name} x${x.quantity}`).join(' | '),
                items_data: JSON.stringify(info.items.map(x=>({backendId:x.__backendId, quantity:x.quantity, name:x.name}))),
                total: info.total, order_status:'pending', seller_confirmed:false, buyer_confirmed:false, created_at:new Date().toISOString()
            });
        }
        cart=[]; currentView='orders'; showToast('Pedido creado'); render();
    }

    async function confirmOrder(bid, isSeller) {
        const o = allOrders.find(x=>x.__backendId===bid);
        if(isSeller) o.seller_confirmed=true; else o.buyer_confirmed=true;
        if(o.seller_confirmed && o.buyer_confirmed) {
            o.order_status='completed'; o.needs_review=true;
            try {
                JSON.parse(o.items_data).forEach(async i => {
                    const p = allProducts.find(x=>x.__backendId===i.backendId);
                    if(p) { p.stock = Math.max(0, p.stock-i.quantity); await window.dataSdk.update(p); }
                });
            } catch(e){}
        }
        await window.dataSdk.update(o); render();
    }

    // --- PRODUCTS ---
    async function handleAddProduct(e) {
        e.preventDefault();
        const p = {
            id:Date.now().toString(), type:'product',
            name:document.getElementById('productName').value,
            category:document.getElementById('productCategory').value,
            price:parseFloat(document.getElementById('productPrice').value),
            stock:parseInt(document.getElementById('productStock').value),
            description:document.getElementById('productDescription').value,
            image_url:document.getElementById('productImage').value,
            discount:parseInt(document.getElementById('productDiscount').value)||0,
            on_sale:document.getElementById('productOnSale').checked,
            seller_username:currentUser.username, seller_shop_name:currentUser.shop_name,
            created_at:new Date().toISOString()
        };
        p.final_price = p.discount>0 ? p.price*(1-p.discount/100) : p.price;
        await window.dataSdk.create(p); showToast('Producto agregado'); e.target.reset();
    }
    async function deleteProduct(bid) { await window.dataSdk.delete(allProducts.find(x=>x.__backendId===bid)); showToast('Eliminado'); }

    // --- ADMIN ---
    async function approveReseller(bid, ok) {
        const u=allUsers.find(x=>x.__backendId===bid); u.approved=ok; u.status=ok?'approved':'rejected';
        await window.dataSdk.update(u); render();
    }
    async function banUser(bid) { selectedOrder=allUsers.find(x=>x.__backendId===bid); showModal='banReason'; render(); }
    async function confirmBanUser() {
        selectedOrder.status='banned'; selectedOrder.ban_reason=document.getElementById('banReason').value;
        selectedOrder.ban_motive=document.getElementById('banMotive').value;
        await window.dataSdk.update(selectedOrder); showModal=null; render();
    }
    async function deleteUser(bid) { selectedOrder=allUsers.find(x=>x.__backendId===bid); showModal='confirmDeleteUser'; render(); }
    async function confirmDeleteUser() {
        const u = selectedOrder;
        allProducts.filter(p=>p.seller_username===u.username).forEach(async p=>await window.dataSdk.delete(p));
        await window.dataSdk.delete(u); showModal=null; render();
    }

    // --- EXPORT/IMPORT ---
    async function exportData() {
        const d = JSON.stringify({users:allUsers, products:allProducts, orders:allOrders, reviews:allReviews}, null, 2);
        await navigator.clipboard.writeText(d); showToast('Copiado al portapapeles');
    }
    async function importData(e) {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = async (ev) => {
            selectedOrder = JSON.parse(ev.target.result); showModal='importConfirm'; render();
        };
        r.readAsText(f);
    }
    async function confirmImport() {
        const d = selectedOrder;
        for(const u of d.users||[]) if(!allUsers.find(x=>x.username===u.username)) { delete u.__backendId; await window.dataSdk.create(u); }
        for(const p of d.products||[]) { delete p.__backendId; await window.dataSdk.create(p); }
        for(const o of d.orders||[]) { delete o.__backendId; await window.dataSdk.create(o); }
        showModal=null; showToast('Importado'); render();
    }

    // --- REVIEWS ---
    async function handleSubmitReview(e) {
        e.preventDefault();
        const r = document.querySelector('input[name="rating"]:checked')?.value;
        if(!r) return showToast('Elige estrellas');
        await window.dataSdk.create({
            id:Date.now().toString(), type:'review',
            buyer_username:currentUser.username, reviewed_seller:selectedOrder.seller_username,
            rating:parseInt(r), review_text:document.getElementById('reviewText').value,
            created_at:new Date().toISOString()
        });
        selectedOrder.needs_review=false; await window.dataSdk.update(selectedOrder);
        showModal=null; showToast('Rese√±a enviada'); render();
    }
    function getSellerRating(s) {
        const r = allReviews.filter(x=>x.reviewed_seller===s);
        if(!r.length) return {avg:0, cnt:0};
        return {avg:(r.reduce((a,b)=>a+b.rating,0)/r.length).toFixed(1), cnt:r.length};
    }
    function renderStars(n) { return '‚≠ê'.repeat(Math.floor(n)) + (n%1>=0.5?'‚ú®':'') + '‚òÜ'.repeat(5-Math.ceil(n)); }

    // --- RENDER ---
    function render() {
        const app = document.getElementById('app');
        const cfg = getConfig();
        document.body.style.background = cfg.background_color;
        document.body.style.color = cfg.text_color;

        if(currentView==='catalog') app.innerHTML = renderCatalog(cfg);
        else if(currentView==='cart') app.innerHTML = renderCart(cfg);
        else if(currentView==='orders') app.innerHTML = renderOrders(cfg);
        else if(currentView==='admin') app.innerHTML = renderAdmin(cfg);

        document.getElementById('modalContainer').innerHTML = showModal ? renderModal(cfg) : '';
    }

    function renderCatalog(cfg) {
        const prods = selectedCategory==='all'?allProducts : selectedCategory==='promotions'?allProducts.filter(p=>p.on_sale) : allProducts.filter(p=>p.category===selectedCategory);
        const tops = allUsers.filter(u=>u.role==='reseller'&&u.approved).map(u=>({...u, ...getSellerRating(u.username)})).sort((a,b)=>b.avg-a.avg).slice(0,3);

        return `
            <div class="pb-10">
                <header class="p-6 shadow-lg mb-6" style="background:${cfg.card_background}">
                    <div class="max-w-7xl mx-auto flex justify-between items-center flex-wrap gap-4">
                        <div><h1 class="text-2xl font-bold">${cfg.site_title}</h1><p class="opacity-80">${cfg.welcome_message}</p></div>
                        <div class="flex gap-2">
                            ${currentUser ? `
                                <button onclick="currentView='cart';render()" class="px-4 py-2 rounded bg-blue-600 text-white">üõí (${cart.length})</button>
                                <button onclick="currentView='orders';render()" class="px-4 py-2 rounded bg-purple-600 text-white">üì¶</button>
                                ${currentUser.role!=='buyer'?`<button onclick="currentView='admin';render()" class="px-4 py-2 rounded bg-green-600 text-white">Tienda</button>`:''}
                                <button onclick="logout()" class="px-4 py-2 rounded bg-red-600 text-white">Salir</button>
                            ` : `
                                <button onclick="showModal='login';render()" class="px-4 py-2 rounded bg-blue-600 text-white">Login</button>
                                <button onclick="showModal='register';render()" class="px-4 py-2 rounded bg-green-600 text-white">Registro</button>
                            `}
                        </div>
                    </div>
                </header>
                ${tops.length?`<div class="max-w-7xl mx-auto mb-6 grid grid-cols-3 gap-4 px-4">${tops.map((t,i)=>`<div class="p-4 rounded bg-black/20 text-center border border-gray-700"><div>${i===0?'ü•á':i===1?'ü•à':'ü•â'}</div><div class="font-bold">${t.shop_name}</div><div>${renderStars(t.avg)}</div></div>`).join('')}</div>`:''}
                <div class="flex justify-center gap-2 mb-6 overflow-x-auto px-4">
                    ${CATEGORIES.map(c=>`<button onclick="selectedCategory='${c.id}';render()" class="px-4 py-2 rounded whitespace-nowrap ${selectedCategory===c.id?'bg-blue-600 text-white':'bg-gray-700'}">${c.icon} ${c.name}</button>`).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 px-6 max-w-7xl mx-auto">
                    ${prods.map(p=>`
                        <div class="rounded-lg overflow-hidden shadow-lg relative" style="background:${cfg.card_background}">
                            ${p.on_sale?'<span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded">PROMO</span>':''}
                            <div class="h-40 bg-black/20 flex items-center justify-center text-4xl">${p.image_url?`<img src="${p.image_url}" class="w-full h-full object-cover">`:getCategoryIcon(p.category)}</div>
                            <div class="p-4">
                                <h3 class="font-bold truncate">${p.name}</h3>
                                <p class="text-xs opacity-70">üè™ ${p.seller_shop_name}</p>
                                <div class="flex justify-between mt-2 items-center">
                                    <span class="font-bold text-green-400">$${p.final_price}</span>
                                    <button onclick="addToCart('${p.__backendId}')" ${p.stock<1?'disabled':''} class="px-3 py-1 rounded bg-blue-600 text-white text-sm disabled:opacity-50">${p.stock>0?'Agregar':'Agotado'}</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderCart(cfg) {
        return `
            <div class="p-6 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4">Carrito</h2>
                ${cart.map((i,idx)=>`<div class="flex justify-between p-4 mb-2 rounded" style="background:${cfg.card_background}"><div>${i.name} x${i.quantity}</div><button onclick="removeFromCart(${idx})" class="text-red-500">üóëÔ∏è</button></div>`).join('')}
                ${cart.length?`<button onclick="createOrder()" class="w-full py-3 bg-green-600 rounded text-white font-bold mt-4">Confirmar Pedido</button>`:'<p>Vac√≠o</p><button onclick="currentView=\'catalog\';render()" class="mt-4 px-4 py-2 bg-blue-600 rounded text-white">Volver</button>'}
            </div>
        `;
    }

    function renderOrders(cfg) {
        return `
            <div class="p-6 max-w-4xl mx-auto">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Pedidos</h2><button onclick="currentView='catalog';render()" class="bg-blue-600 px-4 py-2 rounded text-white">Volver</button></div>
                ${allOrders.filter(o=>o.buyer_username===currentUser.username).map(o=>`
                    <div class="p-4 rounded mb-4" style="background:${cfg.card_background}">
                        <div class="flex justify-between font-bold"><span>#${o.id.slice(-5)}</span><span class="${o.order_status==='completed'?'text-green-400':'text-yellow-400'}">${o.order_status}</span></div>
                        <p class="text-sm opacity-80">${o.items}</p>
                        <p class="mt-1">Total: $${o.total}</p>
                        ${o.order_status==='pending'?`<button onclick="confirmOrder('${o.__backendId}',false)" ${o.buyer_confirmed?'disabled':''} class="mt-2 bg-blue-600 px-3 py-1 rounded text-white text-xs">Confirmar Recibido</button>`:''}
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderAdmin(cfg) {
        const isA=currentUser.role==='admin';
        const items = isA ? allProducts : allProducts.filter(p=>p.seller_username===currentUser.username);
        return `
            <div class="p-6 max-w-6xl mx-auto">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">${isA?'Admin':'Mi Tienda'}</h2><button onclick="currentView='catalog';render()" class="bg-blue-600 px-4 py-2 rounded text-white">Volver</button></div>
                ${isA?`<div class="mb-4 flex gap-2"><button onclick="exportData()" class="px-4 py-2 bg-purple-600 rounded text-white">Exportar</button><label class="px-4 py-2 bg-blue-600 rounded text-white cursor-pointer">Importar<input type="file" hidden onchange="importData(event)"></label></div>`:''}
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="p-6 rounded" style="background:${cfg.card_background}">
                        <h3 class="font-bold mb-4">Agregar</h3>
                        <form onsubmit="handleAddProduct(event)" class="space-y-3">
                            <input id="productName" placeholder="Nombre" required class="w-full p-2 rounded bg-black/30 text-white">
                            <select id="productCategory" class="w-full p-2 rounded bg-black/30 text-white">${CATEGORIES.slice(2).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>
                            <div class="flex gap-2"><input id="productPrice" type="number" placeholder="Precio" required class="w-full p-2 rounded bg-black/30 text-white"><input id="productStock" type="number" placeholder="Stock" required class="w-full p-2 rounded bg-black/30 text-white"></div>
                            <input id="productImage" placeholder="URL Imagen" class="w-full p-2 rounded bg-black/30 text-white">
                            <input id="productDiscount" type="number" placeholder="% Descuento" class="w-full p-2 rounded bg-black/30 text-white">
                            <label><input type="checkbox" id="productOnSale"> Oferta</label>
                            <textarea id="productDescription" placeholder="Descripci√≥n" class="w-full p-2 rounded bg-black/30 text-white"></textarea>
                            <button class="w-full py-2 bg-green-600 rounded font-bold text-white">Publicar</button>
                        </form>
                    </div>
                    <div class="p-6 rounded h-96 overflow-y-auto" style="background:${cfg.card_background}">
                        <h3 class="font-bold mb-4">Items</h3>
                        ${items.map(p=>`<div class="flex justify-between items-center mb-2 p-2 bg-black/20 rounded"><span>${p.name} (${p.stock})</span><button onclick="deleteProduct('${p.__backendId}')" class="text-red-500">üóëÔ∏è</button></div>`).join('')}
                    </div>
                </div>
                ${isA?`<div class="mt-6 p-6 rounded" style="background:${cfg.card_background}"><h3 class="font-bold mb-4">Usuarios</h3>${allUsers.map(u=>`<div class="flex justify-between items-center mb-2 p-2 border-b border-white/10"><span>${u.username} (${u.role}) ${u.status==='banned'?'üî¥':''}</span><div class="flex gap-2 text-xs">${u.role==='reseller'&&!u.approved?`<button onclick="approveReseller('${u.__backendId}',true)" class="text-green-400">Aprobar</button>`:''}<button onclick="banUser('${u.__backendId}')" class="text-orange-400">Ban</button><button onclick="deleteUser('${u.__backendId}')" class="text-red-500">Del</button></div></div>`).join('')}</div>`:''}
            </div>
        `;
    }

    function renderModal(cfg) {
        const wrap = (c) => `<div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target===this){showModal=null;render();}"><div class="rounded p-8 max-w-md w-full relative shadow-2xl" style="background:${cfg.card_background}">${c}</div></div>`;
        
        if(showModal==='login') return wrap(`<h2 class="text-2xl font-bold mb-4 text-center">Login</h2><form onsubmit="handleLogin(event)" class="space-y-4"><input id="loginUsername" placeholder="User" class="w-full p-2 rounded bg-black/30 text-white"><input type="password" id="loginPassword" placeholder="Pass" class="w-full p-2 rounded bg-black/30 text-white"><button class="w-full bg-blue-600 p-2 rounded text-white font-bold">Entrar</button><div class="text-center text-sm mt-4"><p class="opacity-70 mb-2">¬øNo tienes cuenta?</p><button type="button" onclick="showModal='register';render()" class="text-blue-400 hover:text-blue-300 font-semibold">Crear cuenta Comprador</button><span class="mx-2 opacity-50">|</span><button type="button" onclick="showModal='registerReseller';render()" class="text-yellow-400 hover:text-yellow-300 font-semibold">Abrir Tienda</button></div></form>`);
        
        if(showModal==='register') return wrap(`<h2 class="text-2xl font-bold mb-4 text-center">Registro</h2><form onsubmit="handleRegisterBuyer(event)" class="space-y-4"><input id="buyerUsername" placeholder="User" class="w-full p-2 rounded bg-black/30 text-white"><input type="password" id="buyerPassword" placeholder="Pass" class="w-full p-2 rounded bg-black/30 text-white"><input id="buyerDiscord" placeholder="Discord" class="w-full p-2 rounded bg-black/30 text-white"><button class="w-full bg-green-600 p-2 rounded text-white font-bold">Registrar</button></form>`);
        
        if(showModal==='registerReseller') return wrap(`<h2 class="text-2xl font-bold mb-4 text-center">Vender</h2><form onsubmit="handleRegisterReseller(event)" class="space-y-4"><input id="resellerUsername" placeholder="User" class="w-full p-2 rounded bg-black/30 text-white"><input type="password" id="resellerPassword" placeholder="Pass" class="w-full p-2 rounded bg-black/30 text-white"><input id="resellerShop" placeholder="Tienda" class="w-full p-2 rounded bg-black/30 text-white"><input id="resellerDiscord" placeholder="Discord" class="w-full p-2 rounded bg-black/30 text-white"><button class="w-full bg-yellow-600 p-2 rounded text-white font-bold">Solicitar</button></form>`);
        
        if(showModal==='review') return wrap(`<h2 class="text-xl font-bold mb-4">Califica</h2><form onsubmit="handleSubmitReview(event)"><div class="flex justify-center gap-2 text-3xl mb-4">${[1,2,3,4,5].map(n=>`<label class="cursor-pointer"><input type="radio" name="rating" value="${n}" class="hidden"><span onclick="this.parentNode.querySelector('input').checked=true">‚≠ê</span></label>`).join('')}</div><textarea id="reviewText" class="w-full p-2 bg-black/30 text-white rounded mb-4" placeholder="Opini√≥n..."></textarea><button class="w-full bg-green-600 p-2 rounded text-white font-bold">Enviar</button></form>`);
        
        if(showModal==='banReason') return wrap(`<h2 class="text-xl text-red-500 font-bold mb-4">Banear</h2><input id="banReason" placeholder="Raz√≥n" class="w-full p-2 rounded bg-black/30 text-white mb-2"><textarea id="banMotive" placeholder="Detalle" class="w-full p-2 rounded bg-black/30 text-white mb-4"></textarea><button onclick="confirmBanUser()" class="w-full bg-red-600 p-2 rounded text-white font-bold">Confirmar</button>`);

        if(showModal==='bannedInfo') return wrap(`<div class="text-center"><h2 class="text-3xl mb-2">üö´</h2><h3 class="text-xl font-bold text-red-500 mb-4">Cuenta Suspendida</h3><div class="bg-red-900/30 p-4 rounded mb-4"><p class="font-bold">${selectedOrder.ban_reason}</p><p class="text-sm mt-2 opacity-80">${selectedOrder.ban_motive}</p></div><button onclick="showModal=null;render()" class="px-4 py-2 bg-gray-600 rounded text-white">Cerrar</button></div>`);
        
        if(showModal==='setupShop') return wrap(`<h2 class="text-xl font-bold mb-4">Configura Tienda</h2><form onsubmit="selectedOrder.shop_name=document.getElementById('sN').value; selectedOrder.discord_tag=document.getElementById('sD').value; window.dataSdk.update(selectedOrder); showModal=null; render(); event.preventDefault();"><input id="sN" placeholder="Nombre Tienda" class="w-full p-2 rounded bg-black/30 text-white mb-2"><input id="sD" value="${selectedOrder.discord_tag||''}" placeholder="Discord" class="w-full p-2 rounded bg-black/30 text-white mb-4"><button class="w-full bg-blue-600 p-2 rounded text-white font-bold">Guardar</button></form>`);
        
        if(showModal==='importConfirm') return wrap(`<h2 class="text-xl font-bold mb-4">Importar</h2><p>Se cargar√°n ${selectedOrder.products?.length||0} productos y ${selectedOrder.users?.length||0} usuarios.</p><button onclick="confirmImport()" class="w-full bg-green-600 p-2 rounded text-white font-bold mt-4">Confirmar</button>`);
        
        if(showModal==='confirmDeleteUser') return wrap(`<h2 class="text-xl font-bold text-red-500 mb-4">Eliminar Usuario</h2><p>Se borrar√°n todos sus datos.</p><button onclick="confirmDeleteUser()" class="w-full bg-red-600 p-2 rounded text-white font-bold mt-4">Eliminar</button>`);

        return '';
    }

    init();
  </script>
 </body>
</html>

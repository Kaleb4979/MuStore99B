<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mu Online 99B Marketplace</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
    }
    html {
      height: 100%;
    }
    /* Animaciones y Efectos */
    .category-btn { transition: all 0.3s ease; }
    .category-btn:hover { transform: translateY(-2px); }
    
    .product-card { transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
    
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .cart-badge {
      position: absolute;
      top: -8px; right: -8px;
      background-color: #ef4444; color: white;
      border-radius: 50%; width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: bold;
    }
    
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
    
    .star { cursor: pointer; transition: all 0.2s ease; }
    .star:hover { transform: scale(1.3); color: #fbbf24; }
    
    .top-shop-card { transition: all 0.3s ease; }
    .top-shop-card:hover { transform: scale(1.05); }
    
    /* Estilos espec√≠ficos para el ranking */
    .rank-1 { border: 2px solid #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
    .rank-2 { border: 2px solid #C0C0C0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.3); }
    .rank-3 { border: 2px solid #CD7F32; box-shadow: 0 0 10px rgba(205, 127, 50, 0.3); }
  </style>
  <style>@view-transition { navigation: auto; }</style>

  <script>
    const DB_KEY = 'mu_marketplace_db_v3_final'; 

    // Inicializar DB en memoria desde LocalStorage
    let savedData = localStorage.getItem(DB_KEY);
    window.mockDb = {
      data: savedData ? JSON.parse(savedData) : [],
      handler: null,
      notify() {
        localStorage.setItem(DB_KEY, JSON.stringify(this.data));
        if (this.handler) this.handler.onDataChanged(this.data);
      }
    };

    // Data SDK Simulado (Persistencia y Tiempo Real Local)
    window.dataSdk = {
      init: async (handler) => {
        window.mockDb.handler = handler;
        setTimeout(() => window.mockDb.notify(), 50); 
        return { isOk: true };
      },
      create: async (item) => {
        item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        window.mockDb.data.push(item);
        window.mockDb.notify();
        return { isOk: true, item: item };
      },
      update: async (item) => {
        const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
        if (index !== -1) {
          window.mockDb.data[index] = {...item}; 
          window.mockDb.notify();
          return { isOk: true, item: item };
        }
        return { isOk: false };
      },
      delete: async (item) => {
        window.mockDb.data = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
        window.mockDb.notify();
        return { isOk: true };
      }
    };
    
    // Element SDK Simulado
    window.elementSdk = {
      config: {},
      init: (options) => {
        window.elementSdk.config = options.defaultConfig;
        if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
      },
      setConfig: (newConfig) => {
        window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
      }
    };
  </script>
 </head>
 <body>
  <div id="app" class="min-h-full"></div>
  
  <script>
    // --- CONFIGURACI√ìN BASE ---
    const defaultConfig = {
      site_title: "Mu Online 99B Marketplace",
      welcome_message: "El mejor mercado para items, sets y alas.",
      contact_info: "Soporte: Discord Oficial",
      background_color: "#0f172a",
      card_background: "#1e293b",
      text_color: "#f1f5f9",
      primary_button: "#3b82f6",
      secondary_button: "#10b981",
      font_family: "Inter",
      font_size: 16
    };

    // --- ESTADO DE LA APLICACI√ìN ---
    let currentUser = null;
    let currentView = 'catalog';
    let selectedCategory = 'all';
    let allProducts = [];
    let allUsers = [];
    let allOrders = [];
    let allReviews = [];
    let cart = [];
    let showModal = null;
    let selectedOrder = null;

    const CATEGORIES = [
      { id: 'all', name: 'Todos', icon: 'üéÆ' },
      { id: 'promotions', name: 'Promociones', icon: 'üî•' },
      { id: 'items', name: 'Items', icon: '‚öîÔ∏è' },
      { id: 'jewels', name: 'Joyas', icon: 'üíé' },
      { id: 'wings', name: 'Alas', icon: 'ü¶Ö' },
      { id: 'sets', name: 'Sets', icon: 'üõ°Ô∏è' }
    ];

    const ADMIN_CREDENTIALS = { username: 'Kaleb', password: 'Kaleb.2021' };
    let onlineUsers = new Set();
    let userActivityTimeout = null;
    
    // --- AUDIO Y NOTIFICACIONES ---
    let audioContextResumed = false;
    const notificationAudio = new Audio('https://freesound.org/data/previews/389/389332_7366710-lq.mp3'); 

    function playNotificationSound() {
        if (!audioContextResumed) return;
        const audioClone = notificationAudio.cloneNode(true);
        audioClone.volume = 0.6; 
        audioClone.play().catch(e => console.error("Audio error:", e));
    }

    // --- MANEJADOR DE DATOS (CORAZ√ìN DEL TIEMPO REAL) ---
    const dataHandler = {
      onDataChanged(data) {
        // 1. Desempaquetar datos
        allProducts = data.filter(item => item.type === 'product') || [];
        allUsers = data.filter(item => item.type === 'user') || [];
        allOrders = data.filter(item => item.type === 'order') || [];
        allReviews = data.filter(item => item.type === 'review') || [];
        const activityRecords = data.filter(item => item.type === 'activity') || [];
        
        // 2. Notificaciones de Actividad (Nuevos Pedidos)
        if (currentUser) {
            const newOrderAlert = activityRecords.find(a => 
                a.type === 'activity' && a.message && !a.dismissed && 
                (a.username === currentUser.username || currentUser.role === 'admin') 
            );

            if (newOrderAlert) {
                showToast(`üîî ${newOrderAlert.message}`);
                playNotificationSound();
                const updatedAlert = {...newOrderAlert, dismissed: true};
                window.dataSdk.update(updatedAlert); 
            }
        }
        
        // 3. Usuarios Online
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        onlineUsers = new Set(
          activityRecords
            .filter(a => a.type === 'activity' && new Date(a.last_activity).getTime() > fiveMinutesAgo)
            .map(a => a.username)
        );
        
        // 4. Validaciones Cr√≠ticas
        validateCart();
        
        // 5. TRIGGER DE CALIFICACI√ìN (Fix "Apenas se marca")
        // Verifica si hay una orden completada pendiente de review y abre el modal
        checkPendingReviews();
        
        // 6. Renderizar UI
        render(); 
      }
    };

    async function init() {
      await window.dataSdk.init(dataHandler);
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => { render(); }
        });
      }
    }

    // --- FUNCI√ìN CR√çTICA: DETECTAR PENDIENTE DE CALIFICAR ---
    function checkPendingReviews() {
      if (!currentUser || currentUser.role !== 'buyer') return;
      
      // Buscar orden completada que necesite review
      const pendingOrder = allOrders.find(o => 
        o.buyer_username === currentUser.username && 
        o.order_status === 'completed' && 
        o.needs_review === true
      );

      // Si existe y NO estamos ya calific√°ndola, FORZAR APERTURA DEL MODAL
      if (pendingOrder) {
        if (showModal !== 'review' || (selectedOrder && selectedOrder.__backendId !== pendingOrder.__backendId)) {
            selectedOrder = pendingOrder;
            showModal = 'review';
            // No llamamos render() aqu√≠ para evitar bucles infinitos, se llamar√° al final del dataHandler
        }
      }
    }

    // --- FUNCIONES DE AUTENTICACI√ìN ---
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        currentUser = { username, role: 'admin', __backendId: 'admin' };
        currentView = 'admin';
        finishLogin();
        return;
      }

      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        if (user.status === 'banned') { showToast('üö´ Cuenta suspendida.'); return; }
        if (user.role === 'reseller' && !user.approved) { showToast('Cuenta en revisi√≥n.'); return; }
        
        currentUser = user;
        
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag)) {
          selectedOrder = user;
          showModal = 'setupShop';
        } else {
          showModal = null;
          if (user.role === 'reseller') currentView = 'admin';
        }
        finishLogin();
      } else {
        showToast('Credenciales inv√°lidas');
      }
    }

    async function finishLogin() {
        showToast(`Bienvenido ${currentUser.username}`);
        await updateUserActivity();
        checkPendingReviews(); // Chequeo inicial al loguear
        render();
    }

    async function handleRegisterBuyer(e) {
      e.preventDefault();
      // ... (L√≥gica est√°ndar de registro, simplificada para brevedad)
      const username = document.getElementById('buyerUsername').value.trim();
      if (allUsers.find(u => u.username === username)) { showToast('Usuario existente'); return; }
      
      const userData = {
        id: Date.now().toString(), type: 'user', username,
        password: document.getElementById('buyerPassword').value,
        discord_tag: document.getElementById('buyerDiscord').value.trim(),
        role: 'buyer', approved: true, status: 'active', created_at: new Date().toISOString()
      };
      await window.dataSdk.create(userData);
      showToast('Registro exitoso'); showModal = 'login'; render();
    }

    async function handleRegisterReseller(e) {
      e.preventDefault();
      const username = document.getElementById('resellerUsername').value.trim();
      if (allUsers.find(u => u.username === username)) { showToast('Usuario existente'); return; }
      
      const userData = {
        id: Date.now().toString(), type: 'user', username,
        password: document.getElementById('resellerPassword').value,
        shop_name: document.getElementById('resellerShop').value.trim(),
        discord_tag: document.getElementById('resellerDiscord').value.trim(),
        role: 'reseller', approved: false, status: 'pending', created_at: new Date().toISOString()
      };
      await window.dataSdk.create(userData);
      showToast('Solicitud enviada'); showModal = null; render();
    }

    async function updateUserActivity() {
      if (!currentUser) return;
      // Actualizar "Last Seen"
      const existingActivity = window.mockDb.data.find(item => item.type === 'activity' && item.username === currentUser.username);
      if (existingActivity) {
        await window.dataSdk.update({...existingActivity, last_activity: new Date().toISOString()});
      } else {
        await window.dataSdk.create({
            id: 'act_' + currentUser.username, type: 'activity', 
            username: currentUser.username, last_activity: new Date().toISOString()
        });
      }
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      userActivityTimeout = setTimeout(updateUserActivity, 2 * 60 * 1000);
    }

    function logout() {
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      currentUser = null; currentView = 'catalog'; cart = [];
      render();
    }

    // --- GESTI√ìN DE PRODUCTOS Y CARRITO ---
    async function handleAddProduct(e) {
      e.preventDefault();
      // ... (L√≥gica est√°ndar de creaci√≥n de producto)
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      
      const originalPrice = parseFloat(document.getElementById('productPrice').value);
      const discount = parseInt(document.getElementById('productDiscount').value) || 0;
      
      const productData = {
        type: 'product',
        name: document.getElementById('productName').value.trim(),
        category: document.getElementById('productCategory').value,
        price: originalPrice,
        final_price: discount > 0 ? originalPrice * (1 - discount / 100) : originalPrice,
        discount: discount,
        on_sale: document.getElementById('productOnSale').checked,
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value.trim(),
        image_url: document.getElementById('productImage').value.trim(),
        seller_username: currentUser.username,
        seller_shop_name: currentUser.shop_name,
        seller_discord: currentUser.discord_tag,
        created_at: new Date().toISOString()
      };

      await window.dataSdk.create(productData);
      showToast('Producto Agregado'); e.target.reset();
      btn.disabled = false;
    }

    async function deleteProduct(id) {
        const p = allProducts.find(i => i.__backendId === id);
        if(p) await window.dataSdk.delete(p);
    }

    function validateCart() {
        if (cart.length === 0) return;
        let modified = false;
        const newCart = cart.filter(item => {
            const real = allProducts.find(p => p.__backendId === item.__backendId);
            if (!real) { showToast(`Item "${item.name}" eliminado.`); modified = true; return false; }
            if (item.quantity > real.stock) { item.quantity = real.stock; modified = true; }
            // Sincronizar precios/datos
            if (item.price !== real.price || item.final_price !== real.final_price) {
                Object.assign(item, real); modified = true;
            }
            return item.quantity > 0;
        });
        if (modified) cart = newCart;
    }

    function addToCart(id) {
        if (!currentUser) { showModal = 'login'; render(); return; }
        const prod = allProducts.find(p => p.__backendId === id);
        if (!prod || prod.stock < 1) return;
        
        const exist = cart.find(i => i.__backendId === id);
        if (exist) {
            if (exist.quantity < prod.stock) exist.quantity++;
        } else {
            cart.push({ ...prod, quantity: 1 });
        }
        showToast('Agregado al carrito'); render();
    }

    // --- PEDIDOS Y CONFIRMACI√ìN ---
    async function createOrder() {
        validateCart();
        if (cart.length === 0) return;

        const ordersBySeller = {};
        cart.forEach(item => {
            if (!ordersBySeller[item.seller_username]) {
                ordersBySeller[item.seller_username] = { 
                    seller: item.seller_username, discord: item.seller_discord, items: [], total: 0 
                };
            }
            const price = item.discount > 0 ? item.final_price : item.price;
            ordersBySeller[item.seller_username].items.push(item);
            ordersBySeller[item.seller_username].total += price * item.quantity;
        });

        for (const seller in ordersBySeller) {
            const o = ordersBySeller[seller];
            const itemsStr = o.items.map(i => `${i.name} x${i.quantity}`).join(', ');
            const itemsJson = JSON.stringify(o.items.map(i => ({ backendId: i.__backendId, quantity: i.quantity })));
            
            const orderData = {
                type: 'order', id: Date.now() + '_' + seller,
                buyer_username: currentUser.username, buyer_discord: currentUser.discord_tag,
                seller_username: seller, seller_discord: o.discord,
                items: itemsStr, items_data: itemsJson, total: o.total,
                order_status: 'pending', seller_confirmed: false, buyer_confirmed: false,
                created_at: new Date().toISOString(), needs_review: false // Inicialmente false
            };
            
            const res = await window.dataSdk.create(orderData);
            
            // Notificar al vendedor
            if(res.isOk) {
                await window.dataSdk.create({
                    type: 'activity', username: seller, message: `¬°Nuevo Pedido de ${currentUser.username}!`, dismissed: false, created_at: new Date().toISOString()
                });
            }
        }
        
        cart = []; showToast('Pedido Creado'); currentView = 'orders'; render();
    }

    async function confirmOrder(backendId, isSeller) {
        const order = allOrders.find(o => o.__backendId === backendId);
        if (!order) return;
        
        let updated = {...order};
        if (isSeller) updated.seller_confirmed = true;
        else updated.buyer_confirmed = true;

        const res = await window.dataSdk.update(updated);
        
        // VERIFICAR SI AMBOS CONFIRMARON -> COMPLETAR
        if (res.isOk && res.item.seller_confirmed && res.item.buyer_confirmed && res.item.order_status !== 'completed') {
            
            const completedOrder = { ...res.item, order_status: 'completed', needs_review: true };
            
            // 1. Descontar Stock
            try {
                const items = JSON.parse(completedOrder.items_data);
                for (const i of items) {
                    const prod = allProducts.find(p => p.__backendId === i.backendId);
                    if (prod) await window.dataSdk.update({ ...prod, stock: Math.max(0, prod.stock - i.quantity) });
                }
            } catch (e) { console.error(e); }

            // 2. Actualizar Orden a 'completed' (Esto dispara el checkPendingReviews en el otro cliente)
            await window.dataSdk.update(completedOrder);
            
            showToast('¬°Pedido Completado!');
        } else {
            showToast('Confirmado. Esperando a la otra parte.');
        }
    }

    // --- SISTEMA DE REVIEWS Y TOP SHOPS ---
    async function handleSubmitReview(e) {
        e.preventDefault();
        if (!selectedOrder) return;
        
        const rating = parseInt(document.querySelector('input[name="rating"]:checked')?.value || '0');
        if (rating === 0) { showToast('Selecciona estrellas'); return; }

        const reviewData = {
            type: 'review',
            buyer_username: currentUser.username,
            reviewed_seller: selectedOrder.seller_username,
            rating: rating,
            review_text: document.getElementById('reviewText').value.trim(),
            created_at: new Date().toISOString()
        };

        const res = await window.dataSdk.create(reviewData);
        if (res.isOk) {
            // Quitar flag de needs_review
            await window.dataSdk.update({ ...selectedOrder, needs_review: false });
            showToast('¬°Rese√±a Enviada!'); showModal = null; selectedOrder = null; render();
        }
    }

    function getSellerRating(username) {
        const revs = allReviews.filter(r => r.reviewed_seller === username);
        if (revs.length === 0) return { average: 0, count: 0 };
        const sum = revs.reduce((a, b) => a + b.rating, 0);
        return { average: (sum / revs.length).toFixed(1), count: revs.length };
    }

    function getTopShops() {
        const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
        const shops = resellers.map(u => {
            const r = getSellerRating(u.username);
            return { ...u, rating: parseFloat(r.average), count: r.count };
        });
        
        // Ordenar: Mayor Rating > Mayor Cantidad de Reviews
        return shops.filter(s => s.count > 0)
                    .sort((a, b) => (b.rating - a.rating) || (b.count - a.count))
                    .slice(0, 3);
    }

    // --- UTILIDADES UI ---
    function showToast(msg) {
        const t = document.createElement('div');
        t.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white bg-blue-600';
        t.textContent = msg; document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function renderStars(n) {
        return '‚≠ê'.repeat(Math.floor(n)) + (n % 1 >= 0.5 ? '‚ú®' : '') + '‚òÜ'.repeat(5 - Math.floor(n) - (n % 1 >= 0.5 ? 1 : 0));
    }

    function render() {
        const app = document.getElementById('app');
        const config = window.elementSdk.config || defaultConfig;
        document.body.style.backgroundColor = config.background_color;
        document.body.style.color = config.text_color;

        // Autoplay Policy Fix
        if (!audioContextResumed) {
            document.body.addEventListener('click', () => {
                notificationAudio.play().then(() => { 
                    audioContextResumed = true; notificationAudio.pause(); notificationAudio.currentTime = 0; 
                }).catch(()=>{});
            }, { once: true });
        }

        // Router
        if (currentView === 'catalog') app.innerHTML = renderCatalog();
        else if (currentView === 'cart') app.innerHTML = renderCart();
        else if (currentView === 'orders') app.innerHTML = renderOrders();
        else if (currentView === 'admin') app.innerHTML = renderAdmin();

        // Modal Container
        const cont = document.getElementById('modalContainer');
        if(!cont) {
            const d = document.createElement('div'); d.id = 'modalContainer'; 
            app.appendChild(d); d.innerHTML = showModal ? renderModal() : '';
        } else {
            cont.innerHTML = showModal ? renderModal() : '';
        }
    }

    // --- VISTAS HTML ---
    function renderCatalog() {
        const config = window.elementSdk.config || defaultConfig;
        const topShops = getTopShops();
        const filtered = selectedCategory === 'all' ? allProducts : 
                         selectedCategory === 'promotions' ? allProducts.filter(p => p.on_sale) : 
                         allProducts.filter(p => p.category === selectedCategory);

        return `
        <div class="min-h-full pb-10">
            <header class="shadow-lg" style="background-color: ${config.card_background};">
                <div class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold">${config.site_title}</h1>
                        <p class="text-sm opacity-70">${config.welcome_message}</p>
                    </div>
                    <div class="flex gap-2 flex-wrap justify-center">
                        ${currentUser ? `
                            <button onclick="currentView='cart'; render();" class="relative px-4 py-2 rounded bg-blue-600 text-white font-bold">
                                üõí Carrito ${cart.length > 0 ? `<span class="cart-badge">${cart.reduce((a,b)=>a+b.quantity,0)}</span>` : ''}
                            </button>
                            <button onclick="currentView='orders'; render();" class="px-4 py-2 rounded bg-purple-600 text-white font-bold">üì¶ Pedidos</button>
                            ${currentUser.role !== 'buyer' ? `<button onclick="currentView='admin'; render();" class="px-4 py-2 rounded bg-green-600 text-white font-bold">üè™ Tienda</button>` : ''}
                            <button onclick="logout();" class="px-4 py-2 rounded bg-red-600 text-white font-bold">Salir</button>
                        ` : `
                            <button onclick="showModal='login'; render();" class="px-4 py-2 rounded bg-blue-600 text-white font-bold">Login</button>
                            <button onclick="showModal='register'; render();" class="px-4 py-2 rounded bg-green-600 text-white font-bold">Registro</button>
                            <button onclick="showModal='registerReseller'; render();" class="px-4 py-2 rounded bg-purple-600 text-white font-bold">Vender</button>
                        `}
                    </div>
                </div>
            </header>

            ${topShops.length > 0 ? `
            <div class="max-w-7xl mx-auto px-4 mt-8">
                <h2 class="text-2xl font-bold text-center mb-6">üèÜ Top Tiendas Premium</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${topShops.map((shop, idx) => `
                        <div class="top-shop-card rounded-xl p-6 text-center relative overflow-hidden rank-${idx+1}" style="background-color: ${config.card_background};">
                            <div class="text-4xl mb-2">${idx===0?'ü•á':idx===1?'ü•à':'ü•â'}</div>
                            <h3 class="text-xl font-bold">${shop.shop_name}</h3>
                            <p class="text-sm opacity-70">Vendedor: ${shop.username}</p>
                            <div class="mt-3">
                                <p class="text-2xl text-yellow-400">${renderStars(shop.rating)}</p>
                                <p class="text-sm font-bold">${shop.rating} / 5.0</p>
                                <p class="text-xs opacity-60">(${shop.count} rese√±as)</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <div class="max-w-7xl mx-auto px-4 mt-8 flex flex-wrap justify-center gap-3">
                ${CATEGORIES.map(cat => `
                    <button onclick="selectedCategory='${cat.id}'; render();" 
                        class="category-btn px-6 py-3 rounded-lg font-bold shadow-md ${selectedCategory===cat.id ? 'ring-4 ring-blue-400 bg-blue-600 text-white' : 'bg-gray-800 text-gray-200'}">
                        ${cat.icon} ${cat.name}
                    </button>
                `).join('')}
            </div>

            <div class="max-w-7xl mx-auto px-4 mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                ${filtered.map(p => {
                    const r = getSellerRating(p.seller_username);
                    return `
                    <div class="product-card rounded-xl overflow-hidden relative shadow-lg" style="background-color: ${config.card_background};">
                        ${p.on_sale ? `<span class="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold z-10 animate-pulse">üî• PROMO</span>` : ''}
                        <div class="h-48 bg-gray-900 flex items-center justify-center overflow-hidden">
                            ${p.image_url ? `<img src="${p.image_url}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : `<span class="text-6xl">üì¶</span>`}
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg truncate w-40">${p.name}</h3>
                                    <p class="text-xs opacity-70">üè™ ${p.seller_shop_name} ${r.count>0 ? `(${r.average}‚≠ê)`:''}</p>
                                </div>
                                <div class="text-right">
                                    ${p.discount > 0 ? `
                                        <p class="text-xs line-through opacity-50">$${p.price}</p>
                                        <p class="text-lg font-bold text-green-400">$${p.final_price.toFixed(2)}</p>
                                    ` : `<p class="text-lg font-bold text-green-400">$${p.price.toFixed(2)}</p>`}
                                </div>
                            </div>
                            <button onclick="addToCart('${p.__backendId}')" ${p.stock<1?'disabled':''} 
                                class="w-full mt-4 py-2 rounded font-bold text-white transition ${p.stock>0?'bg-blue-600 hover:bg-blue-700':'bg-gray-600 cursor-not-allowed'}">
                                ${p.stock>0 ? 'üõí Agregar' : 'Sin Stock'}
                            </button>
                        </div>
                    </div>
                `}).join('')}
            </div>
        </div>`;
    }

    function renderCart() {
        const config = window.elementSdk.config || defaultConfig;
        const total = cart.reduce((acc, el) => acc + (el.final_price * el.quantity), 0);
        return `
        <div class="max-w-4xl mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-6">üõí Tu Carrito</h1>
            ${cart.length === 0 ? '<p class="opacity-60">Carrito vac√≠o...</p><button onclick="currentView=\'catalog\'; render();" class="mt-4 px-4 py-2 bg-blue-600 rounded text-white">Volver</button>' : `
                <div class="space-y-4">
                    ${cart.map((item, idx) => `
                        <div class="flex justify-between items-center p-4 rounded-lg shadow" style="background-color: ${config.card_background};">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gray-700 rounded flex items-center justify-center text-2xl">üì¶</div>
                                <div>
                                    <h3 class="font-bold">${item.name}</h3>
                                    <p class="text-sm opacity-70">x${item.quantity} - $${(item.final_price * item.quantity).toFixed(2)}</p>
                                </div>
                            </div>
                            <button onclick="cart.splice(${idx},1); render();" class="text-red-500 font-bold">‚ùå</button>
                        </div>
                    `).join('')}
                    <div class="border-t mt-6 pt-4 flex justify-between items-center text-2xl font-bold">
                        <span>Total:</span>
                        <span class="text-green-400">$${total.toFixed(2)} USDT</span>
                    </div>
                    <button onclick="createOrder()" class="w-full py-4 mt-4 bg-green-600 rounded-lg text-xl font-bold hover:bg-green-700 transition text-white">‚úÖ Confirmar Pedido</button>
                    <button onclick="currentView='catalog'; render();" class="w-full mt-2 text-center opacity-70 hover:underline">Seguir Comprando</button>
                </div>
            `}
        </div>`;
    }

    function renderOrders() {
        const config = window.elementSdk.config || defaultConfig;
        const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username);
        return `
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="flex justify-between mb-6">
                <h1 class="text-3xl font-bold">üì¶ Mis Pedidos</h1>
                <button onclick="currentView='catalog'; render();" class="bg-blue-600 px-4 py-2 rounded text-white">Volver</button>
            </div>
            <div class="space-y-4">
                ${myOrders.map(o => `
                    <div class="p-6 rounded-lg shadow-lg border-l-4 ${o.order_status==='completed'?'border-green-500':'border-yellow-500'}" style="background-color: ${config.card_background};">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-lg">Pedido #${o.id.slice(-6)}</h3>
                            <span class="px-2 py-1 rounded text-xs font-bold ${o.order_status==='completed'?'bg-green-900 text-green-200':'bg-yellow-900 text-yellow-200'}">
                                ${o.order_status==='completed'?'COMPLETADO':'PENDIENTE'}
                            </span>
                        </div>
                        <p class="opacity-80 text-sm mb-2">üè™ Tienda: ${o.seller_username} (Discord: ${o.seller_discord})</p>
                        <p class="font-bold mb-4">${o.items}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-green-400">$${o.total.toFixed(2)}</span>
                            ${o.order_status === 'pending' ? `
                                <button onclick="confirmOrder('${o.__backendId}', false)" ${o.buyer_confirmed?'disabled':''} class="px-4 py-2 rounded bg-blue-600 text-white font-bold disabled:opacity-50">
                                    ${o.buyer_confirmed ? 'Esperando Vendedor...' : '‚úÖ Confirmar Recibido'}
                                </button>
                            ` : '<span class="text-green-500 font-bold">‚úÖ Finalizado</span>'}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>`;
    }

    function renderAdmin() {
        // Vista combinada para Admin y Vendedores
        const config = window.elementSdk.config || defaultConfig;
        const isAdm = currentUser.role === 'admin';
        const myProds = isAdm ? allProducts : allProducts.filter(p => p.seller_username === currentUser.username);
        const mySales = isAdm ? allOrders : allOrders.filter(o => o.seller_username === currentUser.username);
        const pendingSales = mySales.filter(o => o.order_status === 'pending');

        return `
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">${isAdm ? '‚öôÔ∏è Panel Admin' : 'üè™ Mi Tienda'}</h1>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="bg-gray-700 px-4 py-2 rounded text-white">üì• Backup</button>
                    <label class="bg-gray-700 px-4 py-2 rounded text-white cursor-pointer">üì§ Restaurar <input type="file" hidden onchange="importData(event)"></label>
                    <button onclick="currentView='catalog'; render();" class="bg-blue-600 px-4 py-2 rounded text-white">üè† Inicio</button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-blue-900 p-4 rounded-lg text-center"><h3 class="text-2xl font-bold">${myProds.length}</h3><p class="text-xs">Productos</p></div>
                <div class="bg-green-900 p-4 rounded-lg text-center"><h3 class="text-2xl font-bold">$${mySales.filter(o=>o.order_status==='completed').reduce((a,b)=>a+b.total,0).toFixed(0)}</h3><p class="text-xs">Ventas ($)</p></div>
                <div class="bg-yellow-900 p-4 rounded-lg text-center"><h3 class="text-2xl font-bold">${pendingSales.length}</h3><p class="text-xs">Pendientes</p></div>
                <div class="bg-purple-900 p-4 rounded-lg text-center"><h3 class="text-2xl font-bold">${getSellerRating(currentUser.username).average}‚≠ê</h3><p class="text-xs">Rating</p></div>
            </div>

            <div class="mb-8 p-6 rounded-lg shadow" style="background-color: ${config.card_background};">
                <h2 class="text-xl font-bold mb-4">üì¶ Gesti√≥n de Pedidos</h2>
                ${pendingSales.length===0 ? '<p class="opacity-50">No hay pedidos pendientes.</p>' : pendingSales.map(o => `
                    <div class="flex justify-between items-center p-3 mb-2 bg-black bg-opacity-30 rounded">
                        <div>
                            <span class="font-bold text-yellow-500">#${o.id.slice(-6)}</span> 
                            <span class="ml-2 text-sm">üë§ ${o.buyer_username} (${o.buyer_discord})</span>
                            <p class="text-xs opacity-70">${o.items}</p>
                        </div>
                        <button onclick="confirmOrder('${o.__backendId}', true)" ${o.seller_confirmed?'disabled':''} class="bg-green-600 px-4 py-2 rounded font-bold text-white disabled:opacity-50">
                            ${o.seller_confirmed ? 'Esperando Cliente' : '‚úÖ Confirmar Entrega'}
                        </button>
                    </div>
                `).join('')}
            </div>

            <div class="mb-8 p-6 rounded-lg shadow" style="background-color: ${config.card_background};">
                <h2 class="text-xl font-bold mb-4">‚ûï Nuevo Producto</h2>
                <form onsubmit="handleAddProduct(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="productName" required placeholder="Nombre Item" class="p-2 rounded bg-gray-700 text-white">
                    <select id="productCategory" class="p-2 rounded bg-gray-700 text-white">
                        <option value="items">Items</option><option value="sets">Sets</option><option value="wings">Alas</option><option value="jewels">Joyas</option>
                    </select>
                    <input id="productPrice" type="number" required placeholder="Precio" class="p-2 rounded bg-gray-700 text-white">
                    <input id="productStock" type="number" required placeholder="Stock" class="p-2 rounded bg-gray-700 text-white">
                    <input id="productDiscount" type="number" placeholder="% Descuento (0-100)" class="p-2 rounded bg-gray-700 text-white">
                    <input id="productImage" placeholder="URL Imagen (Imgur)" class="p-2 rounded bg-gray-700 text-white">
                    <textarea id="productDescription" placeholder="Descripci√≥n detallada..." class="md:col-span-2 p-2 rounded bg-gray-700 text-white"></textarea>
                    <label class="flex items-center gap-2 md:col-span-2"><input type="checkbox" id="productOnSale"> <span class="font-bold text-red-400">üî• Marcar como Promoci√≥n</span></label>
                    <button type="submit" class="md:col-span-2 py-3 bg-blue-600 rounded font-bold text-white hover:bg-blue-700">Publicar Producto</button>
                </form>
            </div>

            ${isAdm ? renderAdminUserManagement() : ''}
        </div>`;
    }

    function renderAdminUserManagement() {
        const pending = allUsers.filter(u => u.role === 'reseller' && !u.approved);
        const active = allUsers;
        return `
        <div class="p-6 rounded-lg shadow mb-8 bg-gray-800">
            <h2 class="text-xl font-bold mb-4">üë• Gesti√≥n de Usuarios (Admin)</h2>
            
            ${pending.length > 0 ? `
                <div class="mb-6 bg-yellow-900 bg-opacity-20 p-4 rounded">
                    <h3 class="font-bold text-yellow-500 mb-2">‚è≥ Solicitudes de Vendedor</h3>
                    ${pending.map(u => `
                        <div class="flex justify-between items-center mb-2">
                            <span>${u.username} - ${u.shop_name}</span>
                            <div class="flex gap-2">
                                <button onclick="window.dataSdk.update({...allUsers.find(x=>x.__backendId==='${u.__backendId}'), approved:true, status:'approved'})" class="bg-green-600 px-2 py-1 rounded text-xs">Aprobar</button>
                                <button onclick="window.dataSdk.delete(allUsers.find(x=>x.__backendId==='${u.__backendId}'))" class="bg-red-600 px-2 py-1 rounded text-xs">Rechazar</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead><tr class="border-b border-gray-600"><th>User</th><th>Rol</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
                    <tbody>
                        ${active.map(u => `
                            <tr class="border-b border-gray-700">
                                <td class="py-2">${u.username}</td>
                                <td>${u.role}</td>
                                <td>${u.status}</td>
                                <td>
                                    <button onclick="window.dataSdk.delete(allUsers.find(x=>x.__backendId==='${u.__backendId}'))" class="text-red-500 hover:underline">Eliminar</button>
                                    ${u.status!=='banned' ? 
                                        `<button onclick="window.dataSdk.update({...allUsers.find(x=>x.__backendId==='${u.__backendId}'), status:'banned'})" class="text-yellow-500 ml-2">Ban</button>` : 
                                        `<button onclick="window.dataSdk.update({...allUsers.find(x=>x.__backendId==='${u.__backendId}'), status:'active'})" class="text-green-500 ml-2">Unban</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;
    }

    function renderModal() {
        const config = window.elementSdk.config || defaultConfig;
        
        // MODAL LOGIN
        if (showModal === 'login') return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target===this) {showModal=null; render();}">
            <div class="p-8 rounded-xl shadow-2xl w-full max-w-md" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
                <form onsubmit="handleLogin(event)">
                    <input id="loginUsername" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Usuario">
                    <input id="loginPassword" type="password" required class="w-full mb-6 p-3 rounded bg-gray-700 text-white" placeholder="Contrase√±a">
                    <button class="w-full py-3 bg-blue-600 rounded font-bold text-white">Entrar</button>
                </form>
            </div>
        </div>`;

        // MODAL REGISTRO
        if (showModal === 'register') return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target===this) {showModal=null; render();}">
            <div class="p-8 rounded-xl shadow-2xl w-full max-w-md" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4 text-center">Registro Comprador</h2>
                <form onsubmit="handleRegisterBuyer(event)">
                    <input id="buyerUsername" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Usuario">
                    <input id="buyerPassword" type="password" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Contrase√±a">
                    <input id="buyerDiscord" required class="w-full mb-6 p-3 rounded bg-gray-700 text-white" placeholder="Discord Tag">
                    <button class="w-full py-3 bg-green-600 rounded font-bold text-white">Registrarse</button>
                </form>
            </div>
        </div>`;

        // MODAL REVIEW (CALIFICACI√ìN)
        if (showModal === 'review' && selectedOrder) return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
            <div class="p-8 rounded-xl shadow-2xl w-full max-w-md border-2 border-yellow-500 relative" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-2 text-center text-yellow-400">‚≠ê Califica tu Compra</h2>
                <p class="text-center text-sm mb-4 opacity-80">Pedido completado con <b>${selectedOrder.seller_username}</b></p>
                <form onsubmit="handleSubmitReview(event)">
                    <div class="flex justify-center gap-2 mb-6">
                        ${[1,2,3,4,5].map(n => `<label><input type="radio" name="rating" value="${n}" class="hidden" required><span class="text-4xl star" onclick="this.parentElement.querySelector('input').checked=true">‚òÜ</span></label>`).join('')}
                    </div>
                    <textarea id="reviewText" rows="3" class="w-full p-3 rounded bg-gray-700 text-white mb-4" placeholder="¬øQu√© tal el servicio?"></textarea>
                    <button class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 rounded font-bold text-white">Enviar Calificaci√≥n</button>
                </form>
            </div>
        </div>`;

        // Otros modales (Setup Shop, Import, etc) se pueden mantener con l√≥gica similar...
        if (showModal === 'setupShop') return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
             <div class="p-8 rounded-xl shadow-2xl w-full max-w-md" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4">Configurar Tienda</h2>
                <form onsubmit="const u = currentUser; u.shop_name=document.getElementById('sName').value; u.discord_tag=document.getElementById('sDisc').value; u.role='reseller'; u.status='approved'; u.approved=true; window.dataSdk.update(u); showModal=null; currentView='admin'; render(); return false;">
                    <input id="sName" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Nombre Tienda">
                    <input id="sDisc" required class="w-full mb-6 p-3 rounded bg-gray-700 text-white" placeholder="Discord">
                    <button class="w-full py-3 bg-blue-600 rounded font-bold text-white">Guardar</button>
                </form>
             </div>
        </div>`;

        // Reseller Registration Modal
        if (showModal === 'registerReseller') return `
         <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onclick="if(event.target===this) {showModal=null; render();}">
            <div class="p-8 rounded-xl shadow-2xl w-full max-w-md" style="background-color: ${config.card_background};">
                <h2 class="text-2xl font-bold mb-4 text-center">Solicitud Vendedor</h2>
                <form onsubmit="handleRegisterReseller(event)">
                    <input id="resellerUsername" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Usuario">
                    <input id="resellerPassword" type="password" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Contrase√±a">
                    <input id="resellerShop" required class="w-full mb-3 p-3 rounded bg-gray-700 text-white" placeholder="Nombre Tienda">
                    <input id="resellerDiscord" required class="w-full mb-6 p-3 rounded bg-gray-700 text-white" placeholder="Discord Tag">
                    <button class="w-full py-3 bg-purple-600 rounded font-bold text-white">Enviar Solicitud</button>
                </form>
            </div>
        </div>`;

        return '';
    }
    
    // Import Functions
    function exportData() {
        const dataStr = JSON.stringify({ users: allUsers, products: allProducts, orders: allOrders, reviews: allReviews });
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = "backup.json"; a.click();
    }
    function importData(e) {
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const d = JSON.parse(ev.target.result);
            // Reset & Load
            window.mockDb.data = [];
            for(const k in d) for(const i of d[k]) await window.dataSdk.create({...i});
            showToast('Datos Restaurados');
        };
        reader.readAsText(e.target.files[0]);
    }

    init();
  </script>
 </body>
</html>

<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mu Online 99B Marketplace - V8 Professional</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  
  <style>
    /* ESTILOS GENERALES */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
    }
    html {
      height: 100%;
    }

    /* ANIMACIONES Y TARJETAS */
    .category-btn {
      transition: all 0.3s ease;
    }
    .category-btn:hover {
      transform: translateY(-2px);
    }

    .product-card {
      transition: all 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .shop-badge {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .shop-badge:hover {
        transform: scale(1.05);
        background-color: #4f46e5; /* Indigo-600 */
    }

    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }

    /* ESTILOS DEL RANKING TOP 3 */
    .top-shop-card {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .top-shop-card:hover {
      transform: translateY(-5px);
    }

    /* RANGO 1: ORO */
    .rank-1 {
      border: 2px solid #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(0,0,0,0.4));
    }
    /* RANGO 2: PLATA */
    .rank-2 {
      border: 2px solid #C0C0C0;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
      background: linear-gradient(145deg, rgba(192,192,192,0.1), rgba(0,0,0,0.4));
    }
    /* RANGO 3: BRONCE */
    .rank-3 {
      border: 2px solid #CD7F32;
      box-shadow: 0 0 10px rgba(205, 127, 50, 0.2);
      background: linear-gradient(145deg, rgba(205,127,50,0.1), rgba(0,0,0,0.4));
    }

    /* INDICADOR ONLINE EN VIVO */
    .live-indicator {
      height: 12px;
      width: 12px;
      background-color: #22c55e; /* Green-500 */
      border-radius: 50%;
      display: inline-block;
      margin-left: 8px;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }
  </style>
  
  <style>@view-transition { navigation: auto; }</style>

  <script>
    // --- CONFIGURACI√ìN DE BASE DE DATOS EN TIEMPO REAL ---
    const DB_KEY = 'mu_marketplace_db_v8_pro'; 
    
    // Inicializar DB desde LocalStorage
    let savedData = localStorage.getItem(DB_KEY);
    window.mockDb = {
      data: savedData ? JSON.parse(savedData) : [],
      handler: null,
      notify() {
        // Guardar persistencia
        const strData = JSON.stringify(this.data);
        localStorage.setItem(DB_KEY, strData);
        // Notificar a la UI actual
        if (this.handler) this.handler.onDataChanged(this.data);
      }
    };

    // --- LISTENER CROSS-TAB (TIEMPO REAL ENTRE PESTA√ëAS) ---
    window.addEventListener('storage', (event) => {
        if (event.key === DB_KEY) {
            const newData = JSON.parse(event.newValue);
            window.mockDb.data = newData;
            if (window.mockDb.handler) {
                window.mockDb.handler.onDataChanged(newData);
            }
        }
    });

    // --- SDK SIMULADO PARA OPERACIONES CRUD ---
    window.dataSdk = {
      init: async (handler) => {
        window.mockDb.handler = handler;
        // Simular carga inicial
        setTimeout(() => window.mockDb.notify(), 50); 
        return { isOk: true };
      },
      create: async (item) => {
        item.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        window.mockDb.data.push(item);
        window.mockDb.notify();
        return { isOk: true, item: item };
      },
      update: async (item) => {
        const index = window.mockDb.data.findIndex(i => i.__backendId === item.__backendId);
        if (index !== -1) {
          window.mockDb.data[index] = {...item}; 
          window.mockDb.notify();
          return { isOk: true, item: item };
        }
        return { isOk: false };
      },
      delete: async (item) => {
        window.mockDb.data = window.mockDb.data.filter(i => i.__backendId !== item.__backendId);
        window.mockDb.notify();
        return { isOk: true };
      }
    };
    
    // --- SDK DE CONFIGURACI√ìN VISUAL ---
    window.elementSdk = {
      config: {},
      init: (options) => {
        window.elementSdk.config = options.defaultConfig;
        if(options.onConfigChange) options.onConfigChange(options.defaultConfig);
      },
      setConfig: (newConfig) => {
        window.elementSdk.config = { ...window.elementSdk.config, ...newConfig };
      }
    };
  </script>
 </head>
 <body>
  <div id="app" class="min-h-full"></div>
  
  <script>
    // --- CONFIGURACI√ìN POR DEFECTO ---
    const defaultConfig = {
      site_title: "Mu Online 99B Marketplace",
      welcome_message: "Bienvenido a nuestra tienda de items premium",
      contact_info: "Contacto: Discord/WhatsApp",
      background_color: "#0f172a",
      card_background: "#1e293b",
      text_color: "#f1f5f9",
      primary_button: "#3b82f6",
      secondary_button: "#10b981",
      font_family: "Inter",
      font_size: 16
    };

    // --- GESTI√ìN DE SESI√ìN Y TIMEOUT ---
    const SESSION_KEY = 'mu_session_user_v8_pro';
    let inactivityTimeout;
    const TIMEOUT_LIMIT = 5 * 60 * 1000; // 5 minutos exactos

    // --- ESTADO GLOBAL DE LA APLICACI√ìN ---
    let currentUser = null;
    let currentView = 'catalog';
    let selectedCategory = 'all';
    let selectedShopFilter = null; // NUEVO: Para filtrar por tienda
    
    // Listas de datos en memoria
    let allProducts = [];
    let allUsers = [];
    let allOrders = [];
    let allReviews = [];
    
    let cart = [];
    let showModal = null;
    let selectedOrder = null;

    const CATEGORIES = [
      { id: 'all', name: 'Todos', icon: 'üéÆ' },
      { id: 'promotions', name: 'Promociones', icon: 'üî•' },
      { id: 'items', name: 'Items', icon: '‚öîÔ∏è' },
      { id: 'jewels', name: 'Joyas', icon: 'üíé' },
      { id: 'wings', name: 'Alas', icon: 'ü¶Ö' },
      { id: 'sets', name: 'Sets', icon: 'üõ°Ô∏è' }
    ];

    const ADMIN_CREDENTIALS = {
      username: 'Kaleb',
      password: 'Kaleb.2021'
    };
    

    let onlineUsers = new Set();
    let userActivityTimeout = null;

    // --- MANEJADOR DE DATOS (DATA HANDLER) ---
    const dataHandler = {
      onDataChanged(data) {
        // Filtrar datos por tipo
        allProducts = data.filter(item => item.type === 'product') || [];
        allUsers = data.filter(item => item.type === 'user') || [];
        allOrders = data.filter(item => item.type === 'order') || [];
        allReviews = data.filter(item => item.type === 'review') || [];
        const activityRecords = data.filter(item => item.type === 'activity') || [];
        
        // 1. Notificaciones Visuales (Sin Sonido)
        if (currentUser) {
            const newOrderAlert = activityRecords.find(a => 
                a.type === 'activity' &&
                a.message && 
                !a.dismissed && 
                (a.username === currentUser.username || currentUser.role === 'admin') 
            );

            if (newOrderAlert) {
                showToast(`üîî ${newOrderAlert.message}`);
                // Marcar como visto inmediatamente
                const updatedAlert = {...newOrderAlert, dismissed: true};
                window.dataSdk.update(updatedAlert); 
            }
        }
        
        // 2. Calcular Usuarios Online (Actividad en los √∫ltimos 5 min)
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        onlineUsers = new Set(
          activityRecords
            .filter(a => a.type === 'activity' && new Date(a.last_activity).getTime() > fiveMinutesAgo)
            .map(a => a.username)
        );
        
        // 3. Ejecutar validaciones y renderizado
        checkPendingReviews();
        validateCart();
        render(); 
      }
    };

    // --- INICIALIZACI√ìN ---
    async function init() {
      // Recuperar sesi√≥n persistente
      const storedUser = localStorage.getItem(SESSION_KEY);
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showToast(`üëã Sesi√≥n restaurada: ${currentUser.username}`);
      }

      // Configurar Auto-Logout
      setupAutoLogout();

      // Iniciar conexi√≥n a DB
      const initResult = await window.dataSdk.init(dataHandler);
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
            document.body.style.color = config.text_color || defaultConfig.text_color;
            const baseSize = config.font_size || defaultConfig.font_size;
            document.body.style.fontSize = `${baseSize}px`;
            render();
          }
        });
      }
      
      if (currentUser) updateUserActivity();
      render();
    }

    // --- SISTEMA DE AUTO-LOGOUT ---
    function setupAutoLogout() {
        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('keypress', resetTimer);
        document.addEventListener('click', resetTimer);
        document.addEventListener('scroll', resetTimer);
        resetTimer();
    }

    function resetTimer() {
        if (currentUser) {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => logout(true), TIMEOUT_LIMIT);
        }
    }

    // --- VALIDACIONES DE NEGOCIO ---
    function checkPendingReviews() {
      if (!currentUser || currentUser.role !== 'buyer') return;
      
      const pendingOrder = allOrders.find(o => 
        o.buyer_username === currentUser.username && 
        o.order_status === 'completed' && 
        o.needs_review === true
      );

      // Forzar modal si hay review pendiente
      if (pendingOrder && (!selectedOrder || selectedOrder.__backendId !== pendingOrder.__backendId)) { 
        selectedOrder = pendingOrder;
        showModal = 'review';
      }
    }

    // --- AUTENTICACI√ìN Y USUARIOS ---
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      // Login Admin Hardcodeado
      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        currentUser = { username, role: 'admin', __backendId: 'admin' };
        localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
        showModal = null;
        currentView = 'admin';
        showToast('Bienvenido Admin');
        await updateUserActivity();
        render();
        return;
      }

      // Login Usuarios Normales
      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        if (user.status === 'banned') {
            showToast('üö´ Tu cuenta ha sido suspendida/baneada.');
            return;
        }

        if (user.role === 'reseller' && !user.approved) {
          showToast('Tu cuenta a√∫n no ha sido aprobada');
          return;
        }
        
        currentUser = { 
          username: user.username,
          role: user.role,
          shop_name: user.shop_name,
          discord_tag: user.discord_tag,
          __backendId: user.__backendId
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
        
        if (user.role === 'reseller' && (!user.shop_name || !user.discord_tag)) {
          selectedOrder = user;
          showModal = 'setupShop';
          showToast('Por favor configura tu tienda para continuar');
          render();
          return;
        }
        
        showModal = null;
        if (user.role === 'reseller' || user.role === 'admin') {
          currentView = 'admin';
        }
        showToast(`Bienvenido ${username}`);
        
        await updateUserActivity();
        checkPendingReviews();
        render();
      } else {
        showToast('Usuario o contrase√±a incorrectos');
      }
    }

    async function handleRegisterBuyer(e) {
      e.preventDefault();
      const username = document.getElementById('buyerUsername').value.trim();
      const password = document.getElementById('buyerPassword').value;
      const discord = document.getElementById('buyerDiscord').value.trim();

      if (allUsers.find(u => u.username === username)) {
        showToast('El usuario ya existe');
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username,
        password,
        discord_tag: discord,
        profile_picture: '',
        role: 'buyer',
        approved: true,
        status: 'active',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);
      if (result.isOk) {
        showToast('Registro exitoso! Ahora puedes iniciar sesi√≥n');
        showModal = 'login';
        render();
      } else {
        showToast('Error al registrar usuario');
      }
    }

    async function handleRegisterReseller(e) {
      e.preventDefault();
      const username = document.getElementById('resellerUsername').value.trim();
      const password = document.getElementById('resellerPassword').value;
      const discord = document.getElementById('resellerDiscord').value.trim();
      const shopName = document.getElementById('resellerShop').value.trim();

      if (allUsers.find(u => u.username === username)) {
        showToast('El usuario ya existe');
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username,
        password,
        discord_tag: discord,
        shop_name: shopName,
        profile_picture: '',
        role: 'reseller',
        approved: false,
        status: 'pending',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);
      if (result.isOk) {
        showToast('Solicitud enviada! Espera aprobaci√≥n del admin');
        showModal = null;
        render();
      } else {
        showToast('Error al enviar solicitud');
      }
    }

    async function updateUserActivity() {
      if (!currentUser) return;
      
      const activityRecords = window.mockDb.data.filter(item => item.type === 'activity');
      const existingActivity = activityRecords.find(a => a.username === currentUser.username);
      
      const lastTime = existingActivity ? new Date(existingActivity.last_activity).getTime() : 0;
      const now = Date.now();

      if (!existingActivity || (now - lastTime > 2 * 60 * 1000)) {
          if (existingActivity) {
             const updatedActivity = {...existingActivity, last_activity: new Date().toISOString()};
             await window.dataSdk.update(updatedActivity);
          } else {
             const activityData = {
               id: 'activity_' + currentUser.username,
               type: 'activity',
               username: currentUser.username,
               last_activity: new Date().toISOString()
             };
             await window.dataSdk.create(activityData);
          }
      }
      
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      userActivityTimeout = setTimeout(updateUserActivity, 3 * 60 * 1000);
    }

    function logout(auto = false) {
      if (userActivityTimeout) clearTimeout(userActivityTimeout);
      clearTimeout(inactivityTimeout);
      currentUser = null;
      localStorage.removeItem(SESSION_KEY);
      currentView = 'catalog';
      cart = [];
      selectedShopFilter = null;
      showToast(auto ? 'üí§ Sesi√≥n cerrada por inactividad' : 'Sesi√≥n cerrada');
      render();
    }

    // --- GESTI√ìN DE PRODUCTOS ---
    async function handleAddProduct(e) {
      e.preventDefault();
      if (allProducts.length >= 999) {
        showToast('L√≠mite de productos alcanzado');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      let imageUrl = document.getElementById('productImage').value.trim();
      
      if (imageUrl && imageUrl.includes('imgur.com/') && !imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        imageUrl = imageUrl + '.jpg';
      }

      const discount = parseInt(document.getElementById('productDiscount').value) || 0;
      const onSale = document.getElementById('productOnSale').checked;
      const originalPrice = parseFloat(document.getElementById('productPrice').value);
      const finalPrice = discount > 0 ? originalPrice * (1 - discount / 100) : originalPrice;

      const productData = {
        id: Date.now().toString(),
        type: 'product',
        name: document.getElementById('productName').value.trim(),
        category: document.getElementById('productCategory').value,
        price: originalPrice,
        final_price: finalPrice,
        discount: discount,
        on_sale: onSale,
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value.trim(),
        image_url: imageUrl,
        seller_username: currentUser.username,
        seller_shop_name: currentUser.shop_name || currentUser.username,
        seller_discord: currentUser.discord_tag || 'Admin',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(productData);
      if (result.isOk) {
        showToast('Producto agregado exitosamente');
        e.target.reset();
      } else {
        showToast('Error al agregar producto');
      }

      btn.disabled = false;
      btn.innerHTML = 'Agregar Producto';
    }

    async function deleteProduct(backendId) {
      const product = allProducts.find(p => p.__backendId === backendId);
      if (!product) return;
      const result = await window.dataSdk.delete(product); 
      if (result.isOk) {
        showToast('Producto eliminado');
      } else {
        showToast('Error al eliminar producto');
      }
    }

    // --- GESTI√ìN DE USUARIOS Y ROLES ---
    async function approveUser(backendId) {
        const user = allUsers.find(u => u.__backendId === backendId);
        if (!user) return;
        
        const updatedUser = {
            ...user,
            status: 'active',
            approved: true
        };
        
        await window.dataSdk.update(updatedUser);
        showToast('‚úÖ Usuario ACEPTADO y activado');
    }

    async function rejectUser(backendId) {
        deleteUserAccount(backendId);
    }

    async function banUser(backendId) {
        const user = allUsers.find(u => u.__backendId === backendId);
        if (!user) return;
        
        let updatedUser;
        if(user.status === 'banned') {
            updatedUser = {...user, status: 'active', approved: true};
            await window.dataSdk.update(updatedUser);
            showToast('Usuario desbaneado (activo)');
        } else {
            updatedUser = {...user, status: 'banned', approved: false};
            await window.dataSdk.update(updatedUser);
            showToast('üö´ Usuario BANEADO exitosamente');
        }
    }

    async function deleteUserAccount(backendId) {
        if(!confirm("‚ö†Ô∏è ¬°ADVERTENCIA DE SEGURIDAD!\n\n¬øEst√°s COMPLETAMENTE SEGURO de eliminar/rechazar este usuario?\nEsta acci√≥n borrar√° su cuenta y todos sus productos permanentemente.")) return;
        
        const user = allUsers.find(u => u.__backendId === backendId);
        if (!user) return;

        if(user.role === 'reseller') {
            const userProducts = allProducts.filter(p => p.seller_username === user.username);
            for(const p of userProducts) {
                await window.dataSdk.delete(p);
            }
        }

        const result = await window.dataSdk.delete(user);
        if (result.isOk) {
            showToast('üóëÔ∏è Cuenta eliminada/rechazada correctamente');
        } else {
            showToast('Error al eliminar cuenta');
        }
    }

    async function handleSetupShop(e) {
      e.preventDefault();
      const user = selectedOrder;
      if (!user) return;

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      const shopName = document.getElementById('setupShopName').value.trim();
      const discordTag = document.getElementById('setupDiscord').value.trim();

      const discordExists = allUsers.find(u => u.discord_tag === discordTag && u.__backendId !== user.__backendId);
      if (discordExists) {
        showToast('Este Discord ya est√° registrado por otro usuario');
        btn.disabled = false;
        btn.innerHTML = 'Crear Tienda';
        return;
      }

      const updatedUser = {
        ...user,
        role: 'reseller',
        shop_name: shopName,
        discord_tag: discordTag,
        approved: true,
        status: 'approved'
      };

      const result = await window.dataSdk.update(updatedUser);
      if (result.isOk) {
        showToast('Tienda configurada exitosamente');
        showModal = null;
        selectedOrder = null;
        
        if (currentUser && user.__backendId === currentUser.__backendId) {
          currentUser = updatedUser;
          localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
          currentView = 'admin';
        }
        
        render();
      } else {
        showToast('Error al configurar tienda');
        btn.disabled = false;
        btn.innerHTML = 'Crear Tienda';
      }
    }

    // --- L√ìGICA DEL CARRITO ---
    function validateCart() {
        if (cart.length === 0) return;

        let cartModified = false;
        
        const newCart = cart.filter(cartItem => {
            const correspondingProduct = allProducts.find(p => p.__backendId === cartItem.__backendId);
            
            if (!correspondingProduct) {
                showToast(`‚ùå El item "${cartItem.name}" ha sido eliminado del cat√°logo.`);
                cartModified = true;
                return false; 
            }
            
            if (cartItem.quantity > correspondingProduct.stock) {
                cartItem.quantity = correspondingProduct.stock;
                cartModified = true;
                if (cartItem.quantity === 0) {
                      showToast(`‚ùå El item "${cartItem.name}" se agot√≥ y se elimin√≥ del carrito.`);
                      return false;
                }
                showToast(`‚ö†Ô∏è Stock de "${cartItem.name}" limitado a ${cartItem.quantity}.`);
            }
            
            // Sincronizar precios si cambiaron
            if (
                cartItem.price !== correspondingProduct.price ||
                cartItem.final_price !== correspondingProduct.final_price ||
                cartItem.name !== correspondingProduct.name
            ) {
                cartItem.price = correspondingProduct.price;
                cartItem.final_price = correspondingProduct.final_price;
                cartItem.discount = correspondingProduct.discount;
                cartItem.name = correspondingProduct.name;
                cartItem.category = correspondingProduct.category;
                cartItem.image_url = correspondingProduct.image_url;
                cartItem.seller_username = correspondingProduct.seller_username;
                cartItem.seller_discord = correspondingProduct.seller_discord;
                cartModified = true;
            }
            
            return true;
        });
        
        if (cartModified) {
           cart = newCart;
        }
    }

    function addToCart(backendId) {
      if (!currentUser) {
        showToast('Inicia sesi√≥n para agregar al carrito');
        showModal = 'login';
        render();
        return;
      }

      const product = allProducts.find(p => p.__backendId === backendId);
      if (!product || product.stock <= 0) {
        showToast('Producto sin stock');
        return;
      }

      const existing = cart.find(item => item.__backendId === backendId);
      if (existing) {
        if (existing.quantity < product.stock) {
          existing.quantity++;
          showToast('Cantidad actualizada');
        } else {
          showToast('No hay m√°s stock disponible');
        }
      } else {
        cart.push({ ...product, quantity: 1 });
        showToast('Agregado al carrito');
      }
      render();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      showToast('Producto eliminado del carrito');
      render();
    }

    function clearCart() {
      cart = [];
      render();
    }

    // --- FUNCIONES DE FILTRO POR TIENDA ---
    function filterByShop(shopName) {
        selectedShopFilter = shopName;
        selectedCategory = 'all'; // Reset category
        showToast(`üõí Viendo tienda: ${shopName}`);
        render();
    }

    function clearShopFilter() {
        selectedShopFilter = null;
        render();
    }

    // --- CREACI√ìN DE PEDIDOS ---
    async function createOrder() {
      if (cart.length === 0) return;
      validateCart(); 
      if (cart.length === 0) return;

      const ordersBySeller = {};
      cart.forEach(item => {
        if (!ordersBySeller[item.seller_username]) {
          ordersBySeller[item.seller_username] = {
            seller: item.seller_username,
            discord: item.seller_discord,
            items: [],
            total: 0
          };
        }
        const itemPrice = item.discount > 0 ? item.final_price : item.price;
        ordersBySeller[item.seller_username].items.push(item);
        ordersBySeller[item.seller_username].total += itemPrice * item.quantity;
      });

      let allOk = true;
      for (const sellerUsername in ordersBySeller) {
        const orderInfo = ordersBySeller[sellerUsername];
        const itemsDesc = orderInfo.items.map(item => {
          const itemPrice = item.discount > 0 ? item.final_price : item.price;
          return `${item.name} x${item.quantity} ($${(itemPrice * item.quantity).toFixed(2)} USDT)`;
        }).join(' | ');

        const itemsData = JSON.stringify(orderInfo.items.map(item => ({
          backendId: item.__backendId,
          name: item.name,
          quantity: item.quantity
        })));

        const orderData = {
          id: Date.now().toString() + '_' + sellerUsername,
          type: 'order',
          buyer_username: currentUser.username,
          buyer_discord: currentUser.discord_tag,
          seller_username: sellerUsername,
          seller_discord: orderInfo.discord,
          items: itemsDesc,
          items_data: itemsData,
          total: orderInfo.total,
          order_status: 'pending',
          seller_confirmed: false,
          buyer_confirmed: false,
          needs_review: false,
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.create(orderData);
        if (!result.isOk) {
          allOk = false;
        } else {
            const notificationData = {
                id: 'notification_' + result.item.__backendId, 
                type: 'activity',
                username: sellerUsername, 
                message: `¬°NUEVO PEDIDO de ${currentUser.username}!`,
                dismissed: false, 
                created_at: new Date().toISOString()
            };
            await window.dataSdk.create(notificationData);
        }
      }

      if (!allOk) {
          showToast('Error al crear uno o m√°s pedidos');
          return;
      }

      showToast('Pedido(s) creado(s) exitosamente!');
      cart = [];
      currentView = 'orders';
      render();
    }

    async function confirmOrder(backendId, isSeller) {
      const order = allOrders.find(o => o.__backendId === backendId);
      if (!order) return;

      let updatedOrder = {...order};

      if (isSeller) {
        updatedOrder.seller_confirmed = true;
      } else {
        updatedOrder.buyer_confirmed = true;
      }

      const result = await window.dataSdk.update(updatedOrder); 
      
      if (result.isOk) {
          if (result.item.seller_confirmed && result.item.buyer_confirmed && result.item.order_status !== 'completed') {
              
              const completedOrder = {...result.item, order_status: 'completed', needs_review: true};
              
              try {
                const itemsData = JSON.parse(completedOrder.items_data);
                for (const item of itemsData) {
                  const product = allProducts.find(p => p.__backendId === item.backendId);
                  if (product) {
                    const updatedProduct = {...product, stock: Math.max(0, product.stock - item.quantity)};
                    await window.dataSdk.update(updatedProduct); 
                  }
                }
                await window.dataSdk.update(completedOrder); 
              } catch (e) {
                console.error(e);
              }

              showToast('¬°Pedido completado!');
          } else {
              showToast('Confirmaci√≥n registrada.');
          }
      } else {
        showToast('Error al confirmar pedido');
      }
    }

    async function handleSubmitReview(e) {
      e.preventDefault();
      if (!selectedOrder) return;

      const rating = parseInt(document.querySelector('input[name="rating"]:checked')?.value || '0');
      const reviewText = document.getElementById('reviewText').value.trim();

      if (rating === 0) {
        showToast('Por favor selecciona una calificaci√≥n');
        return;
      }

      const reviewData = {
        id: Date.now().toString(),
        type: 'review',
        buyer_username: currentUser.username,
        reviewed_seller: selectedOrder.seller_username,
        rating: rating,
        review_text: reviewText,
        created_at: new Date().toISOString()
      };

      await window.dataSdk.create(reviewData);
      const updatedOrder = {...selectedOrder, needs_review: false};
      await window.dataSdk.update(updatedOrder);
        
      showToast('¬°Gracias por tu rese√±a!');
      showModal = null;
      selectedOrder = null;
      render();
    }

    // --- ESTAD√çSTICAS Y RANKING ---
    function getSellerRating(sellerUsername) {
      const sellerReviews = allReviews.filter(r => r.reviewed_seller === sellerUsername);
      if (sellerReviews.length === 0) return { average: 0, count: 0 };
      
      const sum = sellerReviews.reduce((acc, r) => acc + r.rating, 0);
      return {
        average: (sum / sellerReviews.length).toFixed(1),
        count: sellerReviews.length
      };
    }

    function getTopShops() {
      const resellers = allUsers.filter(u => u.role === 'reseller' && u.approved);
      
      const shopsStats = resellers.map(seller => {
        const rating = getSellerRating(seller.username);
        const salesCount = allOrders.filter(o => 
            o.seller_username === seller.username && 
            o.order_status === 'completed'
        ).length;

        return {
          ...seller,
          rating: parseFloat(rating.average),
          reviewCount: rating.count,
          salesCount: salesCount
        };
      });

      const activeShops = shopsStats.filter(s => s.salesCount > 0 || s.reviewCount > 0);

      return activeShops.sort((a, b) => {
        if (b.salesCount !== a.salesCount) return b.salesCount - a.salesCount;
        if (b.reviewCount !== a.reviewCount) return b.reviewCount - a.reviewCount;
        return b.rating - a.rating;
      }).slice(0, 3); 
    }

    function renderStars(rating) {
      const fullStars = Math.floor(rating);
      let stars = '';
      for (let i = 0; i < fullStars; i++) stars += '‚≠ê';
      if (rating % 1 >= 0.5) stars += '‚ú®';
      return stars;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg font-semibold z-50 text-white animate-bounce';
      toast.style.backgroundColor = getConfig().primary_button;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getConfig() {
      return window.elementSdk ? window.elementSdk.config : defaultConfig;
    }

    function getCurrentUserData() {
      if (!currentUser) return null;
      if (currentUser.role === 'admin' && currentUser.__backendId === 'admin') {
        return currentUser;
      }
      return allUsers.find(u => u.username === currentUser.username);
    }

    function getCategoryIcon(categoryId) {
      const cat = CATEGORIES.find(c => c.id === categoryId);
      return cat ? cat.icon : 'üì¶';
    }
    function getCategoryName(categoryId) {
      const cat = CATEGORIES.find(c => c.id === categoryId);
      return cat ? cat.name : 'Otro';
    }

    // --- RENDERIZADO DE VISTAS ---
    function render() {
      const app = document.getElementById('app');
      const config = getConfig();

      document.body.style.backgroundColor = config.background_color;
      document.body.style.color = config.text_color;
      document.body.style.fontFamily = `${config.font_family}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;

      if (currentView === 'catalog') {
        app.innerHTML = renderCatalog();
      } else if (currentView === 'cart') {
        app.innerHTML = renderCart();
      } else if (currentView === 'orders') {
        app.innerHTML = renderOrders();
      } else if (currentView === 'admin') {
        app.innerHTML = renderAdmin();
      }

      const modalContainer = document.getElementById('modalContainer');
      if (modalContainer) {
          modalContainer.innerHTML = showModal ? renderModal() : '';
      } else {
          const d = document.createElement('div'); 
          d.id = 'modalContainer';
          document.body.appendChild(d);
          d.innerHTML = showModal ? renderModal() : '';
      }
    }

    function renderCatalog() {
      const config = getConfig();
      
      // LOGICA DE FILTRADO POR TIENDA O CATEGORIA
      let filteredProducts = allProducts;
      
      if (selectedShopFilter) {
          filteredProducts = allProducts.filter(p => p.seller_shop_name === selectedShopFilter);
      } else {
          filteredProducts = selectedCategory === 'all' 
            ? allProducts 
            : selectedCategory === 'promotions'
            ? allProducts.filter(p => p.on_sale === true)
            : allProducts.filter(p => p.category === selectedCategory);
      }

      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const topShops = getTopShops(); 

      return `
        <div class="min-h-full" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <header class="shadow-lg sticky top-0 z-40" style="background-color: ${config.card_background};">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
              <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="text-center lg:text-left">
                  <h1 class="text-2xl font-bold text-blue-400">MU ONLINE 99B <span class="text-white text-xs">MARKETPLACE</span></h1>
                  <p class="text-xs mt-1 opacity-60">${config.contact_info}</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                  ${currentUser ? `
                    <button onclick="currentView='cart'; render();" class="relative px-4 py-2 rounded-lg font-semibold transition bg-slate-700 hover:bg-slate-600">
                      üõí Carrito ${cartCount > 0 ? `<span class="cart-badge">${cartCount}</span>` : ''}
                    </button>
                    <button onclick="currentView='orders'; render();" class="px-4 py-2 rounded-lg font-semibold transition bg-slate-700 hover:bg-slate-600">
                      üì¶ Pedidos
                    </button>
                    ${currentUser.role !== 'buyer' ? `
                      <button onclick="currentView='admin'; render();" class="px-4 py-2 rounded-lg font-semibold transition border border-blue-500 bg-slate-800">
                        ‚öôÔ∏è Admin
                      </button>
                    ` : ''}
                    <button onclick="logout();" class="px-4 py-2 rounded-lg font-semibold transition bg-red-600 hover:bg-red-500 text-white">
                      üö™
                    </button>
                  ` : `
                    <button onclick="showModal='register'; render();" class="px-4 py-2 rounded-lg font-semibold transition bg-green-600 hover:bg-green-500 text-white">
                      Registro
                    </button>
                    <button onclick="showModal='registerReseller'; render();" class="px-4 py-2 rounded-lg font-semibold transition bg-purple-600 hover:bg-purple-500 text-white">
                      Vender
                    </button>
                    <button onclick="showModal='login'; render();" class="px-4 py-2 rounded-lg font-semibold transition bg-blue-600 hover:bg-blue-500 text-white">
                      Login
                    </button>
                  `}
                </div>
              </div>
            </div>
          </header>

          ${!selectedShopFilter && topShops.length > 0 ? `
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div class="mb-4 text-center">
                <h2 class="text-2xl font-bold text-yellow-400 mb-1">üèÜ MEJORES VENDEDORES</h2>
                <p class="text-xs opacity-60">Top 3 por Ventas y Rese√±as</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                ${topShops.map((shop, index) => `
                  <div class="top-shop-card rank-${index+1} rounded-xl p-6 text-center">
                    <div class="text-4xl mb-2">
                      ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                    </div>
                    <h3 class="font-bold text-xl mb-1 shop-badge px-2 py-1 rounded inline-block" onclick="filterByShop('${shop.shop_name}')">${shop.shop_name}</h3>
                    <p class="text-sm opacity-70 mb-3">üë§ ${shop.username}</p>
                    
                    <div class="flex justify-center gap-4 mb-3">
                        <div class="text-center">
                          <p class="text-2xl font-bold text-green-400">${shop.salesCount}</p>
                          <p class="text-xs opacity-70">Ventas</p>
                        </div>
                        <div class="text-center">
                          <p class="text-2xl font-bold text-yellow-400">${shop.rating}</p>
                          <p class="text-xs opacity-70">${shop.reviewCount} Rese√±as</p>
                        </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            ${selectedShopFilter ? `
                <div class="flex items-center justify-between bg-blue-900/30 border border-blue-500 p-4 rounded-lg mb-6">
                    <h2 class="text-2xl font-bold text-blue-300">üè™ Tienda: ${selectedShopFilter}</h2>
                    <button onclick="clearShopFilter()" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-bold text-sm">
                        Ver Todas las Tiendas
                    </button>
                </div>
            ` : `
                <div class="flex flex-wrap gap-3 justify-center">
                  ${CATEGORIES.map(cat => `
                    <button 
                      onclick="selectedCategory='${cat.id}'; render();" 
                      class="category-btn px-6 py-3 rounded-lg font-semibold shadow-md ${selectedCategory === cat.id ? 'ring-2 ring-blue-400 bg-blue-600' : 'bg-slate-800 text-slate-300'}">
                      ${cat.icon} ${cat.name}
                    </button>
                  `).join('')}
                </div>
            `}
          </div>

          <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-12">
            ${filteredProducts.length === 0 ? `
              <div class="text-center py-20">
                <p class="text-2xl opacity-60">üì¶ No hay productos disponibles</p>
              </div>
            ` : `
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                ${filteredProducts.map(product => {
                  const rating = getSellerRating(product.seller_username);
                  return `
                  <div class="product-card rounded-xl shadow-lg overflow-hidden ${product.on_sale ? 'ring-2 ring-red-500' : 'border border-slate-700'}" style="background-color: ${config.card_background};">
                    ${product.on_sale ? `
                      <div class="absolute top-2 right-2 z-10">
                        <span class="px-2 py-1 rounded text-xs font-bold bg-red-600 text-white animate-pulse">
                          OFERTA
                        </span>
                      </div>
                    ` : ''}
                    
                    <div class="h-40 bg-slate-900 flex items-center justify-center text-6xl relative">
                      ${product.image_url ? `
                        <img src="${product.image_url}" class="w-full h-full object-cover" onerror="this.style.display='none';">
                      ` : getCategoryIcon(product.category)}
                    </div>

                    <div class="p-4 relative">
                      <div class="flex justify-center -mt-8 mb-2 relative z-20">
                          <button onclick="filterByShop('${product.seller_shop_name}')" class="shop-badge bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-blue-400 tracking-wide">
                            üè™ ${product.seller_shop_name}
                          </button>
                      </div>

                      <h3 class="font-bold mb-1 truncate text-center">${product.name}</h3>
                      <p class="text-xs opacity-60 mb-2 text-center">${rating.average}‚≠ê (${rating.count} Reviews)</p>
                      
                      <div class="flex items-center justify-between mt-4 border-t border-slate-700 pt-3">
                        <div>
                          ${product.discount > 0 ? `
                            <p class="text-xs line-through opacity-50">$${product.price}</p>
                            <p class="font-bold text-green-400">$${product.final_price.toFixed(2)}</p>
                          ` : `
                            <p class="font-bold text-green-400">$${product.price.toFixed(2)}</p>
                          `}
                        </div>
                        <button 
                          onclick="addToCart('${product.__backendId}')" 
                          ${product.stock <= 0 ? 'disabled' : ''}
                          class="px-3 py-1 rounded text-sm font-bold bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white">
                          ${product.stock > 0 ? 'COMPRAR' : 'AGOTADO'}
                        </button>
                      </div>
                    </div>
                  </div>
                `}).join('')}
              </div>
            `}
          </main>
          <div id="modalContainer"></div>
        </div>
      `;
    }

    function renderCart() {
      const config = getConfig();
      const total = cart.reduce((sum, item) => {
        const itemPrice = item.discount > 0 ? item.final_price : item.price;
        return sum + (itemPrice * item.quantity);
      }, 0);

      return `
        <div class="min-h-full p-8 max-w-4xl mx-auto" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <h2 class="text-3xl font-bold mb-6">üõí Carrito</h2>
          ${cart.length === 0 ? `
            <p>Tu carrito est√° vac√≠o</p>
            <button onclick="currentView='catalog'; render();" class="mt-4 bg-blue-600 px-4 py-2 rounded">Volver</button>
          ` : `
            ${cart.map((item, index) => `
              <div class="bg-slate-800 p-4 rounded mb-2 flex justify-between items-center border border-slate-700">
                <div>
                    <div class="font-bold">${item.name}</div>
                    <div class="text-sm opacity-70">$${item.final_price} x ${item.quantity}</div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="font-bold text-green-400">$${(item.final_price*item.quantity).toFixed(2)}</div>
                    <button onclick="removeFromCart(${index})" class="text-red-500 font-bold">X</button>
                </div>
              </div>
            `).join('')}
            <div class="mt-6 text-right">
                <div class="text-2xl font-bold mb-4">Total: <span class="text-green-400">$${total.toFixed(2)}</span></div>
                <button onclick="createOrder()" class="bg-green-600 w-full py-3 rounded font-bold">CONFIRMAR PEDIDO</button>
            </div>
          `}
        </div>
      `;
    }

    function renderOrders() {
      const config = getConfig();
      const myOrders = allOrders.filter(o => o.buyer_username === currentUser.username).reverse();

      return `
        <div class="min-h-full p-8 max-w-4xl mx-auto" style="background-color: ${config.background_color}; color: ${config.text_color};">
          <div class="flex justify-between mb-6">
            <h2 class="text-3xl font-bold">üì¶ Mis Pedidos</h2>
            <button onclick="currentView='catalog';render()" class="bg-blue-600 px-4 py-2 rounded">Volver</button>
          </div>
          ${myOrders.map((o, index) => `
            <div class="bg-slate-800 p-6 rounded-lg mb-4 border-l-4 ${o.order_status==='completed'?'border-green-500':'border-yellow-500'}">
                <div class="flex justify-between mb-4 border-b border-slate-700 pb-2">
                    <span class="font-bold text-lg text-blue-400">PEDIDO #${myOrders.length - index}</span>
                    <span class="text-xs font-bold px-2 py-1 rounded ${o.order_status==='completed'?'bg-green-900':'bg-yellow-900'}">${o.order_status.toUpperCase()}</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-slate-900 p-3 rounded">
                    <div>
                        <p class="text-xs uppercase text-slate-500 font-bold">Datos Vendedor</p>
                        <p class="text-sm text-white">üë§ ${o.seller_username}</p>
                        <p class="text-sm text-purple-400">üì± Discord: ${o.seller_discord}</p>
                    </div>
                     <div>
                        <p class="text-xs uppercase text-slate-500 font-bold">Items</p>
                        <p class="text-sm font-mono text-slate-300">${o.items}</p>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <div class="font-bold text-xl">$${o.total.toFixed(2)}</div>
                    ${o.order_status==='pending' ? `
                        <button onclick="confirmOrder('${o.__backendId}', false)" ${o.buyer_confirmed?'disabled':''} class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold disabled:opacity-50">
                            ${o.buyer_confirmed ? 'Esperando Vendedor...' : 'Confirmar Recibido'}
                        </button>
                    ` : '<span class="text-green-500 font-bold">‚úÖ Completado</span>'}
                </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // --- PANEL ADMIN (VENDEDOR) ACTUALIZADO ---
    function renderAdmin() {
      const config = getConfig();
      const userData = getCurrentUserData();
      if (!userData) return 'Error: Usuario no encontrado';

      const userProducts = userData.role === 'admin' ? allProducts : allProducts.filter(p => p.seller_username === userData.username);
      const myOrders = userData.role === 'admin' ? allOrders : allOrders.filter(o => o.seller_username === userData.username);
      const pendingOrders = myOrders.filter(o => o.order_status === 'pending');
      
      const stats = {
          items: userProducts.filter(p => p.category === 'items').length,
          wings: userProducts.filter(p => p.category === 'wings').length,
          jewels: userProducts.filter(p => p.category === 'jewels').length,
          sets: userProducts.filter(p => p.category === 'sets').length,
          totalProducts: userProducts.length,
          totalSales: myOrders.filter(o => o.order_status === 'completed').length,
          users: allUsers.length,
          online: onlineUsers.size
      };

      return `
        <div class="min-h-full p-6 max-w-7xl mx-auto" style="background-color: ${config.background_color}; color: ${config.text_color};">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">${userData.role === 'admin' ? '‚öôÔ∏è ADMIN DASHBOARD' : 'üè™ MI TIENDA'}</h1>
                <button onclick="currentView='catalog';render()" class="bg-blue-600 px-4 py-2 rounded font-bold">Inicio</button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                ${userData.role === 'admin' ? `
                    <div class="bg-slate-800 p-4 rounded border-t-4 border-green-500 text-center shadow-lg">
                        <div class="text-3xl font-bold text-green-400 flex items-center justify-center">
                            ${stats.online} <span class="live-indicator"></span>
                        </div>
                        <div class="text-xs font-bold tracking-wider opacity-70 mt-1">ONLINE</div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded border-t-4 border-blue-500 text-center shadow-lg">
                        <div class="text-3xl font-bold text-blue-400">${stats.users}</div>
                        <div class="text-xs font-bold tracking-wider opacity-70 mt-1">CUENTAS</div>
                    </div>
                ` : ''}
                
                <div class="bg-slate-800 p-4 rounded border-t-4 border-purple-500 text-center shadow-lg">
                    <div class="text-2xl font-bold text-purple-400">${stats.jewels}</div>
                    <div class="text-xs font-bold opacity-70 mt-1">üíé JOYAS</div>
                </div>
                <div class="bg-slate-800 p-4 rounded border-t-4 border-sky-500 text-center shadow-lg">
                    <div class="text-2xl font-bold text-sky-400">${stats.wings}</div>
                    <div class="text-xs font-bold opacity-70 mt-1">ü¶Ö ALAS</div>
                </div>
                <div class="bg-slate-800 p-4 rounded border-t-4 border-red-500 text-center shadow-lg">
                    <div class="text-2xl font-bold text-red-400">${stats.items}</div>
                    <div class="text-xs font-bold opacity-70 mt-1">‚öîÔ∏è ITEMS</div>
                </div>
                <div class="bg-slate-800 p-4 rounded border-t-4 border-yellow-500 text-center shadow-lg">
                    <div class="text-2xl font-bold text-yellow-400">${stats.sets}</div>
                    <div class="text-xs font-bold opacity-70 mt-1">üõ°Ô∏è SETS</div>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl mb-8 shadow-lg border border-slate-700">
                <h2 class="text-xl font-bold mb-4 text-yellow-400">üì¶ Pedidos Pendientes (${pendingOrders.length})</h2>
                ${pendingOrders.length === 0 ? `
                    <p class="opacity-50 italic">No hay pedidos pendientes por procesar.</p>
                ` : pendingOrders.map((o, index) => `
                    <div class="bg-slate-900 p-4 rounded mb-2 flex flex-col gap-4 border border-slate-700">
                        <div class="flex justify-between border-b border-slate-700 pb-2">
                            <span class="font-bold text-lg text-yellow-400">PEDIDO #${index + 1}</span>
                            <span class="text-sm opacity-50 font-mono">${o.id.slice(-6)}</span>
                        </div>

                        <div class="flex flex-wrap md:flex-nowrap gap-6">
                            <div class="w-full md:w-1/3 bg-slate-800/50 p-3 rounded">
                                <h4 class="text-xs font-bold text-blue-400 uppercase mb-2">üë§ Datos del Cliente</h4>
                                <p class="text-sm font-bold text-white mb-1">${o.buyer_username}</p>
                                <div class="flex items-center gap-2 text-purple-300 bg-purple-900/30 p-2 rounded border border-purple-500/30">
                                    <span>üì±</span>
                                    <span class="font-mono text-sm font-bold select-all">Discord: ${o.buyer_discord}</span>
                                </div>
                            </div>

                            <div class="w-full md:w-2/3 bg-slate-800/50 p-3 rounded">
                                <h4 class="text-xs font-bold text-green-400 uppercase mb-2">üõí Detalle de Compra</h4>
                                <div class="font-mono text-sm text-slate-300 mb-2 border-l-2 border-green-500 pl-3">
                                    ${o.items}
                                </div>
                                <div class="text-right font-bold text-xl text-green-400 mt-2">
                                    Total: $${o.total}
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end pt-2 border-t border-slate-700">
                             <button 
                                onclick="confirmOrder('${o.__backendId}', true)" 
                                ${o.seller_confirmed ? 'disabled' : ''}
                                class="w-full md:w-auto bg-green-600 hover:bg-green-500 disabled:opacity-50 px-6 py-2 rounded font-bold text-white shadow-lg transform transition hover:scale-105">
                                ${o.seller_confirmed ? '‚è≥ Esperando Confirmaci√≥n del Cliente...' : '‚úÖ MARCAR COMO ENTREGADO'}
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="bg-slate-800 p-6 rounded-xl mb-8 shadow-lg border border-slate-700">
                <h2 class="text-xl font-bold mb-4 text-blue-400">‚ûï Publicar Nuevo Item</h2>
                <form onsubmit="handleAddProduct(event);" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="productName" placeholder="Nombre del Item" required class="bg-slate-700 p-3 rounded text-white border border-slate-600 focus:border-blue-500 outline-none">
                    <select id="productCategory" class="bg-slate-700 p-3 rounded text-white border border-slate-600">
                        <option value="items">Arma/Escudo</option>
                        <option value="sets">Set Completo</option>
                        <option value="wings">Alas</option>
                        <option value="jewels">Joyas</option>
                    </select>
                    <input id="productPrice" type="number" step="0.01" placeholder="Precio (USDT)" required class="bg-slate-700 p-3 rounded text-white border border-slate-600">
                    <input id="productStock" type="number" placeholder="Cantidad (Stock)" required class="bg-slate-700 p-3 rounded text-white border border-slate-600">
                    <input id="productDiscount" type="number" placeholder="% Descuento (Opcional)" class="bg-slate-700 p-3 rounded text-white border border-slate-600">
                    <input id="productImage" placeholder="URL Imagen (Imgur...)" class="bg-slate-700 p-3 rounded text-white border border-slate-600">
                    <textarea id="productDescription" placeholder="Descripci√≥n detallada..." class="md:col-span-2 bg-slate-700 p-3 rounded text-white h-24 border border-slate-600"></textarea>
                    <label class="flex items-center gap-2 bg-slate-700 p-2 rounded w-fit border border-slate-600 cursor-pointer">
                        <input id="productOnSale" type="checkbox" class="w-5 h-5 accent-red-500"> 
                        <span class="font-bold text-red-400">üî• Oferta Especial</span>
                    </label>
                    <button type="submit" class="md:col-span-2 bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold text-white uppercase tracking-wide shadow-lg transition transform hover:scale-[1.01]">
                        Publicar Ahora
                    </button>
                </form>
            </div>
            
            ${userData.role === 'admin' ? `
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                    <h2 class="text-xl font-bold mb-4 text-purple-400">üëÆ Control de Usuarios</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-300">
                            <thead class="bg-slate-900 text-white uppercase font-bold">
                                <tr>
                                    <th class="p-3">Usuario</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Tienda</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allUsers.map(u => `
                                    <tr class="border-b border-slate-700 hover:bg-slate-700/50 transition">
                                        <td class="p-3 font-bold ${onlineUsers.has(u.username) ? 'text-green-400' : 'text-white'}">
                                            ${u.username} ${onlineUsers.has(u.username) ? '<span class="inline-block w-2 h-2 bg-green-500 rounded-full ml-1"></span>' : ''}
                                        </td>
                                        <td>
                                            <span class="bg-slate-700 px-2 py-1 rounded text-xs border border-slate-600">
                                                ${u.role.toUpperCase()}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="${u.status === 'banned' ? 'text-red-500 font-bold' : 'text-green-500'}">
                                                ${u.status}
                                            </span>
                                        </td>
                                        <td class="text-xs opacity-70">${u.shop_name || '-'}</td>
                                        <td>
                                            ${u.status === 'pending' ? `
                                                <button onclick="approveUser('${u.__backendId}')" class="bg-green-600 text-white px-3 py-1 rounded font-bold text-xs mr-2 hover:bg-green-500 transition">
                                                    ACEPTAR
                                                </button>
                                                <button onclick="rejectUser('${u.__backendId}')" class="bg-red-600 text-white px-3 py-1 rounded font-bold text-xs hover:bg-red-500 transition">
                                                    RECHAZAR
                                                </button>
                                            ` : `
                                                <button onclick="banUser('${u.__backendId}')" class="text-yellow-500 hover:text-yellow-400 font-bold mr-3 transition">
                                                    ${u.status.includes('banned') ? 'UNBAN' : 'BAN'}
                                                </button>
                                                <button onclick="deleteUserAccount('${u.__backendId}')" class="text-red-500 hover:text-red-400 font-bold transition">
                                                    DEL
                                                </button>
                                            `}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : ''}
        </div>
      `;
    }

    // --- MODALES ---
    function renderModal() {
      const close = `onclick="if(event.target===this){showModal=null; render()}"`;
      const boxClasses = "bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full relative border border-slate-600 transform transition-all scale-100";

      if (showModal === 'login') {
        return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
            <div class="${boxClasses}">
                <h2 class="text-2xl font-bold text-center mb-4 text-white">Acceso</h2>
                <form onsubmit="handleLogin(event)">
                    <input id="loginUsername" placeholder="Usuario" class="w-full mb-3 p-3 rounded bg-slate-700 text-white outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input id="loginPassword" type="password" placeholder="Contrase√±a" class="w-full mb-6 p-3 rounded bg-slate-700 text-white outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold text-white shadow-lg">ENTRAR</button>
                </form>
            </div>
        </div>`;
      }

      if (showModal === 'register') {
        return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
            <div class="${boxClasses}">
                <h2 class="text-2xl font-bold text-center mb-4 text-green-400">Registro Comprador</h2>
                <form onsubmit="handleRegisterBuyer(event)">
                    <input id="buyerUsername" placeholder="Usuario" class="w-full mb-3 p-3 rounded bg-slate-700 text-white" required>
                    <input id="buyerPassword" type="password" placeholder="Contrase√±a" class="w-full mb-3 p-3 rounded bg-slate-700 text-white" required>
                    <input id="buyerDiscord" placeholder="Discord Tag (Ej: User#1234)" class="w-full mb-6 p-3 rounded bg-slate-700 text-white" required>
                    <button class="w-full bg-green-600 hover:bg-green-500 py-3 rounded font-bold text-white shadow-lg">CREAR CUENTA</button>
                </form>
            </div>
        </div>`;
      }

      if (showModal === 'registerReseller') {
        return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" ${close}>
            <div class="${boxClasses}">
                <h2 class="text-2xl font-bold text-center mb-4 text-purple-400">Solicitud Vendedor</h2>
                <form onsubmit="handleRegisterReseller(event)">
                    <input id="resellerUsername" placeholder="Usuario" class="w-full mb-3 p-3 rounded bg-slate-700 text-white" required>
                    <input id="resellerPassword" type="password" placeholder="Contrase√±a" class="w-full mb-3 p-3 rounded bg-slate-700 text-white" required>
                    <input id="resellerShop" placeholder="Nombre Tienda" class="w-full mb-3 p-3 rounded bg-slate-700 text-white" required>
                    <input id="resellerDiscord" placeholder="Discord Tag" class="w-full mb-6 p-3 rounded bg-slate-700 text-white" required>
                    <button class="w-full bg-purple-600 hover:bg-purple-500 py-3 rounded font-bold text-white shadow-lg">ENVIAR SOLICITUD</button>
                </form>
            </div>
        </div>`;
      }

      if (showModal === 'review') {
        return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
            <div class="${boxClasses} border-2 border-yellow-500">
                <h2 class="text-2xl font-bold text-center mb-2 text-yellow-400">‚≠ê Calif√≠canos</h2>
                <p class="text-center text-slate-400 mb-6">Tu pedido con <b>${selectedOrder.seller_username}</b> ha finalizado.</p>
                <form onsubmit="handleSubmitReview(event)">
                    <div class="flex justify-center gap-2 mb-6">
                        ${[1,2,3,4,5].map(n => `
                            <label>
                                <input type="radio" name="rating" value="${n}" class="hidden peer">
                                <span class="text-4xl text-slate-600 peer-checked:text-yellow-400 hover:text-yellow-400 cursor-pointer transition transform hover:scale-110">‚òÖ</span>
                            </label>
                        `).join('')}
                    </div>
                    <textarea id="reviewText" class="w-full bg-slate-700 p-3 rounded text-white mb-4" placeholder="Comentario opcional..."></textarea>
                    <button class="w-full bg-yellow-600 hover:bg-yellow-500 py-3 rounded font-bold text-white shadow-lg">ENVIAR RESE√ëA</button>
                </form>
            </div>
        </div>`;
      }

      if (showModal === 'setupShop') {
        return `
        <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
            <div class="${boxClasses}">
                <h2 class="text-2xl font-bold text-center mb-4">Configura tu Tienda</h2>
                <form onsubmit="handleSetupShop(event)">
                    <input id="setupShopName" placeholder="Nombre Tienda" class="w-full mb-3 p-3 rounded bg-slate-700 text-white" required>
                    <input id="setupDiscord" placeholder="Discord" value="${currentUser.discord_tag||''}" class="w-full mb-6 p-3 rounded bg-slate-700 text-white" required>
                    <button class="w-full bg-blue-600 py-3 rounded font-bold text-white shadow-lg">GUARDAR CONFIGURACI√ìN</button>
                </form>
            </div>
        </div>`;
      }

      return '';
    }

    // Arrancar la aplicaci√≥n
    init();
  </script>
 </body>
</html>
